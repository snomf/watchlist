import{y as C,z as T,R as E,I as L,A as F,B as I,H as v,D as h,G as S}from"./index.esm-t1Vi5QVN.js";const M={apiKey:"AIzaSyB7ijoC19A2krXR4kchbLEK_OZy_I53hsY",authDomain:"marvelmarathon.firebaseapp.com",projectId:"marvelmarathon",storageBucket:"marvelmarathon.appspot.com",messagingSenderId:"436493932151",appId:"1:436493932151:web:3db786130c2e7ba0159872"},y=C(M);T(y,{provider:new E("6LebxYsrAAAAAF0FNbAiFp-uA7kjHZJT3i3hr6co"),isTokenAutoRefreshEnabled:!0});const m=L(y),$=F(y),D=I($,{model:"gemini-2.5-flash-lite"}),b="marvel-marathon-default",j="':7:}lb1m/8F17;1%A&65";let f={items:[]},c={};async function B(){console.log("Initializing Stats Page...");try{const[a,t]=await Promise.all([v(h(m,"marathon-data",b)),v(h(m,"settings","main"))]);if(a.exists())f=a.data(),console.log("Marathon data loaded:",f);else{console.error("Marathon data not found!"),document.getElementById("loading-spinner").innerHTML="Error: Marathon data not found.";return}t.exists()?(c=t.data(),console.log("User settings loaded:",c)):(console.warn("User settings not found, using defaults."),c={quotaConservation:!0,aiDisabled:!1,wallpaper:null});const o=H(f.items);console.log("Calculated Stats:",o),N(o),K(o),O(),document.getElementById("loading-spinner").style.display="none"}catch(a){console.error("Error initializing stats page:",a),document.getElementById("loading-spinner").innerHTML="Error loading page data. Please refresh."}}function H(a){const t=a.filter(r=>r.watched===!0),o=t.map(r=>r.ratings.user1).filter(r=>r!=null),n=t.map(r=>r.ratings.user2).filter(r=>r!=null),e=o.reduce((r,l)=>r+l,0)/(o.length||1),i=n.reduce((r,l)=>r+l,0)/(n.length||1);return{ratingBreakdown:{combinedAvg:(e+i)/2,juainnyAvg:e,erickAvg:i,tougherCritic:R(e,i)},marathonAwards:{mvp:_(t),greatDivide:J(t),juainnyFavorite:x(t,"user1"),erickFavorite:x(t,"user2"),juainnyLeastFavorite:w(t,"user1"),erickLeastFavorite:w(t,"user2"),underdog:U(t)},aiData:{unwatchedCount:a.filter(r=>!r.watched&&!r.rejected).length,nextUpTitle:a.find(r=>!r.watched&&!r.rejected)?.title||"N/A"}}}function R(a,t){return a===t?"It's a tie!":a<t?"Juainny":"Erick"}function _(a){let t=-1,o=[];return a.forEach(n=>{const e=n.ratings.user1,i=n.ratings.user2;if(e!==null&&i!==null){const s=(e+i)/2,r={title:n.title,score:s,backdrop_path:n.backdrop_path};s>t?(t=s,o=[r]):s===t&&o.push(r)}}),o}function J(a){let t=-1,o=[];return a.forEach(n=>{const e=n.ratings.user1,i=n.ratings.user2;if(e!==null&&i!==null){const s=Math.abs(e-i),r={title:n.title,difference:s,backdrop_path:n.backdrop_path};s>t?(t=s,o=[r]):s===t&&o.push(r)}}),o}function x(a,t){let o=-1,n=[];return a.forEach(e=>{const i=e.ratings[t];if(i!==null){const s={title:e.title,score:i,backdrop_path:e.backdrop_path};i>o?(o=i,n=[s]):i===o&&n.push(s)}}),n}function U(a){const t=a.filter(e=>e.vote_average&&e.vote_average<7);if(t.length===0)return[];let o=-1,n=[];return t.forEach(e=>{const i=e.ratings.user1,s=e.ratings.user2;if(i!==null&&s!==null){const r=(i+s)/2,l={title:e.title,userScore:r,publicScore:e.vote_average,backdrop_path:e.backdrop_path};r>o?(o=r,n=[l]):r===o&&n.push(l)}}),n}function w(a,t){let o=11,n=[];return a.forEach(e=>{const i=e.ratings[t];if(i!=null){const s={title:e.title,score:i,backdrop_path:e.backdrop_path};i<o?(o=i,n=[s]):i===o&&n.push(s)}}),n}function N(a){const{ratingBreakdown:t,marathonAwards:o}=a,n=document.getElementById("stat-bar");if(!n)return;const e=[{label:"Combined Average",value:t.combinedAvg.toFixed(2),color:"text-text-primary"},{label:"Juainny's Average",value:t.juainnyAvg.toFixed(2),color:"text-green-400"},{label:"Erick's Average",value:t.erickAvg.toFixed(2),color:"text-purple-400"},{label:"Tougher Critic",value:t.tougherCritic,color:"text-danger"}];let i='<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';for(const s of e){const r=s.label==="Tougher Critic"?"text-2xl":"text-3xl";i+=`
            <div class="stat-card text-center p-4 rounded-lg bg-bg-tertiary border border-border-primary">
                <p class="${r} font-bold ${s.color}">${s.value}</p>
                <p class="text-text-muted mt-1 text-xs">${s.label}</p>
            </div>
        `}i+="</div>",n.innerHTML=i,z(o)}function z(a){const t=document.getElementById("awards-container");if(!t)return;const o=[{id:"mvp",title:"Our Marathon MVP",description:"Highest combined average rating.",winners:a.mvp,scoreLabel:"Score",scoreKey:"score",precision:1,color:"text-yellow-400"},{id:"greatDivide",title:"The Great Divide",description:"Largest difference between ratings.",winners:a.greatDivide,scoreLabel:"Difference",scoreKey:"difference",precision:1,color:"text-blue-400"},{id:"juainnyFavorite",title:"Juainny's Favorite",description:"Highest personal rating from Juainny.",winners:a.juainnyFavorite,scoreLabel:"Score",scoreKey:"score",precision:0,color:"text-green-400"},{id:"erickFavorite",title:"Erick's Favorite",description:"Highest personal rating from Erick.",winners:a.erickFavorite,scoreLabel:"Score",scoreKey:"score",precision:0,color:"text-purple-400"},{id:"juainnyLeastFavorite",title:"Juainny's Least Favorite",description:"Lowest personal rating from Juainny.",winners:a.juainnyLeastFavorite,scoreLabel:"Score",scoreKey:"score",precision:0,color:"text-gray-500"},{id:"erickLeastFavorite",title:"Erick's Least Favorite",description:"Lowest personal rating from Erick.",winners:a.erickLeastFavorite,scoreLabel:"Score",scoreKey:"score",precision:0,color:"text-gray-500"},{id:"underdog",title:"The Underdog Award",description:"Highest user-rated film with a low public score.",winners:a.underdog,scoreLabel:"User Score",scoreKey:"userScore",precision:1,color:"text-teal-400"}];let n="";for(const e of o)if(e.winners.length>0){const i=e.winners[0],s=i.backdrop_path?`https://image.tmdb.org/t/p/w500${i.backdrop_path}`:"https://placehold.co/500x281/1f2937/ffffff?text=No+Backdrop",r=e.winners.map(d=>d.title).join(" & ");let l;e.id==="underdog"?l=`User: ${i.userScore.toFixed(1)} | Public: ${i.publicScore.toFixed(1)}`:l=`${e.scoreLabel}: ${i[e.scoreKey].toFixed(e.precision)}`,n+=`
                <div class="award-tile bg-bg-tertiary rounded-lg shadow-lg overflow-hidden">
                    <div class="relative">
                        <img src="${s}" alt="${r}" class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-bg-tertiary to-transparent"></div>
                    </div>
                    <div class="p-4 -mt-10 relative z-10">
                        <h3 class="text-lg font-black ${e.color}">${e.title}</h3>
                        <p class="text-xs text-text-muted italic mb-2">${e.description}</p>
                        <p class="text-md font-semibold text-text-primary truncate" title="${r}">${r}</p>
                        <p class="text-text-muted text-xs">${l}</p>
                    </div>
                </div>
            `}t.innerHTML=n}async function K(a){const t=document.getElementById("ai-analysis");if(c.aiDisabled){t.style.display="none";return}if(t.style.display="block",document.getElementById("ai-content-area"),c.quotaConservation,c.quotaConservation){const o=h(m,"stats-analysis",b);try{const n=await v(o);n.exists()&&n.data().htmlContent?(console.log("Found saved AI analysis. Rendering from Firestore."),k(n.data().htmlContent,a,!0)):(console.log("No saved AI analysis found. Generating new take."),p(a,!0))}catch(n){console.error("Error fetching saved AI analysis:",n),p(a,!0)}}else p(a,!1)}function k(a,t,o){const n=document.getElementById("ai-content-area"),e=document.getElementById("ai-title-container");if(!n||!e)return;const i=e.querySelector("#ai-reload-btn");if(i&&i.remove(),o){const g=document.createElement("button");g.id="ai-reload-btn",g.className="absolute top-0 right-0 text-gray-400 hover:text-white transition",g.innerHTML='<i class="fas fa-sync-alt"></i>',g.onclick=()=>p(t,!0),e.appendChild(g)}n.innerHTML="";const s=document.createElement("div");s.id="ai-content-wrapper",s.className="ai-content-wrapper";const r=document.createElement("div");r.className="text-left";const l=a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");r.innerHTML=l,s.appendChild(r);const d=document.createElement("div");d.className="flex justify-center mt-2";const u=document.createElement("button");u.id="ai-expand-btn",u.className="text-red-500 hover:text-red-600 transition",u.innerHTML='<i class="fas fa-chevron-down"></i>',d.appendChild(u),n.appendChild(s),n.appendChild(d),s.style.transition="max-height 0.5s ease-in-out",u.addEventListener("click",()=>{u.classList.toggle("expanded"),s.style.maxHeight?s.style.maxHeight=null:s.style.maxHeight=s.scrollHeight+"px"})}async function p(a,t){const o=document.getElementById("ai-content-area");o.innerHTML=`
        <div class="flex flex-col items-center justify-center p-6">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-500 mb-4"></div>
            <p class="text-gray-400">Jarvis is analyzing your marathon data...</p>
        </div>`;const n=P(a);try{const s=(await(await D.generateContent(n)).response).text();if(k(s,a,t),c.quotaConservation){const r=h(m,"stats-analysis",b);await S(r,{generatedAt:new Date().toISOString(),htmlContent:s,authKey:j}),console.log("AI analysis saved to Firestore.")}}catch(e){console.error("AI analysis generation failed:",e),o.innerHTML=`<p class="text-red-500 p-6">Sorry, there was an error getting Jarvis's take. Please try again later.</p>`}}function P(a){const{ratingBreakdown:t,marathonAwards:o,aiData:n}=a,e=g=>g.map(A=>A.title).join(" & "),i=e(o.mvp),s=e(o.greatDivide),r=e(o.underdog),l=e(o.juainnyFavorite),d=e(o.erickFavorite),u={"Marathon MVP Title":i,"Underdog Award Title":r,"Great Divide Title":s,"Tougher Critic's Name":t.tougherCritic,"Juainny's Favorite Title":l,"Erick's Favorite Title":d,unwatchedCount:n.unwatchedCount,nextUpTitle:n.nextUpTitle,juainnyAvgRating:t.juainnyAvg,erickAvgRating:t.erickAvg};return`
You are "Jarvis", a data-savvy, and insightful AI companion. Your purpose is to analyze the Marvel marathon viewing history of a couple, Juainny and Erick, and present them with a fun, personalized "Marathon Report Card" narrative.

INSTRUCTIONS:
- Analyze the provided JSON data.
- Your tone should be conversational, encouraging, and a little bit cheeky. Use their names to make it personal.
- Your entire response should be plain text, suitable for direct display.
- You are allowed to use markdown for bolding text by wrapping it in double asterisks, like **this**. Do not use any other markdown or any HTML tags.
- Do NOT spoil any movies or shows that are not in the provided data.

DATA:
${JSON.stringify(u,null,2)}

Here is a loose structure to follow for your narrative:

**Our Marathon Report Card**
Start with a fun, introductory sentence about their journey so far.

**Your Overall Taste Profile**
Generate a 1-2 sentence summary of their combined taste. Analyze if they prefer grounded stories, cosmic adventures, ensemble films, or solo outings based on their highest-rated movies.

**The Marathon Awards**
- Comment on "${i}", their highest-rated film, and why it's a deserving champion.
- Comment on "${r}", congratulating them on spotting a hidden gem that the public may have overlooked.
- Comment on "${s}", the movie with the biggest rating difference between Juainny and Erick. Write a playful sentence about their fun disagreement.

**Head-to-Head Analysis**
- Based on the data, announce who the "Tougher Critic" is.
- Comment on their individual favorites, Juainny's being ${l} and Erick's being ${d}. Add a short, insightful sentence comparing these two choices.

**A Look Ahead**
- Mention that they have ${n.unwatchedCount} items left and that their next item is ${n.nextUpTitle}. Add a fun, non-spoilery comment about it.
`}function O(){const a=document.body,t=c.theme||"dark",o=Array.from(a.classList).filter(n=>n.startsWith("theme-"));a.classList.remove(...o),a.classList.add(`theme-${t}`),c.wallpaper?(document.body.style.backgroundImage=`url(${c.wallpaper})`,document.body.style.backgroundSize="cover",document.body.style.backgroundPosition="center",document.body.style.backgroundAttachment="fixed",document.getElementById("wallpaper-overlay").style.display="block"):(document.body.style.backgroundImage="",document.getElementById("wallpaper-overlay").style.display="none")}document.addEventListener("DOMContentLoaded",B);
