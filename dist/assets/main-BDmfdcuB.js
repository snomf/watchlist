import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as y}from"./supabase-client-Dw9ZaCyq.js";function $n(e,t=0,n){const r=document.getElementById(e);if(!r)return;r.innerHTML=`
        <div class="star-rating-widget flex items-center gap-2">
            <div class="stars-wrapper flex">
                ${[...Array(10)].map((f,h)=>`
                    <div class="star-container" data-value="${h+1}">
                        <div class="star-half left" data-value="${h+.5}"></div>
                        <div class="star-half right" data-value="${h+1}"></div>
                        <i class="star-icon fas fa-star text-gray-500"></i>
                    </div>
                `).join("")}
            </div>
            <input type="number" step="0.5" min="0" max="10" class="rating-input-manual w-16 bg-bg-primary border-border-primary rounded-md text-center">
            <input type="hidden" class="rating-input-hidden" name="rating-${e}">
        </div>
    `;const a=r.querySelector(".stars-wrapper"),o=r.querySelector(".rating-input-manual"),s=r.querySelector(".rating-input-hidden"),i=Array.from(r.querySelectorAll(".star-container"));let l=parseFloat(t)||0;const c=f=>{const h=Math.round(f*2)/2;i.forEach(m=>{const d=parseFloat(m.dataset.value),p=m.querySelector(".star-icon");p.classList.remove("fas","fa-star","fa-star-half-alt","far","fa-star"),h>=d?(p.className="star-icon fas fa-star",p.style.color="var(--star-color, #fbbf24)"):h>=d-.5?(p.className="star-icon fas fa-star-half-alt",p.style.color="var(--star-color, #fbbf24)"):(p.className="star-icon far fa-star text-gray-500",p.style.color="")}),o.value=f.toFixed(1),s.value=f},u=f=>{l=f,c(l),n&&n(l)};i.forEach(f=>{[".left",".right"].forEach(h=>{const m=f.querySelector(h),d=parseFloat(m.dataset.value);m.addEventListener("mouseenter",()=>c(d)),m.addEventListener("click",()=>u(d))})}),a.addEventListener("mouseleave",()=>c(l)),o.addEventListener("change",()=>{let f=parseFloat(o.value);isNaN(f)&&(f=0),f=Math.max(0,Math.min(10,f)),u(f)}),u(l)}const Ra="modulepreload",Ba=function(e){return"/"+e},On={},Da=function(t,n,r){let a=Promise.resolve();if(n&&n.length>0){let l=function(c){return Promise.all(c.map(u=>Promise.resolve(u).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),i=s?.nonce||s?.getAttribute("nonce");a=l(n.map(c=>{if(c=Ba(c),c in On)return;On[c]=!0;const u=c.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":Ra,u||(h.as="script"),h.crossOrigin="",h.href=c,i&&h.setAttribute("nonce",i),document.head.appendChild(h),u)return new Promise((m,d)=>{h.addEventListener("load",m),h.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return a.then(s=>{for(const i of s||[])i.status==="rejected"&&o(i.reason);return t().catch(o)})};let Bt=null;function ft(){const e=document.getElementById("allen-easter-egg");if(!e)return;if(Bt&&clearTimeout(Bt),document.documentElement.getAttribute("data-theme")!=="smiling-friends"){e.classList.add("hidden"),e.style.transform="scale(1)";return}const n=37e3,a=Math.floor(Math.random()*(9e4-n+1))+n;Bt=setTimeout(()=>{e.classList.remove("hidden"),e.style.transform="scale(1)"},a),e.onclick=()=>{e.style.transform="scale(0)",setTimeout(()=>{e.classList.add("hidden"),ft()},500)}}let lt=[];async function Ma(){const e=document.getElementById("settings-modal");if(!e){console.error("Settings modal element not found!");return}try{await populateWallpaperSelector(),await Je()}catch(n){console.error("Error preparing settings modal:",n)}document.body.style.overflow="hidden",e.classList.remove("hidden"),e.classList.remove("modal-hidden"),e.classList.add("flex");const t=document.querySelectorAll(".theme-btn");t.forEach(n=>{n.addEventListener("click",()=>{if(t.forEach(r=>r.classList.remove("border-accent-primary")),n.classList.add("border-accent-primary"),n.dataset.theme==="smiling-friends"){const r=document.getElementById("movie-banner-select"),a="https://images6.alphacoders.com/134/1346437.png";let o=Array.from(r.options).find(s=>s.value===a);o||(o=document.createElement("option"),o.value=a,o.textContent="Smiling Friends (Theme Default)",r.appendChild(o)),r.value=a}})})}function Ir(){const e=document.getElementById("settings-modal");e&&(e.classList.add("hidden"),e.classList.add("modal-hidden"),e.classList.remove("flex"),document.body.style.overflow="")}function $a(){const e=document.getElementById("wallpaper-btn"),t=document.getElementById("wallpaper-modal"),n=document.getElementById("close-wallpaper-modal"),r=document.getElementById("wallpaper-search");!e||!t||(e.addEventListener("click",async()=>{t.classList.remove("hidden"),await Oa()}),n.addEventListener("click",()=>{t.classList.add("hidden")}),t.addEventListener("click",a=>{a.target===t&&t.classList.add("hidden")}),r.addEventListener("input",a=>{Pa(a.target.value)}))}async function Oa(){if(lt.length===0){const{data:e,error:t}=await y.from("media").select("title, backdrop_path");if(t){console.error("Error fetching media for wallpapers:",t);return}lt=e.filter(n=>n.backdrop_path)}kr(lt)}function kr(e){const t=document.getElementById("wallpaper-grid");t&&(t.innerHTML="",e.forEach(n=>{const r=document.createElement("div");r.className="cursor-pointer rounded-lg overflow-hidden transition hover:scale-105",r.style.border="2px solid var(--color-border-primary)";const a=`https://image.tmdb.org/t/p/original${n.backdrop_path}`;r.innerHTML=`
            <img src="${a}" class="w-full h-24 object-cover">
            <div class="p-2" style="background-color: var(--color-bg-tertiary);">
                <p class="text-sm font-semibold truncate" style="color: var(--color-text-primary);">${n.title}</p>
            </div>
        `,r.addEventListener("click",async()=>{ln=a,await dt(),document.getElementById("wallpaper-modal").classList.add("hidden")}),t.appendChild(r)}))}function Pa(e){const t=lt.filter(n=>n.title.toLowerCase().includes(e.toLowerCase()));kr(t)}let ln=null;async function dt(){const e=document.querySelector(".theme-btn.border-accent-primary"),t=e?e.dataset.theme:"night",n=ln||null,r=document.getElementById("device-name-input"),a=r?r.value.trim():"";a&&localStorage.setItem("device_name",a);const o=document.getElementById("device-name");o&&(o.textContent=a||"User");const{error:s}=await y.from("settings").update({theme:t,wallpaper_url:n}).eq("id",1);s?console.error("Error saving settings:",s):(await Je(),Ir())}async function Je(){const{data:e,error:t}=await y.from("settings").select("theme, wallpaper_url, hide_search_results_without_images, juainny_avatar, erick_avatar").eq("id",1).single();if(t||!e){console.error("Error loading settings:",t),document.documentElement.setAttribute("data-theme","night");return}const{theme:n,wallpaper_url:r,hide_search_results_without_images:a,juainny_avatar:o,erick_avatar:s}=e;document.documentElement.setAttribute("data-theme",n||"night"),o&&(Le.juainny=o),s&&(Le.erick=s);const i=(_,T)=>{const L=document.getElementById(T);L&&(L.innerHTML=V(_,"w-full h-full"))};i("juainny","user1-avatar-preview"),i("erick","user2-avatar-preview"),document.querySelectorAll(".theme-btn").forEach(_=>{_.dataset.theme===(n||"night")?_.classList.add("border-accent-primary"):_.classList.remove("border-accent-primary")}),document.getElementById("hide-search-images-toggle").checked=a;const c=document.getElementById("wallpaper-overlay");r?(document.body.style.backgroundImage=`url('${r}')`,document.body.style.backgroundSize="cover",document.body.style.backgroundPosition="center",document.body.style.backgroundRepeat="no-repeat",document.body.style.backgroundAttachment="fixed",c&&(n==="smiling-friends"?c.style.display="none":c.style.display="block")):(document.body.style.backgroundImage="none",document.body.style.backgroundSize="",document.body.style.backgroundPosition="",document.body.style.backgroundRepeat="",document.body.style.backgroundAttachment="",c&&(c.style.display="none")),typeof ft=="function"&&ft();const u=document.getElementById("movie-banner-select");u&&(u.value=r||"");const f=localStorage.getItem("device_name"),h=document.getElementById("device-name-input"),m=document.getElementById("device-name");h&&(h.value=f||""),m&&(m.textContent=f||"User");const d=document.getElementById("user1-avatar-nav"),p=document.getElementById("user2-avatar-nav");d&&(d.innerHTML=V("juainny","w-full h-full")),p&&(p.innerHTML=V("erick","w-full h-full"))}function Na(){const e=document.getElementById("settings-btn"),t=document.getElementById("close-settings-modal-btn"),n=document.getElementById("save-settings-btn"),r=document.getElementById("remove-wallpaper-btn");e?e.addEventListener("click",m=>{Ma()}):console.error("Settings button NOT found in DOM during initialization."),t&&t.addEventListener("click",Ir),n&&n.addEventListener("click",dt);const a=document.getElementById("soft-refresh-btn"),o=document.getElementById("emergency-refresh-btn");a&&a.addEventListener("click",()=>{const m=new URL(window.location.href);m.searchParams.set("refresh","true"),window.location.href=m.toString()}),o&&o.addEventListener("click",()=>{const m=new URL(window.location.href);m.searchParams.set("hardrefresh","true"),window.location.href=m.toString()}),document.querySelectorAll(".theme-btn").forEach(m=>{m.addEventListener("click",()=>{const d=m.dataset.theme;document.documentElement.setAttribute("data-theme",d),document.querySelectorAll(".theme-btn").forEach(p=>p.classList.remove("border-accent-primary")),m.classList.add("border-accent-primary"),dt()})}),$a(),r&&r.addEventListener("click",async()=>{ln=null,await dt()});const s=document.getElementById("avatar-picker-user1-btn"),i=document.getElementById("avatar-picker-user2-btn");s&&s.addEventListener("click",()=>Pn("juainny")),i&&i.addEventListener("click",()=>Pn("erick"));const l=document.getElementById("close-avatar-modal-btn"),c=document.getElementById("close-avatar-modal-backdrop"),u=document.getElementById("save-avatar-btn");l&&l.addEventListener("click",Vt),c&&c.addEventListener("click",Vt),u&&u.addEventListener("click",Wa),document.querySelectorAll(".avatar-user-btn").forEach(m=>{m.addEventListener("click",()=>{M.user=m.dataset.user,Le[M.user]?.imageUrl?M.mode=Le[M.user].type||"gradient":M.mode="gradient",ze()})}),document.querySelectorAll(".avatar-mode-btn").forEach(m=>{m.addEventListener("click",()=>{M.mode=m.dataset.mode,ze()})});const f=document.getElementById("avatar-file-input");f&&f.addEventListener("change",async m=>{const d=m.target.files[0];if(d){document.getElementById("avatar-file-name").textContent=d.name,document.getElementById("avatar-file-name").classList.remove("hidden");const p=await qa(d);p&&(M.imageUrl=p,zt())}});const h=document.getElementById("avatar-url-input");h&&h.addEventListener("input",m=>{const d=m.target.value.trim();d&&(f&&(f.value=""),document.getElementById("avatar-file-name").textContent="",document.getElementById("avatar-file-name").classList.add("hidden"),M.imageUrl=d,zt())})}const Fa=["#ef4444","#f97316","#f59e0b","#84cc16","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#d946ef","#f43f5e","#1f2937"],ja=["cat.png","headphones.png","sofa.png","spider.png","ticket.png"];let M={user:"juainny",mode:"gradient",color1:"#3b82f6",color2:"#8b5cf6",icon:"cat.png",imageUrl:null},Le={};async function Pn(e){const t=document.getElementById("avatar-modal");if(!t)return;await Je();const n=Le[e];n?M={...n,user:e,mode:n.type||"gradient"}:M={user:e,mode:"gradient",color1:e==="juainny"?"#8b5cf6":"#3b82f6",color2:e==="juainny"?"#d946ef":"#06b6d4",icon:"cat.png",imageUrl:null},Ha(),Ua(),ze();const r=document.getElementById("avatar-file-input");r&&(r.value=""),document.getElementById("avatar-file-name").textContent="",document.getElementById("avatar-file-name").classList.add("hidden"),t.classList.remove("hidden"),t.classList.remove("modal-hidden"),t.classList.add("flex")}function Vt(){const e=document.getElementById("avatar-modal");e&&(e.classList.add("hidden"),e.classList.add("modal-hidden"),e.classList.remove("flex"))}function ze(){document.querySelectorAll(".avatar-user-btn").forEach(n=>{n.dataset.user===M.user?n.classList.add("border-accent-primary","bg-bg-tertiary"):n.classList.remove("border-accent-primary","bg-bg-tertiary")}),document.querySelectorAll(".avatar-mode-btn").forEach(n=>{n.dataset.mode===M.mode?(n.classList.add("bg-bg-secondary","text-text-primary","shadow-sm"),n.classList.remove("text-text-muted","hover:text-text-primary")):(n.classList.remove("bg-bg-secondary","text-text-primary","shadow-sm"),n.classList.add("text-text-muted","hover:text-text-primary"))});const e=document.getElementById("avatar-gradient-controls"),t=document.getElementById("avatar-image-controls");M.mode==="gradient"?(e.classList.remove("hidden"),t.classList.add("hidden")):(e.classList.add("hidden"),t.classList.remove("hidden")),document.querySelectorAll(".color-option").forEach(n=>{const r=n.dataset.type,a=n.dataset.color;M[r]===a?n.classList.add("ring-2","ring-white"):n.classList.remove("ring-2","ring-white")}),document.querySelectorAll(".icon-option").forEach(n=>{n.dataset.icon===M.icon?n.classList.add("border-accent-primary","bg-bg-tertiary"):n.classList.remove("border-accent-primary","bg-bg-tertiary")}),zt()}function Ha(){const e=(t,n)=>{const r=document.getElementById(t);r&&(r.innerHTML="",Fa.forEach(a=>{const o=document.createElement("button");o.className="color-option w-8 h-8 rounded-full cursor-pointer transition transform hover:scale-110",o.style.backgroundColor=a,o.dataset.color=a,o.dataset.type=n,o.addEventListener("click",()=>{M[n]=a,ze()}),r.appendChild(o)}))};e("color-picker-1","color1"),e("color-picker-2","color2")}function Ua(){const e=document.getElementById("icon-picker");e&&(e.innerHTML="",ja.forEach(t=>{const n=document.createElement("button");n.className="icon-option p-2 rounded-lg border-2 border-transparent hover:bg-bg-tertiary transition flex items-center justify-center",n.dataset.icon=t,n.innerHTML=`<img src="avatars/${t}" class="w-8 h-8 object-contain">`,n.addEventListener("click",()=>{M.icon=t,ze()}),e.appendChild(n)}))}function zt(){const e=document.getElementById("avatar-preview-display");if(!e)return;const{color1:t,color2:n,icon:r,user:a,mode:o,imageUrl:s}=M;o==="image"&&s?(e.style.background="none",e.innerHTML=`<img src="${s}" class="w-full h-full object-cover">`):(e.style.background=`linear-gradient(135deg, ${t}, ${n})`,r?e.innerHTML=`<img src="avatars/${r}" class="w-16 h-16 object-contain drop-shadow-md">`:e.innerHTML=`<span class="text-4xl font-bold text-white drop-shadow-md">${a[0].toUpperCase()}</span>`)}async function qa(e){const t=`${Date.now()}-${e.name}`,{data:n,error:r}=await y.storage.from("images").upload(`avatars/${t}`,e);if(r)return console.error("Error uploading image:",r),alert("Failed to upload image. Please try again."),null;const{data:a}=y.storage.from("images").getPublicUrl(`avatars/${t}`);return a.publicUrl}async function Wa(){const{user:e,mode:t,color1:n,color2:r,icon:a,imageUrl:o}=M,s={type:t,color1:n,color2:r,icon:a,imageUrl:o};Le[e]=s;const i={};i[`${e}_avatar`]=s;const{error:l}=await y.from("settings").update(i).eq("id",1);if(l)console.error("Error saving avatar:",l),alert("Failed to save avatar. Please try again.");else{await Je();const{refreshAllReactionAvatars:c}=await Da(async()=>{const{refreshAllReactionAvatars:u}=await Promise.resolve().then(()=>Zl);return{refreshAllReactionAvatars:u}},void 0);c(),Vt()}}function V(e,t="w-8 h-8"){const n=Le[e];if(!n)return`<div class="${t} rounded-full ${e==="juainny"?"bg-purple-500":"bg-blue-500"} flex items-center justify-center text-white font-bold border border-white/20 overflow-hidden">${e[0].toUpperCase()}</div>`;const{type:r,color1:a,color2:o,icon:s,imageUrl:i}=n;return r==="image"&&i?`
            <div class="${t} rounded-full border border-white/20 relative overflow-hidden">
                <img src="${i}" class="w-full h-full object-cover">
            </div>
        `:`
        <div class="${t} rounded-full flex items-center justify-center border border-white/20 relative overflow-hidden" 
             style="background: linear-gradient(135deg, ${a}, ${o});">
            <img src="avatars/${s}" class="w-[60%] h-[60%] object-contain drop-shadow-sm">
        </div>
    `}const Va=()=>{};var Nn={};const Tr=function(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let a=e.charCodeAt(r);a<128?t[n++]=a:a<2048?(t[n++]=a>>6|192,t[n++]=a&63|128):(a&64512)===55296&&r+1<e.length&&(e.charCodeAt(r+1)&64512)===56320?(a=65536+((a&1023)<<10)+(e.charCodeAt(++r)&1023),t[n++]=a>>18|240,t[n++]=a>>12&63|128,t[n++]=a>>6&63|128,t[n++]=a&63|128):(t[n++]=a>>12|224,t[n++]=a>>6&63|128,t[n++]=a&63|128)}return t},za=function(e){const t=[];let n=0,r=0;for(;n<e.length;){const a=e[n++];if(a<128)t[r++]=String.fromCharCode(a);else if(a>191&&a<224){const o=e[n++];t[r++]=String.fromCharCode((a&31)<<6|o&63)}else if(a>239&&a<365){const o=e[n++],s=e[n++],i=e[n++],l=((a&7)<<18|(o&63)<<12|(s&63)<<6|i&63)-65536;t[r++]=String.fromCharCode(55296+(l>>10)),t[r++]=String.fromCharCode(56320+(l&1023))}else{const o=e[n++],s=e[n++];t[r++]=String.fromCharCode((a&15)<<12|(o&63)<<6|s&63)}}return t.join("")},dn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let a=0;a<e.length;a+=3){const o=e[a],s=a+1<e.length,i=s?e[a+1]:0,l=a+2<e.length,c=l?e[a+2]:0,u=o>>2,f=(o&3)<<4|i>>4;let h=(i&15)<<2|c>>6,m=c&63;l||(m=64,s||(h=64)),r.push(n[u],n[f],n[h],n[m])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(Tr(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):za(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let a=0;a<e.length;){const o=n[e.charAt(a++)],i=a<e.length?n[e.charAt(a)]:0;++a;const c=a<e.length?n[e.charAt(a)]:64;++a;const f=a<e.length?n[e.charAt(a)]:64;if(++a,o==null||i==null||c==null||f==null)throw new Ga;const h=o<<2|i>>4;if(r.push(h),c!==64){const m=i<<4&240|c>>2;if(r.push(m),f!==64){const d=c<<6&192|f;r.push(d)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class Ga extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Ka=function(e){const t=Tr(e);return dn.encodeByteArray(t,!0)},Lr=function(e){return Ka(e).replace(/\./g,"")},Ya=function(e){try{return dn.decodeString(e,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};function Sr(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const Ja=()=>Sr().__FIREBASE_DEFAULTS__,Xa=()=>{if(typeof process>"u"||typeof Nn>"u")return;const e=Nn.__FIREBASE_DEFAULTS__;if(e)return JSON.parse(e)},Qa=()=>{if(typeof document>"u")return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=e&&Ya(e[1]);return t&&JSON.parse(t)},Za=()=>{try{return Va()||Ja()||Xa()||Qa()}catch(e){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`);return}},Ar=()=>Za()?.config;class Ge{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,n)=>{this.resolve=t,this.reject=n})}wrapCallback(t){return(n,r)=>{n?this.reject(n):this.resolve(r),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(n):t(n,r))}}}function eo(){const e=typeof chrome=="object"?chrome.runtime:typeof browser=="object"?browser.runtime:void 0;return typeof e=="object"&&e.id!==void 0}function _t(){try{return typeof indexedDB=="object"}catch{return!1}}function Cr(){return new Promise((e,t)=>{try{let n=!0;const r="validate-browser-context-for-indexeddb-analytics-module",a=self.indexedDB.open(r);a.onsuccess=()=>{a.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},a.onupgradeneeded=()=>{n=!1},a.onerror=()=>{t(a.error?.message||"")}}catch(n){t(n)}})}function to(){return!(typeof navigator>"u"||!navigator.cookieEnabled)}const no="FirebaseError";class be extends Error{constructor(t,n,r){super(n),this.code=t,this.customData=r,this.name=no,Object.setPrototypeOf(this,be.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Xe.prototype.create)}}class Xe{constructor(t,n,r){this.service=t,this.serviceName=n,this.errors=r}create(t,...n){const r=n[0]||{},a=`${this.service}/${t}`,o=this.errors[t],s=o?ro(o,r):"Error",i=`${this.serviceName}: ${s} (${a}).`;return new be(a,i,r)}}function ro(e,t){return e.replace(ao,(n,r)=>{const a=t[r];return a!=null?String(a):`<${r}?>`})}const ao=/\{\$([^}]+)}/g;function mt(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const a of n){if(!r.includes(a))return!1;const o=e[a],s=t[a];if(Fn(o)&&Fn(s)){if(!mt(o,s))return!1}else if(o!==s)return!1}for(const a of r)if(!n.includes(a))return!1;return!0}function Fn(e){return e!==null&&typeof e=="object"}const oo=1e3,so=2,io=14400*1e3,co=.5;function Gt(e,t=oo,n=so){const r=t*Math.pow(n,e),a=Math.round(co*r*(Math.random()-.5)*2);return Math.min(io,r+a)}function Qe(e){return e&&e._delegate?e._delegate:e}class ee{constructor(t,n,r){this.name=t,this.instanceFactory=n,this.type=r,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}const we="[DEFAULT]";class lo{constructor(t,n){this.name=t,this.container=n,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const n=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(n)){const r=new Ge;if(this.instancesDeferred.set(n,r),this.isInitialized(n)||this.shouldAutoInitialize())try{const a=this.getOrInitializeService({instanceIdentifier:n});a&&r.resolve(a)}catch{}}return this.instancesDeferred.get(n).promise}getImmediate(t){const n=this.normalizeInstanceIdentifier(t?.identifier),r=t?.optional??!1;if(this.isInitialized(n)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:n})}catch(a){if(r)return null;throw a}else{if(r)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(fo(t))try{this.getOrInitializeService({instanceIdentifier:we})}catch{}for(const[n,r]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(n);try{const o=this.getOrInitializeService({instanceIdentifier:a});r.resolve(o)}catch{}}}}clearInstance(t=we){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(n=>"INTERNAL"in n).map(n=>n.INTERNAL.delete()),...t.filter(n=>"_delete"in n).map(n=>n._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=we){return this.instances.has(t)}getOptions(t=we){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:n={}}=t,r=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(r))throw Error(`${this.name}(${r}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const a=this.getOrInitializeService({instanceIdentifier:r,options:n});for(const[o,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(o);r===i&&s.resolve(a)}return a}onInit(t,n){const r=this.normalizeInstanceIdentifier(n),a=this.onInitCallbacks.get(r)??new Set;a.add(t),this.onInitCallbacks.set(r,a);const o=this.instances.get(r);return o&&t(o,r),()=>{a.delete(t)}}invokeOnInitCallbacks(t,n){const r=this.onInitCallbacks.get(n);if(r)for(const a of r)try{a(t,n)}catch{}}getOrInitializeService({instanceIdentifier:t,options:n={}}){let r=this.instances.get(t);if(!r&&this.component&&(r=this.component.instanceFactory(this.container,{instanceIdentifier:uo(t),options:n}),this.instances.set(t,r),this.instancesOptions.set(t,n),this.invokeOnInitCallbacks(r,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,r)}catch{}return r||null}normalizeInstanceIdentifier(t=we){return this.component?this.component.multipleInstances?t:we:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function uo(e){return e===we?void 0:e}function fo(e){return e.instantiationMode==="EAGER"}class mo{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const n=this.getProvider(t.name);if(n.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);n.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const n=new lo(t,this);return this.providers.set(t,n),n}getProviders(){return Array.from(this.providers.values())}}var x;(function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"})(x||(x={}));const ho={debug:x.DEBUG,verbose:x.VERBOSE,info:x.INFO,warn:x.WARN,error:x.ERROR,silent:x.SILENT},po=x.INFO,go={[x.DEBUG]:"log",[x.VERBOSE]:"log",[x.INFO]:"info",[x.WARN]:"warn",[x.ERROR]:"error"},yo=(e,t,...n)=>{if(t<e.logLevel)return;const r=new Date().toISOString(),a=go[t];if(a)console[a](`[${r}]  ${e.name}:`,...n);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class Et{constructor(t){this.name=t,this._logLevel=po,this._logHandler=yo,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in x))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?ho[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,x.DEBUG,...t),this._logHandler(this,x.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,x.VERBOSE,...t),this._logHandler(this,x.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,x.INFO,...t),this._logHandler(this,x.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,x.WARN,...t),this._logHandler(this,x.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,x.ERROR,...t),this._logHandler(this,x.ERROR,...t)}}const bo=(e,t)=>t.some(n=>e instanceof n);let jn,Hn;function wo(){return jn||(jn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function vo(){return Hn||(Hn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const xr=new WeakMap,Kt=new WeakMap,Rr=new WeakMap,Dt=new WeakMap,un=new WeakMap;function _o(e){const t=new Promise((n,r)=>{const a=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{n(pe(e.result)),a()},s=()=>{r(e.error),a()};e.addEventListener("success",o),e.addEventListener("error",s)});return t.then(n=>{n instanceof IDBCursor&&xr.set(n,e)}).catch(()=>{}),un.set(t,e),t}function Eo(e){if(Kt.has(e))return;const t=new Promise((n,r)=>{const a=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{n(),a()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)});Kt.set(e,t)}let Yt={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return Kt.get(e);if(t==="objectStoreNames")return e.objectStoreNames||Rr.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return pe(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Io(e){Yt=e(Yt)}function ko(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const r=e.call(Mt(this),t,...n);return Rr.set(r,t.sort?t.sort():[t]),pe(r)}:vo().includes(e)?function(...t){return e.apply(Mt(this),t),pe(xr.get(this))}:function(...t){return pe(e.apply(Mt(this),t))}}function To(e){return typeof e=="function"?ko(e):(e instanceof IDBTransaction&&Eo(e),bo(e,wo())?new Proxy(e,Yt):e)}function pe(e){if(e instanceof IDBRequest)return _o(e);if(Dt.has(e))return Dt.get(e);const t=To(e);return t!==e&&(Dt.set(e,t),un.set(t,e)),t}const Mt=e=>un.get(e);function Br(e,t,{blocked:n,upgrade:r,blocking:a,terminated:o}={}){const s=indexedDB.open(e,t),i=pe(s);return r&&s.addEventListener("upgradeneeded",l=>{r(pe(s.result),l.oldVersion,l.newVersion,pe(s.transaction),l)}),n&&s.addEventListener("blocked",l=>n(l.oldVersion,l.newVersion,l)),i.then(l=>{o&&l.addEventListener("close",()=>o()),a&&l.addEventListener("versionchange",c=>a(c.oldVersion,c.newVersion,c))}).catch(()=>{}),i}const Lo=["get","getKey","getAll","getAllKeys","count"],So=["put","add","delete","clear"],$t=new Map;function Un(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if($t.get(t))return $t.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,a=So.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(a||Lo.includes(n)))return;const o=async function(s,...i){const l=this.transaction(s,a?"readwrite":"readonly");let c=l.store;return r&&(c=c.index(i.shift())),(await Promise.all([c[n](...i),a&&l.done]))[0]};return $t.set(t,o),o}Io(e=>({...e,get:(t,n,r)=>Un(t,n)||e.get(t,n,r),has:(t,n)=>!!Un(t,n)||e.has(t,n)}));class Ao{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(n=>{if(Co(n)){const r=n.getImmediate();return`${r.library}/${r.version}`}else return null}).filter(n=>n).join(" ")}}function Co(e){return e.getComponent()?.type==="VERSION"}const Jt="@firebase/app",qn="0.14.6";const ce=new Et("@firebase/app"),xo="@firebase/app-compat",Ro="@firebase/analytics-compat",Bo="@firebase/analytics",Do="@firebase/app-check-compat",Mo="@firebase/app-check",$o="@firebase/auth",Oo="@firebase/auth-compat",Po="@firebase/database",No="@firebase/data-connect",Fo="@firebase/database-compat",jo="@firebase/functions",Ho="@firebase/functions-compat",Uo="@firebase/installations",qo="@firebase/installations-compat",Wo="@firebase/messaging",Vo="@firebase/messaging-compat",zo="@firebase/performance",Go="@firebase/performance-compat",Ko="@firebase/remote-config",Yo="@firebase/remote-config-compat",Jo="@firebase/storage",Xo="@firebase/storage-compat",Qo="@firebase/firestore",Zo="@firebase/ai",es="@firebase/firestore-compat",ts="firebase";const Xt="[DEFAULT]",ns={[Jt]:"fire-core",[xo]:"fire-core-compat",[Bo]:"fire-analytics",[Ro]:"fire-analytics-compat",[Mo]:"fire-app-check",[Do]:"fire-app-check-compat",[$o]:"fire-auth",[Oo]:"fire-auth-compat",[Po]:"fire-rtdb",[No]:"fire-data-connect",[Fo]:"fire-rtdb-compat",[jo]:"fire-fn",[Ho]:"fire-fn-compat",[Uo]:"fire-iid",[qo]:"fire-iid-compat",[Wo]:"fire-fcm",[Vo]:"fire-fcm-compat",[zo]:"fire-perf",[Go]:"fire-perf-compat",[Ko]:"fire-rc",[Yo]:"fire-rc-compat",[Jo]:"fire-gcs",[Xo]:"fire-gcs-compat",[Qo]:"fire-fst",[es]:"fire-fst-compat",[Zo]:"fire-vertex","fire-js":"fire-js",[ts]:"fire-js-all"};const ht=new Map,rs=new Map,Qt=new Map;function Wn(e,t){try{e.container.addComponent(t)}catch(n){ce.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function se(e){const t=e.name;if(Qt.has(t))return ce.debug(`There were multiple attempts to register component ${t}.`),!1;Qt.set(t,e);for(const n of ht.values())Wn(n,e);for(const n of rs.values())Wn(n,e);return!0}function Ce(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function as(e){return e==null?!1:e.settings!==void 0}const os={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},ge=new Xe("app","Firebase",os);class ss{constructor(t,n,r){this._isDeleted=!1,this._options={...t},this._config={...n},this._name=n.name,this._automaticDataCollectionEnabled=n.automaticDataCollectionEnabled,this._container=r,this.container.addComponent(new ee("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw ge.create("app-deleted",{appName:this._name})}}function Dr(e,t={}){let n=e;typeof t!="object"&&(t={name:t});const r={name:Xt,automaticDataCollectionEnabled:!0,...t},a=r.name;if(typeof a!="string"||!a)throw ge.create("bad-app-name",{appName:String(a)});if(n||(n=Ar()),!n)throw ge.create("no-options");const o=ht.get(a);if(o){if(mt(n,o.options)&&mt(r,o.config))return o;throw ge.create("duplicate-app",{appName:a})}const s=new mo(a);for(const l of Qt.values())s.addComponent(l);const i=new ss(n,r,s);return ht.set(a,i),i}function fn(e=Xt){const t=ht.get(e);if(!t&&e===Xt&&Ar())return Dr();if(!t)throw ge.create("no-app",{appName:e});return t}function Z(e,t,n){let r=ns[e]??e;n&&(r+=`-${n}`);const a=r.match(/\s|\//),o=t.match(/\s|\//);if(a||o){const s=[`Unable to register library "${r}" with version "${t}":`];a&&s.push(`library name "${r}" contains illegal characters (whitespace or "/")`),a&&o&&s.push("and"),o&&s.push(`version name "${t}" contains illegal characters (whitespace or "/")`),ce.warn(s.join(" "));return}se(new ee(`${r}-version`,()=>({library:r,version:t}),"VERSION"))}const is="firebase-heartbeat-database",cs=1,Ke="firebase-heartbeat-store";let Ot=null;function Mr(){return Ot||(Ot=Br(is,cs,{upgrade:(e,t)=>{switch(t){case 0:try{e.createObjectStore(Ke)}catch(n){console.warn(n)}}}}).catch(e=>{throw ge.create("idb-open",{originalErrorMessage:e.message})})),Ot}async function ls(e){try{const n=(await Mr()).transaction(Ke),r=await n.objectStore(Ke).get($r(e));return await n.done,r}catch(t){if(t instanceof be)ce.warn(t.message);else{const n=ge.create("idb-get",{originalErrorMessage:t?.message});ce.warn(n.message)}}}async function Vn(e,t){try{const r=(await Mr()).transaction(Ke,"readwrite");await r.objectStore(Ke).put(t,$r(e)),await r.done}catch(n){if(n instanceof be)ce.warn(n.message);else{const r=ge.create("idb-set",{originalErrorMessage:n?.message});ce.warn(r.message)}}}function $r(e){return`${e.name}!${e.options.appId}`}const ds=1024,us=30;class fs{constructor(t){this.container=t,this._heartbeatsCache=null;const n=this.container.getProvider("app").getImmediate();this._storage=new hs(n),this._heartbeatsCachePromise=this._storage.read().then(r=>(this._heartbeatsCache=r,r))}async triggerHeartbeat(){try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=zn();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(a=>a.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>us){const a=ps(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(a,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(t){ce.warn(t)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const t=zn(),{heartbeatsToSend:n,unsentEntries:r}=ms(this._heartbeatsCache.heartbeats),a=Lr(JSON.stringify({version:2,heartbeats:n}));return this._heartbeatsCache.lastSentHeartbeatDate=t,r.length>0?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),a}catch(t){return ce.warn(t),""}}}function zn(){return new Date().toISOString().substring(0,10)}function ms(e,t=ds){const n=[];let r=e.slice();for(const a of e){const o=n.find(s=>s.agent===a.agent);if(o){if(o.dates.push(a.date),Gn(n)>t){o.dates.pop();break}}else if(n.push({agent:a.agent,dates:[a.date]}),Gn(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}class hs{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return _t()?Cr().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const n=await ls(this.app);return n?.heartbeats?n:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){if(await this._canUseIndexedDBPromise){const r=await this.read();return Vn(this.app,{lastSentHeartbeatDate:t.lastSentHeartbeatDate??r.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){if(await this._canUseIndexedDBPromise){const r=await this.read();return Vn(this.app,{lastSentHeartbeatDate:t.lastSentHeartbeatDate??r.lastSentHeartbeatDate,heartbeats:[...r.heartbeats,...t.heartbeats]})}else return}}function Gn(e){return Lr(JSON.stringify({version:2,heartbeats:e})).length}function ps(e){if(e.length===0)return-1;let t=0,n=e[0].date;for(let r=1;r<e.length;r++)e[r].date<n&&(n=e[r].date,t=r);return t}function gs(e){se(new ee("platform-logger",t=>new Ao(t),"PRIVATE")),se(new ee("heartbeat",t=>new fs(t),"PRIVATE")),Z(Jt,qn,e),Z(Jt,qn,"esm2020"),Z("fire-js","")}gs("");var ys="firebase",bs="12.6.0";Z(ys,bs,"app");const Or="@firebase/installations",mn="0.6.19";const Pr=1e4,Nr=`w:${mn}`,Fr="FIS_v2",ws="https://firebaseinstallations.googleapis.com/v1",vs=3600*1e3,_s="installations",Es="Installations";const Is={"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."},Se=new Xe(_s,Es,Is);function jr(e){return e instanceof be&&e.code.includes("request-failed")}function Hr({projectId:e}){return`${ws}/projects/${e}/installations`}function Ur(e){return{token:e.token,requestStatus:2,expiresIn:Ts(e.expiresIn),creationTime:Date.now()}}async function qr(e,t){const r=(await t.json()).error;return Se.create("request-failed",{requestName:e,serverCode:r.code,serverMessage:r.message,serverStatus:r.status})}function Wr({apiKey:e}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e})}function ks(e,{refreshToken:t}){const n=Wr(e);return n.append("Authorization",Ls(t)),n}async function Vr(e){const t=await e();return t.status>=500&&t.status<600?e():t}function Ts(e){return Number(e.replace("s","000"))}function Ls(e){return`${Fr} ${e}`}async function Ss({appConfig:e,heartbeatServiceProvider:t},{fid:n}){const r=Hr(e),a=Wr(e),o=t.getImmediate({optional:!0});if(o){const c=await o.getHeartbeatsHeader();c&&a.append("x-firebase-client",c)}const s={fid:n,authVersion:Fr,appId:e.appId,sdkVersion:Nr},i={method:"POST",headers:a,body:JSON.stringify(s)},l=await Vr(()=>fetch(r,i));if(l.ok){const c=await l.json();return{fid:c.fid||n,registrationStatus:2,refreshToken:c.refreshToken,authToken:Ur(c.authToken)}}else throw await qr("Create Installation",l)}function zr(e){return new Promise(t=>{setTimeout(t,e)})}function As(e){return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_")}const Cs=/^[cdef][\w-]{21}$/,Zt="";function xs(){try{const e=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(e),e[0]=112+e[0]%16;const n=Rs(e);return Cs.test(n)?n:Zt}catch{return Zt}}function Rs(e){return As(e).substr(0,22)}function It(e){return`${e.appName}!${e.appId}`}const Gr=new Map;function Kr(e,t){const n=It(e);Yr(n,t),Bs(n,t)}function Yr(e,t){const n=Gr.get(e);if(n)for(const r of n)r(t)}function Bs(e,t){const n=Ds();n&&n.postMessage({key:e,fid:t}),Ms()}let Ie=null;function Ds(){return!Ie&&"BroadcastChannel"in self&&(Ie=new BroadcastChannel("[Firebase] FID Change"),Ie.onmessage=e=>{Yr(e.data.key,e.data.fid)}),Ie}function Ms(){Gr.size===0&&Ie&&(Ie.close(),Ie=null)}const $s="firebase-installations-database",Os=1,Ae="firebase-installations-store";let Pt=null;function hn(){return Pt||(Pt=Br($s,Os,{upgrade:(e,t)=>{switch(t){case 0:e.createObjectStore(Ae)}}})),Pt}async function pt(e,t){const n=It(e),a=(await hn()).transaction(Ae,"readwrite"),o=a.objectStore(Ae),s=await o.get(n);return await o.put(t,n),await a.done,(!s||s.fid!==t.fid)&&Kr(e,t.fid),t}async function Jr(e){const t=It(e),r=(await hn()).transaction(Ae,"readwrite");await r.objectStore(Ae).delete(t),await r.done}async function kt(e,t){const n=It(e),a=(await hn()).transaction(Ae,"readwrite"),o=a.objectStore(Ae),s=await o.get(n),i=t(s);return i===void 0?await o.delete(n):await o.put(i,n),await a.done,i&&(!s||s.fid!==i.fid)&&Kr(e,i.fid),i}async function pn(e){let t;const n=await kt(e.appConfig,r=>{const a=Ps(r),o=Ns(e,a);return t=o.registrationPromise,o.installationEntry});return n.fid===Zt?{installationEntry:await t}:{installationEntry:n,registrationPromise:t}}function Ps(e){const t=e||{fid:xs(),registrationStatus:0};return Xr(t)}function Ns(e,t){if(t.registrationStatus===0){if(!navigator.onLine){const a=Promise.reject(Se.create("app-offline"));return{installationEntry:t,registrationPromise:a}}const n={fid:t.fid,registrationStatus:1,registrationTime:Date.now()},r=Fs(e,n);return{installationEntry:n,registrationPromise:r}}else return t.registrationStatus===1?{installationEntry:t,registrationPromise:js(e)}:{installationEntry:t}}async function Fs(e,t){try{const n=await Ss(e,t);return pt(e.appConfig,n)}catch(n){throw jr(n)&&n.customData.serverCode===409?await Jr(e.appConfig):await pt(e.appConfig,{fid:t.fid,registrationStatus:0}),n}}async function js(e){let t=await Kn(e.appConfig);for(;t.registrationStatus===1;)await zr(100),t=await Kn(e.appConfig);if(t.registrationStatus===0){const{installationEntry:n,registrationPromise:r}=await pn(e);return r||n}return t}function Kn(e){return kt(e,t=>{if(!t)throw Se.create("installation-not-found");return Xr(t)})}function Xr(e){return Hs(e)?{fid:e.fid,registrationStatus:0}:e}function Hs(e){return e.registrationStatus===1&&e.registrationTime+Pr<Date.now()}async function Us({appConfig:e,heartbeatServiceProvider:t},n){const r=qs(e,n),a=ks(e,n),o=t.getImmediate({optional:!0});if(o){const c=await o.getHeartbeatsHeader();c&&a.append("x-firebase-client",c)}const s={installation:{sdkVersion:Nr,appId:e.appId}},i={method:"POST",headers:a,body:JSON.stringify(s)},l=await Vr(()=>fetch(r,i));if(l.ok){const c=await l.json();return Ur(c)}else throw await qr("Generate Auth Token",l)}function qs(e,{fid:t}){return`${Hr(e)}/${t}/authTokens:generate`}async function gn(e,t=!1){let n;const r=await kt(e.appConfig,o=>{if(!Qr(o))throw Se.create("not-registered");const s=o.authToken;if(!t&&zs(s))return o;if(s.requestStatus===1)return n=Ws(e,t),o;{if(!navigator.onLine)throw Se.create("app-offline");const i=Ks(o);return n=Vs(e,i),i}});return n?await n:r.authToken}async function Ws(e,t){let n=await Yn(e.appConfig);for(;n.authToken.requestStatus===1;)await zr(100),n=await Yn(e.appConfig);const r=n.authToken;return r.requestStatus===0?gn(e,t):r}function Yn(e){return kt(e,t=>{if(!Qr(t))throw Se.create("not-registered");const n=t.authToken;return Ys(n)?{...t,authToken:{requestStatus:0}}:t})}async function Vs(e,t){try{const n=await Us(e,t),r={...t,authToken:n};return await pt(e.appConfig,r),n}catch(n){if(jr(n)&&(n.customData.serverCode===401||n.customData.serverCode===404))await Jr(e.appConfig);else{const r={...t,authToken:{requestStatus:0}};await pt(e.appConfig,r)}throw n}}function Qr(e){return e!==void 0&&e.registrationStatus===2}function zs(e){return e.requestStatus===2&&!Gs(e)}function Gs(e){const t=Date.now();return t<e.creationTime||e.creationTime+e.expiresIn<t+vs}function Ks(e){const t={requestStatus:1,requestTime:Date.now()};return{...e,authToken:t}}function Ys(e){return e.requestStatus===1&&e.requestTime+Pr<Date.now()}async function Js(e){const t=e,{installationEntry:n,registrationPromise:r}=await pn(t);return r?r.catch(console.error):gn(t).catch(console.error),n.fid}async function Xs(e,t=!1){const n=e;return await Qs(n),(await gn(n,t)).token}async function Qs(e){const{registrationPromise:t}=await pn(e);t&&await t}function Zs(e){if(!e||!e.options)throw Nt("App Configuration");if(!e.name)throw Nt("App Name");const t=["projectId","apiKey","appId"];for(const n of t)if(!e.options[n])throw Nt(n);return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}function Nt(e){return Se.create("missing-app-config-values",{valueName:e})}const Zr="installations",ei="installations-internal",ti=e=>{const t=e.getProvider("app").getImmediate(),n=Zs(t),r=Ce(t,"heartbeat");return{app:t,appConfig:n,heartbeatServiceProvider:r,_delete:()=>Promise.resolve()}},ni=e=>{const t=e.getProvider("app").getImmediate(),n=Ce(t,Zr).getImmediate();return{getId:()=>Js(n),getToken:a=>Xs(n,a)}};function ri(){se(new ee(Zr,ti,"PUBLIC")),se(new ee(ei,ni,"PRIVATE"))}ri();Z(Or,mn);Z(Or,mn,"esm2020");const gt="analytics",ai="firebase_id",oi="origin",si=60*1e3,ii="https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig",yn="https://www.googletagmanager.com/gtag/js";const j=new Et("@firebase/analytics");const ci={"already-exists":"A Firebase Analytics instance with the appId {$id}  already exists. Only one Firebase Analytics instance can be created for each appId.","already-initialized":"initializeAnalytics() cannot be called again with different options than those it was initially called with. It can be called again with the same options to return the existing instance, or getAnalytics() can be used to get a reference to the already-initialized instance.","already-initialized-settings":"Firebase Analytics has already been initialized.settings() must be called before initializing any Analytics instanceor it will have no effect.","interop-component-reg-failed":"Firebase Analytics Interop Component failed to instantiate: {$reason}","invalid-analytics-context":"Firebase Analytics is not supported in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","indexeddb-unavailable":"IndexedDB unavailable or restricted in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","fetch-throttle":"The config fetch request timed out while in an exponential backoff state. Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.","config-fetch-failed":"Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}","no-api-key":'The "apiKey" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid API key.',"no-app-id":'The "appId" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid app ID.',"no-client-id":'The "client_id" field is empty.',"invalid-gtag-resource":"Trusted Types detected an invalid gtag resource: {$gtagURL}."},z=new Xe("analytics","Analytics",ci);function li(e){if(!e.startsWith(yn)){const t=z.create("invalid-gtag-resource",{gtagURL:e});return j.warn(t.message),""}return e}function ea(e){return Promise.all(e.map(t=>t.catch(n=>n)))}function di(e,t){let n;return window.trustedTypes&&(n=window.trustedTypes.createPolicy(e,t)),n}function ui(e,t){const n=di("firebase-js-sdk-policy",{createScriptURL:li}),r=document.createElement("script"),a=`${yn}?l=${e}&id=${t}`;r.src=n?n?.createScriptURL(a):a,r.async=!0,document.head.appendChild(r)}function fi(e){let t=[];return Array.isArray(window[e])?t=window[e]:window[e]=t,t}async function mi(e,t,n,r,a,o){const s=r[a];try{if(s)await t[s];else{const l=(await ea(n)).find(c=>c.measurementId===a);l&&await t[l.appId]}}catch(i){j.error(i)}e("config",a,o)}async function hi(e,t,n,r,a){try{let o=[];if(a&&a.send_to){let s=a.send_to;Array.isArray(s)||(s=[s]);const i=await ea(n);for(const l of s){const c=i.find(f=>f.measurementId===l),u=c&&t[c.appId];if(u)o.push(u);else{o=[];break}}}o.length===0&&(o=Object.values(t)),await Promise.all(o),e("event",r,a||{})}catch(o){j.error(o)}}function pi(e,t,n,r){async function a(o,...s){try{if(o==="event"){const[i,l]=s;await hi(e,t,n,i,l)}else if(o==="config"){const[i,l]=s;await mi(e,t,n,r,i,l)}else if(o==="consent"){const[i,l]=s;e("consent",i,l)}else if(o==="get"){const[i,l,c]=s;e("get",i,l,c)}else if(o==="set"){const[i]=s;e("set",i)}else e(o,...s)}catch(i){j.error(i)}}return a}function gi(e,t,n,r,a){let o=function(...s){window[r].push(arguments)};return window[a]&&typeof window[a]=="function"&&(o=window[a]),window[a]=pi(o,e,t,n),{gtagCore:o,wrappedGtag:window[a]}}function yi(e){const t=window.document.getElementsByTagName("script");for(const n of Object.values(t))if(n.src&&n.src.includes(yn)&&n.src.includes(e))return n;return null}const bi=30,wi=1e3;class vi{constructor(t={},n=wi){this.throttleMetadata=t,this.intervalMillis=n}getThrottleMetadata(t){return this.throttleMetadata[t]}setThrottleMetadata(t,n){this.throttleMetadata[t]=n}deleteThrottleMetadata(t){delete this.throttleMetadata[t]}}const ta=new vi;function _i(e){return new Headers({Accept:"application/json","x-goog-api-key":e})}async function Ei(e){const{appId:t,apiKey:n}=e,r={method:"GET",headers:_i(n)},a=ii.replace("{app-id}",t),o=await fetch(a,r);if(o.status!==200&&o.status!==304){let s="";try{const i=await o.json();i.error?.message&&(s=i.error.message)}catch{}throw z.create("config-fetch-failed",{httpStatus:o.status,responseMessage:s})}return o.json()}async function Ii(e,t=ta,n){const{appId:r,apiKey:a,measurementId:o}=e.options;if(!r)throw z.create("no-app-id");if(!a){if(o)return{measurementId:o,appId:r};throw z.create("no-api-key")}const s=t.getThrottleMetadata(r)||{backoffCount:0,throttleEndTimeMillis:Date.now()},i=new Li;return setTimeout(async()=>{i.abort()},si),na({appId:r,apiKey:a,measurementId:o},s,i,t)}async function na(e,{throttleEndTimeMillis:t,backoffCount:n},r,a=ta){const{appId:o,measurementId:s}=e;try{await ki(r,t)}catch(i){if(s)return j.warn(`Timed out fetching this Firebase app's measurement ID from the server. Falling back to the measurement ID ${s} provided in the "measurementId" field in the local Firebase config. [${i?.message}]`),{appId:o,measurementId:s};throw i}try{const i=await Ei(e);return a.deleteThrottleMetadata(o),i}catch(i){const l=i;if(!Ti(l)){if(a.deleteThrottleMetadata(o),s)return j.warn(`Failed to fetch this Firebase app's measurement ID from the server. Falling back to the measurement ID ${s} provided in the "measurementId" field in the local Firebase config. [${l?.message}]`),{appId:o,measurementId:s};throw i}const c=Number(l?.customData?.httpStatus)===503?Gt(n,a.intervalMillis,bi):Gt(n,a.intervalMillis),u={throttleEndTimeMillis:Date.now()+c,backoffCount:n+1};return a.setThrottleMetadata(o,u),j.debug(`Calling attemptFetch again in ${c} millis`),na(e,u,r,a)}}function ki(e,t){return new Promise((n,r)=>{const a=Math.max(t-Date.now(),0),o=setTimeout(n,a);e.addEventListener(()=>{clearTimeout(o),r(z.create("fetch-throttle",{throttleEndTimeMillis:t}))})})}function Ti(e){if(!(e instanceof be)||!e.customData)return!1;const t=Number(e.customData.httpStatus);return t===429||t===500||t===503||t===504}class Li{constructor(){this.listeners=[]}addEventListener(t){this.listeners.push(t)}abort(){this.listeners.forEach(t=>t())}}async function Si(e,t,n,r,a){if(a&&a.global){e("event",n,r);return}else{const o=await t,s={...r,send_to:o};e("event",n,s)}}async function Ai(e,t,n,r){if(r&&r.global){const a={};for(const o of Object.keys(n))a[`user_properties.${o}`]=n[o];return e("set",a),Promise.resolve()}else{const a=await t;e("config",a,{update:!0,user_properties:n})}}async function Ci(){if(_t())try{await Cr()}catch(e){return j.warn(z.create("indexeddb-unavailable",{errorInfo:e?.toString()}).message),!1}else return j.warn(z.create("indexeddb-unavailable",{errorInfo:"IndexedDB is not available in this environment."}).message),!1;return!0}async function xi(e,t,n,r,a,o,s){const i=Ii(e);i.then(h=>{n[h.measurementId]=h.appId,e.options.measurementId&&h.measurementId!==e.options.measurementId&&j.warn(`The measurement ID in the local Firebase config (${e.options.measurementId}) does not match the measurement ID fetched from the server (${h.measurementId}). To ensure analytics events are always sent to the correct Analytics property, update the measurement ID field in the local config or remove it from the local config.`)}).catch(h=>j.error(h)),t.push(i);const l=Ci().then(h=>{if(h)return r.getId()}),[c,u]=await Promise.all([i,l]);yi(o)||ui(o,c.measurementId),a("js",new Date);const f=s?.config??{};return f[oi]="firebase",f.update=!0,u!=null&&(f[ai]=u),a("config",c.measurementId,f),c.measurementId}class Ri{constructor(t){this.app=t}_delete(){return delete $e[this.app.options.appId],Promise.resolve()}}let $e={},Jn=[];const Xn={};let Ft="dataLayer",Bi="gtag",Qn,bn,Zn=!1;function Di(){const e=[];if(eo()&&e.push("This is a browser extension environment."),to()||e.push("Cookies are not available."),e.length>0){const t=e.map((r,a)=>`(${a+1}) ${r}`).join(" "),n=z.create("invalid-analytics-context",{errorInfo:t});j.warn(n.message)}}function Mi(e,t,n){Di();const r=e.options.appId;if(!r)throw z.create("no-app-id");if(!e.options.apiKey)if(e.options.measurementId)j.warn(`The "apiKey" field is empty in the local Firebase config. This is needed to fetch the latest measurement ID for this Firebase app. Falling back to the measurement ID ${e.options.measurementId} provided in the "measurementId" field in the local Firebase config.`);else throw z.create("no-api-key");if($e[r]!=null)throw z.create("already-exists",{id:r});if(!Zn){fi(Ft);const{wrappedGtag:o,gtagCore:s}=gi($e,Jn,Xn,Ft,Bi);bn=o,Qn=s,Zn=!0}return $e[r]=xi(e,Jn,Xn,t,Qn,Ft,n),new Ri(e)}function $i(e=fn()){e=Qe(e);const t=Ce(e,gt);return t.isInitialized()?t.getImmediate():Oi(e)}function Oi(e,t={}){const n=Ce(e,gt);if(n.isInitialized()){const a=n.getImmediate();if(mt(t,n.getOptions()))return a;throw z.create("already-initialized")}return n.initialize({options:t})}function Pi(e,t,n){e=Qe(e),Ai(bn,$e[e.app.options.appId],t,n).catch(r=>j.error(r))}function Ni(e,t,n,r){e=Qe(e),Si(bn,$e[e.app.options.appId],t,n,r).catch(a=>j.error(a))}const er="@firebase/analytics",tr="0.10.19";function Fi(){se(new ee(gt,(t,{options:n})=>{const r=t.getProvider("app").getImmediate(),a=t.getProvider("installations-internal").getImmediate();return Mi(r,a,n)},"PUBLIC")),se(new ee("analytics-internal",e,"PRIVATE")),Z(er,tr),Z(er,tr,"esm2020");function e(t){try{const n=t.getProvider(gt).getImmediate();return{logEvent:(r,a,o)=>Ni(n,r,a,o),setUserProperties:(r,a)=>Pi(n,r,a)}}catch(n){throw z.create("interop-component-reg-failed",{reason:n})}}}Fi();const en=new Map,ra={activated:!1,tokenObservers:[]},ji={initialized:!1,enabled:!1};function $(e){return en.get(e)||{...ra}}function Hi(e,t){return en.set(e,t),en.get(e)}function Tt(){return ji}const aa="https://content-firebaseappcheck.googleapis.com/v1",Ui="exchangeRecaptchaV3Token",qi="exchangeDebugToken",nr={RETRIAL_MIN_WAIT:30*1e3,RETRIAL_MAX_WAIT:960*1e3},Wi=1440*60*1e3;class Vi{constructor(t,n,r,a,o){if(this.operation=t,this.retryPolicy=n,this.getWaitDuration=r,this.lowerBound=a,this.upperBound=o,this.pending=null,this.nextErrorWaitInterval=a,a>o)throw new Error("Proactive refresh lower bound greater than upper bound!")}start(){this.nextErrorWaitInterval=this.lowerBound,this.process(!0).catch(()=>{})}stop(){this.pending&&(this.pending.reject("cancelled"),this.pending=null)}isRunning(){return!!this.pending}async process(t){this.stop();try{this.pending=new Ge,this.pending.promise.catch(n=>{}),await zi(this.getNextRun(t)),this.pending.resolve(),await this.pending.promise,this.pending=new Ge,this.pending.promise.catch(n=>{}),await this.operation(),this.pending.resolve(),await this.pending.promise,this.process(!0).catch(()=>{})}catch(n){this.retryPolicy(n)?this.process(!1).catch(()=>{}):this.stop()}}getNextRun(t){if(t)return this.nextErrorWaitInterval=this.lowerBound,this.getWaitDuration();{const n=this.nextErrorWaitInterval;return this.nextErrorWaitInterval*=2,this.nextErrorWaitInterval>this.upperBound&&(this.nextErrorWaitInterval=this.upperBound),n}}}function zi(e){return new Promise(t=>{setTimeout(t,e)})}const Gi={"already-initialized":"You have already called initializeAppCheck() for FirebaseApp {$appName} with different options. To avoid this error, call initializeAppCheck() with the same options as when it was originally called. This will return the already initialized instance.","use-before-activation":"App Check is being used before initializeAppCheck() is called for FirebaseApp {$appName}. Call initializeAppCheck() before instantiating other Firebase services.","fetch-network-error":"Fetch failed to connect to a network. Check Internet connection. Original error: {$originalErrorMessage}.","fetch-parse-error":"Fetch client could not parse response. Original error: {$originalErrorMessage}.","fetch-status-error":"Fetch server returned an HTTP error status. HTTP status: {$httpStatus}.","storage-open":"Error thrown when opening storage. Original error: {$originalErrorMessage}.","storage-get":"Error thrown when reading from storage. Original error: {$originalErrorMessage}.","storage-set":"Error thrown when writing to storage. Original error: {$originalErrorMessage}.","recaptcha-error":"ReCAPTCHA error.","initial-throttle":"{$httpStatus} error. Attempts allowed again after {$time}",throttled:"Requests throttled due to previous {$httpStatus} error. Attempts allowed again after {$time}"},q=new Xe("appCheck","AppCheck",Gi);function rr(e=!1){return e?self.grecaptcha?.enterprise:self.grecaptcha}function wn(e){if(!$(e).activated)throw q.create("use-before-activation",{appName:e.name})}function oa(e){const t=Math.round(e/1e3),n=Math.floor(t/(3600*24)),r=Math.floor((t-n*3600*24)/3600),a=Math.floor((t-n*3600*24-r*3600)/60),o=t-n*3600*24-r*3600-a*60;let s="";return n&&(s+=ot(n)+"d:"),r&&(s+=ot(r)+"h:"),s+=ot(a)+"m:"+ot(o)+"s",s}function ot(e){return e===0?"00":e>=10?e.toString():"0"+e}async function vn({url:e,body:t},n){const r={"Content-Type":"application/json"},a=n.getImmediate({optional:!0});if(a){const f=await a.getHeartbeatsHeader();f&&(r["X-Firebase-Client"]=f)}const o={method:"POST",body:JSON.stringify(t),headers:r};let s;try{s=await fetch(e,o)}catch(f){throw q.create("fetch-network-error",{originalErrorMessage:f?.message})}if(s.status!==200)throw q.create("fetch-status-error",{httpStatus:s.status});let i;try{i=await s.json()}catch(f){throw q.create("fetch-parse-error",{originalErrorMessage:f?.message})}const l=i.ttl.match(/^([\d.]+)(s)$/);if(!l||!l[2]||isNaN(Number(l[1])))throw q.create("fetch-parse-error",{originalErrorMessage:`ttl field (timeToLive) is not in standard Protobuf Duration format: ${i.ttl}`});const c=Number(l[1])*1e3,u=Date.now();return{token:i.token,expireTimeMillis:u+c,issuedAtTimeMillis:u}}function Ki(e,t){const{projectId:n,appId:r,apiKey:a}=e.options;return{url:`${aa}/projects/${n}/apps/${r}:${Ui}?key=${a}`,body:{recaptcha_v3_token:t}}}function sa(e,t){const{projectId:n,appId:r,apiKey:a}=e.options;return{url:`${aa}/projects/${n}/apps/${r}:${qi}?key=${a}`,body:{debug_token:t}}}const Yi="firebase-app-check-database",Ji=1,Ye="firebase-app-check-store",ia="debug-token";let st=null;function ca(){return st||(st=new Promise((e,t)=>{try{const n=indexedDB.open(Yi,Ji);n.onsuccess=r=>{e(r.target.result)},n.onerror=r=>{t(q.create("storage-open",{originalErrorMessage:r.target.error?.message}))},n.onupgradeneeded=r=>{const a=r.target.result;switch(r.oldVersion){case 0:a.createObjectStore(Ye,{keyPath:"compositeKey"})}}}catch(n){t(q.create("storage-open",{originalErrorMessage:n?.message}))}}),st)}function Xi(e){return da(ua(e))}function Qi(e,t){return la(ua(e),t)}function Zi(e){return la(ia,e)}function ec(){return da(ia)}async function la(e,t){const r=(await ca()).transaction(Ye,"readwrite"),o=r.objectStore(Ye).put({compositeKey:e,value:t});return new Promise((s,i)=>{o.onsuccess=l=>{s()},r.onerror=l=>{i(q.create("storage-set",{originalErrorMessage:l.target.error?.message}))}})}async function da(e){const n=(await ca()).transaction(Ye,"readonly"),a=n.objectStore(Ye).get(e);return new Promise((o,s)=>{a.onsuccess=i=>{const l=i.target.result;o(l?l.value:void 0)},n.onerror=i=>{s(q.create("storage-get",{originalErrorMessage:i.target.error?.message}))}})}function ua(e){return`${e.options.appId}-${e.name}`}const me=new Et("@firebase/app-check");async function tc(e){if(_t()){let t;try{t=await Xi(e)}catch(n){me.warn(`Failed to read token from IndexedDB. Error: ${n}`)}return t}}function jt(e,t){return _t()?Qi(e,t).catch(n=>{me.warn(`Failed to write token to IndexedDB. Error: ${n}`)}):Promise.resolve()}async function nc(){let e;try{e=await ec()}catch{}if(e)return e;{const t=crypto.randomUUID();return Zi(t).catch(n=>me.warn(`Failed to persist debug token to IndexedDB. Error: ${n}`)),t}}function _n(){return Tt().enabled}async function En(){const e=Tt();if(e.enabled&&e.token)return e.token.promise;throw Error(`
            Can't get debug token in production mode.
        `)}function rc(){const e=Sr(),t=Tt();if(t.initialized=!0,typeof e.FIREBASE_APPCHECK_DEBUG_TOKEN!="string"&&e.FIREBASE_APPCHECK_DEBUG_TOKEN!==!0)return;t.enabled=!0;const n=new Ge;t.token=n,typeof e.FIREBASE_APPCHECK_DEBUG_TOKEN=="string"?n.resolve(e.FIREBASE_APPCHECK_DEBUG_TOKEN):n.resolve(nc())}const ac={error:"UNKNOWN_ERROR"};function oc(e){return dn.encodeString(JSON.stringify(e),!1)}async function tn(e,t=!1,n=!1){const r=e.app;wn(r);const a=$(r);let o=a.token,s;if(o&&!De(o)&&(a.token=void 0,o=void 0),!o){const c=await a.cachedTokenPromise;c&&(De(c)?o=c:await jt(r,void 0))}if(!t&&o&&De(o))return{token:o.token};let i=!1;if(_n())try{a.exchangeTokenPromise||(a.exchangeTokenPromise=vn(sa(r,await En()),e.heartbeatServiceProvider).finally(()=>{a.exchangeTokenPromise=void 0}),i=!0);const c=await a.exchangeTokenPromise;return await jt(r,c),a.token=c,{token:c.token}}catch(c){return c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?me.warn(c.message):n&&me.error(c),Ht(c)}try{a.exchangeTokenPromise||(a.exchangeTokenPromise=a.provider.getToken().finally(()=>{a.exchangeTokenPromise=void 0}),i=!0),o=await $(r).exchangeTokenPromise}catch(c){c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?me.warn(c.message):n&&me.error(c),s=c}let l;return o?s?De(o)?l={token:o.token,internalError:s}:l=Ht(s):(l={token:o.token},a.token=o,await jt(r,o)):l=Ht(s),i&&ha(r,l),l}async function sc(e){const t=e.app;wn(t);const{provider:n}=$(t);if(_n()){const r=await En(),{token:a}=await vn(sa(t,r),e.heartbeatServiceProvider);return{token:a}}else{const{token:r}=await n.getToken();return{token:r}}}function fa(e,t,n,r){const{app:a}=e,o=$(a),s={next:n,error:r,type:t};if(o.tokenObservers=[...o.tokenObservers,s],o.token&&De(o.token)){const i=o.token;Promise.resolve().then(()=>{n({token:i.token}),ar(e)}).catch(()=>{})}o.cachedTokenPromise.then(()=>ar(e))}function ma(e,t){const n=$(e),r=n.tokenObservers.filter(a=>a.next!==t);r.length===0&&n.tokenRefresher&&n.tokenRefresher.isRunning()&&n.tokenRefresher.stop(),n.tokenObservers=r}function ar(e){const{app:t}=e,n=$(t);let r=n.tokenRefresher;r||(r=ic(e),n.tokenRefresher=r),!r.isRunning()&&n.isTokenAutoRefreshEnabled&&r.start()}function ic(e){const{app:t}=e;return new Vi(async()=>{const n=$(t);let r;if(n.token?r=await tn(e,!0):r=await tn(e),r.error)throw r.error;if(r.internalError)throw r.internalError},()=>!0,()=>{const n=$(t);if(n.token){let r=n.token.issuedAtTimeMillis+(n.token.expireTimeMillis-n.token.issuedAtTimeMillis)*.5+3e5;const a=n.token.expireTimeMillis-300*1e3;return r=Math.min(r,a),Math.max(0,r-Date.now())}else return 0},nr.RETRIAL_MIN_WAIT,nr.RETRIAL_MAX_WAIT)}function ha(e,t){const n=$(e).tokenObservers;for(const r of n)try{r.type==="EXTERNAL"&&t.error!=null?r.error(t.error):r.next(t)}catch{}}function De(e){return e.expireTimeMillis-Date.now()>0}function Ht(e){return{token:oc(ac),error:e}}class cc{constructor(t,n){this.app=t,this.heartbeatServiceProvider=n}_delete(){const{tokenObservers:t}=$(this.app);for(const n of t)ma(this.app,n.next);return Promise.resolve()}}function lc(e,t){return new cc(e,t)}function dc(e){return{getToken:t=>tn(e,t),getLimitedUseToken:()=>sc(e),addTokenListener:t=>fa(e,"INTERNAL",t),removeTokenListener:t=>ma(e.app,t)}}const uc="@firebase/app-check",fc="0.11.0";const mc="https://www.google.com/recaptcha/api.js";function hc(e,t){const n=new Ge,r=$(e);r.reCAPTCHAState={initialized:n};const a=pc(e),o=rr(!1);return o?or(e,t,o,a,n):bc(()=>{const s=rr(!1);if(!s)throw new Error("no recaptcha");or(e,t,s,a,n)}),n.promise}function or(e,t,n,r,a){n.ready(()=>{yc(e,t,n,r),a.resolve(n)})}function pc(e){const t=`fire_app_check_${e.name}`,n=document.createElement("div");return n.id=t,n.style.display="none",document.body.appendChild(n),t}async function gc(e){wn(e);const n=await $(e).reCAPTCHAState.initialized.promise;return new Promise((r,a)=>{const o=$(e).reCAPTCHAState;n.ready(()=>{r(n.execute(o.widgetId,{action:"fire_app_check"}))})})}function yc(e,t,n,r){const a=n.render(r,{sitekey:t,size:"invisible",callback:()=>{$(e).reCAPTCHAState.succeeded=!0},"error-callback":()=>{$(e).reCAPTCHAState.succeeded=!1}}),o=$(e);o.reCAPTCHAState={...o.reCAPTCHAState,widgetId:a}}function bc(e){const t=document.createElement("script");t.src=mc,t.onload=e,document.head.appendChild(t)}class In{constructor(t){this._siteKey=t,this._throttleData=null}async getToken(){vc(this._throttleData);const t=await gc(this._app).catch(r=>{throw q.create("recaptcha-error")});if(!$(this._app).reCAPTCHAState?.succeeded)throw q.create("recaptcha-error");let n;try{n=await vn(Ki(this._app,t),this._heartbeatServiceProvider)}catch(r){throw r.code?.includes("fetch-status-error")?(this._throttleData=wc(Number(r.customData?.httpStatus),this._throttleData),q.create("initial-throttle",{time:oa(this._throttleData.allowRequestsAfter-Date.now()),httpStatus:this._throttleData.httpStatus})):r}return this._throttleData=null,n}initialize(t){this._app=t,this._heartbeatServiceProvider=Ce(t,"heartbeat"),hc(t,this._siteKey).catch(()=>{})}isEqual(t){return t instanceof In?this._siteKey===t._siteKey:!1}}function wc(e,t){if(e===404||e===403)return{backoffCount:1,allowRequestsAfter:Date.now()+Wi,httpStatus:e};{const n=t?t.backoffCount:0,r=Gt(n,1e3,2);return{backoffCount:n+1,allowRequestsAfter:Date.now()+r,httpStatus:e}}}function vc(e){if(e&&Date.now()-e.allowRequestsAfter<=0)throw q.create("throttled",{time:oa(e.allowRequestsAfter-Date.now()),httpStatus:e.httpStatus})}function _c(e=fn(),t){e=Qe(e);const n=Ce(e,"app-check");if(Tt().initialized||rc(),_n()&&En().then(a=>console.log(`App Check debug token: ${a}. You will need to add it to your app's App Check settings in the Firebase console for it to work.`)),n.isInitialized()){const a=n.getImmediate(),o=n.getOptions();if(o.isTokenAutoRefreshEnabled===t.isTokenAutoRefreshEnabled&&o.provider.isEqual(t.provider))return a;throw q.create("already-initialized",{appName:e.name})}const r=n.initialize({options:t});return Ec(e,t.provider,t.isTokenAutoRefreshEnabled),$(e).isTokenAutoRefreshEnabled&&fa(r,"INTERNAL",()=>{}),r}function Ec(e,t,n=!1){const r=Hi(e,{...ra});r.activated=!0,r.provider=t,r.cachedTokenPromise=tc(e).then(a=>(a&&De(a)&&(r.token=a,ha(e,{token:a.token})),a)),r.isTokenAutoRefreshEnabled=n&&e.automaticDataCollectionEnabled,!e.automaticDataCollectionEnabled&&n&&me.warn("`isTokenAutoRefreshEnabled` is true but `automaticDataCollectionEnabled` was set to false during `initializeApp()`. This blocks automatic token refresh."),r.provider.initialize(e)}const Ic="app-check",sr="app-check-internal";function kc(){se(new ee(Ic,e=>{const t=e.getProvider("app").getImmediate(),n=e.getProvider("heartbeat");return lc(t,n)},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((e,t,n)=>{e.getProvider(sr).initialize()})),se(new ee(sr,e=>{const t=e.getProvider("app-check").getImmediate();return dc(t)},"PUBLIC").setInstantiationMode("EXPLICIT")),Z(uc,fc)}kc();var ir="@firebase/ai",nn="2.6.0";const Fe="AI",cr="us-central1",Tc="firebasevertexai.googleapis.com",yt="v1beta",lr=nn,Lc="gl-js",Sc=180*1e3,Ac="gemini-2.0-flash-lite";class k extends be{constructor(t,n,r){const a=Fe,o=`${a}/${t}`,s=`${a}: ${n} (${o})`;super(t,s),this.code=t,this.customErrorData=r,Error.captureStackTrace&&Error.captureStackTrace(this,k),Object.setPrototypeOf(this,k.prototype),this.toString=()=>s}}const dr=["user","model","function","system"],pa={HARM_SEVERITY_UNSUPPORTED:"HARM_SEVERITY_UNSUPPORTED"},ur={SAFETY:"SAFETY",RECITATION:"RECITATION"},ke={PREFER_ON_DEVICE:"prefer_on_device",ONLY_ON_DEVICE:"only_on_device",ONLY_IN_CLOUD:"only_in_cloud",PREFER_IN_CLOUD:"prefer_in_cloud"},ue={ON_DEVICE:"on_device",IN_CLOUD:"in_cloud"};const I={ERROR:"error",REQUEST_ERROR:"request-error",RESPONSE_ERROR:"response-error",FETCH_ERROR:"fetch-error",SESSION_CLOSED:"session-closed",INVALID_CONTENT:"invalid-content",API_NOT_ENABLED:"api-not-enabled",INVALID_SCHEMA:"invalid-schema",NO_API_KEY:"no-api-key",NO_APP_ID:"no-app-id",NO_MODEL:"no-model",NO_PROJECT_ID:"no-project-id",PARSE_FAILED:"parse-failed",UNSUPPORTED:"unsupported"};const le={VERTEX_AI:"VERTEX_AI",GOOGLE_AI:"GOOGLE_AI"};class ga{constructor(t){this.backendType=t}}class Lt extends ga{constructor(){super(le.GOOGLE_AI)}_getModelPath(t,n){return`/${yt}/projects/${t}/${n}`}_getTemplatePath(t,n){return`/${yt}/projects/${t}/templates/${n}`}}class kn extends ga{constructor(t=cr){super(le.VERTEX_AI),t?this.location=t:this.location=cr}_getModelPath(t,n){return`/${yt}/projects/${t}/locations/${this.location}/${n}`}_getTemplatePath(t,n){return`/${yt}/projects/${t}/locations/${this.location}/templates/${n}`}}function Cc(e){if(e instanceof Lt)return`${Fe}/googleai`;if(e instanceof kn)return`${Fe}/vertexai/${e.location}`;throw new k(I.ERROR,`Invalid backend: ${JSON.stringify(e.backendType)}`)}function xc(e){const t=e.split("/");if(t[0]!==Fe)throw new k(I.ERROR,`Invalid instance identifier, unknown prefix '${t[0]}'`);switch(t[1]){case"vertexai":const r=t[2];if(!r)throw new k(I.ERROR,`Invalid instance identifier, unknown location '${e}'`);return new kn(r);case"googleai":return new Lt;default:throw new k(I.ERROR,`Invalid instance identifier string: '${e}'`)}}const U=new Et("@firebase/vertexai");var _e;(function(e){e.UNAVAILABLE="unavailable",e.DOWNLOADABLE="downloadable",e.DOWNLOADING="downloading",e.AVAILABLE="available"})(_e||(_e={}));const Ut=[{type:"image"}];class Q{constructor(t,n,r){this.languageModelProvider=t,this.mode=n,this.isDownloading=!1,this.onDeviceParams={createOptions:{expectedInputs:Ut}},r&&(this.onDeviceParams=r,this.onDeviceParams.createOptions?this.onDeviceParams.createOptions.expectedInputs||(this.onDeviceParams.createOptions.expectedInputs=Ut):this.onDeviceParams.createOptions={expectedInputs:Ut})}async isAvailable(t){if(!this.mode)return U.debug("On-device inference unavailable because mode is undefined."),!1;if(this.mode===ke.ONLY_IN_CLOUD)return U.debug('On-device inference unavailable because mode is "only_in_cloud".'),!1;const n=await this.downloadIfAvailable();if(this.mode===ke.ONLY_ON_DEVICE){if(n===_e.UNAVAILABLE)throw new k(I.API_NOT_ENABLED,"Local LanguageModel API not available in this environment.");return(n===_e.DOWNLOADABLE||n===_e.DOWNLOADING)&&(U.debug("Waiting for download of LanguageModel to complete."),await this.downloadPromise),!0}return n!==_e.AVAILABLE?(U.debug(`On-device inference unavailable because availability is "${n}".`),!1):Q.isOnDeviceRequest(t)?!0:(U.debug("On-device inference unavailable because request is incompatible."),!1)}async generateContent(t){const n=await this.createSession(),r=await Promise.all(t.contents.map(Q.toLanguageModelMessage)),a=await n.prompt(r,this.onDeviceParams.promptOptions);return Q.toResponse(a)}async generateContentStream(t){const n=await this.createSession(),r=await Promise.all(t.contents.map(Q.toLanguageModelMessage)),a=n.promptStreaming(r,this.onDeviceParams.promptOptions);return Q.toStreamResponse(a)}async countTokens(t){throw new k(I.REQUEST_ERROR,"Count Tokens is not yet available for on-device model.")}static isOnDeviceRequest(t){if(t.contents.length===0)return U.debug("Empty prompt rejected for on-device inference."),!1;for(const n of t.contents){if(n.role==="function")return U.debug('"Function" role rejected for on-device inference.'),!1;for(const r of n.parts)if(r.inlineData&&Q.SUPPORTED_MIME_TYPES.indexOf(r.inlineData.mimeType)===-1)return U.debug(`Unsupported mime type "${r.inlineData.mimeType}" rejected for on-device inference.`),!1}return!0}async downloadIfAvailable(){const t=await this.languageModelProvider?.availability(this.onDeviceParams.createOptions);return t===_e.DOWNLOADABLE&&this.download(),t}download(){this.isDownloading||(this.isDownloading=!0,this.downloadPromise=this.languageModelProvider?.create(this.onDeviceParams.createOptions).finally(()=>{this.isDownloading=!1}))}static async toLanguageModelMessage(t){const n=await Promise.all(t.parts.map(Q.toLanguageModelMessageContent));return{role:Q.toLanguageModelMessageRole(t.role),content:n}}static async toLanguageModelMessageContent(t){if(t.text)return{type:"text",value:t.text};if(t.inlineData){const r=await(await fetch(`data:${t.inlineData.mimeType};base64,${t.inlineData.data}`)).blob();return{type:"image",value:await createImageBitmap(r)}}throw new k(I.REQUEST_ERROR,"Processing of this Part type is not currently supported.")}static toLanguageModelMessageRole(t){return t==="model"?"assistant":"user"}async createSession(){if(!this.languageModelProvider)throw new k(I.UNSUPPORTED,"Chrome AI requested for unsupported browser version.");const t=await this.languageModelProvider.create(this.onDeviceParams.createOptions);return this.oldSession&&this.oldSession.destroy(),this.oldSession=t,t}static toResponse(t){return{json:async()=>({candidates:[{content:{parts:[{text:t}]}}]})}}static toStreamResponse(t){const n=new TextEncoder;return{body:t.pipeThrough(new TransformStream({transform(r,a){const o=JSON.stringify({candidates:[{content:{role:"model",parts:[{text:r}]}}]});a.enqueue(n.encode(`data: ${o}

`))}}))}}}Q.SUPPORTED_MIME_TYPES=["image/jpeg","image/png"];function Rc(e,t,n){if(typeof t<"u"&&e)return new Q(t.LanguageModel,e,n)}class Bc{constructor(t,n,r,a,o){this.app=t,this.backend=n,this.chromeAdapterFactory=o;const s=a?.getImmediate({optional:!0}),i=r?.getImmediate({optional:!0});this.auth=i||null,this.appCheck=s||null,n instanceof kn?this.location=n.location:this.location=""}_delete(){return Promise.resolve()}set options(t){this._options=t}get options(){return this._options}}function Dc(e,{instanceIdentifier:t}){if(!t)throw new k(I.ERROR,"AIService instance identifier is undefined.");const n=xc(t),r=e.getProvider("app").getImmediate(),a=e.getProvider("auth-internal"),o=e.getProvider("app-check-internal");return new Bc(r,n,a,o,Rc)}function Mc(e){if(e.app?.options?.apiKey)if(e.app?.options?.projectId){if(!e.app?.options?.appId)throw new k(I.NO_APP_ID,'The "appId" field is empty in the local Firebase config. Firebase AI requires this field to contain a valid app ID.')}else throw new k(I.NO_PROJECT_ID,'The "projectId" field is empty in the local Firebase config. Firebase AI requires this field to contain a valid project ID.');else throw new k(I.NO_API_KEY,'The "apiKey" field is empty in the local Firebase config. Firebase AI requires this field to contain a valid API key.');const t={apiKey:e.app.options.apiKey,project:e.app.options.projectId,appId:e.app.options.appId,automaticDataCollectionEnabled:e.app.automaticDataCollectionEnabled,location:e.location,backend:e.backend};if(as(e.app)&&e.app.settings.appCheckToken){const n=e.app.settings.appCheckToken;t.getAppCheckToken=()=>Promise.resolve({token:n})}else e.appCheck&&(e.options?.useLimitedUseAppCheckTokens?t.getAppCheckToken=()=>e.appCheck.getLimitedUseToken():t.getAppCheckToken=()=>e.appCheck.getToken());return e.auth&&(t.getAuthToken=()=>e.auth.getToken()),t}class qe{constructor(t,n){this._apiSettings=Mc(t),this.model=qe.normalizeModelName(n,this._apiSettings.backend.backendType)}static normalizeModelName(t,n){return n===le.GOOGLE_AI?qe.normalizeGoogleAIModelName(t):qe.normalizeVertexAIModelName(t)}static normalizeGoogleAIModelName(t){return`models/${t}`}static normalizeVertexAIModelName(t){let n;return t.includes("/")?t.startsWith("models/")?n=`publishers/google/${t}`:n=t:n=`publishers/google/models/${t}`,n}}class $c{constructor(t){this.params=t}toString(){const t=new URL(this.baseUrl);return t.pathname=this.pathname,t.search=this.queryParams.toString(),t.toString()}get pathname(){return this.params.templateId?`${this.params.apiSettings.backend._getTemplatePath(this.params.apiSettings.project,this.params.templateId)}:${this.params.task}`:`${this.params.apiSettings.backend._getModelPath(this.params.apiSettings.project,this.params.model)}:${this.params.task}`}get baseUrl(){return this.params.requestOptions?.baseUrl??`https://${Tc}`}get queryParams(){const t=new URLSearchParams;return this.params.stream&&t.set("alt","sse"),t}}function Oc(){const e=[];return e.push(`${Lc}/${lr}`),e.push(`fire/${lr}`),e.join(" ")}async function Pc(e){const t=new Headers;if(t.append("Content-Type","application/json"),t.append("x-goog-api-client",Oc()),t.append("x-goog-api-key",e.params.apiSettings.apiKey),e.params.apiSettings.automaticDataCollectionEnabled&&t.append("X-Firebase-Appid",e.params.apiSettings.appId),e.params.apiSettings.getAppCheckToken){const n=await e.params.apiSettings.getAppCheckToken();n&&(t.append("X-Firebase-AppCheck",n.token),n.error&&U.warn(`Unable to obtain a valid App Check token: ${n.error.message}`))}if(e.params.apiSettings.getAuthToken){const n=await e.params.apiSettings.getAuthToken();n&&t.append("Authorization",`Firebase ${n.accessToken}`)}return t}async function Tn(e,t){const n=new $c(e);let r,a;try{const o={method:"POST",headers:await Pc(n),body:t},s=e.requestOptions?.timeout!=null&&e.requestOptions.timeout>=0?e.requestOptions.timeout:Sc,i=new AbortController;if(a=setTimeout(()=>i.abort(),s),o.signal=i.signal,r=await fetch(n.toString(),o),!r.ok){let l="",c;try{const u=await r.json();l=u.error.message,u.error.details&&(l+=` ${JSON.stringify(u.error.details)}`,c=u.error.details)}catch{}throw r.status===403&&c&&c.some(u=>u.reason==="SERVICE_DISABLED")&&c.some(u=>u.links?.[0]?.description.includes("Google developers console API activation"))?new k(I.API_NOT_ENABLED,`The Firebase AI SDK requires the Firebase AI API ('firebasevertexai.googleapis.com') to be enabled in your Firebase project. Enable this API by visiting the Firebase Console at https://console.firebase.google.com/project/${n.params.apiSettings.project}/genai/ and clicking "Get started". If you enabled this API recently, wait a few minutes for the action to propagate to our systems and then retry.`,{status:r.status,statusText:r.statusText,errorDetails:c}):new k(I.FETCH_ERROR,`Error fetching from ${n}: [${r.status} ${r.statusText}] ${l}`,{status:r.status,statusText:r.statusText,errorDetails:c})}}catch(o){let s=o;throw o.code!==I.FETCH_ERROR&&o.code!==I.API_NOT_ENABLED&&o instanceof Error&&(s=new k(I.ERROR,`Error fetching from ${n.toString()}: ${o.message}`),s.stack=o.stack),s}finally{a&&clearTimeout(a)}return r}function it(e){if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&U.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),ya(e.candidates[0]))throw new k(I.RESPONSE_ERROR,`Response error: ${Te(e)}. Response body stored in error.response`,{response:e});return!0}else return!1}function bt(e,t=ue.IN_CLOUD){e.candidates&&!e.candidates[0].hasOwnProperty("index")&&(e.candidates[0].index=0);const n=Nc(e);return n.inferenceSource=t,n}function Nc(e){return e.text=()=>{if(it(e))return fr(e,t=>!t.thought);if(e.promptFeedback)throw new k(I.RESPONSE_ERROR,`Text not available. ${Te(e)}`,{response:e});return""},e.thoughtSummary=()=>{if(it(e)){const t=fr(e,n=>!!n.thought);return t===""?void 0:t}else if(e.promptFeedback)throw new k(I.RESPONSE_ERROR,`Thought summary not available. ${Te(e)}`,{response:e})},e.inlineDataParts=()=>{if(it(e))return jc(e);if(e.promptFeedback)throw new k(I.RESPONSE_ERROR,`Data not available. ${Te(e)}`,{response:e})},e.functionCalls=()=>{if(it(e))return Fc(e);if(e.promptFeedback)throw new k(I.RESPONSE_ERROR,`Function call not available. ${Te(e)}`,{response:e})},e}function fr(e,t){const n=[];if(e.candidates?.[0].content?.parts)for(const r of e.candidates?.[0].content?.parts)r.text&&t(r)&&n.push(r.text);return n.length>0?n.join(""):""}function Fc(e){const t=[];if(e.candidates?.[0].content?.parts)for(const n of e.candidates?.[0].content?.parts)n.functionCall&&t.push(n.functionCall);if(t.length>0)return t}function jc(e){const t=[];if(e.candidates?.[0].content?.parts)for(const n of e.candidates?.[0].content?.parts)n.inlineData&&t.push(n);if(t.length>0)return t}const Hc=[ur.RECITATION,ur.SAFETY];function ya(e){return!!e.finishReason&&Hc.some(t=>t===e.finishReason)}function Te(e){let t="";if((!e.candidates||e.candidates.length===0)&&e.promptFeedback)t+="Response was blocked",e.promptFeedback?.blockReason&&(t+=` due to ${e.promptFeedback.blockReason}`),e.promptFeedback?.blockReasonMessage&&(t+=`: ${e.promptFeedback.blockReasonMessage}`);else if(e.candidates?.[0]){const n=e.candidates[0];ya(n)&&(t+=`Candidate was blocked due to ${n.finishReason}`,n.finishMessage&&(t+=`: ${n.finishMessage}`))}return t}function ba(e){if(e.safetySettings?.forEach(t=>{if(t.method)throw new k(I.UNSUPPORTED,"SafetySetting.method is not supported in the the Gemini Developer API. Please remove this property.")}),e.generationConfig?.topK){const t=Math.round(e.generationConfig.topK);t!==e.generationConfig.topK&&(U.warn("topK in GenerationConfig has been rounded to the nearest integer to match the format for requests to the Gemini Developer API."),e.generationConfig.topK=t)}return e}function Ln(e){return{candidates:e.candidates?qc(e.candidates):void 0,prompt:e.promptFeedback?Wc(e.promptFeedback):void 0,usageMetadata:e.usageMetadata}}function Uc(e,t){return{generateContentRequest:{model:t,...e}}}function qc(e){const t=[];let n;return t&&e.forEach(r=>{let a;if(r.citationMetadata&&(a={citations:r.citationMetadata.citationSources}),r.safetyRatings&&(n=r.safetyRatings.map(s=>({...s,severity:s.severity??pa.HARM_SEVERITY_UNSUPPORTED,probabilityScore:s.probabilityScore??0,severityScore:s.severityScore??0}))),r.content?.parts?.some(s=>s?.videoMetadata))throw new k(I.UNSUPPORTED,"Part.videoMetadata is not supported in the Gemini Developer API. Please remove this property.");const o={index:r.index,content:r.content,finishReason:r.finishReason,finishMessage:r.finishMessage,safetyRatings:n,citationMetadata:a,groundingMetadata:r.groundingMetadata,urlContextMetadata:r.urlContextMetadata};t.push(o)}),t}function Wc(e){const t=[];return e.safetyRatings.forEach(r=>{t.push({category:r.category,probability:r.probability,severity:r.severity??pa.HARM_SEVERITY_UNSUPPORTED,probabilityScore:r.probabilityScore??0,severityScore:r.severityScore??0,blocked:r.blocked})}),{blockReason:e.blockReason,safetyRatings:t,blockReasonMessage:e.blockReasonMessage}}const mr=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function Vc(e,t,n){const r=e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),a=Kc(r),[o,s]=a.tee();return{stream:Gc(o,t,n),response:zc(s,t,n)}}async function zc(e,t,n){const r=[],a=e.getReader();for(;;){const{done:o,value:s}=await a.read();if(o){let i=Yc(r);return t.backend.backendType===le.GOOGLE_AI&&(i=Ln(i)),bt(i,n)}r.push(s)}}async function*Gc(e,t,n){const r=e.getReader();for(;;){const{value:a,done:o}=await r.read();if(o)break;let s;t.backend.backendType===le.GOOGLE_AI?s=bt(Ln(a),n):s=bt(a,n);const i=s.candidates?.[0];!i?.content?.parts&&!i?.finishReason&&!i?.citationMetadata&&!i?.urlContextMetadata||(yield s)}}function Kc(e){const t=e.getReader();return new ReadableStream({start(r){let a="";return o();function o(){return t.read().then(({value:s,done:i})=>{if(i){if(a.trim()){r.error(new k(I.PARSE_FAILED,"Failed to parse stream"));return}r.close();return}a+=s;let l=a.match(mr),c;for(;l;){try{c=JSON.parse(l[1])}catch{r.error(new k(I.PARSE_FAILED,`Error parsing JSON response: "${l[1]}`));return}r.enqueue(c),a=a.substring(l[0].length),l=a.match(mr)}return o()})}}})}function Yc(e){const n={promptFeedback:e[e.length-1]?.promptFeedback};for(const r of e)if(r.candidates)for(const a of r.candidates){const o=a.index||0;n.candidates||(n.candidates=[]),n.candidates[o]||(n.candidates[o]={index:a.index}),n.candidates[o].citationMetadata=a.citationMetadata,n.candidates[o].finishReason=a.finishReason,n.candidates[o].finishMessage=a.finishMessage,n.candidates[o].safetyRatings=a.safetyRatings,n.candidates[o].groundingMetadata=a.groundingMetadata;const s=a.urlContextMetadata;if(typeof s=="object"&&s!==null&&Object.keys(s).length>0&&(n.candidates[o].urlContextMetadata=s),a.content){if(!a.content.parts)continue;n.candidates[o].content||(n.candidates[o].content={role:a.content.role||"user",parts:[]});for(const i of a.content.parts){const l={...i};i.text!==""&&Object.keys(l).length>0&&n.candidates[o].content.parts.push(l)}}}return n}const Jc=[I.FETCH_ERROR,I.ERROR,I.API_NOT_ENABLED];async function wa(e,t,n,r){if(!t)return{response:await r(),inferenceSource:ue.IN_CLOUD};switch(t.mode){case ke.ONLY_ON_DEVICE:if(await t.isAvailable(e))return{response:await n(),inferenceSource:ue.ON_DEVICE};throw new k(I.UNSUPPORTED,"Inference mode is ONLY_ON_DEVICE, but an on-device model is not available.");case ke.ONLY_IN_CLOUD:return{response:await r(),inferenceSource:ue.IN_CLOUD};case ke.PREFER_IN_CLOUD:try{return{response:await r(),inferenceSource:ue.IN_CLOUD}}catch(a){if(a instanceof k&&Jc.includes(a.code))return{response:await n(),inferenceSource:ue.ON_DEVICE};throw a}case ke.PREFER_ON_DEVICE:return await t.isAvailable(e)?{response:await n(),inferenceSource:ue.ON_DEVICE}:{response:await r(),inferenceSource:ue.IN_CLOUD};default:throw new k(I.ERROR,`Unexpected infererence mode: ${t.mode}`)}}async function Xc(e,t,n,r){return e.backend.backendType===le.GOOGLE_AI&&(n=ba(n)),Tn({task:"streamGenerateContent",model:t,apiSettings:e,stream:!0,requestOptions:r},JSON.stringify(n))}async function va(e,t,n,r,a){const o=await wa(n,r,()=>r.generateContentStream(n),()=>Xc(e,t,n,a));return Vc(o.response,e)}async function Qc(e,t,n,r){return e.backend.backendType===le.GOOGLE_AI&&(n=ba(n)),Tn({model:t,task:"generateContent",apiSettings:e,stream:!1,requestOptions:r},JSON.stringify(n))}async function _a(e,t,n,r,a){const o=await wa(n,r,()=>r.generateContent(n),()=>Qc(e,t,n,a)),s=await Zc(o.response,e);return{response:bt(s,o.inferenceSource)}}async function Zc(e,t){const n=await e.json();return t.backend.backendType===le.GOOGLE_AI?Ln(n):n}function Ea(e){if(e!=null){if(typeof e=="string")return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)return e.role?e:{role:"system",parts:e.parts}}}function rn(e){let t=[];if(typeof e=="string")t=[{text:e}];else for(const n of e)typeof n=="string"?t.push({text:n}):t.push(n);return el(t)}function el(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let r=!1,a=!1;for(const o of e)"functionResponse"in o?(n.parts.push(o),a=!0):(t.parts.push(o),r=!0);if(r&&a)throw new k(I.INVALID_CONTENT,"Within a single message, FunctionResponse cannot be mixed with other type of Part in the request for sending chat message.");if(!r&&!a)throw new k(I.INVALID_CONTENT,"No Content is provided for sending chat message.");return r?t:n}function qt(e){let t;return e.contents?t=e:t={contents:[rn(e)]},e.systemInstruction&&(t.systemInstruction=Ea(e.systemInstruction)),t}const hr=["text","inlineData","functionCall","functionResponse","thought","thoughtSignature"],tl={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","thought","thoughtSignature"],system:["text"]},pr={user:["model"],function:["model"],model:["user","function"],system:[]};function nl(e){let t=null;for(const n of e){const{role:r,parts:a}=n;if(!t&&r!=="user")throw new k(I.INVALID_CONTENT,`First Content should be with role 'user', got ${r}`);if(!dr.includes(r))throw new k(I.INVALID_CONTENT,`Each item should include role field. Got ${r} but valid roles are: ${JSON.stringify(dr)}`);if(!Array.isArray(a))throw new k(I.INVALID_CONTENT,"Content should have 'parts' property with an array of Parts");if(a.length===0)throw new k(I.INVALID_CONTENT,"Each Content should have at least one part");const o={text:0,inlineData:0,functionCall:0,functionResponse:0,thought:0,thoughtSignature:0,executableCode:0,codeExecutionResult:0};for(const i of a)for(const l of hr)l in i&&(o[l]+=1);const s=tl[r];for(const i of hr)if(!s.includes(i)&&o[i]>0)throw new k(I.INVALID_CONTENT,`Content with role '${r}' can't contain '${i}' part`);if(t&&!pr[r].includes(t.role))throw new k(I.INVALID_CONTENT,`Content with role '${r}' can't follow '${t.role}'. Valid previous roles: ${JSON.stringify(pr)}`);t=n}}const gr="SILENT_ERROR";class rl{constructor(t,n,r,a,o){this.model=n,this.chromeAdapter=r,this.params=a,this.requestOptions=o,this._history=[],this._sendPromise=Promise.resolve(),this._apiSettings=t,a?.history&&(nl(a.history),this._history=a.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(t){await this._sendPromise;const n=rn(t),r={safetySettings:this.params?.safetySettings,generationConfig:this.params?.generationConfig,tools:this.params?.tools,toolConfig:this.params?.toolConfig,systemInstruction:this.params?.systemInstruction,contents:[...this._history,n]};let a={};return this._sendPromise=this._sendPromise.then(()=>_a(this._apiSettings,this.model,r,this.chromeAdapter,this.requestOptions)).then(o=>{if(o.response.candidates&&o.response.candidates.length>0){this._history.push(n);const s={parts:o.response.candidates?.[0].content.parts||[],role:o.response.candidates?.[0].content.role||"model"};this._history.push(s)}else{const s=Te(o.response);s&&U.warn(`sendMessage() was unsuccessful. ${s}. Inspect response object for details.`)}a=o}),await this._sendPromise,a}async sendMessageStream(t){await this._sendPromise;const n=rn(t),r={safetySettings:this.params?.safetySettings,generationConfig:this.params?.generationConfig,tools:this.params?.tools,toolConfig:this.params?.toolConfig,systemInstruction:this.params?.systemInstruction,contents:[...this._history,n]},a=va(this._apiSettings,this.model,r,this.chromeAdapter,this.requestOptions);return this._sendPromise=this._sendPromise.then(()=>a).catch(o=>{throw new Error(gr)}).then(o=>o.response).then(o=>{if(o.candidates&&o.candidates.length>0){this._history.push(n);const s={...o.candidates[0].content};s.role||(s.role="model"),this._history.push(s)}else{const s=Te(o);s&&U.warn(`sendMessageStream() was unsuccessful. ${s}. Inspect response object for details.`)}}).catch(o=>{o.message!==gr&&U.error(o)}),a}}async function al(e,t,n,r){let a="";if(e.backend.backendType===le.GOOGLE_AI){const s=Uc(n,t);a=JSON.stringify(s)}else a=JSON.stringify(n);return(await Tn({model:t,task:"countTokens",apiSettings:e,stream:!1,requestOptions:r},a)).json()}async function ol(e,t,n,r,a){if(r?.mode===ke.ONLY_ON_DEVICE)throw new k(I.UNSUPPORTED,"countTokens() is not supported for on-device models.");return al(e,t,n,a)}class sl extends qe{constructor(t,n,r,a){super(t,n.model),this.chromeAdapter=a,this.generationConfig=n.generationConfig||{},this.safetySettings=n.safetySettings||[],this.tools=n.tools,this.toolConfig=n.toolConfig,this.systemInstruction=Ea(n.systemInstruction),this.requestOptions=r||{}}async generateContent(t){const n=qt(t);return _a(this._apiSettings,this.model,{generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,...n},this.chromeAdapter,this.requestOptions)}async generateContentStream(t){const n=qt(t);return va(this._apiSettings,this.model,{generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,...n},this.chromeAdapter,this.requestOptions)}startChat(t){return new rl(this._apiSettings,this.model,this.chromeAdapter,{tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,generationConfig:this.generationConfig,safetySettings:this.safetySettings,...t},this.requestOptions)}async countTokens(t){const n=qt(t);return ol(this._apiSettings,this.model,n,this.chromeAdapter)}}function il(e=fn(),t){e=Qe(e);const n=Ce(e,Fe),r=t?.backend??new Lt,a={useLimitedUseAppCheckTokens:t?.useLimitedUseAppCheckTokens??!1},o=Cc(r),s=n.getImmediate({identifier:o});return s.options=a,s}function cl(e,t,n){const r=t;let a;if(r.mode?a=r.inCloudParams||{model:Ac}:a=t,!a.model)throw new k(I.NO_MODEL,"Must provide a model name. Example: getGenerativeModel({ model: 'my-model-name' })");const o=e.chromeAdapterFactory?.(r.mode,typeof window>"u"?void 0:window,r.onDeviceParams);return new sl(e,a,n,o)}function ll(){se(new ee(Fe,Dc,"PUBLIC").setMultipleInstances(!0)),Z(ir,nn),Z(ir,nn,"esm2020")}ll();const dl={apiKey:"AIzaSyCmAiYHJ77vZCNzP1juaeU4xQ_KV6kc5h4",authDomain:"watchlist-b2fd0.firebaseapp.com",projectId:"watchlist-b2fd0",storageBucket:"watchlist-b2fd0.firebasestorage.app",messagingSenderId:"917010956394",appId:"1:917010956394:web:6ed1aa6e057ceced48ca13",measurementId:"G-ZZFBMG2K1G"},Sn=Dr(dl);$i(Sn);typeof window<"u"&&_c(Sn,{provider:new In("6LdRTRQsAAAAAK07rxxw0rG2s7iBlrx_zLaLs4u5"),isTokenAutoRefreshEnabled:!0});const ul=il(Sn,{backend:new Lt}),He=cl(ul,{model:"gemini-2.5-flash"}),fl="25e3d089cc8e37a56bf6a1984daf3c5c";async function ml(){console.log("Performing a hard reset. Deleting all media data...");const{error:e}=await y.from("media").delete().neq("id",0);if(e){console.error("CRITICAL: Failed to delete data. Check your RLS policies.",e);return}console.log("All existing media has been deleted.");const t=await pl();if(t.length){console.log(`Starting to seed ${t.length} items from watchednotes.json...`);for(const n of t){const r=await hl(n.title);if(r){const{error:a}=await y.from("media").insert({title:n.title,type:n.type,tmdb_id:r,source:"fetched"});a&&console.error(`Error inserting '${n.title}':`,a)}}console.log("Database hard reset and seeding complete.")}}async function hl(e){const t=`https://api.themoviedb.org/3/search/multi?api_key=${fl}&query=${encodeURIComponent(e)}`;try{const r=await(await fetch(t)).json();if(r.results&&r.results.length>0){const a=r.results.find(o=>o.media_type==="movie"||o.media_type==="tv");if(a)return a.id}return console.warn(`TMDB ID not found for: ${e}`),null}catch(n){return console.error(`Error fetching TMDB ID for ${e}:`,n),null}}async function pl(){try{const e=await fetch("/watchednotes.json");if(!e.ok)throw new Error("Failed to fetch watchednotes.json");return await e.json()}catch(e){return console.error("Error fetching local media data:",e),[]}}async function gl(){const{data:e,error:t}=await y.from("flairs").select("*").order("name");return t?(console.error("Error fetching flairs:",t),[]):e}async function yl(e){const{data:t,error:n}=await y.from("media_flairs").select(`
            flair_id,
            flairs (
                id,
                name,
                color,
                icon,
                description
            )
        `).eq("media_id",e);return n?(console.error("Error fetching media flairs:",n),[]):t.map(r=>r.flairs)}async function bl(e){const{data:t,error:n}=await y.from("flairs").insert([e]).select().single();return n?(console.error("Error creating flair:",n),null):t}async function wl(e,t){const n=await yl(e);if(n.length>=2)return{success:!1,message:"Max 2 flairs per media item."};if(n.find(a=>a.id===t))return{success:!1,message:"Flair already assigned."};const{error:r}=await y.from("media_flairs").insert([{media_id:e,flair_id:t}]);return r?(console.error("Error assigning flair:",r),{success:!1,message:"Failed to assign flair."}):{success:!0,message:"Flair assigned."}}async function vl(e,t){const{error:n}=await y.from("media_flairs").delete().eq("media_id",e).eq("flair_id",t);return n?(console.error("Error removing flair:",n),!1):!0}function fe(e,t="text-xs px-2 py-0.5"){let n="";return e.icon&&(e.icon.startsWith("fa")?n=`<i class="${e.icon}"></i>`:n=`<span>${e.icon}</span>`),`
        <span class="inline-flex items-center gap-1 rounded-full font-semibold shadow-sm ${t} transform transition-transform hover:scale-105 cursor-default border border-white/20" 
              style="background-color: ${e.color}; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
            ${n}
            <span>${e.name}</span>
        </span>
    `}async function yr(e,t,n){const r=`Summarize opinions on "${e.title||e.name}":

**Juainny:** ${t.user1||"Not rated"}/10 - ${n.user1||"No notes"}
**Erick:** ${t.user2||"Not rated"}/10 - ${n.user2||"No notes"}

Rules:
- Use **markdown** (bold, italic, lists)
- Max 60 words
- Highlight agreement/disagreement
- No greetings`;try{return(await(await He.generateContent(r)).response).text()}catch(a){return console.error("Error generating summary:",a),"Willow is having trouble thinking right now. check back later!"}}async function _l(e,t){e.toLowerCase();const n=/\b(watched|rated|favorite|note|list|recommend from|what did|how many|we watched|we rated|our)\b/i.test(e)||/\b(juainny|erick|both of)\b/i.test(e),r=/\b(when (is|will)|release|coming out|new|latest|2024|2025|streaming|where to watch|trailer)\b/i.test(e)||/\b(who (is|plays|starred)|cast|director|about|plot)\b/i.test(e);if(n){const a={total:t.length,watched:t.filter(i=>i.watched).length,want_to_watch:t.filter(i=>i.want_to_watch).length,currently_watching:t.filter(i=>i.currently_watching).length,favorited:t.filter(i=>i.favorited_by?.length>0).length},o=t.map(i=>({t:i.title||i.name,w:i.watched?1:0,id:i.tmdb_id})),s=`Database query for Juainny & Erick's watchlist.

**Stats:** ${JSON.stringify(a)}
**Titles:** ${JSON.stringify(o)}
**Question:** ${e}

**Rules:**
- Ratings are /10
- Use **markdown**
- Be brief
- Answer from database only`;try{return` ${(await(await He.generateContent(s)).response).text()}`}catch(i){return console.error("Error with database query:",i),"Database access failed. Try asking differently!"}}else if(r){const a=`${e}

Use Google Search to find current, accurate information. Be concise and use **markdown** formatting.`;try{return` ${(await(await He.generateContent({contents:[{role:"user",parts:[{text:a}]}],tools:[{googleSearchRetrieval:{dynamicRetrievalConfig:{mode:"MODE_DYNAMIC",dynamicThreshold:.3}}}]})).response).text()}`}catch(o){console.error("Error with web search:",o);try{return` ${(await(await He.generateContent(a)).response).text()}`}catch{return"Couldn't search the web right now. Try again!"}}}else{const a=`${e}

Be conversational, brief, and use **markdown**. Keep it under 100 words.`;try{return` ${(await(await He.generateContent(a)).response).text()}`}catch(o){return console.error("Error in conversation:",o),"I'm having trouble thinking right now!"}}}const ye="25e3d089cc8e37a56bf6a1984daf3c5c";async function El(e){console.log("Starting TMDB data synchronization...");const t=10;let n=[],r=0,a=0;for(let o=0;o<e.length;o+=t){const i=e.slice(o,o+t).map(async c=>{if(!c.tmdb_id||!c.type)return c;const h=`https://api.themoviedb.org/3/${c.type==="movie"?"movie":"tv"}/${c.tmdb_id}?api_key=${ye}&append_to_response=release_dates,content_ratings,external_ids`;try{const m=await fetch(h);if(!m.ok)return console.error(`Error fetching TMDB data for ${c.title} (ID: ${c.tmdb_id}): ${m.status}`),a++,c;const d=await m.json(),p=d.title||d.name,_={};c.poster_path!==d.poster_path&&(_.poster_path=d.poster_path),c.title!==p&&(_.title=p);const T=d.release_date||d.first_air_date||"",L=T?parseInt(T.split("-")[0]):null;L&&(!c.release_year||c.release_year!==L)&&(_.release_year=L);let E=d.runtime||(d.episode_run_time&&d.episode_run_time.length>0?d.episode_run_time[0]:0);const b=c.type==="tv"||c.type==="series";b&&!E&&(d.last_episode_to_air&&d.last_episode_to_air.runtime?E=d.last_episode_to_air.runtime:d.next_episode_to_air&&d.next_episode_to_air.runtime&&(E=d.next_episode_to_air.runtime)),E&&(c.runtime===0||!c.runtime||c.runtime!==E)&&(_.runtime=E);let w="N/A";if(c.type==="movie"&&d.release_dates){const B=d.release_dates.results.find(O=>O.iso_3166_1==="US");if(B){const O=B.release_dates.find(te=>te.certification!=="");O&&(w=O.certification)}}else if(b&&d.content_ratings&&d.content_ratings.results){const B=d.content_ratings.results.find(O=>O.iso_3166_1==="US");B?w=B.rating:d.content_ratings.results.length>0&&(w=d.content_ratings.results[0].rating)}w!=="N/A"&&(!c.content_rating||c.content_rating==="N/A"||c.content_rating!==w)&&(_.content_rating=w);const S=d.external_ids?.imdb_id;if(S&&(!c.imdb_id||c.imdb_id!==S)&&(_.imdb_id=S),Object.keys(_).length>0){const{error:B}=await y.from("media").update(_).eq("id",c.id);return B?(console.error(`Error updating Supabase for ${c.title}:`,B),a++,c):(console.log(` Updated ${c.title}:`,Object.keys(_).join(", ")),r++,{...c,..._})}return c}catch(m){return console.error(`Error during TMDB sync for ${c.title}:`,m),a++,c}}),l=await Promise.all(i);n=n.concat(l)}return console.log(`TMDB sync complete. Updated: ${r}/${e.length}. Errors: ${a}`),n}let A=[],Oe=[],P=[],ne="all",an="grid",wt="default",ve=[],D=new Map;async function Il(e){if(!e||e.trim()==="")return[];const t=`https://api.themoviedb.org/3/search/multi?api_key=${ye}&query=${encodeURIComponent(e)}`;try{let a=(await(await fetch(t)).json()).results.filter(s=>s.media_type==="movie"||s.media_type==="tv");const{data:o}=await y.from("settings").select("hide_search_results_without_images").single();return o?.hide_search_results_without_images&&(a=a.filter(s=>s.poster_path)),o?.hide_search_results_without_images&&(a=a.filter(s=>s.poster_path)),console.log("TMDB Search Results:",a.length),a}catch(n){return console.error("Error searching TMDB:",n),[]}}function W(){console.log("Rendering content. Current Filter:",ne,"Media Count:",Oe.length);const e=document.getElementById("movie-grid"),t=document.getElementById("movie-list");if(ne==="all"?P=Oe:P=Oe.filter(n=>{const r=n.type||n.media_type;return ne==="movie"?r==="movie":ne==="tv"?r==="tv"||r==="series":ne==="watched"?n.watched===!0:ne==="rejected"?n.rejected===!0:!1}),Ol(),an==="grid"){if(e.innerHTML="",t.innerHTML="",e.style.display="grid",t.style.display="none",P.length===0){e.innerHTML='<p class="text-text-muted col-span-full text-center">No results found.</p>';return}for(const n of P){const r=n.poster_path?`https://image.tmdb.org/t/p/w500${n.poster_path}`:"https://placehold.co/500x750?text=No+Image",a=n.title||n.name,o=n.type||n.media_type,s=n.tmdb_id||n.id;kl(e,a,o,s,r,n.watched)}}else{if(e.innerHTML="",t.innerHTML="",e.style.display="none",t.style.display="block",P.length===0){t.innerHTML='<p class="text-text-muted text-center">No results found.</p>';return}const n=document.createElement("div");n.className="bg-bg-secondary p-4 md:p-6 rounded-lg shadow-lg",P.forEach(r=>{const a=r.title||r.name,o=r.type||r.media_type,s=r.tmdb_id||r.id,i=document.createElement("div");i.className="flex items-center py-1",i.innerHTML=`
                <span class="text-text-muted mr-2">-</span>
                <a href="#" class="text-text-primary hover:text-accent-primary underline transition-colors" data-tmdb-id="${s}" data-type="${o}">${a}</a>
            `,i.querySelector("a").addEventListener("click",l=>{l.preventDefault(),St(s,o)}),n.appendChild(i)}),t.appendChild(n)}}function kl(e,t,n,r,a,o){const s=document.createElement("div");s.className="movie-card relative rounded-lg shadow-lg overflow-hidden cursor-pointer group",o&&s.classList.add("watched"),s.dataset.tmdbId=r,s.dataset.type=n;const i=A.find(c=>c.tmdb_id==r)?.favorited_by||[];i.length>1?s.classList.add("super-favorite-glow"):i.length>0&&s.classList.add("favorite-glow"),s.innerHTML=`
        <img src="${a}" alt="${t}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
        
        <!-- Reactions Overlay -->
        <div class="absolute top-2 left-2 flex flex-col gap-1 z-10">
            ${A.find(c=>c.tmdb_id==r)?.juainny_reaction?`
                <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Juainny" data-reaction="${A.find(c=>c.tmdb_id==r).juainny_reaction}">
                    <img src="moods/${A.find(c=>c.tmdb_id==r).juainny_reaction}" class="w-full h-full object-contain drop-shadow-md">
                    <div class="absolute -bottom-1 -right-1 w-4 h-4">
                        ${V("juainny","w-full h-full")}
                    </div>
                </div>
            `:""}
            ${A.find(c=>c.tmdb_id==r)?.erick_reaction?`
                <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Erick" data-reaction="${A.find(c=>c.tmdb_id==r).erick_reaction}">
                    <img src="moods/${A.find(c=>c.tmdb_id==r).erick_reaction}" class="w-full h-full object-contain drop-shadow-md">
                    <div class="absolute -bottom-1 -right-1 w-4 h-4">
                        ${V("erick","w-full h-full")}
                    </div>
                </div>
            `:""}
        </div>

        <div class="absolute bottom-2 left-2 flex flex-col gap-1 z-10 items-start pointer-events-none">
            <!-- Flairs Container -->
             ${(D.get(A.find(c=>c.tmdb_id==r)?.id)||[]).map(c=>fe(c,"text-[10px] px-1.5 py-0.5 shadow-md")).join("")}
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4">
            <!-- Title removed as per user request -->
        </div>
        <button class="bookmark-icon absolute bottom-2 right-2 text-white text-2xl opacity-0 group-hover:opacity-100 transition-opacity">
            <i class="fas fa-bookmark"></i>
        </button>
    `,s.querySelectorAll(".reaction-item").forEach(c=>{c.addEventListener("mouseenter",u=>{Ct(u.currentTarget)}),c.addEventListener("mouseleave",()=>{Ze()}),c.addEventListener("click",u=>{Cn(u.currentTarget,u)})});const l=s.querySelector(".bookmark-icon");l.addEventListener("click",async c=>{c.stopPropagation();const u=a.includes("image.tmdb.org")?a.replace("https://image.tmdb.org/t/p/w500",""):null,f=await Pe(r,n,t,u);if(!f)return;D.has(f.id)||D.set(f.id,[]);const h=!f.want_to_watch,m={want_to_watch:h};h&&(m.currently_watching=!1);const{error:d}=await y.from("media").update(m).eq("id",item.id);d?console.error("Error updating bookmark from grid:",d):l.classList.toggle("text-accent-primary",h)}),s.addEventListener("click",c=>{console.log("Movie card clicked:",t),St(r,n)}),e.appendChild(s)}async function We(){const{data:e,error:t}=await y.from("media").select("*").eq("currently_watching",!0);if(t)return console.error("Error fetching currently watching media:",t),[];if(!e||e.length===0)return[];const n=e.map(s=>s.id),{data:r,error:a}=await y.from("activity_log").select("media_id, created_at").in("media_id",n).order("created_at",{ascending:!1});if(a)return console.error("Error fetching activity logs for sorting:",a),e;const o={};return r.forEach(s=>{o[s.media_id]||(o[s.media_id]=new Date(s.created_at).getTime())}),e.sort((s,i)=>{const l=o[s.id]||0;return(o[i.id]||0)-l})}async function Ve(){const{data:e,error:t}=await y.from("media").select("*").eq("want_to_watch",!0).order("created_at",{ascending:!1});return t?(console.error("Error fetching want to watch media:",t),[]):e}function re(e,t){const n=document.getElementById(e);if(!n)return;if(n.className="relative group/carousel w-full overflow-hidden",n.innerHTML="",t.length===0){n.innerHTML='<p class="text-text-muted text-center w-full">Nothing here yet!</p>';return}const r=document.createElement("div");r.className="flex gap-4 scroll-smooth pb-4 px-1 scrollbar-hide snap-x snap-mandatory",r.style.cssText="overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; max-width: 100%; width: 100%;";const a=document.createElement("style");a.textContent=`
        #${e} .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    `,n.appendChild(a);const o=document.createElement("div");o.className="absolute left-0 top-0 bottom-0 z-20 flex items-center px-2 opacity-0 group-hover/carousel:opacity-100 transition-opacity";const s=document.createElement("button");s.type="button",s.className="bg-black/50 hover:bg-black/80 text-white p-2 rounded-full cursor-pointer transition-colors",s.innerHTML='<i class="fas fa-chevron-left"></i>',s.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation();const u=r.clientWidth*.8;r.scrollTo({left:r.scrollLeft-u,behavior:"smooth"})}),o.appendChild(s);const i=document.createElement("div");i.className="absolute right-0 top-0 bottom-0 z-20 flex items-center px-2 opacity-0 group-hover/carousel:opacity-100 transition-opacity";const l=document.createElement("button");l.type="button",l.className="bg-black/50 hover:bg-black/80 text-white p-2 rounded-full cursor-pointer transition-colors",l.innerHTML='<i class="fas fa-chevron-right"></i>',l.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation();const u=r.clientWidth*.8;r.scrollTo({left:r.scrollLeft+u,behavior:"smooth"})}),i.appendChild(l),n.appendChild(o),n.appendChild(r),n.appendChild(i),t.forEach(c=>{const u=c.poster_path?`https://image.tmdb.org/t/p/w500${c.poster_path}`:"https://placehold.co/500x750?text=No+Image",f=c.title||c.name,h=c.type||c.media_type,m=c.tmdb_id||c.id,d=document.createElement("div");d.className="flex-shrink-0 w-32 sm:w-36 md:w-44 lg:w-48 movie-card relative rounded-lg shadow-lg overflow-hidden cursor-pointer group snap-start",d.style.cssText="flex-shrink: 0;",d.dataset.tmdbId=m,d.dataset.type=h;let p=c.favorited_by||[];if(typeof p=="string")try{p=JSON.parse(p)}catch{p=[]}const _=p.includes("user1"),T=p.includes("user2");_&&T?d.classList.add("rainbow-glow"):(_||T)&&d.classList.add("favorite-glow"),d.innerHTML=`
            <img src="${u}" alt="${f}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
            <!-- Removed gradient overlay as per request -->
            
            <!-- Reactions Overlay -->
            <div class="absolute top-2 left-2 flex flex-col gap-1 z-10">
                ${c.juainny_reaction?`
                    <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Juainny" data-reaction="${c.juainny_reaction}">
                        <img src="moods/${c.juainny_reaction}" class="w-full h-full object-contain drop-shadow-md">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4">
                            ${V("juainny","w-full h-full")}
                        </div>
                    </div>
                `:""}
                ${c.erick_reaction?`
                    <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Erick" data-reaction="${c.erick_reaction}">
                        <img src="moods/${c.erick_reaction}" class="w-full h-full object-contain drop-shadow-md">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4">
                            ${V("erick","w-full h-full")}
                        </div>
                    </div>
                `:""}
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-2">
                 <!-- Title removed -->
            </div>
            
            <div class="absolute bottom-2 left-2 flex flex-col gap-1 z-10 items-start pointer-events-none">
                <!-- Flairs Container -->
                 ${(D.get(c.id)||[]).map(L=>fe(L,"text-[10px] px-1.5 py-0.5 shadow-md")).join("")}
            </div>
        `,d.querySelectorAll(".reaction-item").forEach(L=>{L.addEventListener("mouseenter",E=>{Ct(E.currentTarget)}),L.addEventListener("mouseleave",()=>{Ze()}),L.addEventListener("click",E=>{Cn(E.currentTarget,E)})}),d.addEventListener("click",()=>St(m,h)),r.appendChild(d)})}let g=null;async function St(e,t){const n=document.getElementById("movie-modal");if(!n)return;let r;document.body.style.overflow="hidden";const a=document.querySelector("footer");a&&a.classList.add("hidden");const o=document.getElementById("tv-progress-section"),s=document.getElementById("tv-warning-section"),i=p=>p?p.watched||p.currently_watching||p.want_to_watch:!1,l=A.find(p=>p.tmdb_id==e),c=i(l);if(console.log("OpenModal - TMDB ID:",e,"Tracked Item:",l,"Is Tracked:",c),t==="tv"||t==="series"){if(o.classList.remove("hidden"),!s){const p=document.createElement("div");p.id="tv-warning-section",p.className="hidden text-center py-8 px-4 bg-yellow-500/10 rounded-lg border border-yellow-500/20 my-4",p.innerHTML=`
                <i class="fas fa-lock text-yellow-500 text-3xl mb-3"></i>
                <p class="text-text-primary font-semibold">Episode Guide Locked</p>
                <p class="text-text-muted text-sm mt-2">You can't see the episode carousel until you add this as "Watched", "Watching", or "Want to Watch".</p>
             `,o.parentNode.insertBefore(p,o.nextSibling)}if(c){o.classList.remove("hidden");const p=document.getElementById("tv-warning-section");p&&p.classList.add("hidden");const L=`https://api.themoviedb.org/3/${t==="movie"?"movie":"tv"}/${e}?api_key=${ye}&append_to_response=credits,images,videos,release_dates,external_ids`,b=await(await fetch(L)).json();await ka(e,b.seasons)}else{o.classList.add("hidden");const p=document.getElementById("tv-warning-section");p&&p.classList.remove("hidden")}}else{o.classList.add("hidden");const p=document.getElementById("tv-warning-section");p&&p.classList.add("hidden")}n.dataset.tmdbId=e;const u=A.find(p=>p.tmdb_id==e)||(g&&g.tmdb_id==e?g:null);if(u){document.getElementById("modal-overview").textContent=u.overview||"Loading...",document.getElementById("modal-title").textContent=u.title||u.name||"Loading...";const p=u.release_date||u.first_air_date||"";document.getElementById("modal-release-year").textContent=p.substring(0,4),n.classList.remove("hidden"),n.classList.remove("modal-hidden"),n.classList.add("flex")}const m=`https://api.themoviedb.org/3/${t==="movie"?"movie":"tv"}/${e}?api_key=${ye}&append_to_response=credits,images,videos,release_dates,external_ids,content_ratings`;let d;try{const p=await fetch(m);if(!p.ok)throw new Error("Failed to fetch modal data.");d=await p.json(),document.getElementById("modal-overview").textContent=d.overview;const _=document.getElementById("modal-title");_.innerHTML="";const T=d.images?.logos?.find(v=>v.iso_639_1==="en"&&!v.file_path.endsWith(".svg"))||d.images?.logos?.[0];if(T){const v=`https://image.tmdb.org/t/p/w500${T.file_path}`;_.innerHTML=`<img src="${v}" alt="${d.title||d.name} Logo" class="max-h-20 object-contain" style="max-width: 14.4rem;">`}else _.textContent=d.title||d.name;const L=d.release_date||d.first_air_date||"",E=u?.release_year||L.substring(0,4);document.getElementById("modal-release-year").textContent=E;let b=u?.runtime||d.runtime||(d.episode_run_time&&d.episode_run_time.length>0?d.episode_run_time[0]:0);t==="tv"&&!b&&(d.last_episode_to_air&&d.last_episode_to_air.runtime?b=d.last_episode_to_air.runtime:d.next_episode_to_air&&d.next_episode_to_air.runtime&&(b=d.next_episode_to_air.runtime)),document.getElementById("modal-runtime").textContent=Sl(b),Al(b);let w=u?.content_rating||"N/A";if(w==="N/A"){if(t==="movie"&&d.release_dates){const v=d.release_dates.results.find(R=>R.iso_3166_1==="US");if(v){const R=v.release_dates.find(C=>C.certification!=="");R&&(w=R.certification)}}else if(t==="tv"&&d.content_ratings&&d.content_ratings.results){const v=d.content_ratings.results.find(R=>R.iso_3166_1==="US");v?w=v.rating:d.content_ratings.results.length>0&&(w=d.content_ratings.results[0].rating)}}document.getElementById("modal-content-rating").textContent=w;const S=document.getElementById("title-tooltip");if(S){const v=u?.title||u?.name||d.title||d.name;S.setAttribute("title",v)}const B=d.external_ids.imdb_id,O=d.vote_average?d.vote_average.toFixed(1):"N/A";document.getElementById("modal-score").textContent=O;const te=document.getElementById("modal-imdb-link");if(B?(te.href=`https://www.imdb.com/title/${B}`,te.style.display="flex"):te.style.display="none",c&&l&&l.id&&l.watched){const v={},R=document.getElementById("willow-summary-section"),C=document.getElementById("willow-summary-text"),K=document.getElementById("regenerate-summary-btn");R.classList.remove("hidden"),C.innerHTML='<i class="fas fa-spinner fa-spin"></i> Loading...';const Y=l.user1_rating||l.user2_rating,J=l.user1_notes&&l.user1_notes.trim()||l.user2_notes&&l.user2_notes.trim();!Y&&!J?(C.innerHTML='<em class="text-text-muted">No ratings or notes yet. Willow will share thoughts once you add some!</em>',K.style.display="none"):(K.style.display="",l.ai_summary?C.innerHTML=ut(l.ai_summary):(async()=>{C.innerHTML='<i class="fas fa-spinner fa-spin"></i> Willow is thinking...';const X=document.querySelector("#juainny-rating-container .stars")?.dataset.rating||l.user1_rating,ie=document.getElementById("juainny-notes").innerText,xt=document.querySelector("#erick-rating-container .stars")?.dataset.rating||l.user2_rating,Mn=document.getElementById("erick-notes").innerText,Rt=await yr(l,{user1:X,user2:xt},{user1:ie,user2:Mn});C.innerHTML=ut(Rt),await y.from("media").update({ai_summary:Rt}).eq("tmdb_id",e),l.ai_summary=Rt})(),K.onclick=async()=>{C.innerHTML='<i class="fas fa-spinner fa-spin"></i> Willow is thinking...';const H=document.querySelector("#juainny-rating-container .stars")?.dataset.rating||l.user1_rating,X=document.getElementById("juainny-notes").innerText,ie=document.querySelector("#erick-rating-container .stars")?.dataset.rating||l.user2_rating,xt=document.getElementById("erick-notes").innerText,at=await yr(l,{user1:H,user2:ie},{user1:X,user2:xt});C.innerHTML=ut(at),await y.from("media").update({ai_summary:at}).eq("tmdb_id",e),l.ai_summary=at})}else document.getElementById("willow-summary-section").classList.add("hidden");if(c&&l&&l.id){const v={};!l.release_year&&E&&(v.release_year=parseInt(E)),!l.runtime&&b&&(v.runtime=b),(!l.content_rating||l.content_rating==="N/A")&&w!=="N/A"&&(v.content_rating=w),!l.imdb_id&&B&&(v.imdb_id=B),Object.keys(v).length>0&&y.from("media").update(v).eq("tmdb_id",e).then(({error:R})=>{R&&console.error("Error auto-saving metadata:",R)})}const xe=d.backdrop_path?`https://image.tmdb.org/t/p/w780${d.backdrop_path}`:"https://placehold.co/800x400?text=No+Image";document.getElementById("modal-backdrop-image").src=xe;const{data:G,error:Re}=await y.from("media").select("*").eq("tmdb_id",e).maybeSingle();Re&&Re.code!=="PGRST116"&&console.error("Error fetching media item for ratings:",Re),g=G||{tmdb_id:e,type:t,title:d.title||d.name,poster_path:d.poster_path,favorited_by:[],watched:!1,juainny_rating:null,erick_rating:null,juainny_notes:null,erick_notes:null},await $n("juainny-rating-container",g?.juainny_rating||0,on),await $n("erick-rating-container",g?.erick_rating||0,on);const et=(v,R)=>{const C=document.getElementById(R);if(C){const K=V(v,"w-10 h-10 mr-3"),Y=document.createElement("div");Y.innerHTML=K;const J=Y.firstElementChild;J.id=R,C.replaceWith(J)}};et("juainny","juainny-avatar"),et("erick","erick-avatar"),sn(g),Ue(g);const xn=(v,R)=>{const C=document.getElementById(R);if(!C)return;const K=C.previousElementSibling;K&&K.classList.contains("notes-toolbar")&&K.remove();const Y=document.createElement("div");Y.className="flex gap-2 mb-2 notes-toolbar",Y.innerHTML=`
                <button type="button" data-format="bold" class="p-2 hover:bg-gray-700 rounded text-white" style="font-weight: bold;">B</button>
                <button type="button" data-format="italic" class="p-2 hover:bg-gray-700 rounded text-white" style="font-style: italic;">I</button>
                <button type="button" data-format="underline" class="p-2 hover:bg-gray-700 rounded text-white" style="text-decoration: underline;">U</button>
            `,C.parentNode.insertBefore(Y,C),Y.querySelectorAll("button").forEach(H=>{H.addEventListener("click",X=>{X.preventDefault();const ie=H.dataset.format;ie==="bold"&&document.execCommand("bold",!1,null),ie==="italic"&&document.execCommand("italic",!1,null),ie==="underline"&&document.execCommand("underline",!1,null),C.focus()})});const J=g?.[`${v}_notes`]||"";C.innerHTML=J};if(xn("juainny","juainny-notes"),xn("erick","erick-notes"),document.getElementById("notes-section").classList.remove("hidden"),G&&d.backdrop_path&&G.backdrop_path!==d.backdrop_path){const{error:v}=await y.from("media").update({backdrop_path:d.backdrop_path}).eq("tmdb_id",e);v&&console.error("Error updating backdrop path:",v)}At();const Rn=document.getElementById("add-mood-btn");Rn&&(Rn.onclick=v=>{v.preventDefault(),Kl(e)});const Bn=document.getElementById("modal-flairs-container");if(Bn){const v=G&&D.get(G.id)||[];Bn.innerHTML=v.map(R=>fe(R,"text-xs px-2 py-1")).join("")}r=document.getElementById("manage-flairs-btn"),r&&(c?(r.classList.remove("hidden"),r.onclick=async v=>{v.preventDefault();const R=await Pe(e,t,d.title||d.name,d.poster_path);R&&Tl(R.id)}):r.classList.add("hidden"));const Aa="45991eb5-21e1-40ee-8bde-5beee11a7dff",Ca=(G&&D.get(G.id)||[]).some(v=>v.id===Aa||v.name==="MCU"),de=document.getElementById("marvel-marathon-display"),tt=document.getElementById("normal-modal-content"),nt=document.getElementById("mood-controls");Ca?(de&&de.classList.remove("hidden"),de&&de.classList.add("flex"),tt&&tt.classList.add("hidden"),nt&&nt.classList.add("hidden")):(de&&de.classList.add("hidden"),de&&de.classList.remove("flex"),tt&&tt.classList.remove("hidden"),nt&&nt.classList.remove("hidden")),n.classList.remove("hidden"),n.classList.remove("modal-hidden"),n.classList.add("flex");const rt=document.getElementById("movie-modal-scrollable-content");if(rt&&r){const v=()=>{rt.scrollTop>20?(r.style.opacity="0",r.style.pointerEvents="none"):(r.style.opacity="1",r.style.pointerEvents="auto")};rt.removeEventListener("scroll",v),rt.addEventListener("scroll",v)}const Dn=document.getElementById("modal-stats-pill");if(Dn){let v=0,R=null;Dn.onclick=async()=>{if(v++,v===1)R=setTimeout(()=>{v=0},500);else if(v===3){clearTimeout(R),v=0;let C=d.runtime||(d.episode_run_time&&d.episode_run_time.length>0?d.episode_run_time[0]:0);t==="tv"&&!C&&(d.last_episode_to_air&&d.last_episode_to_air.runtime?C=d.last_episode_to_air.runtime:d.next_episode_to_air&&d.next_episode_to_air.runtime&&(C=d.next_episode_to_air.runtime));const K=d.release_date||d.first_air_date||"",Y=K?parseInt(K.split("-")[0]):null;let J="N/A";if(t==="movie"&&d.release_dates){const H=d.release_dates.results.find(X=>X.iso_3166_1==="US");if(H){const X=H.release_dates.find(ie=>ie.certification!=="");X&&(J=X.certification)}}else if(t==="tv"&&d.content_ratings&&d.content_ratings.results){const H=d.content_ratings.results.find(X=>X.iso_3166_1==="US");H?J=H.rating:d.content_ratings.results.length>0&&(J=d.content_ratings.results[0].rating)}if(confirm(`Update database with:
Year: ${Y}
Runtime: ${C}m
Rating: ${J}`)){const{error:H}=await y.from("media").update({release_year:Y,runtime:C,content_rating:J}).eq("tmdb_id",e);H?(alert("Failed to update stats."),console.error(H)):alert("Updated database with runtime, year date, and rating.")}}}}}catch(p){console.error("Error opening movie modal:",p)}}async function Tl(e){const t=document.getElementById("flair-modal"),n=document.getElementById("close-flair-modal-btn"),r=document.getElementById("current-flairs-list"),a=document.getElementById("available-flairs-list"),o=document.getElementById("toggle-create-flair-btn"),s=document.getElementById("create-flair-form"),i=document.getElementById("save-new-flair-btn");if(!t)return;s.classList.add("hidden");const l=document.getElementById("delete-flair-btn"),c=document.getElementById("cancel-edit-flair-btn"),u=document.getElementById("flair-form-title"),f=document.getElementById("edit-flair-id"),h=document.getElementById("new-flair-name"),m=document.getElementById("new-flair-color"),d=document.getElementById("new-flair-icon"),p=()=>{s.classList.add("hidden"),f.value="",h.value="",m.value="#ef4444",d.value="",u.textContent="NEW FLAIR",i.textContent="Create Flair",l.classList.add("hidden"),c.classList.add("hidden")},_=()=>{r.innerHTML="";const T=D.get(e)||[];T.forEach(L=>{const E=document.createElement("div");E.className="relative group cursor-pointer",E.innerHTML=fe(L,"text-sm px-3 py-1");const b=document.createElement("div");b.className="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs",b.innerHTML='<i class="fas fa-times"></i>',b.onclick=async w=>{w.stopPropagation(),await vl(e,L.id);const S=D.get(e).filter(O=>O.id!==L.id);D.set(e,S),_(),W();const B=document.getElementById("modal-flairs-container");B&&(B.innerHTML=S.map(O=>fe(O,"text-xs px-2 py-1")).join(""))},E.appendChild(b),r.appendChild(E)}),a.innerHTML="",ve.forEach(L=>{if(T.find(S=>S.id===L.id))return;const E=document.createElement("div");E.className="flex items-center gap-2 group";const b=document.createElement("div");b.className="cursor-pointer hover:opacity-80",b.innerHTML=fe(L,"text-sm px-3 py-1"),b.onclick=async()=>{if(T.length>=2){alert("Max 2 flairs per item!");return}const S=await wl(e,L.id);if(S.success){D.has(e)||D.set(e,[]),D.get(e).push(L),_(),W();const B=document.getElementById("modal-flairs-container");if(B){const O=D.get(e);B.innerHTML=O.map(te=>fe(te,"text-xs px-2 py-1")).join("")}}else alert(S.message)};const w=document.createElement("button");w.className="text-xs text-text-muted hover:text-accent-primary opacity-0 group-hover:opacity-100 transition-opacity",w.innerHTML='<i class="fas fa-pencil-alt"></i>',w.onclick=S=>{S.stopPropagation(),f.value=L.id,h.value=L.name,m.value=L.color,d.value=L.icon||"",u.textContent="EDIT FLAIR",i.textContent="Update Flair",l.classList.remove("hidden"),c.classList.remove("hidden"),s.classList.remove("hidden")},E.appendChild(b),E.appendChild(w),a.appendChild(E)})};_(),n.onclick=()=>{t.classList.add("hidden"),t.classList.add("modal-hidden"),p()},t.onclick=T=>{T.target===t&&(t.classList.add("hidden"),t.classList.add("modal-hidden"),p())},o.onclick=()=>{!s.classList.contains("hidden")&&!f.value?s.classList.add("hidden"):(p(),s.classList.remove("hidden"))},c.onclick=()=>{p()},l.onclick=async()=>{const T=f.value;if(T&&confirm("Are you sure you want to delete this flair? This will remove it from all media items."))if(await deleteFlair(T)){ve=ve.filter(E=>E.id!==T);for(let[E,b]of D)D.set(E,b.filter(w=>w.id!==T));p(),_(),W()}else alert("Failed to delete flair.")},i.onclick=async()=>{const T=h.value.trim(),L=m.value,E=d.value.trim(),b=f.value;if(!T){alert("Name is required");return}if(b){const w=await updateFlair(b,{name:T,color:L,icon:E});if(w){const S=ve.findIndex(xe=>xe.id===b);S!==-1&&(ve[S]=w);for(let[xe,G]of D){const Re=G.findIndex(et=>et.id===b);Re!==-1&&(G[Re]=w)}p(),_(),W();const[B,O]=await Promise.all([We(),Ve()]);re("currently-watching-carousel",B),re("want-to-watch-carousel",O);const te=document.getElementById("modal-flairs-container");if(te){const xe=D.get(e)||[];te.innerHTML=xe.map(G=>fe(G,"text-xs px-2 py-1")).join("")}}else alert("Failed to update flair.")}else{const w=await bl({name:T,color:L,icon:E});w?(ve.push(w),p(),_()):alert("Failed to create flair.")}},t.classList.remove("hidden"),t.classList.remove("modal-hidden"),t.classList.add("flex")}function Ll(){const e=document.getElementById("close-modal-btn"),t=document.getElementById("movie-modal"),n=()=>{t.classList.add("hidden"),t.classList.add("modal-hidden"),t.classList.remove("flex"),document.body.style.overflow="";const r=document.querySelector("footer");r&&r.classList.remove("hidden");const a=document.getElementById("iron-man-walker");a&&(a.classList.remove("walk"),a.classList.add("hidden"))};e&&(e.onclick=n),t&&(t.onclick=r=>{r.target===t&&n()})}function Sl(e){if(!e||e===0)return"N/A";const t=Math.floor(e/60),n=e%60;let r="";return t>0&&(r+=`${t}h `),n>0&&(r+=`${n}m`),r.trim()}function Al(e){const t=document.getElementById("start-time-hour"),n=document.getElementById("start-time-minute"),r=document.getElementById("end-time"),a=document.getElementById("end-time-calculator");if(!e||e===0){a.classList.add("hidden");return}a.classList.remove("hidden");let o=new Date,s=o.getHours(),i=o.getMinutes();const l=()=>{const c=new Date;c.setHours(s,i,0,0),c.setMinutes(c.getMinutes()+e);const u=c.getHours().toString().padStart(2,"0"),f=c.getMinutes().toString().padStart(2,"0");r.textContent=`${u}:${f}`,t.textContent=s.toString().padStart(2,"0"),n.textContent=i.toString().padStart(2,"0")};t.onclick=()=>{s=(s+1)%24,l()},n.onclick=()=>{i=(i+1)%60,l()},l()}let N=[],je=[],F=1,he=!1,Ia=null,ae=null;async function ka(e,t){const n=document.getElementById("tv-progress-container");n.innerHTML='<div class="text-center">Loading progress...</div>',je=t.filter(r=>r.season_number>0&&r.episode_count>0),Ia=e;try{const{data:r,error:a}=await y.from("media").select("id").eq("tmdb_id",e).single();if(a){console.log("Media not in DB. Executing Plan 2: Fetch and Save.");try{const i=await fetch(`https://api.themoviedb.org/3/tv/${e}?api_key=${ye}&append_to_response=content_ratings`);if(!i.ok)throw new Error("Failed to fetch TV details from TMDB");const l=await i.json(),c=l.first_air_date?parseInt(l.first_air_date.split("-")[0]):null;let u="N/A";if(l.content_ratings&&l.content_ratings.results){const m=l.content_ratings.results.find(d=>d.iso_3166_1==="US");m?u=m.rating:l.content_ratings.results.length>0&&(u=l.content_ratings.results[0].rating)}const{data:f,error:h}=await y.from("media").insert({tmdb_id:e,type:"series",title:l.name,poster_path:l.poster_path,backdrop_path:l.backdrop_path,release_year:c,source:"fetched",runtime:l.episode_run_time?.[0]||0,content_rating:u}).select("id").single();if(h)throw h;ae=f.id,console.log("Plan 2 Successful: Media saved to DB with ID:",ae)}catch(i){console.error("Plan 2 Failed:",i),n.innerHTML=`
                    <div class="text-center py-8 px-4">
                        <i class="fas fa-exclamation-circle text-danger text-3xl mb-3"></i>
                        <p class="text-text-muted">Failed to sync TV show data.</p>
                        <p class="text-text-muted text-sm mt-2">Please try adding it to your watchlist manually first.</p>
                    </div>
                `;return}}else ae=r.id;const[o,s]=await Promise.all([y.from("episode_progress").select("*").eq("media_id",ae).eq("viewer","user1"),y.from("episode_progress").select("*").eq("media_id",ae).eq("viewer","user2")]);if(o.error)throw o.error;if(s.error)throw s.error;if(N=[...o.data||[],...s.data||[]],n.innerHTML=`
            <div class="flex justify-between items-center sticky top-0 z-40 bg-bg-tertiary/95 backdrop-blur-md py-3 px-4 border-b border-white/5 mb-4 rounded-t-lg">
                <div class="relative group">
                    <select id="season-select" class="appearance-none bg-black/20 hover:bg-black/40 text-text-primary py-2 pl-4 pr-10 rounded-full font-semibold focus:outline-none focus:ring-2 focus:ring-accent-primary cursor-pointer transition-all border border-white/10">
                        ${je.map(i=>`<option value="${i.season_number}">Season ${i.season_number}</option>`).join("")}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-text-muted group-hover:text-text-primary transition-colors">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                     <button id="mark-season-watched-btn" class="text-xs py-2 px-4 rounded-full bg-accent-secondary/20 text-accent-secondary hover:bg-accent-secondary hover:text-white border border-accent-secondary/50 transition font-semibold flex items-center gap-2">
                        <i class="fas fa-check"></i> Season Watched
                    </button>
                    <button id="edit-episodes-btn" class="text-text-muted hover:text-text-primary transition p-2 rounded-full hover:bg-white/10" title="Edit Watched Status">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
            </div>

            <div id="episodes-carousel-wrapper" class="relative pb-4" style="overflow: hidden;">
                <!-- Episodes carousel will be loaded here -->
                <div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-accent-primary mx-auto"></div></div>
            </div>
        `,document.getElementById("season-select").addEventListener("change",i=>{F=parseInt(i.target.value),vt(F)}),document.getElementById("mark-season-watched-btn").addEventListener("click",()=>Cl()),document.getElementById("edit-episodes-btn").addEventListener("click",Rl),je.length>0){let i=je[0].season_number;const{data:l}=await y.from("activity_log").select("details").eq("media_id",ae).eq("action_type","watched_episode").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(l&&l.details&&l.details.season){const u=l.details.season;je.some(f=>f.season_number===u)&&(i=u)}F=i;const c=document.getElementById("season-select");c&&(c.value=F),await vt(F)}else n.innerHTML='<div class="text-center">No seasons found.</div>'}catch(r){console.error("Error rendering TV progress:",r),n.innerHTML='<div class="text-center text-danger">Failed to load progress.</div>'}}async function vt(e){const t=document.getElementById("episodes-carousel-wrapper");if(t){t.innerHTML='<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-accent-primary mx-auto"></div></div>';try{const n=await fetch(`https://api.themoviedb.org/3/tv/${Ia}/season/${e}?api_key=${ye}`);if(!n.ok)throw new Error("Failed to fetch season details");const r=await n.json();if(!r||!r.episodes){t.innerHTML='<div class="text-center">No episodes found.</div>';return}t.innerHTML=`
            <div class="episodes-carousel-container relative px-2 sm:px-12" style="position: relative;">
                <button class="episodes-nav-btn episodes-nav-left absolute left-0 sm:left-2 top-1/2 -translate-y-1/2 z-10 bg-black/70 hover:bg-black/90 text-white p-2 sm:p-3 rounded-full transition-all shadow-lg hidden sm:block" style="position: absolute;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="episodes-carousel" class="flex overflow-x-auto gap-3 sm:gap-4 pb-4 px-1 sm:px-2 scroll-smooth snap-x snap-mandatory" style="touch-action: pan-x; overscroll-behavior-x: contain; overscroll-behavior-y: none;">
                    <!-- Episodes will be inserted here -->
                </div>
                <button class="episodes-nav-btn episodes-nav-right absolute right-0 sm:right-2 top-1/2 -translate-y-1/2 z-10 bg-black/70 hover:bg-black/90 text-white p-2 sm:p-3 rounded-full transition-all shadow-lg hidden sm:block" style="position: absolute;">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;const a=document.getElementById("episodes-carousel");a.addEventListener("wheel",i=>{if(Math.abs(i.deltaY)>Math.abs(i.deltaX)){const c=i.deltaY;a.scrollLeft+=c,i.preventDefault(),i.stopPropagation()}else i.stopPropagation()},{passive:!1}),r.episodes.forEach(i=>{const l=N.some(d=>d.season_number===e&&d.episode_number===i.episode_number&&d.viewer==="user1"&&d.watched),c=N.some(d=>d.season_number===e&&d.episode_number===i.episode_number&&d.viewer==="user2"&&d.watched),u=l&&c,f=i.still_path?`https://image.tmdb.org/t/p/w500${i.still_path}`:"https://placehold.co/500x281?text=No+Image",h=document.createElement("div");h.className=`episode-card flex-shrink-0 w-[calc(100vw-4rem)] sm:w-72 md:w-80 relative rounded-lg overflow-hidden shadow-md bg-bg-primary cursor-pointer snap-start ${u&&he?"shake":""}`,h.style.maxWidth="400px",h.dataset.episodeNumber=i.episode_number,h.dataset.seasonNumber=e,h.innerHTML=`
                <div class="relative aspect-video">
                    <img src="${f}" alt="${i.name}" class="w-full h-full object-cover transition-opacity duration-300 ${u?"opacity-50":"opacity-100"}">
                    <div class="absolute top-0 left-0 bg-black/80 text-white text-xs font-bold px-2 py-1 rounded-br-lg z-20">
                        E${i.episode_number}
                    </div>
                    ${u?`
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                            <i class="fas fa-check text-success text-4xl drop-shadow-lg"></i>
                        </div>
                    `:""}
                    <button class="unwatch-btn absolute top-2 right-2 bg-danger text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-700 transition z-30 ${u&&he?"":"hidden"}">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <div class="p-3">
                    <h4 class="font-semibold text-sm truncate" title="${i.name}">${i.name}</h4>
                    <p class="text-xs text-text-muted line-clamp-2 mt-1">${i.overview||"No description available."}</p>
                </div>
            `,h.addEventListener("click",d=>{d.target.closest(".unwatch-btn")||he||u||br(e,i.episode_number,!0)}),h.querySelector(".unwatch-btn").addEventListener("click",d=>{d.stopPropagation(),br(e,i.episode_number,!1)}),a.appendChild(h)});const o=t.querySelector(".episodes-nav-left"),s=t.querySelector(".episodes-nav-right");o.addEventListener("click",()=>{a.scrollBy({left:-a.clientWidth,behavior:"smooth"})}),s.addEventListener("click",()=>{a.scrollBy({left:a.clientWidth,behavior:"smooth"})}),Ta(r.episodes.length)}catch(n){console.error("Error rendering season episodes:",n),t.innerHTML='<div class="text-center text-danger">Failed to load episodes.</div>'}}}async function br(e,t,n){["user1","user2"].forEach(o=>{const s=N.findIndex(i=>i.season_number===e&&i.episode_number===t&&i.viewer===o);s>=0?N[s].watched=n:N.push({media_id:ae,season_number:e,episode_number:t,watched:n,viewer:o})}),Bl(e,t,n),Ta(document.querySelectorAll(".episode-card").length);const r=["user1","user2"].map(o=>({media_id:ae,viewer:o,season_number:e,episode_number:t,watched:n})),{error:a}=await y.from("episode_progress").upsert(r,{onConflict:"media_id,viewer,season_number,episode_number"});a?(console.error("Error updating episode progress:",a),vt(F)):n&&await oe("watched_episode","both",g,{season:e,episode:t})}async function Cl(){const e=document.querySelectorAll(".episode-card");if(e.length===0)return;const n=!Array.from(e).every(o=>{const s=parseInt(o.dataset.episodeNumber),i=N.some(c=>c.season_number===F&&c.episode_number===s&&c.viewer==="user1"&&c.watched),l=N.some(c=>c.season_number===F&&c.episode_number===s&&c.viewer==="user2"&&c.watched);return i&&l}),r=[];e.forEach(o=>{const s=parseInt(o.dataset.episodeNumber);["user1","user2"].forEach(i=>{const l=N.findIndex(c=>c.season_number===F&&c.episode_number===s&&c.viewer===i);l>=0?N[l].watched=n:N.push({media_id:ae,season_number:F,episode_number:s,watched:n,viewer:i}),r.push({media_id:ae,viewer:i,season_number:F,episode_number:s,watched:n})})}),vt(F);const{error:a}=await y.from("episode_progress").upsert(r,{onConflict:"media_id,viewer,season_number,episode_number"});a&&console.error("Error updating season progress:",a)}async function xl(e){try{const{data:t,error:n}=await y.from("media").select("id").eq("tmdb_id",e).single();if(n)throw console.error("Error fetching media for markAllEpisodesWatched:",n),new Error("Could not find media in database");const r=t.id,a=await fetch(`https://api.themoviedb.org/3/tv/${e}?api_key=${ye}`);if(!a.ok)throw new Error("Failed to fetch TV series details");const o=await a.json(),s=[];for(const i of o.seasons)if(i.season_number>0&&i.episode_count>0){const l=await fetch(`https://api.themoviedb.org/3/tv/${e}/season/${i.season_number}?api_key=${ye}`);if(!l.ok)throw new Error(`Failed to fetch season ${i.season_number} details`);(await l.json()).episodes.forEach(u=>{["user1","user2"].forEach(f=>{s.push({media_id:r,viewer:f,season_number:i.season_number,episode_number:u.episode_number,watched:!0})})})}if(s.length>0){const{error:i}=await y.from("episode_progress").upsert(s,{onConflict:"media_id,viewer,season_number,episode_number"});i?console.error("Error marking all episodes watched:",i):(console.log("All episodes marked as watched successfully."),await ka(e,o.seasons))}}catch(t){console.error("Error in markAllEpisodesWatched:",t)}}function Rl(){he=!he;const e=document.getElementById("edit-episodes-btn");he?e.classList.add("text-accent-primary","animate-pulse"):e.classList.remove("text-accent-primary","animate-pulse"),document.querySelectorAll(".episode-card").forEach(n=>{const r=parseInt(n.dataset.episodeNumber),a=parseInt(n.dataset.seasonNumber),o=N.some(c=>c.season_number===a&&c.episode_number===r&&c.viewer==="user1"&&c.watched),s=N.some(c=>c.season_number===a&&c.episode_number===r&&c.viewer==="user2"&&c.watched),i=o&&s,l=n.querySelector(".unwatch-btn");i&&he?(n.classList.add("shake"),l.classList.remove("hidden")):(n.classList.remove("shake"),l.classList.add("hidden"))})}function Bl(e,t,n){const r=document.querySelector(`.episode-card[data-season-number="${e}"][data-episode-number="${t}"]`);if(!r)return;const a=r.querySelector("img"),o=r.querySelector(".fa-check")?.parentElement,s=r.querySelector(".unwatch-btn");if(n){if(a.classList.remove("opacity-100"),a.classList.add("opacity-50"),!o){const i=document.createElement("div");i.className="absolute inset-0 flex items-center justify-center pointer-events-none",i.innerHTML='<i class="fas fa-check text-success text-4xl drop-shadow-lg"></i>',r.querySelector(".aspect-video").appendChild(i)}he&&(r.classList.add("shake"),s.classList.remove("hidden"))}else a.classList.remove("opacity-50"),a.classList.add("opacity-100"),o&&o.remove(),r.classList.remove("shake"),s.classList.add("hidden")}function Ta(e){const t=document.getElementById("mark-season-watched-btn");if(!t)return;[...new Set(N.filter(a=>a.season_number===F&&a.watched).map(a=>a.episode_number))].filter(a=>{const o=N.some(i=>i.season_number===F&&i.episode_number===a&&i.viewer==="user1"&&i.watched),s=N.some(i=>i.season_number===F&&i.episode_number===a&&i.viewer==="user2"&&i.watched);return o&&s}).length===e&&e>0?(t.textContent="Season Watched",t.classList.remove("bg-accent-secondary"),t.classList.add("bg-success")):(t.textContent="Mark Season Watched",t.classList.remove("bg-success"),t.classList.add("bg-accent-secondary","text-white"),t.classList.remove("text-accent-secondary"))}function La(e,t){let n;return function(...r){const a=this;clearTimeout(n),n=setTimeout(()=>e.apply(a,r),t)}}const on=La(Dl,500);async function Dl(){const t=document.getElementById("movie-modal").dataset.tmdbId;if(!t){console.error("saveRatingsAndNotes: tmdbId not found on modal");return}const n=document.querySelector("#juainny-rating-container .rating-input-hidden").value,r=document.querySelector("#erick-rating-container .rating-input-hidden").value,a={juainny_rating:parseFloat(n)||null,juainny_notes:document.getElementById("juainny-notes").innerHTML||null,erick_rating:parseFloat(r)||null,erick_notes:document.getElementById("erick-notes").innerHTML||null};if(!t){console.error("saveRatingsAndNotes: tmdbId is missing!");return}const{data:o,error:s}=await y.from("media").select("tmdb_id").eq("tmdb_id",t).single();if(s&&s.code!=="PGRST116"){console.error("Error checking for existing media:",s);return}let i;if(o)i=await y.from("media").update(a).eq("tmdb_id",t).select().single();else{console.log("Ratings and notes not saved: item not in database. Add to watchlist first.");return}const{data:l,error:c}=i;c?console.error("Error saving ratings and notes:",c):(g&&(a.juainny_rating!==g.juainny_rating&&a.juainny_rating!==null&&await oe("rate","juainny",l,{rating:a.juainny_rating}),a.juainny_notes!==g.juainny_notes&&a.juainny_notes!==""&&await oe("note_added","juainny",l),a.erick_rating!==g.erick_rating&&a.erick_rating!==null&&await oe("rate","erick",l,{rating:a.erick_rating}),a.erick_notes!==g.erick_notes&&a.erick_notes!==""&&await oe("note_added","erick",l)),g=l)}function Ml(){["juainny-notes","erick-notes"].forEach(t=>{const n=document.getElementById(t);n&&n.addEventListener("input",on)})}function $l(){const e=document.getElementById("random-movie-btn");e&&e.addEventListener("click",()=>{if(P.length===0){console.log("No movies to choose from!");return}const t=P[Math.floor(Math.random()*P.length)],n=t.tmdb_id||t.id,r=t.type||t.media_type;St(n,r)})}function Ol(){switch(wt){case"popularity":P.sort((n,r)=>r.popularity-n.popularity);break;case"alphabetical":P.sort((n,r)=>(n.title||n.name).localeCompare(r.title||r.name));break;case"release_date":P.sort((n,r)=>{const a=new Date(n.release_date||n.first_air_date);return new Date(r.release_date||r.first_air_date)-a});break;case"length":P.sort((n,r)=>(r.runtime||r.episode_run_time?.[0]||0)-(n.runtime||n.episode_run_time?.[0]||0));break;case"default":default:const e=P.filter(n=>n.source==="fetched").sort((n,r)=>n.id-r.id);P=[...P.filter(n=>n.source!=="fetched").sort((n,r)=>{const a=new Date(n.release_date||n.first_air_date);return new Date(r.release_date||r.first_air_date)-a}),...e];break}}function Pl(){document.getElementById("sort-select").addEventListener("change",t=>{wt=t.target.value,W()})}function Nl(){const e=document.getElementById("filter-controls");e.addEventListener("click",t=>{if(t.target.matches(".filter-btn")){const n=t.target.dataset.filter;if(n===ne)return;ne=n,e.querySelectorAll(".filter-btn").forEach(r=>{r.classList.remove("btn-active")}),t.target.classList.add("btn-active"),W()}})}function sn(e){const t=document.querySelector(".movie-modal-content"),n=document.querySelector(`.movie-card[data-tmdb-id="${e.tmdb_id}"]`),r=e.favorited_by||[],a=r.includes("user1"),o=r.includes("user2");[t,n].forEach(s=>{s&&(s.classList.remove("favorite-glow","rainbow-glow"),a&&o?s.classList.add("rainbow-glow"):(a||o)&&s.classList.add("favorite-glow"))})}async function oe(e,t,n,r={}){try{if(!n||!n.id){console.warn("Cannot log activity: Missing media ID");return}const{error:a}=await y.from("activity_log").insert({media_id:n.id,tmdb_id:n.tmdb_id,action_type:e,user_id:t,details:r});a?console.error("Error logging activity:",a):console.log(`Activity logged: ${e} by ${t}`)}catch(a){console.error("Unexpected error logging activity:",a)}}function Fl(){const e=document.getElementById("favorite-btn"),t=document.getElementById("user-selection-menu");e.addEventListener("click",()=>{t.classList.toggle("hidden")}),t.addEventListener("click",async n=>{if(n.target.matches("button")){const r=n.target.id.replace("-btn",""),a=g.tmdb_id,o=g.type||g.media_type,s=g.title||g.name,i=g.poster_path,l=await Pe(a,o,s,i);if(!l){console.error("Failed to ensure media item exists"),t.classList.add("hidden");return}if(r==="remove-all"){const{error:c}=await y.from("media").update({favorited_by:[]}).eq("tmdb_id",a);c?console.error("Error removing all favorites:",c):(g.favorited_by=[],sn(g))}else{const c=r,u=c==="user1"?"juainny":"erick",{data:f,error:h}=await y.from("media").select("id, tmdb_id, title, poster_path, favorited_by").contains("favorited_by",[c]);if(h){console.error("Error checking favorite count:",h),t.classList.add("hidden");return}if(f&&f.length>=3&&!f.some(T=>T.tmdb_id===a)){const T=await jl(f);if(!T){t.classList.add("hidden");return}const L=f.find(E=>E.tmdb_id===T);if(L){const E=(L.favorited_by||[]).filter(w=>w!==c);await y.from("media").update({favorited_by:E}).eq("tmdb_id",T);const b=A.findIndex(w=>w.tmdb_id==T);b>-1&&(A[b].favorited_by=E)}}let m=l.favorited_by||[];if(typeof m=="string")try{m=JSON.parse(m)}catch{m=[]}m.includes(c)?m=m.filter(_=>_!==c):m.push(c);const{data:d,error:p}=await y.from("media").update({favorited_by:m}).eq("tmdb_id",a).select().single();if(p)console.error("Error updating favorites:",p);else{g=d,sn(g);const _=A.findIndex(T=>T.tmdb_id===a);_>-1&&(A[_]=d),m.includes(c)&&await oe("favorite",u,d)}}W(),t.classList.add("hidden")}})}async function jl(e,t){return new Promise(n=>{const r=document.getElementById("favorite-removal-modal"),a=document.getElementById("favorite-removal-list"),o=document.getElementById("cancel-favorite-removal-btn");a.innerHTML="",e.forEach(i=>{const l=document.createElement("div");l.className="flex items-center gap-3 p-3 rounded-lg border border-border-primary hover:bg-bg-tertiary cursor-pointer transition";const c=i.poster_path?`https://image.tmdb.org/t/p/w92${i.poster_path}`:"https://placehold.co/92x138?text=No+Image";l.innerHTML=`
                <img src="${c}" class="w-12 h-18 object-cover rounded" alt="${i.title}">
                <span class="flex-grow text-text-primary font-semibold">${i.title}</span>
                <button class="remove-favorite-btn text-danger hover:text-red-400 px-3 py-1 border border-danger rounded transition" data-tmdb-id="${i.tmdb_id}">
                    <i class="fas fa-times"></i> Remove
                </button>
            `,l.querySelector(".remove-favorite-btn").addEventListener("click",()=>{r.classList.add("hidden"),r.classList.remove("flex"),n(i.tmdb_id)}),a.appendChild(l)});const s=()=>{r.classList.add("hidden"),r.classList.remove("flex"),n(null)};o.removeEventListener("click",s),o.addEventListener("click",s),r.classList.remove("hidden"),r.classList.add("flex")})}function Ue(e){const t=document.getElementById("toggle-watched-btn"),n=document.getElementById("currently-watching-btn"),r=document.getElementById("remove-currently-watching-btn"),a=document.getElementById("bookmark-btn");n.classList.add("hidden"),r.classList.add("hidden"),t.classList.remove("hidden"),e.watched?(t.textContent="Mark as Unwatched",t.classList.replace("bg-success","bg-gray-600")):e.currently_watching?(t.textContent="Mark as Watched",t.classList.replace("bg-gray-600","bg-success"),r.classList.remove("hidden")):(t.textContent="Mark as Watched",t.classList.replace("bg-gray-600","bg-success"),n.classList.remove("hidden")),e.want_to_watch?a.classList.add("text-accent-primary"):a.classList.remove("text-accent-primary")}async function Pe(e,t,n,r=null){let a=t;a==="tv"&&(a="series");let{data:o,error:s}=await y.from("media").select("*").eq("tmdb_id",e).single();if(s&&s.code!=="PGRST116")return console.error("Error checking for media item:",s),null;if(o){if(r&&!o.poster_path){const{data:c,error:u}=await y.from("media").update({poster_path:r}).eq("tmdb_id",e).select().single();return u?(console.error("Error updating poster path:",u),o):c}return o}const{data:i,error:l}=await y.from("media").insert({tmdb_id:e,type:a,title:n,poster_path:r,source:"added"}).select().single();return l?(console.error("Error creating new media item:",l),null):i}function Hl(){const e=document.getElementById("toggle-watched-btn"),t=document.getElementById("toggle-rejected-btn"),n=document.getElementById("currently-watching-btn"),r=document.getElementById("remove-currently-watching-btn"),a=document.getElementById("bookmark-btn"),o=async s=>{const{tmdb_id:i,type:l,title:c,poster_path:u}=g;if(!await Pe(i,l,c,u))return;if((l==="tv"||l==="series")&&!g.watched&&!s){const _=await Jl("Mark Series Watched?","How would you like to mark this series?");if(_==="cancel")return;_==="all-episodes"&&await xl(i)}const h=s?!1:!g.watched;let m={watched:h};s&&(m.currently_watching=!1,m.source=null),h&&(m.currently_watching=!1,m.want_to_watch=!1);const{data:d,error:p}=await y.from("media").update(m).eq("tmdb_id",i).select().single();if(p)console.error("Error updating watched status:",p);else{g=d,Ue(g);const _=A.findIndex(T=>T.tmdb_id===i);_>-1?A[_]=d:A.push(d),h&&!s&&await oe("watched","both",d),W()}};r.addEventListener("click",async()=>{const{tmdb_id:s}=g,{data:i,error:l}=await y.from("media").update({currently_watching:!1}).eq("tmdb_id",s).select().single();l?console.error("Error removing from currently watching:",l):(g=i,Ue(g))}),n.addEventListener("click",async()=>{const{tmdb_id:s,type:i,title:l,poster_path:c}=g;if(!await Pe(s,i,l,c))return;const f={currently_watching:!0,want_to_watch:!1,watched:!1},{data:h,error:m}=await y.from("media").update(f).eq("tmdb_id",s).select().single();m?console.error("Error setting currently watching:",m):(g=h,Ue(g),await oe("currently_watching","both",h))}),a.addEventListener("click",async()=>{const{tmdb_id:s,type:i,title:l,poster_path:c}=g;if(!await Pe(s,i,l,c))return;const f=!g.want_to_watch;let h={want_to_watch:f};f&&(h.currently_watching=!1);const{data:m,error:d}=await y.from("media").update(h).eq("tmdb_id",s).select().single();d?console.error("Error updating bookmark:",d):(g=m,Ue(g),f&&await oe("want_to_watch","both",m))}),e.addEventListener("click",()=>o(!1)),t.addEventListener("click",()=>o(!0))}function Ul(){const e=document.getElementById("tooltip");document.addEventListener("mouseover",t=>{if(t.target.matches("[title]")){const n=t.target.getAttribute("title");t.target.setAttribute("data-original-title",n),t.target.removeAttribute("title"),e.textContent=n,e.classList.remove("hidden");const r=t.target.getBoundingClientRect();e.style.left=`${r.left+r.width/2-e.offsetWidth/2}px`,e.style.top=`${r.top-e.offsetHeight-5}px`}}),document.addEventListener("mouseout",t=>{t.target.matches("[data-original-title]")&&(t.target.setAttribute("title",t.target.getAttribute("data-original-title")),t.target.removeAttribute("data-original-title"),e.classList.add("hidden"))})}function ql(){const e=document.getElementById("view-controls");e.addEventListener("click",t=>{const n=t.target.closest(".view-btn");if(n){const r=n.dataset.view;if(r===an)return;an=r,e.querySelectorAll(".view-btn").forEach(a=>{a.classList.remove("btn-active")}),n.classList.add("btn-active"),W()}})}async function Wl(){try{console.log("App Initializing... v2.1"),ve=await gl();const{data:e,error:t}=await y.from("media_flairs").select("media_id, flairs(*)");!t&&e&&e.forEach(b=>{D.has(b.media_id)||D.set(b.media_id,[]),D.get(b.media_id).push(b.flairs)});const n=await We();re("currently-watching-carousel",n);const r=await Ve();re("want-to-watch-carousel",r),y.channel("media-carousels").on("postgres_changes",{event:"*",schema:"public",table:"media"},async b=>{const[w,S]=await Promise.all([We(),Ve()]);re("currently-watching-carousel",w),re("want-to-watch-carousel",S)}).subscribe(),y.channel("media").on("postgres_changes",{event:"*",schema:"public",table:"media"},async b=>{const[w,S]=await Promise.all([We(),Ve()]);re("currently-watching-carousel",w),re("want-to-watch-carousel",S)}).subscribe(),new URLSearchParams(window.location.search).get("hardrefresh")==="true"&&(await ml(),window.history.replaceState({},document.title,window.location.pathname));const s=document.getElementById("loading-spinner");s&&(s.style.display="flex");const{data:i,error:l}=await y.from("media").select("*");if(l){console.error("Error fetching all media:",l);return}A=await El(i),Oe=A.filter(b=>b.watched),W(),s&&(s.style.display="none");const c=document.getElementById("search-bar");c.setAttribute("autocomplete","off"),c.setAttribute("data-lpignore","true"),c.setAttribute("data-form-type","other"),c.setAttribute("spellcheck","false");const u=document.getElementById("sort-select"),f=document.getElementById("home-btn"),h=document.getElementById("logo-container"),m=document.getElementById("currently-watching-section"),d=document.getElementById("want-to-watch-section"),p=()=>{c.value="",Oe=A,ne="watched",u.value="default",wt="default",u.disabled=!1,f.classList.add("hidden"),m.classList.remove("hidden"),d.classList.remove("hidden");const b=document.getElementById("watched-items-header");b&&b.classList.remove("hidden"),W(),cn()},T=La(async b=>{console.log("Search input event:",b.target.value);try{const w=b.target.value.trim();if(w==="")p();else{f.classList.remove("hidden"),m.classList.add("hidden"),d.classList.add("hidden");const S=document.getElementById("watched-items-header");S&&S.classList.add("hidden"),console.log("Executing search for:",w),Oe=await Il(w),wt="popularity",ne="all",u.disabled=!0,W()}}catch(w){console.error("Error in search handler:",w)}},300);c.addEventListener("input",T),f.addEventListener("click",p),h.addEventListener("click",p),Ll(),Ml(),Nl(),ql(),$l(),Ul(),Fl(),Hl(),Pl(),Na(),await Je(),Vl(),zl(),cn();const L=document.getElementById("notification-btn");L&&L.addEventListener("click",()=>{alert("Notifications Coming Soon!")});const E=document.getElementById("avatar-toggle");E&&E.addEventListener("change",b=>{document.body.classList.toggle("show-avatars",b.target.checked)}),ft(),document.addEventListener("click",b=>{const w=document.getElementById("reaction-tooltip");w&&!w.classList.contains("hidden")&&(b.target.closest(".reaction-item")||Ze())})}catch(e){console.error("Error during app initialization:",e)}}function Vl(){const e=document.getElementById("user-menu-btn"),t=document.getElementById("user-menu");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("hidden")})}function zl(){const e={"currently-watching":document.getElementById("edit-currently-watching-btn"),"want-to-watch":document.getElementById("edit-want-to-watch-btn")},t={"currently-watching":document.getElementById("currently-watching-carousel"),"want-to-watch":document.getElementById("want-to-watch-carousel")};let n={"currently-watching":!1,"want-to-watch":!1};const r=a=>{n[a]=!n[a];const o=t[a],s=e[a];n[a]?(s.classList.add("text-accent-primary"),o.querySelectorAll(".movie-card").forEach(i=>{i.classList.add("shake");const l=document.createElement("button");l.className="absolute inset-0 bg-black bg-opacity-50 text-white flex items-center justify-center text-4xl",l.innerHTML='<i class="fas fa-times"></i>',l.onclick=async()=>{const c=i.dataset.tmdbId,u=a==="currently-watching"?{currently_watching:!1}:{want_to_watch:!1},{error:f}=await y.from("media").update(u).eq("tmdb_id",c);f?console.error(`Error removing from ${a}:`,f):i.remove()},i.appendChild(l)})):(s.classList.remove("text-accent-primary"),o.querySelectorAll(".movie-card").forEach(i=>{i.classList.remove("shake"),i.querySelector("button")?.remove()}))};e["currently-watching"].addEventListener("click",()=>r("currently-watching")),e["want-to-watch"].addEventListener("click",()=>r("want-to-watch"))}document.addEventListener("DOMContentLoaded",Wl);const Gl=["24klabubu.png","afraid.png","amazed.png","angry.png","bored.png","celebratory.png","crazy.png","crying.png","disgusted.png","happy.png","melted.png","neutral.png","not-a-fan.png","sad.png","satisfied.png","sexy.png","surprised.png","thinking.png","tea.png","lol.png"],Sa={"tea.png":"Das Tea","lol.png":"Laughter","24klabubu.png":"24k Labubu","not-a-fan.png":"Not A Fan"};function Kl(e){const t=document.getElementById("mood-modal-container");if(!t){console.error("mood-modal-container not found!");return}t.style.cssText=`
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
    `,Ee=null,Me=null,t.innerHTML=`
        <div class="mood-modal" style="background-color: #1a1a1a; color: white; border-radius: 1rem; width: 95%; max-width: 40rem; max-height: 80vh; overflow-y: auto; position: relative; border: 1px solid #404040; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <button id="close-mood-modal-btn" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.1); border-radius: 50%; padding: 0.5rem; cursor: pointer; color: white;">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div style="padding: 1.5rem;">
                <h2 class="text-2xl font-bold mb-6 text-center">How did this movie make you react?</h2>
                
                <div class="flex justify-center mb-8 gap-4">
                    <button class="user-select-btn" data-user="juainny">
                        <div class="user-avatar-preview user1-avatar-preview">J</div>
                        <span class="font-semibold">Juainny</span>
                    </button>
                    <button class="user-select-btn" data-user="erick">
                        <div class="user-avatar-preview user2-avatar-preview">E</div>
                        <span class="font-semibold">Erick</span>
                    </button>
                </div>

                <div id="mood-grid-container" class="mood-grid grayscale transition-all duration-300" style="opacity: 0.5; pointer-events: none;">
                    ${Gl.map(a=>{const o=Sa[a]||a.replace(".png","").replace(/-/g," ").replace(/_/g," ");return`
                        <div class="mood-option" data-mood="${a}" role="button" aria-label="${o}">
                            <img src="moods/${a}" alt="${o}">
                            <span class="mood-label">${o}</span>
                        </div>
                    `}).join("")}
                </div>

                <div class="mt-8 text-center">
                    <button id="mood-done-btn" class="bg-accent-primary hover:bg-accent-secondary text-text-on-accent font-bold py-2 px-8 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Done</button>
                </div>
            </div>
        </div >
        `,document.getElementById("close-mood-modal-btn").addEventListener("click",closeReactionSelector),t.addEventListener("click",a=>{a.target===t&&closeReactionSelector()});const n=t.querySelectorAll(".user-select-btn");n.forEach(a=>{a.addEventListener("click",()=>{n.forEach(s=>s.classList.remove("selected")),a.classList.add("selected"),Ee=a.dataset.user;const o=document.getElementById("mood-grid-container");o.classList.remove("grayscale"),o.style.opacity="1",o.style.pointerEvents="auto",wr()})});const r=t.querySelectorAll(".mood-option");r.forEach(a=>{a.addEventListener("click",()=>{Ee&&(r.forEach(o=>o.classList.remove("selected")),a.classList.add("selected"),Me=a.dataset.mood,wr())})}),document.getElementById("mood-done-btn").addEventListener("click",()=>{Ee&&Me&&(Yl(e,Ee,Me),closeReactionSelector())})}let Ee=null,Me=null;function wr(){const e=document.getElementById("mood-done-btn");Ee&&Me?e.disabled=!1:e.disabled=!0}window.closeReactionSelector=function(){const e=document.getElementById("mood-modal-container");e&&(e.innerHTML="",e.style.cssText=""),Ee=null,Me=null};async function Yl(e,t,n){const r={};if((t==="user1"||t==="juainny")&&(r.juainny_reaction=n),(t==="user2"||t==="erick")&&(r.erick_reaction=n),g&&g.tmdb_id==e)g.title||g.name,g.poster_path,g.type||g.title;else{const i=A.find(l=>l.tmdb_id==e);i&&(i.title||i.name,i.poster_path,i.type)}g&&g.tmdb_id==e&&(t==="user1"&&(g.juainny_reaction=n),t==="user2"&&(g.erick_reaction=n),At());const a=A.findIndex(i=>i.tmdb_id==e);if(a>-1){A[a]={...A[a],...r},W();const i=await We();re("currently-watching-carousel",i);const l=await Ve();re("want-to-watch-carousel",l)}const{data:o,error:s}=await y.from("media").update(r).eq("tmdb_id",e).select().single();s?(console.error("Error saving reaction:",s),alert("Failed to save reaction. Please try again.")):(console.log("Reaction saved successfully to DB for TMDB ID:",e),o&&n&&await oe("reaction",t==="user1"||t==="juainny"?"juainny":"erick",o,{reaction:n}))}function At(){const e=document.getElementById("modal-mood-display"),t=document.getElementById("remove-mood-btn");if(!e)return;e.innerHTML="";let n=!1;g?.juainny_reaction&&(n=!0,e.innerHTML+=`
        <div class="relative group" title="Juainny's Reaction">
            <img src="moods/${g.juainny_reaction}" class="w-10 h-10 object-contain drop-shadow-md">
                <div class="absolute -bottom-1 -right-1 w-4 h-4">
                    ${V("juainny","w-full h-full")}
                </div>
            </div>
    `),g?.erick_reaction&&(n=!0,e.innerHTML+=`
        <div class="relative group" title="Erick's Reaction">
            <img src="moods/${g.erick_reaction}" class="w-10 h-10 object-contain drop-shadow-md">
                <div class="absolute -bottom-1 -right-1 w-4 h-4">
                    ${V("erick","w-full h-full")}
                </div>
            </div>
    `),n?(t.classList.remove("hidden"),t.onclick=async()=>{if(confirm("Remove all reactions for this item?")){const r={juainny_reaction:null,erick_reaction:null};g.juainny_reaction=null,g.erick_reaction=null,At(),await y.from("media").update(r).eq("tmdb_id",g.tmdb_id),W()}}):t.classList.add("hidden")}function cn(){document.querySelectorAll(".movie-card").forEach(e=>{const t=e.dataset.tmdbId,n=A.find(r=>r.tmdb_id==t);if(n){const r=e.querySelector(".absolute.top-2.left-2");if(r){let a="";n.juainny_reaction&&(a+=`
                        <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Juainny" data-reaction="${n.juainny_reaction}">
                            <img src="moods/${n.juainny_reaction}" class="w-full h-full object-contain drop-shadow-md">
                            <div class="absolute -bottom-1 -right-1 w-4 h-4">
                                ${V("juainny","w-full h-full")}
                            </div>
                        </div>
                    `),n.erick_reaction&&(a+=`
                        <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Erick" data-reaction="${n.erick_reaction}">
                            <img src="moods/${n.erick_reaction}" class="w-full h-full object-contain drop-shadow-md">
                            <div class="absolute -bottom-1 -right-1 w-4 h-4">
                                ${V("erick","w-full h-full")}
                            </div>
                        </div>
                    `),r.innerHTML=a,r.querySelectorAll(".reaction-item").forEach(o=>{o.addEventListener("mouseenter",s=>{Ct(s.currentTarget)}),o.addEventListener("mouseleave",()=>{Ze()}),o.addEventListener("click",s=>{Cn(s.currentTarget,s)})})}}}),g&&At()}let An=null;function Ct(e){const t=document.getElementById("reaction-tooltip"),n=document.getElementById("tooltip-avatar"),r=document.getElementById("tooltip-text");if(!t||!n||!r)return;const a=e.dataset.user,o=e.dataset.reaction;let s=Sa[o];s||(s=o.replace(".png","").replace(/_/g," ").replace(/-/g," ").split(" ").map(u=>u.charAt(0).toUpperCase()+u.slice(1)).join(" ")),n.innerHTML=V(a.toLowerCase(),"w-6 h-6"),r.textContent=`${a} reacted with ${s}`;const i=e.getBoundingClientRect(),l=window.pageYOffset||document.documentElement.scrollTop,c=window.pageXOffset||document.documentElement.scrollLeft;t.style.position="absolute",t.style.left=`${i.left+c+i.width/2}px`,t.style.top=`${i.bottom+l+8}px`,t.style.transform="translateX(-50%)",t.classList.remove("hidden"),An=e}function Ze(){const e=document.getElementById("reaction-tooltip");e&&(e.classList.add("hidden"),An=null)}function Cn(e,t){t.stopPropagation(),An===e?Ze():Ct(e)}function Jl(e,t){return new Promise(n=>{const r=document.getElementById("confirmation-modal"),a=document.getElementById("confirmation-title"),o=document.getElementById("confirmation-message"),s=document.getElementById("confirm-series-only-btn"),i=document.getElementById("confirm-all-episodes-btn"),l=document.getElementById("cancel-confirmation-btn");a.textContent=e,o.textContent=t,i&&i.classList.remove("hidden"),r.classList.remove("hidden"),r.classList.add("flex");const c=()=>{r.classList.add("hidden"),r.classList.remove("flex"),s.onclick=null,i&&(i.onclick=null),l.onclick=null};s.onclick=()=>{c(),n("series-only")},i&&(i.onclick=()=>{c(),n("all-episodes")}),l.onclick=()=>{c(),n("cancel")}})}const vr=document.getElementById("willow-fab"),Wt=document.getElementById("willow-chat-modal"),ct=document.getElementById("willow-chat-container"),_r=document.getElementById("willow-chat-form"),Be=document.getElementById("willow-chat-input"),Ne=document.getElementById("willow-chat-messages");window.toggleWillowChat=function(){Wt.classList.contains("hidden")?(Wt.classList.remove("hidden"),setTimeout(()=>{ct.classList.remove("translate-y-full"),ct.classList.add("translate-y-0")},10),Be.focus()):(ct.classList.remove("translate-y-0"),ct.classList.add("translate-y-full"),setTimeout(()=>{Wt.classList.add("hidden")},300))};vr&&vr.addEventListener("click",window.toggleWillowChat);_r&&_r.addEventListener("submit",async e=>{e.preventDefault();const t=Be.value.trim();if(!t)return;Er(t,"user"),Be.value="",Be.disabled=!0;const n=Xl(),r=await _l(t,A);Ql(n),Er(r,"ai"),Be.disabled=!1,Be.focus()});function ut(e){return e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,'<ul class="list-disc pl-4 space-y-1">$1</ul>').replace(/\n/g,"<br>")}function Er(e,t){const n=document.createElement("div");n.className=`flex items-start gap-2 ${t==="user"?"flex-row-reverse":""}`;const r=t==="ai"?'<div class="w-10 h-10 flex-shrink-0 flex items-center justify-center overflow-hidden"><img src="/willow-logo.png" class="w-full h-full object-contain"></div>':"",a=t==="ai"?"bg-bg-tertiary text-text-primary rounded-tl-none":"bg-teal-600 text-white rounded-tr-none",o=t==="ai"?ut(e):e;return n.innerHTML=`
        ${r}
        <div class="${a} p-3 rounded-2xl text-sm shadow-sm max-w-[85%] markdown-content">
            ${o}
        </div>
    `,Ne.appendChild(n),Ne.scrollTop=Ne.scrollHeight,n.id="msg-"+Date.now()}function Xl(){const e=document.createElement("div");return e.id="typing-"+Date.now(),e.className="flex items-start gap-2",e.innerHTML=`
        <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center overflow-hidden"><img src="/willow-logo.png" class="w-full h-full object-contain"></div>
        <div class="bg-bg-tertiary p-3 rounded-2xl rounded-tl-none text-text-primary text-sm shadow-sm">
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    `,Ne.appendChild(e),Ne.scrollTop=Ne.scrollHeight,e.id}function Ql(e){const t=document.getElementById(e);t&&t.remove()}const Zl=Object.freeze(Object.defineProperty({__proto__:null,refreshAllReactionAvatars:cn},Symbol.toStringTag,{value:"Module"}));
