import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as g}from"./supabase-client-Dw9ZaCyq.js";function an(e,t=0,n){const r=document.getElementById(e);if(!r)return;r.innerHTML=`
        <div class="star-rating-widget flex items-center gap-2">
            <div class="stars-wrapper flex">
                ${[...Array(10)].map((m,f)=>`
                    <div class="star-container" data-value="${f+1}">
                        <div class="star-half left" data-value="${f+.5}"></div>
                        <div class="star-half right" data-value="${f+1}"></div>
                        <i class="star-icon fas fa-star text-gray-500"></i>
                    </div>
                `).join("")}
            </div>
            <input type="number" step="0.5" min="0" max="10" class="rating-input-manual w-16 bg-bg-primary border-border-primary rounded-md text-center">
            <input type="hidden" class="rating-input-hidden" name="rating-${e}">
        </div>
    `;const a=r.querySelector(".stars-wrapper"),i=r.querySelector(".rating-input-manual"),s=r.querySelector(".rating-input-hidden"),o=Array.from(r.querySelectorAll(".star-container"));let l=parseFloat(t)||0;const c=m=>{const f=Math.round(m*2)/2;o.forEach(y=>{const h=parseFloat(y.dataset.value),E=y.querySelector(".star-icon");E.classList.remove("fas","fa-star","fa-star-half-alt","far","fa-star"),f>=h?(E.className="star-icon fas fa-star",E.style.color="var(--star-color, #fbbf24)"):f>=h-.5?(E.className="star-icon fas fa-star-half-alt",E.style.color="var(--star-color, #fbbf24)"):(E.className="star-icon far fa-star text-gray-500",E.style.color="")}),i.value=m.toFixed(1),s.value=m},d=m=>{l=m,c(l),n&&n(l)};o.forEach(m=>{[".left",".right"].forEach(f=>{const y=m.querySelector(f),h=parseFloat(y.dataset.value);y.addEventListener("mouseenter",()=>c(h)),y.addEventListener("click",()=>d(h))})}),a.addEventListener("mouseleave",()=>c(l)),i.addEventListener("change",()=>{let m=parseFloat(i.value);isNaN(m)&&(m=0),m=Math.max(0,Math.min(10,m)),d(m)}),d(l)}const Qa="modulepreload",Za=function(e){return"/"+e},Qn={},ei=function(t,n,r){let a=Promise.resolve();if(n&&n.length>0){let l=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),o=s?.nonce||s?.getAttribute("nonce");a=l(n.map(c=>{if(c=Za(c),c in Qn)return;Qn[c]=!0;const d=c.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${m}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":Qa,d||(f.as="script"),f.crossOrigin="",f.href=c,o&&f.setAttribute("nonce",o),document.head.appendChild(f),d)return new Promise((y,h)=>{f.addEventListener("load",y),f.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(s){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=s,window.dispatchEvent(o),!o.defaultPrevented)throw s}return a.then(s=>{for(const o of s||[])o.status==="rejected"&&i(o.reason);return t().catch(i)})};let ht=null;function qe(){const e=document.getElementById("allen-easter-egg"),t=document.getElementById("balloon-easter-egg");ht&&clearTimeout(ht),e&&(e.classList.add("hidden"),e.style.transform="scale(1)"),t&&(t.classList.add("hidden"),t.style.bottom="-150px",t.style.transition="none");const n=document.documentElement.getAttribute("data-theme");if(n==="smiling-friends"&&e){const i=Math.floor(Math.random()*53001)+37e3;console.log(`ðŸŸ¡ Smiling Friends Easter Egg: Allen will appear in ${(i/1e3).toFixed(1)}s`),ht=setTimeout(()=>{console.log("ðŸŸ¡ Allen has appeared!"),e.classList.remove("hidden"),e.style.transform="scale(1)"},i),e.onclick=()=>{console.log("ðŸŸ¡ Allen was clicked! Restarting interval..."),e.style.transform="scale(0)",setTimeout(()=>{e.classList.add("hidden"),qe()},500)}}else if(n==="it"&&t){const i=Math.floor(Math.random()*8001)+15e3;console.log(`ðŸŽˆ IT Easter Egg: Balloon will appear in ${(i/1e3).toFixed(1)}s`),ht=setTimeout(()=>{console.log("ðŸŽˆ Balloon has appeared and is floating up!"),t.classList.remove("hidden"),t.style.transition="bottom 10s linear",t.offsetWidth,t.style.bottom="110vh";const s=o=>{o.propertyName==="bottom"&&(console.log("ðŸŽˆ Balloon floated off screen! Restarting interval..."),t.removeEventListener("transitionend",s),t.classList.add("hidden"),t.style.bottom="-150px",qe())};t.addEventListener("transitionend",s)},i),t.onclick=()=>{console.log("ðŸŽˆ Balloon was clicked! Restarting interval..."),t.style.transition="transform 0.2s ease-out",t.style.transform="translateX(-50%) scale(0)",setTimeout(()=>{t.classList.add("hidden"),t.style.transform="translateX(-50%) scale(1)",t.style.bottom="-150px",qe()},200)}}}let wt=[];async function ti(){const e=document.getElementById("settings-modal");if(!e){console.error("Settings modal element not found!");return}try{await populateWallpaperSelector(),await st()}catch(n){console.error("Error preparing settings modal:",n)}document.body.style.overflow="hidden",e.classList.remove("hidden"),e.classList.remove("modal-hidden"),e.classList.add("flex");const t=document.querySelectorAll(".theme-btn");t.forEach(n=>{n.addEventListener("click",()=>{if(t.forEach(r=>r.classList.remove("border-accent-primary")),n.classList.add("border-accent-primary"),n.dataset.theme==="smiling-friends"){const r=document.getElementById("movie-banner-select"),a="https://images6.alphacoders.com/134/1346437.png";let i=Array.from(r.options).find(s=>s.value===a);i||(i=document.createElement("option"),i.value=a,i.textContent="Smiling Friends (Theme Default)",r.appendChild(i)),r.value=a}})})}function qr(){const e=document.getElementById("settings-modal");e&&(e.classList.add("hidden"),e.classList.add("modal-hidden"),e.classList.remove("flex"),document.body.style.overflow="")}function ni(){const e=document.getElementById("wallpaper-btn"),t=document.getElementById("wallpaper-modal"),n=document.getElementById("close-wallpaper-modal"),r=document.getElementById("wallpaper-search");!e||!t||(e.addEventListener("click",async()=>{t.classList.remove("hidden"),await ri()}),n.addEventListener("click",()=>{t.classList.add("hidden")}),t.addEventListener("click",a=>{a.target===t&&t.classList.add("hidden")}),r.addEventListener("input",a=>{ai(a.target.value)}))}async function ri(){if(wt.length===0){const{data:e,error:t}=await g.from("media").select("title, backdrop_path");if(t){console.error("Error fetching media for wallpapers:",t);return}wt=e.filter(n=>n.backdrop_path)}Ur(wt)}function Ur(e){const t=document.getElementById("wallpaper-grid");t&&(t.innerHTML="",e.forEach(n=>{const r=document.createElement("div");r.className="cursor-pointer rounded-lg overflow-hidden transition hover:scale-105",r.style.border="2px solid var(--color-border-primary)";const a=`https://image.tmdb.org/t/p/original${n.backdrop_path}`;r.innerHTML=`
            <img src="${a}" class="w-full h-24 object-cover">
            <div class="p-2" style="background-color: var(--color-bg-tertiary);">
                <p class="text-sm font-semibold truncate" style="color: var(--color-text-primary);">${n.title}</p>
            </div>
        `,r.addEventListener("click",async()=>{ze=a,await ke(),document.getElementById("wallpaper-modal").classList.add("hidden")}),t.appendChild(r)}))}function ai(e){const t=wt.filter(n=>n.title.toLowerCase().includes(e.toLowerCase()));Ur(t)}let ze=null;async function ke(e=!0){const t=document.querySelector(".theme-btn.border-accent-primary"),n=t?t.dataset.theme:"night",r=ze,a=document.getElementById("device-name-input"),i=a?a.value.trim():"";i&&localStorage.setItem("device_name",i);const s=document.getElementById("device-name");s&&(s.textContent=i||"User");const{error:o}=await g.from("settings").update({theme:n,wallpaper_url:r}).eq("id",1);o?console.error("Error saving settings:",o):(await st(),e&&qr())}async function st(){const{data:e,error:t}=await g.from("settings").select("theme, wallpaper_url, hide_search_results_without_images, juainny_avatar, erick_avatar").eq("id",1).single();if(t||!e){console.error("Error loading settings:",t),document.documentElement.setAttribute("data-theme","night");return}const{theme:n,wallpaper_url:r,hide_search_results_without_images:a,juainny_avatar:i,erick_avatar:s}=e;document.documentElement.setAttribute("data-theme",n||"night"),ze===null&&(ze=r),i&&(Me.juainny=i),s&&(Me.erick=s);const o=(u,p)=>{const _=document.getElementById(p);_&&(_.innerHTML=z(u,"w-full h-full"))};o("juainny","user1-avatar-preview"),o("erick","user2-avatar-preview"),document.querySelectorAll(".theme-btn").forEach(u=>{u.dataset.theme===(n||"night")?u.classList.add("border-accent-primary"):u.classList.remove("border-accent-primary")}),document.getElementById("hide-search-images-toggle").checked=a;const c=document.getElementById("wallpaper-overlay");if(r){document.body.style.backgroundImage=`url('${r}')`,document.body.style.backgroundSize="cover";const u=window.matchMedia("(max-width: 768px)").matches;document.body.style.backgroundPosition=u?"center top":"center",document.body.style.backgroundRepeat="no-repeat",document.body.style.backgroundAttachment="fixed",c&&(n==="smiling-friends"?c.style.display="none":c.style.display="block")}else document.body.style.backgroundImage="none",document.body.style.backgroundSize="",document.body.style.backgroundPosition="",document.body.style.backgroundRepeat="",document.body.style.backgroundAttachment="",c&&(c.style.display="none");typeof qe=="function"&&qe();const d=document.getElementById("movie-banner-select");d&&(d.value=r||"");const m=localStorage.getItem("device_name"),f=document.getElementById("device-name-input"),y=document.getElementById("device-name");f&&(f.value=m||""),y&&(y.textContent=m||"User");const h=document.getElementById("user1-avatar-nav"),E=document.getElementById("user2-avatar-nav");h&&(h.innerHTML=z("juainny","w-full h-full")),E&&(E.innerHTML=z("erick","w-full h-full"))}function ii(){const e=document.getElementById("settings-btn"),t=document.getElementById("close-settings-modal-btn"),n=document.getElementById("save-settings-btn"),r=document.getElementById("remove-wallpaper-btn");e?e.addEventListener("click",p=>{ti()}):console.error("Settings button NOT found in DOM during initialization."),t&&t.addEventListener("click",qr),n&&n.addEventListener("click",ke);const a=document.getElementById("soft-refresh-btn"),i=document.getElementById("emergency-refresh-btn");a&&a.addEventListener("click",()=>{const p=new URL(window.location.href);p.searchParams.set("refresh","true"),window.location.href=p.toString()}),i&&i.addEventListener("click",()=>{const p=new URL(window.location.href);p.searchParams.set("hardrefresh","true"),window.location.href=p.toString()}),document.querySelectorAll(".theme-btn").forEach(p=>{p.addEventListener("click",()=>{const _=p.dataset.theme;document.documentElement.setAttribute("data-theme",_),document.querySelectorAll(".theme-btn").forEach(B=>B.classList.remove("border-accent-primary")),p.classList.add("border-accent-primary");const I=document.getElementById("theme-change-modal");I?(I.classList.remove("hidden"),I.classList.add("flex")):ke(!1)})});const s=document.getElementById("theme-change-new-wallpaper-btn"),o=document.getElementById("theme-change-no-wallpaper-btn"),l=document.getElementById("theme-change-cancel-btn"),c=document.getElementById("theme-change-modal");s&&s.addEventListener("click",async()=>{c.classList.add("hidden"),c.classList.remove("flex"),await ke(!1);const p=document.getElementById("wallpaper-btn");p&&p.click()}),o&&o.addEventListener("click",async()=>{ze=null,c.classList.add("hidden"),c.classList.remove("flex"),await ke(!1)}),l&&l.addEventListener("click",async()=>{c.classList.add("hidden"),c.classList.remove("flex"),await ke(!1)}),ni(),r&&r.addEventListener("click",async()=>{ze=null,await ke()});const d=document.getElementById("avatar-picker-user1-btn"),m=document.getElementById("avatar-picker-user2-btn");d&&d.addEventListener("click",()=>Zn("juainny")),m&&m.addEventListener("click",()=>Zn("erick"));const f=document.getElementById("close-avatar-modal-btn"),y=document.getElementById("close-avatar-modal-backdrop"),h=document.getElementById("save-avatar-btn");f&&f.addEventListener("click",sn),y&&y.addEventListener("click",sn),h&&h.addEventListener("click",ui),document.querySelectorAll(".avatar-user-btn").forEach(p=>{p.addEventListener("click",()=>{O.user=p.dataset.user,Me[O.user]?.imageUrl?O.mode=Me[O.user].type||"gradient":O.mode="gradient",nt()})}),document.querySelectorAll(".avatar-mode-btn").forEach(p=>{p.addEventListener("click",()=>{O.mode=p.dataset.mode,nt()})});const E=document.getElementById("avatar-file-input");E&&E.addEventListener("change",async p=>{const _=p.target.files[0];if(_){document.getElementById("avatar-file-name").textContent=_.name,document.getElementById("avatar-file-name").classList.remove("hidden");const I=await di(_);I&&(O.imageUrl=I,on())}});const u=document.getElementById("avatar-url-input");u&&u.addEventListener("input",p=>{const _=p.target.value.trim();_&&(E&&(E.value=""),document.getElementById("avatar-file-name").textContent="",document.getElementById("avatar-file-name").classList.add("hidden"),O.imageUrl=_,on())})}const si=["#ef4444","#f97316","#f59e0b","#84cc16","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#d946ef","#f43f5e","#1f2937"],oi=["cat.png","headphones.png","sofa.png","spider.png","ticket.png"];let O={user:"juainny",mode:"gradient",color1:"#3b82f6",color2:"#8b5cf6",icon:"cat.png",imageUrl:null},Me={};async function Zn(e){const t=document.getElementById("avatar-modal");if(!t)return;await st();const n=Me[e];n?O={...n,user:e,mode:n.type||"gradient"}:O={user:e,mode:"gradient",color1:e==="juainny"?"#8b5cf6":"#3b82f6",color2:e==="juainny"?"#d946ef":"#06b6d4",icon:"cat.png",imageUrl:null},ci(),li(),nt();const r=document.getElementById("avatar-file-input");r&&(r.value=""),document.getElementById("avatar-file-name").textContent="",document.getElementById("avatar-file-name").classList.add("hidden"),t.classList.remove("hidden"),t.classList.remove("modal-hidden"),t.classList.add("flex")}function sn(){const e=document.getElementById("avatar-modal");e&&(e.classList.add("hidden"),e.classList.add("modal-hidden"),e.classList.remove("flex"))}function nt(){document.querySelectorAll(".avatar-user-btn").forEach(n=>{n.dataset.user===O.user?n.classList.add("border-accent-primary","bg-bg-tertiary"):n.classList.remove("border-accent-primary","bg-bg-tertiary")}),document.querySelectorAll(".avatar-mode-btn").forEach(n=>{n.dataset.mode===O.mode?(n.classList.add("bg-bg-secondary","text-text-primary","shadow-sm"),n.classList.remove("text-text-muted","hover:text-text-primary")):(n.classList.remove("bg-bg-secondary","text-text-primary","shadow-sm"),n.classList.add("text-text-muted","hover:text-text-primary"))});const e=document.getElementById("avatar-gradient-controls"),t=document.getElementById("avatar-image-controls");O.mode==="gradient"?(e.classList.remove("hidden"),t.classList.add("hidden")):(e.classList.add("hidden"),t.classList.remove("hidden")),document.querySelectorAll(".color-option").forEach(n=>{const r=n.dataset.type,a=n.dataset.color;O[r]===a?n.classList.add("ring-2","ring-white"):n.classList.remove("ring-2","ring-white")}),document.querySelectorAll(".icon-option").forEach(n=>{n.dataset.icon===O.icon?n.classList.add("border-accent-primary","bg-bg-tertiary"):n.classList.remove("border-accent-primary","bg-bg-tertiary")}),on()}function ci(){const e=(t,n)=>{const r=document.getElementById(t);r&&(r.innerHTML="",si.forEach(a=>{const i=document.createElement("button");i.className="color-option w-8 h-8 rounded-full cursor-pointer transition transform hover:scale-110",i.style.backgroundColor=a,i.dataset.color=a,i.dataset.type=n,i.addEventListener("click",()=>{O[n]=a,nt()}),r.appendChild(i)}))};e("color-picker-1","color1"),e("color-picker-2","color2")}function li(){const e=document.getElementById("icon-picker");e&&(e.innerHTML="",oi.forEach(t=>{const n=document.createElement("button");n.className="icon-option p-2 rounded-lg border-2 border-transparent hover:bg-bg-tertiary transition flex items-center justify-center",n.dataset.icon=t,n.innerHTML=`<img src="avatars/${t}" class="w-8 h-8 object-contain">`,n.addEventListener("click",()=>{O.icon=t,nt()}),e.appendChild(n)}))}function on(){const e=document.getElementById("avatar-preview-display");if(!e)return;const{color1:t,color2:n,icon:r,user:a,mode:i,imageUrl:s}=O;i==="image"&&s?(e.style.background="none",e.innerHTML=`<img src="${s}" class="w-full h-full object-cover">`):(e.style.background=`linear-gradient(135deg, ${t}, ${n})`,r?e.innerHTML=`<img src="avatars/${r}" class="w-16 h-16 object-contain drop-shadow-md">`:e.innerHTML=`<span class="text-4xl font-bold text-white drop-shadow-md">${a[0].toUpperCase()}</span>`)}async function di(e){const t=`${Date.now()}-${e.name}`,{data:n,error:r}=await g.storage.from("images").upload(`avatars/${t}`,e);if(r)return console.error("Error uploading image:",r),alert("Failed to upload image. Please try again."),null;const{data:a}=g.storage.from("images").getPublicUrl(`avatars/${t}`);return a.publicUrl}async function ui(){const{user:e,mode:t,color1:n,color2:r,icon:a,imageUrl:i}=O,s={type:t,color1:n,color2:r,icon:a,imageUrl:i};Me[e]=s;const o={};o[`${e}_avatar`]=s;const{error:l}=await g.from("settings").update(o).eq("id",1);if(l)console.error("Error saving avatar:",l),alert("Failed to save avatar. Please try again.");else{await st();const{refreshAllReactionAvatars:c}=await ei(async()=>{const{refreshAllReactionAvatars:d}=await Promise.resolve().then(()=>Td);return{refreshAllReactionAvatars:d}},void 0);c(),sn()}}function z(e,t="w-8 h-8"){const n=Me[e];if(!n)return`<div class="${t} rounded-full ${e==="juainny"?"bg-purple-500":"bg-blue-500"} flex items-center justify-center text-white font-bold border border-white/20 overflow-hidden">${e[0].toUpperCase()}</div>`;const{type:r,color1:a,color2:i,icon:s,imageUrl:o}=n;return r==="image"&&o?`
            <div class="${t} rounded-full border border-white/20 relative overflow-hidden">
                <img src="${o}" class="w-full h-full object-cover">
            </div>
        `:`
        <div class="${t} rounded-full flex items-center justify-center border border-white/20 relative overflow-hidden" 
             style="background: linear-gradient(135deg, ${a}, ${i});">
            <img src="avatars/${s}" class="w-[60%] h-[60%] object-contain drop-shadow-sm">
        </div>
    `}const mi=()=>{};var er={};const Wr=function(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let a=e.charCodeAt(r);a<128?t[n++]=a:a<2048?(t[n++]=a>>6|192,t[n++]=a&63|128):(a&64512)===55296&&r+1<e.length&&(e.charCodeAt(r+1)&64512)===56320?(a=65536+((a&1023)<<10)+(e.charCodeAt(++r)&1023),t[n++]=a>>18|240,t[n++]=a>>12&63|128,t[n++]=a>>6&63|128,t[n++]=a&63|128):(t[n++]=a>>12|224,t[n++]=a>>6&63|128,t[n++]=a&63|128)}return t},fi=function(e){const t=[];let n=0,r=0;for(;n<e.length;){const a=e[n++];if(a<128)t[r++]=String.fromCharCode(a);else if(a>191&&a<224){const i=e[n++];t[r++]=String.fromCharCode((a&31)<<6|i&63)}else if(a>239&&a<365){const i=e[n++],s=e[n++],o=e[n++],l=((a&7)<<18|(i&63)<<12|(s&63)<<6|o&63)-65536;t[r++]=String.fromCharCode(55296+(l>>10)),t[r++]=String.fromCharCode(56320+(l&1023))}else{const i=e[n++],s=e[n++];t[r++]=String.fromCharCode((a&15)<<12|(i&63)<<6|s&63)}}return t.join("")},Tn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let a=0;a<e.length;a+=3){const i=e[a],s=a+1<e.length,o=s?e[a+1]:0,l=a+2<e.length,c=l?e[a+2]:0,d=i>>2,m=(i&3)<<4|o>>4;let f=(o&15)<<2|c>>6,y=c&63;l||(y=64,s||(f=64)),r.push(n[d],n[m],n[f],n[y])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(Wr(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):fi(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let a=0;a<e.length;){const i=n[e.charAt(a++)],o=a<e.length?n[e.charAt(a)]:0;++a;const c=a<e.length?n[e.charAt(a)]:64;++a;const m=a<e.length?n[e.charAt(a)]:64;if(++a,i==null||o==null||c==null||m==null)throw new hi;const f=i<<2|o>>4;if(r.push(f),c!==64){const y=o<<4&240|c>>2;if(r.push(y),m!==64){const h=c<<6&192|m;r.push(h)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class hi extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const pi=function(e){const t=Wr(e);return Tn.encodeByteArray(t,!0)},Vr=function(e){return pi(e).replace(/\./g,"")},gi=function(e){try{return Tn.decodeString(e,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};function zr(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const yi=()=>zr().__FIREBASE_DEFAULTS__,wi=()=>{if(typeof process>"u"||typeof er>"u")return;const e=er.__FIREBASE_DEFAULTS__;if(e)return JSON.parse(e)},bi=()=>{if(typeof document>"u")return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=e&&gi(e[1]);return t&&JSON.parse(t)},vi=()=>{try{return mi()||yi()||wi()||bi()}catch(e){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`);return}},Gr=()=>vi()?.config;class rt{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,n)=>{this.resolve=t,this.reject=n})}wrapCallback(t){return(n,r)=>{n?this.reject(n):this.resolve(r),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(n):t(n,r))}}}function _i(){const e=typeof chrome=="object"?chrome.runtime:typeof browser=="object"?browser.runtime:void 0;return typeof e=="object"&&e.id!==void 0}function At(){try{return typeof indexedDB=="object"}catch{return!1}}function Kr(){return new Promise((e,t)=>{try{let n=!0;const r="validate-browser-context-for-indexeddb-analytics-module",a=self.indexedDB.open(r);a.onsuccess=()=>{a.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},a.onupgradeneeded=()=>{n=!1},a.onerror=()=>{t(a.error?.message||"")}}catch(n){t(n)}})}function Ei(){return!(typeof navigator>"u"||!navigator.cookieEnabled)}const Ii="FirebaseError";class ve extends Error{constructor(t,n,r){super(n),this.code=t,this.customData=r,this.name=Ii,Object.setPrototypeOf(this,ve.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,ot.prototype.create)}}class ot{constructor(t,n,r){this.service=t,this.serviceName=n,this.errors=r}create(t,...n){const r=n[0]||{},a=`${this.service}/${t}`,i=this.errors[t],s=i?ki(i,r):"Error",o=`${this.serviceName}: ${s} (${a}).`;return new ve(a,o,r)}}function ki(e,t){return e.replace(Ti,(n,r)=>{const a=t[r];return a!=null?String(a):`<${r}?>`})}const Ti=/\{\$([^}]+)}/g;function _t(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const a of n){if(!r.includes(a))return!1;const i=e[a],s=t[a];if(tr(i)&&tr(s)){if(!_t(i,s))return!1}else if(i!==s)return!1}for(const a of r)if(!n.includes(a))return!1;return!0}function tr(e){return e!==null&&typeof e=="object"}const xi=1e3,Li=2,Si=14400*1e3,Ci=.5;function cn(e,t=xi,n=Li){const r=t*Math.pow(n,e),a=Math.round(Ci*r*(Math.random()-.5)*2);return Math.min(Si,r+a)}function ct(e){return e&&e._delegate?e._delegate:e}class ee{constructor(t,n,r){this.name=t,this.instanceFactory=n,this.type=r,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}const Te="[DEFAULT]";class Ai{constructor(t,n){this.name=t,this.container=n,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const n=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(n)){const r=new rt;if(this.instancesDeferred.set(n,r),this.isInitialized(n)||this.shouldAutoInitialize())try{const a=this.getOrInitializeService({instanceIdentifier:n});a&&r.resolve(a)}catch{}}return this.instancesDeferred.get(n).promise}getImmediate(t){const n=this.normalizeInstanceIdentifier(t?.identifier),r=t?.optional??!1;if(this.isInitialized(n)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:n})}catch(a){if(r)return null;throw a}else{if(r)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(Ri(t))try{this.getOrInitializeService({instanceIdentifier:Te})}catch{}for(const[n,r]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(n);try{const i=this.getOrInitializeService({instanceIdentifier:a});r.resolve(i)}catch{}}}}clearInstance(t=Te){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(n=>"INTERNAL"in n).map(n=>n.INTERNAL.delete()),...t.filter(n=>"_delete"in n).map(n=>n._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=Te){return this.instances.has(t)}getOptions(t=Te){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:n={}}=t,r=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(r))throw Error(`${this.name}(${r}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const a=this.getOrInitializeService({instanceIdentifier:r,options:n});for(const[i,s]of this.instancesDeferred.entries()){const o=this.normalizeInstanceIdentifier(i);r===o&&s.resolve(a)}return a}onInit(t,n){const r=this.normalizeInstanceIdentifier(n),a=this.onInitCallbacks.get(r)??new Set;a.add(t),this.onInitCallbacks.set(r,a);const i=this.instances.get(r);return i&&t(i,r),()=>{a.delete(t)}}invokeOnInitCallbacks(t,n){const r=this.onInitCallbacks.get(n);if(r)for(const a of r)try{a(t,n)}catch{}}getOrInitializeService({instanceIdentifier:t,options:n={}}){let r=this.instances.get(t);if(!r&&this.component&&(r=this.component.instanceFactory(this.container,{instanceIdentifier:Bi(t),options:n}),this.instances.set(t,r),this.instancesOptions.set(t,n),this.invokeOnInitCallbacks(r,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,r)}catch{}return r||null}normalizeInstanceIdentifier(t=Te){return this.component?this.component.multipleInstances?t:Te:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function Bi(e){return e===Te?void 0:e}function Ri(e){return e.instantiationMode==="EAGER"}class $i{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const n=this.getProvider(t.name);if(n.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);n.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const n=new Ai(t,this);return this.providers.set(t,n),n}getProviders(){return Array.from(this.providers.values())}}var R;(function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"})(R||(R={}));const Mi={debug:R.DEBUG,verbose:R.VERBOSE,info:R.INFO,warn:R.WARN,error:R.ERROR,silent:R.SILENT},Di=R.INFO,Oi={[R.DEBUG]:"log",[R.VERBOSE]:"log",[R.INFO]:"info",[R.WARN]:"warn",[R.ERROR]:"error"},Ni=(e,t,...n)=>{if(t<e.logLevel)return;const r=new Date().toISOString(),a=Oi[t];if(a)console[a](`[${r}]  ${e.name}:`,...n);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class Bt{constructor(t){this.name=t,this._logLevel=Di,this._logHandler=Ni,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in R))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?Mi[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,R.DEBUG,...t),this._logHandler(this,R.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,R.VERBOSE,...t),this._logHandler(this,R.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,R.INFO,...t),this._logHandler(this,R.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,R.WARN,...t),this._logHandler(this,R.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,R.ERROR,...t),this._logHandler(this,R.ERROR,...t)}}const Pi=(e,t)=>t.some(n=>e instanceof n);let nr,rr;function Fi(){return nr||(nr=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ji(){return rr||(rr=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Yr=new WeakMap,ln=new WeakMap,Jr=new WeakMap,zt=new WeakMap,xn=new WeakMap;function Hi(e){const t=new Promise((n,r)=>{const a=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{n(we(e.result)),a()},s=()=>{r(e.error),a()};e.addEventListener("success",i),e.addEventListener("error",s)});return t.then(n=>{n instanceof IDBCursor&&Yr.set(n,e)}).catch(()=>{}),xn.set(t,e),t}function qi(e){if(ln.has(e))return;const t=new Promise((n,r)=>{const a=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{n(),a()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)});ln.set(e,t)}let dn={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return ln.get(e);if(t==="objectStoreNames")return e.objectStoreNames||Jr.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return we(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Ui(e){dn=e(dn)}function Wi(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const r=e.call(Gt(this),t,...n);return Jr.set(r,t.sort?t.sort():[t]),we(r)}:ji().includes(e)?function(...t){return e.apply(Gt(this),t),we(Yr.get(this))}:function(...t){return we(e.apply(Gt(this),t))}}function Vi(e){return typeof e=="function"?Wi(e):(e instanceof IDBTransaction&&qi(e),Pi(e,Fi())?new Proxy(e,dn):e)}function we(e){if(e instanceof IDBRequest)return Hi(e);if(zt.has(e))return zt.get(e);const t=Vi(e);return t!==e&&(zt.set(e,t),xn.set(t,e)),t}const Gt=e=>xn.get(e);function Xr(e,t,{blocked:n,upgrade:r,blocking:a,terminated:i}={}){const s=indexedDB.open(e,t),o=we(s);return r&&s.addEventListener("upgradeneeded",l=>{r(we(s.result),l.oldVersion,l.newVersion,we(s.transaction),l)}),n&&s.addEventListener("blocked",l=>n(l.oldVersion,l.newVersion,l)),o.then(l=>{i&&l.addEventListener("close",()=>i()),a&&l.addEventListener("versionchange",c=>a(c.oldVersion,c.newVersion,c))}).catch(()=>{}),o}const zi=["get","getKey","getAll","getAllKeys","count"],Gi=["put","add","delete","clear"],Kt=new Map;function ar(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(Kt.get(t))return Kt.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,a=Gi.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(a||zi.includes(n)))return;const i=async function(s,...o){const l=this.transaction(s,a?"readwrite":"readonly");let c=l.store;return r&&(c=c.index(o.shift())),(await Promise.all([c[n](...o),a&&l.done]))[0]};return Kt.set(t,i),i}Ui(e=>({...e,get:(t,n,r)=>ar(t,n)||e.get(t,n,r),has:(t,n)=>!!ar(t,n)||e.has(t,n)}));class Ki{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(n=>{if(Yi(n)){const r=n.getImmediate();return`${r.library}/${r.version}`}else return null}).filter(n=>n).join(" ")}}function Yi(e){return e.getComponent()?.type==="VERSION"}const un="@firebase/app",ir="0.14.6";const de=new Bt("@firebase/app"),Ji="@firebase/app-compat",Xi="@firebase/analytics-compat",Qi="@firebase/analytics",Zi="@firebase/app-check-compat",es="@firebase/app-check",ts="@firebase/auth",ns="@firebase/auth-compat",rs="@firebase/database",as="@firebase/data-connect",is="@firebase/database-compat",ss="@firebase/functions",os="@firebase/functions-compat",cs="@firebase/installations",ls="@firebase/installations-compat",ds="@firebase/messaging",us="@firebase/messaging-compat",ms="@firebase/performance",fs="@firebase/performance-compat",hs="@firebase/remote-config",ps="@firebase/remote-config-compat",gs="@firebase/storage",ys="@firebase/storage-compat",ws="@firebase/firestore",bs="@firebase/ai",vs="@firebase/firestore-compat",_s="firebase";const mn="[DEFAULT]",Es={[un]:"fire-core",[Ji]:"fire-core-compat",[Qi]:"fire-analytics",[Xi]:"fire-analytics-compat",[es]:"fire-app-check",[Zi]:"fire-app-check-compat",[ts]:"fire-auth",[ns]:"fire-auth-compat",[rs]:"fire-rtdb",[as]:"fire-data-connect",[is]:"fire-rtdb-compat",[ss]:"fire-fn",[os]:"fire-fn-compat",[cs]:"fire-iid",[ls]:"fire-iid-compat",[ds]:"fire-fcm",[us]:"fire-fcm-compat",[ms]:"fire-perf",[fs]:"fire-perf-compat",[hs]:"fire-rc",[ps]:"fire-rc-compat",[gs]:"fire-gcs",[ys]:"fire-gcs-compat",[ws]:"fire-fst",[vs]:"fire-fst-compat",[bs]:"fire-vertex","fire-js":"fire-js",[_s]:"fire-js-all"};const Et=new Map,Is=new Map,fn=new Map;function sr(e,t){try{e.container.addComponent(t)}catch(n){de.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function re(e){const t=e.name;if(fn.has(t))return de.debug(`There were multiple attempts to register component ${t}.`),!1;fn.set(t,e);for(const n of Et.values())sr(n,e);for(const n of Is.values())sr(n,e);return!0}function Ne(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function ks(e){return e==null?!1:e.settings!==void 0}const Ts={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},be=new ot("app","Firebase",Ts);class xs{constructor(t,n,r){this._isDeleted=!1,this._options={...t},this._config={...n},this._name=n.name,this._automaticDataCollectionEnabled=n.automaticDataCollectionEnabled,this._container=r,this.container.addComponent(new ee("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw be.create("app-deleted",{appName:this._name})}}function Qr(e,t={}){let n=e;typeof t!="object"&&(t={name:t});const r={name:mn,automaticDataCollectionEnabled:!0,...t},a=r.name;if(typeof a!="string"||!a)throw be.create("bad-app-name",{appName:String(a)});if(n||(n=Gr()),!n)throw be.create("no-options");const i=Et.get(a);if(i){if(_t(n,i.options)&&_t(r,i.config))return i;throw be.create("duplicate-app",{appName:a})}const s=new $i(a);for(const l of fn.values())s.addComponent(l);const o=new xs(n,r,s);return Et.set(a,o),o}function Ln(e=mn){const t=Et.get(e);if(!t&&e===mn&&Gr())return Qr();if(!t)throw be.create("no-app",{appName:e});return t}function Z(e,t,n){let r=Es[e]??e;n&&(r+=`-${n}`);const a=r.match(/\s|\//),i=t.match(/\s|\//);if(a||i){const s=[`Unable to register library "${r}" with version "${t}":`];a&&s.push(`library name "${r}" contains illegal characters (whitespace or "/")`),a&&i&&s.push("and"),i&&s.push(`version name "${t}" contains illegal characters (whitespace or "/")`),de.warn(s.join(" "));return}re(new ee(`${r}-version`,()=>({library:r,version:t}),"VERSION"))}const Ls="firebase-heartbeat-database",Ss=1,at="firebase-heartbeat-store";let Yt=null;function Zr(){return Yt||(Yt=Xr(Ls,Ss,{upgrade:(e,t)=>{switch(t){case 0:try{e.createObjectStore(at)}catch(n){console.warn(n)}}}}).catch(e=>{throw be.create("idb-open",{originalErrorMessage:e.message})})),Yt}async function Cs(e){try{const n=(await Zr()).transaction(at),r=await n.objectStore(at).get(ea(e));return await n.done,r}catch(t){if(t instanceof ve)de.warn(t.message);else{const n=be.create("idb-get",{originalErrorMessage:t?.message});de.warn(n.message)}}}async function or(e,t){try{const r=(await Zr()).transaction(at,"readwrite");await r.objectStore(at).put(t,ea(e)),await r.done}catch(n){if(n instanceof ve)de.warn(n.message);else{const r=be.create("idb-set",{originalErrorMessage:n?.message});de.warn(r.message)}}}function ea(e){return`${e.name}!${e.options.appId}`}const As=1024,Bs=30;class Rs{constructor(t){this.container=t,this._heartbeatsCache=null;const n=this.container.getProvider("app").getImmediate();this._storage=new Ms(n),this._heartbeatsCachePromise=this._storage.read().then(r=>(this._heartbeatsCache=r,r))}async triggerHeartbeat(){try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=cr();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(a=>a.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>Bs){const a=Ds(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(a,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(t){de.warn(t)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const t=cr(),{heartbeatsToSend:n,unsentEntries:r}=$s(this._heartbeatsCache.heartbeats),a=Vr(JSON.stringify({version:2,heartbeats:n}));return this._heartbeatsCache.lastSentHeartbeatDate=t,r.length>0?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),a}catch(t){return de.warn(t),""}}}function cr(){return new Date().toISOString().substring(0,10)}function $s(e,t=As){const n=[];let r=e.slice();for(const a of e){const i=n.find(s=>s.agent===a.agent);if(i){if(i.dates.push(a.date),lr(n)>t){i.dates.pop();break}}else if(n.push({agent:a.agent,dates:[a.date]}),lr(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}class Ms{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return At()?Kr().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const n=await Cs(this.app);return n?.heartbeats?n:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){if(await this._canUseIndexedDBPromise){const r=await this.read();return or(this.app,{lastSentHeartbeatDate:t.lastSentHeartbeatDate??r.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){if(await this._canUseIndexedDBPromise){const r=await this.read();return or(this.app,{lastSentHeartbeatDate:t.lastSentHeartbeatDate??r.lastSentHeartbeatDate,heartbeats:[...r.heartbeats,...t.heartbeats]})}else return}}function lr(e){return Vr(JSON.stringify({version:2,heartbeats:e})).length}function Ds(e){if(e.length===0)return-1;let t=0,n=e[0].date;for(let r=1;r<e.length;r++)e[r].date<n&&(n=e[r].date,t=r);return t}function Os(e){re(new ee("platform-logger",t=>new Ki(t),"PRIVATE")),re(new ee("heartbeat",t=>new Rs(t),"PRIVATE")),Z(un,ir,e),Z(un,ir,"esm2020"),Z("fire-js","")}Os("");var Ns="firebase",Ps="12.6.0";Z(Ns,Ps,"app");const ta="@firebase/installations",Sn="0.6.19";const na=1e4,ra=`w:${Sn}`,aa="FIS_v2",Fs="https://firebaseinstallations.googleapis.com/v1",js=3600*1e3,Hs="installations",qs="Installations";const Us={"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."},De=new ot(Hs,qs,Us);function ia(e){return e instanceof ve&&e.code.includes("request-failed")}function sa({projectId:e}){return`${Fs}/projects/${e}/installations`}function oa(e){return{token:e.token,requestStatus:2,expiresIn:Vs(e.expiresIn),creationTime:Date.now()}}async function ca(e,t){const r=(await t.json()).error;return De.create("request-failed",{requestName:e,serverCode:r.code,serverMessage:r.message,serverStatus:r.status})}function la({apiKey:e}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e})}function Ws(e,{refreshToken:t}){const n=la(e);return n.append("Authorization",zs(t)),n}async function da(e){const t=await e();return t.status>=500&&t.status<600?e():t}function Vs(e){return Number(e.replace("s","000"))}function zs(e){return`${aa} ${e}`}async function Gs({appConfig:e,heartbeatServiceProvider:t},{fid:n}){const r=sa(e),a=la(e),i=t.getImmediate({optional:!0});if(i){const c=await i.getHeartbeatsHeader();c&&a.append("x-firebase-client",c)}const s={fid:n,authVersion:aa,appId:e.appId,sdkVersion:ra},o={method:"POST",headers:a,body:JSON.stringify(s)},l=await da(()=>fetch(r,o));if(l.ok){const c=await l.json();return{fid:c.fid||n,registrationStatus:2,refreshToken:c.refreshToken,authToken:oa(c.authToken)}}else throw await ca("Create Installation",l)}function ua(e){return new Promise(t=>{setTimeout(t,e)})}function Ks(e){return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_")}const Ys=/^[cdef][\w-]{21}$/,hn="";function Js(){try{const e=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(e),e[0]=112+e[0]%16;const n=Xs(e);return Ys.test(n)?n:hn}catch{return hn}}function Xs(e){return Ks(e).substr(0,22)}function Rt(e){return`${e.appName}!${e.appId}`}const ma=new Map;function fa(e,t){const n=Rt(e);ha(n,t),Qs(n,t)}function ha(e,t){const n=ma.get(e);if(n)for(const r of n)r(t)}function Qs(e,t){const n=Zs();n&&n.postMessage({key:e,fid:t}),eo()}let Ce=null;function Zs(){return!Ce&&"BroadcastChannel"in self&&(Ce=new BroadcastChannel("[Firebase] FID Change"),Ce.onmessage=e=>{ha(e.data.key,e.data.fid)}),Ce}function eo(){ma.size===0&&Ce&&(Ce.close(),Ce=null)}const to="firebase-installations-database",no=1,Oe="firebase-installations-store";let Jt=null;function Cn(){return Jt||(Jt=Xr(to,no,{upgrade:(e,t)=>{switch(t){case 0:e.createObjectStore(Oe)}}})),Jt}async function It(e,t){const n=Rt(e),a=(await Cn()).transaction(Oe,"readwrite"),i=a.objectStore(Oe),s=await i.get(n);return await i.put(t,n),await a.done,(!s||s.fid!==t.fid)&&fa(e,t.fid),t}async function pa(e){const t=Rt(e),r=(await Cn()).transaction(Oe,"readwrite");await r.objectStore(Oe).delete(t),await r.done}async function $t(e,t){const n=Rt(e),a=(await Cn()).transaction(Oe,"readwrite"),i=a.objectStore(Oe),s=await i.get(n),o=t(s);return o===void 0?await i.delete(n):await i.put(o,n),await a.done,o&&(!s||s.fid!==o.fid)&&fa(e,o.fid),o}async function An(e){let t;const n=await $t(e.appConfig,r=>{const a=ro(r),i=ao(e,a);return t=i.registrationPromise,i.installationEntry});return n.fid===hn?{installationEntry:await t}:{installationEntry:n,registrationPromise:t}}function ro(e){const t=e||{fid:Js(),registrationStatus:0};return ga(t)}function ao(e,t){if(t.registrationStatus===0){if(!navigator.onLine){const a=Promise.reject(De.create("app-offline"));return{installationEntry:t,registrationPromise:a}}const n={fid:t.fid,registrationStatus:1,registrationTime:Date.now()},r=io(e,n);return{installationEntry:n,registrationPromise:r}}else return t.registrationStatus===1?{installationEntry:t,registrationPromise:so(e)}:{installationEntry:t}}async function io(e,t){try{const n=await Gs(e,t);return It(e.appConfig,n)}catch(n){throw ia(n)&&n.customData.serverCode===409?await pa(e.appConfig):await It(e.appConfig,{fid:t.fid,registrationStatus:0}),n}}async function so(e){let t=await dr(e.appConfig);for(;t.registrationStatus===1;)await ua(100),t=await dr(e.appConfig);if(t.registrationStatus===0){const{installationEntry:n,registrationPromise:r}=await An(e);return r||n}return t}function dr(e){return $t(e,t=>{if(!t)throw De.create("installation-not-found");return ga(t)})}function ga(e){return oo(e)?{fid:e.fid,registrationStatus:0}:e}function oo(e){return e.registrationStatus===1&&e.registrationTime+na<Date.now()}async function co({appConfig:e,heartbeatServiceProvider:t},n){const r=lo(e,n),a=Ws(e,n),i=t.getImmediate({optional:!0});if(i){const c=await i.getHeartbeatsHeader();c&&a.append("x-firebase-client",c)}const s={installation:{sdkVersion:ra,appId:e.appId}},o={method:"POST",headers:a,body:JSON.stringify(s)},l=await da(()=>fetch(r,o));if(l.ok){const c=await l.json();return oa(c)}else throw await ca("Generate Auth Token",l)}function lo(e,{fid:t}){return`${sa(e)}/${t}/authTokens:generate`}async function Bn(e,t=!1){let n;const r=await $t(e.appConfig,i=>{if(!ya(i))throw De.create("not-registered");const s=i.authToken;if(!t&&fo(s))return i;if(s.requestStatus===1)return n=uo(e,t),i;{if(!navigator.onLine)throw De.create("app-offline");const o=po(i);return n=mo(e,o),o}});return n?await n:r.authToken}async function uo(e,t){let n=await ur(e.appConfig);for(;n.authToken.requestStatus===1;)await ua(100),n=await ur(e.appConfig);const r=n.authToken;return r.requestStatus===0?Bn(e,t):r}function ur(e){return $t(e,t=>{if(!ya(t))throw De.create("not-registered");const n=t.authToken;return go(n)?{...t,authToken:{requestStatus:0}}:t})}async function mo(e,t){try{const n=await co(e,t),r={...t,authToken:n};return await It(e.appConfig,r),n}catch(n){if(ia(n)&&(n.customData.serverCode===401||n.customData.serverCode===404))await pa(e.appConfig);else{const r={...t,authToken:{requestStatus:0}};await It(e.appConfig,r)}throw n}}function ya(e){return e!==void 0&&e.registrationStatus===2}function fo(e){return e.requestStatus===2&&!ho(e)}function ho(e){const t=Date.now();return t<e.creationTime||e.creationTime+e.expiresIn<t+js}function po(e){const t={requestStatus:1,requestTime:Date.now()};return{...e,authToken:t}}function go(e){return e.requestStatus===1&&e.requestTime+na<Date.now()}async function yo(e){const t=e,{installationEntry:n,registrationPromise:r}=await An(t);return r?r.catch(console.error):Bn(t).catch(console.error),n.fid}async function wo(e,t=!1){const n=e;return await bo(n),(await Bn(n,t)).token}async function bo(e){const{registrationPromise:t}=await An(e);t&&await t}function vo(e){if(!e||!e.options)throw Xt("App Configuration");if(!e.name)throw Xt("App Name");const t=["projectId","apiKey","appId"];for(const n of t)if(!e.options[n])throw Xt(n);return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}function Xt(e){return De.create("missing-app-config-values",{valueName:e})}const wa="installations",_o="installations-internal",Eo=e=>{const t=e.getProvider("app").getImmediate(),n=vo(t),r=Ne(t,"heartbeat");return{app:t,appConfig:n,heartbeatServiceProvider:r,_delete:()=>Promise.resolve()}},Io=e=>{const t=e.getProvider("app").getImmediate(),n=Ne(t,wa).getImmediate();return{getId:()=>yo(n),getToken:a=>wo(n,a)}};function ko(){re(new ee(wa,Eo,"PUBLIC")),re(new ee(_o,Io,"PRIVATE"))}ko();Z(ta,Sn);Z(ta,Sn,"esm2020");const kt="analytics",To="firebase_id",xo="origin",Lo=60*1e3,So="https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig",Rn="https://www.googletagmanager.com/gtag/js";const q=new Bt("@firebase/analytics");const Co={"already-exists":"A Firebase Analytics instance with the appId {$id}  already exists. Only one Firebase Analytics instance can be created for each appId.","already-initialized":"initializeAnalytics() cannot be called again with different options than those it was initially called with. It can be called again with the same options to return the existing instance, or getAnalytics() can be used to get a reference to the already-initialized instance.","already-initialized-settings":"Firebase Analytics has already been initialized.settings() must be called before initializing any Analytics instanceor it will have no effect.","interop-component-reg-failed":"Firebase Analytics Interop Component failed to instantiate: {$reason}","invalid-analytics-context":"Firebase Analytics is not supported in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","indexeddb-unavailable":"IndexedDB unavailable or restricted in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","fetch-throttle":"The config fetch request timed out while in an exponential backoff state. Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.","config-fetch-failed":"Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}","no-api-key":'The "apiKey" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid API key.',"no-app-id":'The "appId" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid app ID.',"no-client-id":'The "client_id" field is empty.',"invalid-gtag-resource":"Trusted Types detected an invalid gtag resource: {$gtagURL}."},Y=new ot("analytics","Analytics",Co);function Ao(e){if(!e.startsWith(Rn)){const t=Y.create("invalid-gtag-resource",{gtagURL:e});return q.warn(t.message),""}return e}function ba(e){return Promise.all(e.map(t=>t.catch(n=>n)))}function Bo(e,t){let n;return window.trustedTypes&&(n=window.trustedTypes.createPolicy(e,t)),n}function Ro(e,t){const n=Bo("firebase-js-sdk-policy",{createScriptURL:Ao}),r=document.createElement("script"),a=`${Rn}?l=${e}&id=${t}`;r.src=n?n?.createScriptURL(a):a,r.async=!0,document.head.appendChild(r)}function $o(e){let t=[];return Array.isArray(window[e])?t=window[e]:window[e]=t,t}async function Mo(e,t,n,r,a,i){const s=r[a];try{if(s)await t[s];else{const l=(await ba(n)).find(c=>c.measurementId===a);l&&await t[l.appId]}}catch(o){q.error(o)}e("config",a,i)}async function Do(e,t,n,r,a){try{let i=[];if(a&&a.send_to){let s=a.send_to;Array.isArray(s)||(s=[s]);const o=await ba(n);for(const l of s){const c=o.find(m=>m.measurementId===l),d=c&&t[c.appId];if(d)i.push(d);else{i=[];break}}}i.length===0&&(i=Object.values(t)),await Promise.all(i),e("event",r,a||{})}catch(i){q.error(i)}}function Oo(e,t,n,r){async function a(i,...s){try{if(i==="event"){const[o,l]=s;await Do(e,t,n,o,l)}else if(i==="config"){const[o,l]=s;await Mo(e,t,n,r,o,l)}else if(i==="consent"){const[o,l]=s;e("consent",o,l)}else if(i==="get"){const[o,l,c]=s;e("get",o,l,c)}else if(i==="set"){const[o]=s;e("set",o)}else e(i,...s)}catch(o){q.error(o)}}return a}function No(e,t,n,r,a){let i=function(...s){window[r].push(arguments)};return window[a]&&typeof window[a]=="function"&&(i=window[a]),window[a]=Oo(i,e,t,n),{gtagCore:i,wrappedGtag:window[a]}}function Po(e){const t=window.document.getElementsByTagName("script");for(const n of Object.values(t))if(n.src&&n.src.includes(Rn)&&n.src.includes(e))return n;return null}const Fo=30,jo=1e3;class Ho{constructor(t={},n=jo){this.throttleMetadata=t,this.intervalMillis=n}getThrottleMetadata(t){return this.throttleMetadata[t]}setThrottleMetadata(t,n){this.throttleMetadata[t]=n}deleteThrottleMetadata(t){delete this.throttleMetadata[t]}}const va=new Ho;function qo(e){return new Headers({Accept:"application/json","x-goog-api-key":e})}async function Uo(e){const{appId:t,apiKey:n}=e,r={method:"GET",headers:qo(n)},a=So.replace("{app-id}",t),i=await fetch(a,r);if(i.status!==200&&i.status!==304){let s="";try{const o=await i.json();o.error?.message&&(s=o.error.message)}catch{}throw Y.create("config-fetch-failed",{httpStatus:i.status,responseMessage:s})}return i.json()}async function Wo(e,t=va,n){const{appId:r,apiKey:a,measurementId:i}=e.options;if(!r)throw Y.create("no-app-id");if(!a){if(i)return{measurementId:i,appId:r};throw Y.create("no-api-key")}const s=t.getThrottleMetadata(r)||{backoffCount:0,throttleEndTimeMillis:Date.now()},o=new Go;return setTimeout(async()=>{o.abort()},Lo),_a({appId:r,apiKey:a,measurementId:i},s,o,t)}async function _a(e,{throttleEndTimeMillis:t,backoffCount:n},r,a=va){const{appId:i,measurementId:s}=e;try{await Vo(r,t)}catch(o){if(s)return q.warn(`Timed out fetching this Firebase app's measurement ID from the server. Falling back to the measurement ID ${s} provided in the "measurementId" field in the local Firebase config. [${o?.message}]`),{appId:i,measurementId:s};throw o}try{const o=await Uo(e);return a.deleteThrottleMetadata(i),o}catch(o){const l=o;if(!zo(l)){if(a.deleteThrottleMetadata(i),s)return q.warn(`Failed to fetch this Firebase app's measurement ID from the server. Falling back to the measurement ID ${s} provided in the "measurementId" field in the local Firebase config. [${l?.message}]`),{appId:i,measurementId:s};throw o}const c=Number(l?.customData?.httpStatus)===503?cn(n,a.intervalMillis,Fo):cn(n,a.intervalMillis),d={throttleEndTimeMillis:Date.now()+c,backoffCount:n+1};return a.setThrottleMetadata(i,d),q.debug(`Calling attemptFetch again in ${c} millis`),_a(e,d,r,a)}}function Vo(e,t){return new Promise((n,r)=>{const a=Math.max(t-Date.now(),0),i=setTimeout(n,a);e.addEventListener(()=>{clearTimeout(i),r(Y.create("fetch-throttle",{throttleEndTimeMillis:t}))})})}function zo(e){if(!(e instanceof ve)||!e.customData)return!1;const t=Number(e.customData.httpStatus);return t===429||t===500||t===503||t===504}class Go{constructor(){this.listeners=[]}addEventListener(t){this.listeners.push(t)}abort(){this.listeners.forEach(t=>t())}}async function Ko(e,t,n,r,a){if(a&&a.global){e("event",n,r);return}else{const i=await t,s={...r,send_to:i};e("event",n,s)}}async function Yo(e,t,n,r){if(r&&r.global){const a={};for(const i of Object.keys(n))a[`user_properties.${i}`]=n[i];return e("set",a),Promise.resolve()}else{const a=await t;e("config",a,{update:!0,user_properties:n})}}async function Jo(){if(At())try{await Kr()}catch(e){return q.warn(Y.create("indexeddb-unavailable",{errorInfo:e?.toString()}).message),!1}else return q.warn(Y.create("indexeddb-unavailable",{errorInfo:"IndexedDB is not available in this environment."}).message),!1;return!0}async function Xo(e,t,n,r,a,i,s){const o=Wo(e);o.then(f=>{n[f.measurementId]=f.appId,e.options.measurementId&&f.measurementId!==e.options.measurementId&&q.warn(`The measurement ID in the local Firebase config (${e.options.measurementId}) does not match the measurement ID fetched from the server (${f.measurementId}). To ensure analytics events are always sent to the correct Analytics property, update the measurement ID field in the local config or remove it from the local config.`)}).catch(f=>q.error(f)),t.push(o);const l=Jo().then(f=>{if(f)return r.getId()}),[c,d]=await Promise.all([o,l]);Po(i)||Ro(i,c.measurementId),a("js",new Date);const m=s?.config??{};return m[xo]="firebase",m.update=!0,d!=null&&(m[To]=d),a("config",c.measurementId,m),c.measurementId}class Qo{constructor(t){this.app=t}_delete(){return delete Ue[this.app.options.appId],Promise.resolve()}}let Ue={},mr=[];const fr={};let Qt="dataLayer",Zo="gtag",hr,$n,pr=!1;function ec(){const e=[];if(_i()&&e.push("This is a browser extension environment."),Ei()||e.push("Cookies are not available."),e.length>0){const t=e.map((r,a)=>`(${a+1}) ${r}`).join(" "),n=Y.create("invalid-analytics-context",{errorInfo:t});q.warn(n.message)}}function tc(e,t,n){ec();const r=e.options.appId;if(!r)throw Y.create("no-app-id");if(!e.options.apiKey)if(e.options.measurementId)q.warn(`The "apiKey" field is empty in the local Firebase config. This is needed to fetch the latest measurement ID for this Firebase app. Falling back to the measurement ID ${e.options.measurementId} provided in the "measurementId" field in the local Firebase config.`);else throw Y.create("no-api-key");if(Ue[r]!=null)throw Y.create("already-exists",{id:r});if(!pr){$o(Qt);const{wrappedGtag:i,gtagCore:s}=No(Ue,mr,fr,Qt,Zo);$n=i,hr=s,pr=!0}return Ue[r]=Xo(e,mr,fr,t,hr,Qt,n),new Qo(e)}function nc(e=Ln()){e=ct(e);const t=Ne(e,kt);return t.isInitialized()?t.getImmediate():rc(e)}function rc(e,t={}){const n=Ne(e,kt);if(n.isInitialized()){const a=n.getImmediate();if(_t(t,n.getOptions()))return a;throw Y.create("already-initialized")}return n.initialize({options:t})}function ac(e,t,n){e=ct(e),Yo($n,Ue[e.app.options.appId],t,n).catch(r=>q.error(r))}function ic(e,t,n,r){e=ct(e),Ko($n,Ue[e.app.options.appId],t,n,r).catch(a=>q.error(a))}const gr="@firebase/analytics",yr="0.10.19";function sc(){re(new ee(kt,(t,{options:n})=>{const r=t.getProvider("app").getImmediate(),a=t.getProvider("installations-internal").getImmediate();return tc(r,a,n)},"PUBLIC")),re(new ee("analytics-internal",e,"PRIVATE")),Z(gr,yr),Z(gr,yr,"esm2020");function e(t){try{const n=t.getProvider(kt).getImmediate();return{logEvent:(r,a,i)=>ic(n,r,a,i),setUserProperties:(r,a)=>ac(n,r,a)}}catch(n){throw Y.create("interop-component-reg-failed",{reason:n})}}}sc();const pn=new Map,Ea={activated:!1,tokenObservers:[]},oc={initialized:!1,enabled:!1};function N(e){return pn.get(e)||{...Ea}}function cc(e,t){return pn.set(e,t),pn.get(e)}function Mt(){return oc}const Ia="https://content-firebaseappcheck.googleapis.com/v1",lc="exchangeRecaptchaV3Token",dc="exchangeDebugToken",wr={RETRIAL_MIN_WAIT:30*1e3,RETRIAL_MAX_WAIT:960*1e3},uc=1440*60*1e3;class mc{constructor(t,n,r,a,i){if(this.operation=t,this.retryPolicy=n,this.getWaitDuration=r,this.lowerBound=a,this.upperBound=i,this.pending=null,this.nextErrorWaitInterval=a,a>i)throw new Error("Proactive refresh lower bound greater than upper bound!")}start(){this.nextErrorWaitInterval=this.lowerBound,this.process(!0).catch(()=>{})}stop(){this.pending&&(this.pending.reject("cancelled"),this.pending=null)}isRunning(){return!!this.pending}async process(t){this.stop();try{this.pending=new rt,this.pending.promise.catch(n=>{}),await fc(this.getNextRun(t)),this.pending.resolve(),await this.pending.promise,this.pending=new rt,this.pending.promise.catch(n=>{}),await this.operation(),this.pending.resolve(),await this.pending.promise,this.process(!0).catch(()=>{})}catch(n){this.retryPolicy(n)?this.process(!1).catch(()=>{}):this.stop()}}getNextRun(t){if(t)return this.nextErrorWaitInterval=this.lowerBound,this.getWaitDuration();{const n=this.nextErrorWaitInterval;return this.nextErrorWaitInterval*=2,this.nextErrorWaitInterval>this.upperBound&&(this.nextErrorWaitInterval=this.upperBound),n}}}function fc(e){return new Promise(t=>{setTimeout(t,e)})}const hc={"already-initialized":"You have already called initializeAppCheck() for FirebaseApp {$appName} with different options. To avoid this error, call initializeAppCheck() with the same options as when it was originally called. This will return the already initialized instance.","use-before-activation":"App Check is being used before initializeAppCheck() is called for FirebaseApp {$appName}. Call initializeAppCheck() before instantiating other Firebase services.","fetch-network-error":"Fetch failed to connect to a network. Check Internet connection. Original error: {$originalErrorMessage}.","fetch-parse-error":"Fetch client could not parse response. Original error: {$originalErrorMessage}.","fetch-status-error":"Fetch server returned an HTTP error status. HTTP status: {$httpStatus}.","storage-open":"Error thrown when opening storage. Original error: {$originalErrorMessage}.","storage-get":"Error thrown when reading from storage. Original error: {$originalErrorMessage}.","storage-set":"Error thrown when writing to storage. Original error: {$originalErrorMessage}.","recaptcha-error":"ReCAPTCHA error.","initial-throttle":"{$httpStatus} error. Attempts allowed again after {$time}",throttled:"Requests throttled due to previous {$httpStatus} error. Attempts allowed again after {$time}"},W=new ot("appCheck","AppCheck",hc);function br(e=!1){return e?self.grecaptcha?.enterprise:self.grecaptcha}function Mn(e){if(!N(e).activated)throw W.create("use-before-activation",{appName:e.name})}function ka(e){const t=Math.round(e/1e3),n=Math.floor(t/(3600*24)),r=Math.floor((t-n*3600*24)/3600),a=Math.floor((t-n*3600*24-r*3600)/60),i=t-n*3600*24-r*3600-a*60;let s="";return n&&(s+=pt(n)+"d:"),r&&(s+=pt(r)+"h:"),s+=pt(a)+"m:"+pt(i)+"s",s}function pt(e){return e===0?"00":e>=10?e.toString():"0"+e}async function Dn({url:e,body:t},n){const r={"Content-Type":"application/json"},a=n.getImmediate({optional:!0});if(a){const m=await a.getHeartbeatsHeader();m&&(r["X-Firebase-Client"]=m)}const i={method:"POST",body:JSON.stringify(t),headers:r};let s;try{s=await fetch(e,i)}catch(m){throw W.create("fetch-network-error",{originalErrorMessage:m?.message})}if(s.status!==200)throw W.create("fetch-status-error",{httpStatus:s.status});let o;try{o=await s.json()}catch(m){throw W.create("fetch-parse-error",{originalErrorMessage:m?.message})}const l=o.ttl.match(/^([\d.]+)(s)$/);if(!l||!l[2]||isNaN(Number(l[1])))throw W.create("fetch-parse-error",{originalErrorMessage:`ttl field (timeToLive) is not in standard Protobuf Duration format: ${o.ttl}`});const c=Number(l[1])*1e3,d=Date.now();return{token:o.token,expireTimeMillis:d+c,issuedAtTimeMillis:d}}function pc(e,t){const{projectId:n,appId:r,apiKey:a}=e.options;return{url:`${Ia}/projects/${n}/apps/${r}:${lc}?key=${a}`,body:{recaptcha_v3_token:t}}}function Ta(e,t){const{projectId:n,appId:r,apiKey:a}=e.options;return{url:`${Ia}/projects/${n}/apps/${r}:${dc}?key=${a}`,body:{debug_token:t}}}const gc="firebase-app-check-database",yc=1,it="firebase-app-check-store",xa="debug-token";let gt=null;function La(){return gt||(gt=new Promise((e,t)=>{try{const n=indexedDB.open(gc,yc);n.onsuccess=r=>{e(r.target.result)},n.onerror=r=>{t(W.create("storage-open",{originalErrorMessage:r.target.error?.message}))},n.onupgradeneeded=r=>{const a=r.target.result;switch(r.oldVersion){case 0:a.createObjectStore(it,{keyPath:"compositeKey"})}}}catch(n){t(W.create("storage-open",{originalErrorMessage:n?.message}))}}),gt)}function wc(e){return Ca(Aa(e))}function bc(e,t){return Sa(Aa(e),t)}function vc(e){return Sa(xa,e)}function _c(){return Ca(xa)}async function Sa(e,t){const r=(await La()).transaction(it,"readwrite"),i=r.objectStore(it).put({compositeKey:e,value:t});return new Promise((s,o)=>{i.onsuccess=l=>{s()},r.onerror=l=>{o(W.create("storage-set",{originalErrorMessage:l.target.error?.message}))}})}async function Ca(e){const n=(await La()).transaction(it,"readonly"),a=n.objectStore(it).get(e);return new Promise((i,s)=>{a.onsuccess=o=>{const l=o.target.result;i(l?l.value:void 0)},n.onerror=o=>{s(W.create("storage-get",{originalErrorMessage:o.target.error?.message}))}})}function Aa(e){return`${e.options.appId}-${e.name}`}const ge=new Bt("@firebase/app-check");async function Ec(e){if(At()){let t;try{t=await wc(e)}catch(n){ge.warn(`Failed to read token from IndexedDB. Error: ${n}`)}return t}}function Zt(e,t){return At()?bc(e,t).catch(n=>{ge.warn(`Failed to write token to IndexedDB. Error: ${n}`)}):Promise.resolve()}async function Ic(){let e;try{e=await _c()}catch{}if(e)return e;{const t=crypto.randomUUID();return vc(t).catch(n=>ge.warn(`Failed to persist debug token to IndexedDB. Error: ${n}`)),t}}function On(){return Mt().enabled}async function Nn(){const e=Mt();if(e.enabled&&e.token)return e.token.promise;throw Error(`
            Can't get debug token in production mode.
        `)}function kc(){const e=zr(),t=Mt();if(t.initialized=!0,typeof e.FIREBASE_APPCHECK_DEBUG_TOKEN!="string"&&e.FIREBASE_APPCHECK_DEBUG_TOKEN!==!0)return;t.enabled=!0;const n=new rt;t.token=n,typeof e.FIREBASE_APPCHECK_DEBUG_TOKEN=="string"?n.resolve(e.FIREBASE_APPCHECK_DEBUG_TOKEN):n.resolve(Ic())}const Tc={error:"UNKNOWN_ERROR"};function xc(e){return Tn.encodeString(JSON.stringify(e),!1)}async function gn(e,t=!1,n=!1){const r=e.app;Mn(r);const a=N(r);let i=a.token,s;if(i&&!je(i)&&(a.token=void 0,i=void 0),!i){const c=await a.cachedTokenPromise;c&&(je(c)?i=c:await Zt(r,void 0))}if(!t&&i&&je(i))return{token:i.token};let o=!1;if(On())try{a.exchangeTokenPromise||(a.exchangeTokenPromise=Dn(Ta(r,await Nn()),e.heartbeatServiceProvider).finally(()=>{a.exchangeTokenPromise=void 0}),o=!0);const c=await a.exchangeTokenPromise;return await Zt(r,c),a.token=c,{token:c.token}}catch(c){return c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?ge.warn(c.message):n&&ge.error(c),en(c)}try{a.exchangeTokenPromise||(a.exchangeTokenPromise=a.provider.getToken().finally(()=>{a.exchangeTokenPromise=void 0}),o=!0),i=await N(r).exchangeTokenPromise}catch(c){c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?ge.warn(c.message):n&&ge.error(c),s=c}let l;return i?s?je(i)?l={token:i.token,internalError:s}:l=en(s):(l={token:i.token},a.token=i,await Zt(r,i)):l=en(s),o&&$a(r,l),l}async function Lc(e){const t=e.app;Mn(t);const{provider:n}=N(t);if(On()){const r=await Nn(),{token:a}=await Dn(Ta(t,r),e.heartbeatServiceProvider);return{token:a}}else{const{token:r}=await n.getToken();return{token:r}}}function Ba(e,t,n,r){const{app:a}=e,i=N(a),s={next:n,error:r,type:t};if(i.tokenObservers=[...i.tokenObservers,s],i.token&&je(i.token)){const o=i.token;Promise.resolve().then(()=>{n({token:o.token}),vr(e)}).catch(()=>{})}i.cachedTokenPromise.then(()=>vr(e))}function Ra(e,t){const n=N(e),r=n.tokenObservers.filter(a=>a.next!==t);r.length===0&&n.tokenRefresher&&n.tokenRefresher.isRunning()&&n.tokenRefresher.stop(),n.tokenObservers=r}function vr(e){const{app:t}=e,n=N(t);let r=n.tokenRefresher;r||(r=Sc(e),n.tokenRefresher=r),!r.isRunning()&&n.isTokenAutoRefreshEnabled&&r.start()}function Sc(e){const{app:t}=e;return new mc(async()=>{const n=N(t);let r;if(n.token?r=await gn(e,!0):r=await gn(e),r.error)throw r.error;if(r.internalError)throw r.internalError},()=>!0,()=>{const n=N(t);if(n.token){let r=n.token.issuedAtTimeMillis+(n.token.expireTimeMillis-n.token.issuedAtTimeMillis)*.5+3e5;const a=n.token.expireTimeMillis-300*1e3;return r=Math.min(r,a),Math.max(0,r-Date.now())}else return 0},wr.RETRIAL_MIN_WAIT,wr.RETRIAL_MAX_WAIT)}function $a(e,t){const n=N(e).tokenObservers;for(const r of n)try{r.type==="EXTERNAL"&&t.error!=null?r.error(t.error):r.next(t)}catch{}}function je(e){return e.expireTimeMillis-Date.now()>0}function en(e){return{token:xc(Tc),error:e}}class Cc{constructor(t,n){this.app=t,this.heartbeatServiceProvider=n}_delete(){const{tokenObservers:t}=N(this.app);for(const n of t)Ra(this.app,n.next);return Promise.resolve()}}function Ac(e,t){return new Cc(e,t)}function Bc(e){return{getToken:t=>gn(e,t),getLimitedUseToken:()=>Lc(e),addTokenListener:t=>Ba(e,"INTERNAL",t),removeTokenListener:t=>Ra(e.app,t)}}const Rc="@firebase/app-check",$c="0.11.0";const Mc="https://www.google.com/recaptcha/api.js";function Dc(e,t){const n=new rt,r=N(e);r.reCAPTCHAState={initialized:n};const a=Oc(e),i=br(!1);return i?_r(e,t,i,a,n):Fc(()=>{const s=br(!1);if(!s)throw new Error("no recaptcha");_r(e,t,s,a,n)}),n.promise}function _r(e,t,n,r,a){n.ready(()=>{Pc(e,t,n,r),a.resolve(n)})}function Oc(e){const t=`fire_app_check_${e.name}`,n=document.createElement("div");return n.id=t,n.style.display="none",document.body.appendChild(n),t}async function Nc(e){Mn(e);const n=await N(e).reCAPTCHAState.initialized.promise;return new Promise((r,a)=>{const i=N(e).reCAPTCHAState;n.ready(()=>{r(n.execute(i.widgetId,{action:"fire_app_check"}))})})}function Pc(e,t,n,r){const a=n.render(r,{sitekey:t,size:"invisible",callback:()=>{N(e).reCAPTCHAState.succeeded=!0},"error-callback":()=>{N(e).reCAPTCHAState.succeeded=!1}}),i=N(e);i.reCAPTCHAState={...i.reCAPTCHAState,widgetId:a}}function Fc(e){const t=document.createElement("script");t.src=Mc,t.onload=e,document.head.appendChild(t)}class Pn{constructor(t){this._siteKey=t,this._throttleData=null}async getToken(){Hc(this._throttleData);const t=await Nc(this._app).catch(r=>{throw W.create("recaptcha-error")});if(!N(this._app).reCAPTCHAState?.succeeded)throw W.create("recaptcha-error");let n;try{n=await Dn(pc(this._app,t),this._heartbeatServiceProvider)}catch(r){throw r.code?.includes("fetch-status-error")?(this._throttleData=jc(Number(r.customData?.httpStatus),this._throttleData),W.create("initial-throttle",{time:ka(this._throttleData.allowRequestsAfter-Date.now()),httpStatus:this._throttleData.httpStatus})):r}return this._throttleData=null,n}initialize(t){this._app=t,this._heartbeatServiceProvider=Ne(t,"heartbeat"),Dc(t,this._siteKey).catch(()=>{})}isEqual(t){return t instanceof Pn?this._siteKey===t._siteKey:!1}}function jc(e,t){if(e===404||e===403)return{backoffCount:1,allowRequestsAfter:Date.now()+uc,httpStatus:e};{const n=t?t.backoffCount:0,r=cn(n,1e3,2);return{backoffCount:n+1,allowRequestsAfter:Date.now()+r,httpStatus:e}}}function Hc(e){if(e&&Date.now()-e.allowRequestsAfter<=0)throw W.create("throttled",{time:ka(e.allowRequestsAfter-Date.now()),httpStatus:e.httpStatus})}function qc(e=Ln(),t){e=ct(e);const n=Ne(e,"app-check");if(Mt().initialized||kc(),On()&&Nn().then(a=>console.log(`App Check debug token: ${a}. You will need to add it to your app's App Check settings in the Firebase console for it to work.`)),n.isInitialized()){const a=n.getImmediate(),i=n.getOptions();if(i.isTokenAutoRefreshEnabled===t.isTokenAutoRefreshEnabled&&i.provider.isEqual(t.provider))return a;throw W.create("already-initialized",{appName:e.name})}const r=n.initialize({options:t});return Uc(e,t.provider,t.isTokenAutoRefreshEnabled),N(e).isTokenAutoRefreshEnabled&&Ba(r,"INTERNAL",()=>{}),r}function Uc(e,t,n=!1){const r=cc(e,{...Ea});r.activated=!0,r.provider=t,r.cachedTokenPromise=Ec(e).then(a=>(a&&je(a)&&(r.token=a,$a(e,{token:a.token})),a)),r.isTokenAutoRefreshEnabled=n&&e.automaticDataCollectionEnabled,!e.automaticDataCollectionEnabled&&n&&ge.warn("`isTokenAutoRefreshEnabled` is true but `automaticDataCollectionEnabled` was set to false during `initializeApp()`. This blocks automatic token refresh."),r.provider.initialize(e)}const Wc="app-check",Er="app-check-internal";function Vc(){re(new ee(Wc,e=>{const t=e.getProvider("app").getImmediate(),n=e.getProvider("heartbeat");return Ac(t,n)},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((e,t,n)=>{e.getProvider(Er).initialize()})),re(new ee(Er,e=>{const t=e.getProvider("app-check").getImmediate();return Bc(t)},"PUBLIC").setInstantiationMode("EXPLICIT")),Z(Rc,$c)}Vc();var Ir="@firebase/ai",yn="2.6.0";const Ge="AI",kr="us-central1",zc="firebasevertexai.googleapis.com",Tt="v1beta",Tr=yn,Gc="gl-js",Kc=180*1e3,Yc="gemini-2.0-flash-lite";class x extends ve{constructor(t,n,r){const a=Ge,i=`${a}/${t}`,s=`${a}: ${n} (${i})`;super(t,s),this.code=t,this.customErrorData=r,Error.captureStackTrace&&Error.captureStackTrace(this,x),Object.setPrototypeOf(this,x.prototype),this.toString=()=>s}}const xr=["user","model","function","system"],Ma={HARM_SEVERITY_UNSUPPORTED:"HARM_SEVERITY_UNSUPPORTED"},Lr={SAFETY:"SAFETY",RECITATION:"RECITATION"},Ae={PREFER_ON_DEVICE:"prefer_on_device",ONLY_ON_DEVICE:"only_on_device",ONLY_IN_CLOUD:"only_in_cloud",PREFER_IN_CLOUD:"prefer_in_cloud"},he={ON_DEVICE:"on_device",IN_CLOUD:"in_cloud"};const T={ERROR:"error",REQUEST_ERROR:"request-error",RESPONSE_ERROR:"response-error",FETCH_ERROR:"fetch-error",SESSION_CLOSED:"session-closed",INVALID_CONTENT:"invalid-content",API_NOT_ENABLED:"api-not-enabled",INVALID_SCHEMA:"invalid-schema",NO_API_KEY:"no-api-key",NO_APP_ID:"no-app-id",NO_MODEL:"no-model",NO_PROJECT_ID:"no-project-id",PARSE_FAILED:"parse-failed",UNSUPPORTED:"unsupported"};const ue={VERTEX_AI:"VERTEX_AI",GOOGLE_AI:"GOOGLE_AI"};class Da{constructor(t){this.backendType=t}}class Dt extends Da{constructor(){super(ue.GOOGLE_AI)}_getModelPath(t,n){return`/${Tt}/projects/${t}/${n}`}_getTemplatePath(t,n){return`/${Tt}/projects/${t}/templates/${n}`}}class Fn extends Da{constructor(t=kr){super(ue.VERTEX_AI),t?this.location=t:this.location=kr}_getModelPath(t,n){return`/${Tt}/projects/${t}/locations/${this.location}/${n}`}_getTemplatePath(t,n){return`/${Tt}/projects/${t}/locations/${this.location}/templates/${n}`}}function Jc(e){if(e instanceof Dt)return`${Ge}/googleai`;if(e instanceof Fn)return`${Ge}/vertexai/${e.location}`;throw new x(T.ERROR,`Invalid backend: ${JSON.stringify(e.backendType)}`)}function Xc(e){const t=e.split("/");if(t[0]!==Ge)throw new x(T.ERROR,`Invalid instance identifier, unknown prefix '${t[0]}'`);switch(t[1]){case"vertexai":const r=t[2];if(!r)throw new x(T.ERROR,`Invalid instance identifier, unknown location '${e}'`);return new Fn(r);case"googleai":return new Dt;default:throw new x(T.ERROR,`Invalid instance identifier string: '${e}'`)}}const U=new Bt("@firebase/vertexai");var Le;(function(e){e.UNAVAILABLE="unavailable",e.DOWNLOADABLE="downloadable",e.DOWNLOADING="downloading",e.AVAILABLE="available"})(Le||(Le={}));const tn=[{type:"image"}];class J{constructor(t,n,r){this.languageModelProvider=t,this.mode=n,this.isDownloading=!1,this.onDeviceParams={createOptions:{expectedInputs:tn}},r&&(this.onDeviceParams=r,this.onDeviceParams.createOptions?this.onDeviceParams.createOptions.expectedInputs||(this.onDeviceParams.createOptions.expectedInputs=tn):this.onDeviceParams.createOptions={expectedInputs:tn})}async isAvailable(t){if(!this.mode)return U.debug("On-device inference unavailable because mode is undefined."),!1;if(this.mode===Ae.ONLY_IN_CLOUD)return U.debug('On-device inference unavailable because mode is "only_in_cloud".'),!1;const n=await this.downloadIfAvailable();if(this.mode===Ae.ONLY_ON_DEVICE){if(n===Le.UNAVAILABLE)throw new x(T.API_NOT_ENABLED,"Local LanguageModel API not available in this environment.");return(n===Le.DOWNLOADABLE||n===Le.DOWNLOADING)&&(U.debug("Waiting for download of LanguageModel to complete."),await this.downloadPromise),!0}return n!==Le.AVAILABLE?(U.debug(`On-device inference unavailable because availability is "${n}".`),!1):J.isOnDeviceRequest(t)?!0:(U.debug("On-device inference unavailable because request is incompatible."),!1)}async generateContent(t){const n=await this.createSession(),r=await Promise.all(t.contents.map(J.toLanguageModelMessage)),a=await n.prompt(r,this.onDeviceParams.promptOptions);return J.toResponse(a)}async generateContentStream(t){const n=await this.createSession(),r=await Promise.all(t.contents.map(J.toLanguageModelMessage)),a=n.promptStreaming(r,this.onDeviceParams.promptOptions);return J.toStreamResponse(a)}async countTokens(t){throw new x(T.REQUEST_ERROR,"Count Tokens is not yet available for on-device model.")}static isOnDeviceRequest(t){if(t.contents.length===0)return U.debug("Empty prompt rejected for on-device inference."),!1;for(const n of t.contents){if(n.role==="function")return U.debug('"Function" role rejected for on-device inference.'),!1;for(const r of n.parts)if(r.inlineData&&J.SUPPORTED_MIME_TYPES.indexOf(r.inlineData.mimeType)===-1)return U.debug(`Unsupported mime type "${r.inlineData.mimeType}" rejected for on-device inference.`),!1}return!0}async downloadIfAvailable(){const t=await this.languageModelProvider?.availability(this.onDeviceParams.createOptions);return t===Le.DOWNLOADABLE&&this.download(),t}download(){this.isDownloading||(this.isDownloading=!0,this.downloadPromise=this.languageModelProvider?.create(this.onDeviceParams.createOptions).finally(()=>{this.isDownloading=!1}))}static async toLanguageModelMessage(t){const n=await Promise.all(t.parts.map(J.toLanguageModelMessageContent));return{role:J.toLanguageModelMessageRole(t.role),content:n}}static async toLanguageModelMessageContent(t){if(t.text)return{type:"text",value:t.text};if(t.inlineData){const r=await(await fetch(`data:${t.inlineData.mimeType};base64,${t.inlineData.data}`)).blob();return{type:"image",value:await createImageBitmap(r)}}throw new x(T.REQUEST_ERROR,"Processing of this Part type is not currently supported.")}static toLanguageModelMessageRole(t){return t==="model"?"assistant":"user"}async createSession(){if(!this.languageModelProvider)throw new x(T.UNSUPPORTED,"Chrome AI requested for unsupported browser version.");const t=await this.languageModelProvider.create(this.onDeviceParams.createOptions);return this.oldSession&&this.oldSession.destroy(),this.oldSession=t,t}static toResponse(t){return{json:async()=>({candidates:[{content:{parts:[{text:t}]}}]})}}static toStreamResponse(t){const n=new TextEncoder;return{body:t.pipeThrough(new TransformStream({transform(r,a){const i=JSON.stringify({candidates:[{content:{role:"model",parts:[{text:r}]}}]});a.enqueue(n.encode(`data: ${i}

`))}}))}}}J.SUPPORTED_MIME_TYPES=["image/jpeg","image/png"];function Qc(e,t,n){if(typeof t<"u"&&e)return new J(t.LanguageModel,e,n)}class Zc{constructor(t,n,r,a,i){this.app=t,this.backend=n,this.chromeAdapterFactory=i;const s=a?.getImmediate({optional:!0}),o=r?.getImmediate({optional:!0});this.auth=o||null,this.appCheck=s||null,n instanceof Fn?this.location=n.location:this.location=""}_delete(){return Promise.resolve()}set options(t){this._options=t}get options(){return this._options}}function el(e,{instanceIdentifier:t}){if(!t)throw new x(T.ERROR,"AIService instance identifier is undefined.");const n=Xc(t),r=e.getProvider("app").getImmediate(),a=e.getProvider("auth-internal"),i=e.getProvider("app-check-internal");return new Zc(r,n,a,i,Qc)}function tl(e){if(e.app?.options?.apiKey)if(e.app?.options?.projectId){if(!e.app?.options?.appId)throw new x(T.NO_APP_ID,'The "appId" field is empty in the local Firebase config. Firebase AI requires this field to contain a valid app ID.')}else throw new x(T.NO_PROJECT_ID,'The "projectId" field is empty in the local Firebase config. Firebase AI requires this field to contain a valid project ID.');else throw new x(T.NO_API_KEY,'The "apiKey" field is empty in the local Firebase config. Firebase AI requires this field to contain a valid API key.');const t={apiKey:e.app.options.apiKey,project:e.app.options.projectId,appId:e.app.options.appId,automaticDataCollectionEnabled:e.app.automaticDataCollectionEnabled,location:e.location,backend:e.backend};if(ks(e.app)&&e.app.settings.appCheckToken){const n=e.app.settings.appCheckToken;t.getAppCheckToken=()=>Promise.resolve({token:n})}else e.appCheck&&(e.options?.useLimitedUseAppCheckTokens?t.getAppCheckToken=()=>e.appCheck.getLimitedUseToken():t.getAppCheckToken=()=>e.appCheck.getToken());return e.auth&&(t.getAuthToken=()=>e.auth.getToken()),t}class Xe{constructor(t,n){this._apiSettings=tl(t),this.model=Xe.normalizeModelName(n,this._apiSettings.backend.backendType)}static normalizeModelName(t,n){return n===ue.GOOGLE_AI?Xe.normalizeGoogleAIModelName(t):Xe.normalizeVertexAIModelName(t)}static normalizeGoogleAIModelName(t){return`models/${t}`}static normalizeVertexAIModelName(t){let n;return t.includes("/")?t.startsWith("models/")?n=`publishers/google/${t}`:n=t:n=`publishers/google/models/${t}`,n}}class nl{constructor(t){this.params=t}toString(){const t=new URL(this.baseUrl);return t.pathname=this.pathname,t.search=this.queryParams.toString(),t.toString()}get pathname(){return this.params.templateId?`${this.params.apiSettings.backend._getTemplatePath(this.params.apiSettings.project,this.params.templateId)}:${this.params.task}`:`${this.params.apiSettings.backend._getModelPath(this.params.apiSettings.project,this.params.model)}:${this.params.task}`}get baseUrl(){return this.params.requestOptions?.baseUrl??`https://${zc}`}get queryParams(){const t=new URLSearchParams;return this.params.stream&&t.set("alt","sse"),t}}function rl(){const e=[];return e.push(`${Gc}/${Tr}`),e.push(`fire/${Tr}`),e.join(" ")}async function al(e){const t=new Headers;if(t.append("Content-Type","application/json"),t.append("x-goog-api-client",rl()),t.append("x-goog-api-key",e.params.apiSettings.apiKey),e.params.apiSettings.automaticDataCollectionEnabled&&t.append("X-Firebase-Appid",e.params.apiSettings.appId),e.params.apiSettings.getAppCheckToken){const n=await e.params.apiSettings.getAppCheckToken();n&&(t.append("X-Firebase-AppCheck",n.token),n.error&&U.warn(`Unable to obtain a valid App Check token: ${n.error.message}`))}if(e.params.apiSettings.getAuthToken){const n=await e.params.apiSettings.getAuthToken();n&&t.append("Authorization",`Firebase ${n.accessToken}`)}return t}async function jn(e,t){const n=new nl(e);let r,a;try{const i={method:"POST",headers:await al(n),body:t},s=e.requestOptions?.timeout!=null&&e.requestOptions.timeout>=0?e.requestOptions.timeout:Kc,o=new AbortController;if(a=setTimeout(()=>o.abort(),s),i.signal=o.signal,r=await fetch(n.toString(),i),!r.ok){let l="",c;try{const d=await r.json();l=d.error.message,d.error.details&&(l+=` ${JSON.stringify(d.error.details)}`,c=d.error.details)}catch{}throw r.status===403&&c&&c.some(d=>d.reason==="SERVICE_DISABLED")&&c.some(d=>d.links?.[0]?.description.includes("Google developers console API activation"))?new x(T.API_NOT_ENABLED,`The Firebase AI SDK requires the Firebase AI API ('firebasevertexai.googleapis.com') to be enabled in your Firebase project. Enable this API by visiting the Firebase Console at https://console.firebase.google.com/project/${n.params.apiSettings.project}/genai/ and clicking "Get started". If you enabled this API recently, wait a few minutes for the action to propagate to our systems and then retry.`,{status:r.status,statusText:r.statusText,errorDetails:c}):new x(T.FETCH_ERROR,`Error fetching from ${n}: [${r.status} ${r.statusText}] ${l}`,{status:r.status,statusText:r.statusText,errorDetails:c})}}catch(i){let s=i;throw i.code!==T.FETCH_ERROR&&i.code!==T.API_NOT_ENABLED&&i instanceof Error&&(s=new x(T.ERROR,`Error fetching from ${n.toString()}: ${i.message}`),s.stack=i.stack),s}finally{a&&clearTimeout(a)}return r}function yt(e){if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&U.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Oa(e.candidates[0]))throw new x(T.RESPONSE_ERROR,`Response error: ${Be(e)}. Response body stored in error.response`,{response:e});return!0}else return!1}function xt(e,t=he.IN_CLOUD){e.candidates&&!e.candidates[0].hasOwnProperty("index")&&(e.candidates[0].index=0);const n=il(e);return n.inferenceSource=t,n}function il(e){return e.text=()=>{if(yt(e))return Sr(e,t=>!t.thought);if(e.promptFeedback)throw new x(T.RESPONSE_ERROR,`Text not available. ${Be(e)}`,{response:e});return""},e.thoughtSummary=()=>{if(yt(e)){const t=Sr(e,n=>!!n.thought);return t===""?void 0:t}else if(e.promptFeedback)throw new x(T.RESPONSE_ERROR,`Thought summary not available. ${Be(e)}`,{response:e})},e.inlineDataParts=()=>{if(yt(e))return ol(e);if(e.promptFeedback)throw new x(T.RESPONSE_ERROR,`Data not available. ${Be(e)}`,{response:e})},e.functionCalls=()=>{if(yt(e))return sl(e);if(e.promptFeedback)throw new x(T.RESPONSE_ERROR,`Function call not available. ${Be(e)}`,{response:e})},e}function Sr(e,t){const n=[];if(e.candidates?.[0].content?.parts)for(const r of e.candidates?.[0].content?.parts)r.text&&t(r)&&n.push(r.text);return n.length>0?n.join(""):""}function sl(e){const t=[];if(e.candidates?.[0].content?.parts)for(const n of e.candidates?.[0].content?.parts)n.functionCall&&t.push(n.functionCall);if(t.length>0)return t}function ol(e){const t=[];if(e.candidates?.[0].content?.parts)for(const n of e.candidates?.[0].content?.parts)n.inlineData&&t.push(n);if(t.length>0)return t}const cl=[Lr.RECITATION,Lr.SAFETY];function Oa(e){return!!e.finishReason&&cl.some(t=>t===e.finishReason)}function Be(e){let t="";if((!e.candidates||e.candidates.length===0)&&e.promptFeedback)t+="Response was blocked",e.promptFeedback?.blockReason&&(t+=` due to ${e.promptFeedback.blockReason}`),e.promptFeedback?.blockReasonMessage&&(t+=`: ${e.promptFeedback.blockReasonMessage}`);else if(e.candidates?.[0]){const n=e.candidates[0];Oa(n)&&(t+=`Candidate was blocked due to ${n.finishReason}`,n.finishMessage&&(t+=`: ${n.finishMessage}`))}return t}function Na(e){if(e.safetySettings?.forEach(t=>{if(t.method)throw new x(T.UNSUPPORTED,"SafetySetting.method is not supported in the the Gemini Developer API. Please remove this property.")}),e.generationConfig?.topK){const t=Math.round(e.generationConfig.topK);t!==e.generationConfig.topK&&(U.warn("topK in GenerationConfig has been rounded to the nearest integer to match the format for requests to the Gemini Developer API."),e.generationConfig.topK=t)}return e}function Hn(e){return{candidates:e.candidates?dl(e.candidates):void 0,prompt:e.promptFeedback?ul(e.promptFeedback):void 0,usageMetadata:e.usageMetadata}}function ll(e,t){return{generateContentRequest:{model:t,...e}}}function dl(e){const t=[];let n;return t&&e.forEach(r=>{let a;if(r.citationMetadata&&(a={citations:r.citationMetadata.citationSources}),r.safetyRatings&&(n=r.safetyRatings.map(s=>({...s,severity:s.severity??Ma.HARM_SEVERITY_UNSUPPORTED,probabilityScore:s.probabilityScore??0,severityScore:s.severityScore??0}))),r.content?.parts?.some(s=>s?.videoMetadata))throw new x(T.UNSUPPORTED,"Part.videoMetadata is not supported in the Gemini Developer API. Please remove this property.");const i={index:r.index,content:r.content,finishReason:r.finishReason,finishMessage:r.finishMessage,safetyRatings:n,citationMetadata:a,groundingMetadata:r.groundingMetadata,urlContextMetadata:r.urlContextMetadata};t.push(i)}),t}function ul(e){const t=[];return e.safetyRatings.forEach(r=>{t.push({category:r.category,probability:r.probability,severity:r.severity??Ma.HARM_SEVERITY_UNSUPPORTED,probabilityScore:r.probabilityScore??0,severityScore:r.severityScore??0,blocked:r.blocked})}),{blockReason:e.blockReason,safetyRatings:t,blockReasonMessage:e.blockReasonMessage}}const Cr=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function ml(e,t,n){const r=e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),a=pl(r),[i,s]=a.tee();return{stream:hl(i,t,n),response:fl(s,t,n)}}async function fl(e,t,n){const r=[],a=e.getReader();for(;;){const{done:i,value:s}=await a.read();if(i){let o=gl(r);return t.backend.backendType===ue.GOOGLE_AI&&(o=Hn(o)),xt(o,n)}r.push(s)}}async function*hl(e,t,n){const r=e.getReader();for(;;){const{value:a,done:i}=await r.read();if(i)break;let s;t.backend.backendType===ue.GOOGLE_AI?s=xt(Hn(a),n):s=xt(a,n);const o=s.candidates?.[0];!o?.content?.parts&&!o?.finishReason&&!o?.citationMetadata&&!o?.urlContextMetadata||(yield s)}}function pl(e){const t=e.getReader();return new ReadableStream({start(r){let a="";return i();function i(){return t.read().then(({value:s,done:o})=>{if(o){if(a.trim()){r.error(new x(T.PARSE_FAILED,"Failed to parse stream"));return}r.close();return}a+=s;let l=a.match(Cr),c;for(;l;){try{c=JSON.parse(l[1])}catch{r.error(new x(T.PARSE_FAILED,`Error parsing JSON response: "${l[1]}`));return}r.enqueue(c),a=a.substring(l[0].length),l=a.match(Cr)}return i()})}}})}function gl(e){const n={promptFeedback:e[e.length-1]?.promptFeedback};for(const r of e)if(r.candidates)for(const a of r.candidates){const i=a.index||0;n.candidates||(n.candidates=[]),n.candidates[i]||(n.candidates[i]={index:a.index}),n.candidates[i].citationMetadata=a.citationMetadata,n.candidates[i].finishReason=a.finishReason,n.candidates[i].finishMessage=a.finishMessage,n.candidates[i].safetyRatings=a.safetyRatings,n.candidates[i].groundingMetadata=a.groundingMetadata;const s=a.urlContextMetadata;if(typeof s=="object"&&s!==null&&Object.keys(s).length>0&&(n.candidates[i].urlContextMetadata=s),a.content){if(!a.content.parts)continue;n.candidates[i].content||(n.candidates[i].content={role:a.content.role||"user",parts:[]});for(const o of a.content.parts){const l={...o};o.text!==""&&Object.keys(l).length>0&&n.candidates[i].content.parts.push(l)}}}return n}const yl=[T.FETCH_ERROR,T.ERROR,T.API_NOT_ENABLED];async function Pa(e,t,n,r){if(!t)return{response:await r(),inferenceSource:he.IN_CLOUD};switch(t.mode){case Ae.ONLY_ON_DEVICE:if(await t.isAvailable(e))return{response:await n(),inferenceSource:he.ON_DEVICE};throw new x(T.UNSUPPORTED,"Inference mode is ONLY_ON_DEVICE, but an on-device model is not available.");case Ae.ONLY_IN_CLOUD:return{response:await r(),inferenceSource:he.IN_CLOUD};case Ae.PREFER_IN_CLOUD:try{return{response:await r(),inferenceSource:he.IN_CLOUD}}catch(a){if(a instanceof x&&yl.includes(a.code))return{response:await n(),inferenceSource:he.ON_DEVICE};throw a}case Ae.PREFER_ON_DEVICE:return await t.isAvailable(e)?{response:await n(),inferenceSource:he.ON_DEVICE}:{response:await r(),inferenceSource:he.IN_CLOUD};default:throw new x(T.ERROR,`Unexpected infererence mode: ${t.mode}`)}}async function wl(e,t,n,r){return e.backend.backendType===ue.GOOGLE_AI&&(n=Na(n)),jn({task:"streamGenerateContent",model:t,apiSettings:e,stream:!0,requestOptions:r},JSON.stringify(n))}async function Fa(e,t,n,r,a){const i=await Pa(n,r,()=>r.generateContentStream(n),()=>wl(e,t,n,a));return ml(i.response,e)}async function bl(e,t,n,r){return e.backend.backendType===ue.GOOGLE_AI&&(n=Na(n)),jn({model:t,task:"generateContent",apiSettings:e,stream:!1,requestOptions:r},JSON.stringify(n))}async function ja(e,t,n,r,a){const i=await Pa(n,r,()=>r.generateContent(n),()=>bl(e,t,n,a)),s=await vl(i.response,e);return{response:xt(s,i.inferenceSource)}}async function vl(e,t){const n=await e.json();return t.backend.backendType===ue.GOOGLE_AI?Hn(n):n}function Ha(e){if(e!=null){if(typeof e=="string")return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)return e.role?e:{role:"system",parts:e.parts}}}function wn(e){let t=[];if(typeof e=="string")t=[{text:e}];else for(const n of e)typeof n=="string"?t.push({text:n}):t.push(n);return _l(t)}function _l(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let r=!1,a=!1;for(const i of e)"functionResponse"in i?(n.parts.push(i),a=!0):(t.parts.push(i),r=!0);if(r&&a)throw new x(T.INVALID_CONTENT,"Within a single message, FunctionResponse cannot be mixed with other type of Part in the request for sending chat message.");if(!r&&!a)throw new x(T.INVALID_CONTENT,"No Content is provided for sending chat message.");return r?t:n}function nn(e){let t;return e.contents?t=e:t={contents:[wn(e)]},e.systemInstruction&&(t.systemInstruction=Ha(e.systemInstruction)),t}const Ar=["text","inlineData","functionCall","functionResponse","thought","thoughtSignature"],El={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","thought","thoughtSignature"],system:["text"]},Br={user:["model"],function:["model"],model:["user","function"],system:[]};function Il(e){let t=null;for(const n of e){const{role:r,parts:a}=n;if(!t&&r!=="user")throw new x(T.INVALID_CONTENT,`First Content should be with role 'user', got ${r}`);if(!xr.includes(r))throw new x(T.INVALID_CONTENT,`Each item should include role field. Got ${r} but valid roles are: ${JSON.stringify(xr)}`);if(!Array.isArray(a))throw new x(T.INVALID_CONTENT,"Content should have 'parts' property with an array of Parts");if(a.length===0)throw new x(T.INVALID_CONTENT,"Each Content should have at least one part");const i={text:0,inlineData:0,functionCall:0,functionResponse:0,thought:0,thoughtSignature:0,executableCode:0,codeExecutionResult:0};for(const o of a)for(const l of Ar)l in o&&(i[l]+=1);const s=El[r];for(const o of Ar)if(!s.includes(o)&&i[o]>0)throw new x(T.INVALID_CONTENT,`Content with role '${r}' can't contain '${o}' part`);if(t&&!Br[r].includes(t.role))throw new x(T.INVALID_CONTENT,`Content with role '${r}' can't follow '${t.role}'. Valid previous roles: ${JSON.stringify(Br)}`);t=n}}const Rr="SILENT_ERROR";class kl{constructor(t,n,r,a,i){this.model=n,this.chromeAdapter=r,this.params=a,this.requestOptions=i,this._history=[],this._sendPromise=Promise.resolve(),this._apiSettings=t,a?.history&&(Il(a.history),this._history=a.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(t){await this._sendPromise;const n=wn(t),r={safetySettings:this.params?.safetySettings,generationConfig:this.params?.generationConfig,tools:this.params?.tools,toolConfig:this.params?.toolConfig,systemInstruction:this.params?.systemInstruction,contents:[...this._history,n]};let a={};return this._sendPromise=this._sendPromise.then(()=>ja(this._apiSettings,this.model,r,this.chromeAdapter,this.requestOptions)).then(i=>{if(i.response.candidates&&i.response.candidates.length>0){this._history.push(n);const s={parts:i.response.candidates?.[0].content.parts||[],role:i.response.candidates?.[0].content.role||"model"};this._history.push(s)}else{const s=Be(i.response);s&&U.warn(`sendMessage() was unsuccessful. ${s}. Inspect response object for details.`)}a=i}),await this._sendPromise,a}async sendMessageStream(t){await this._sendPromise;const n=wn(t),r={safetySettings:this.params?.safetySettings,generationConfig:this.params?.generationConfig,tools:this.params?.tools,toolConfig:this.params?.toolConfig,systemInstruction:this.params?.systemInstruction,contents:[...this._history,n]},a=Fa(this._apiSettings,this.model,r,this.chromeAdapter,this.requestOptions);return this._sendPromise=this._sendPromise.then(()=>a).catch(i=>{throw new Error(Rr)}).then(i=>i.response).then(i=>{if(i.candidates&&i.candidates.length>0){this._history.push(n);const s={...i.candidates[0].content};s.role||(s.role="model"),this._history.push(s)}else{const s=Be(i);s&&U.warn(`sendMessageStream() was unsuccessful. ${s}. Inspect response object for details.`)}}).catch(i=>{i.message!==Rr&&U.error(i)}),a}}async function Tl(e,t,n,r){let a="";if(e.backend.backendType===ue.GOOGLE_AI){const s=ll(n,t);a=JSON.stringify(s)}else a=JSON.stringify(n);return(await jn({model:t,task:"countTokens",apiSettings:e,stream:!1,requestOptions:r},a)).json()}async function xl(e,t,n,r,a){if(r?.mode===Ae.ONLY_ON_DEVICE)throw new x(T.UNSUPPORTED,"countTokens() is not supported for on-device models.");return Tl(e,t,n,a)}class Ll extends Xe{constructor(t,n,r,a){super(t,n.model),this.chromeAdapter=a,this.generationConfig=n.generationConfig||{},this.safetySettings=n.safetySettings||[],this.tools=n.tools,this.toolConfig=n.toolConfig,this.systemInstruction=Ha(n.systemInstruction),this.requestOptions=r||{}}async generateContent(t){const n=nn(t);return ja(this._apiSettings,this.model,{generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,...n},this.chromeAdapter,this.requestOptions)}async generateContentStream(t){const n=nn(t);return Fa(this._apiSettings,this.model,{generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,...n},this.chromeAdapter,this.requestOptions)}startChat(t){return new kl(this._apiSettings,this.model,this.chromeAdapter,{tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,generationConfig:this.generationConfig,safetySettings:this.safetySettings,...t},this.requestOptions)}async countTokens(t){const n=nn(t);return xl(this._apiSettings,this.model,n,this.chromeAdapter)}}function Sl(e=Ln(),t){e=ct(e);const n=Ne(e,Ge),r=t?.backend??new Dt,a={useLimitedUseAppCheckTokens:t?.useLimitedUseAppCheckTokens??!1},i=Jc(r),s=n.getImmediate({identifier:i});return s.options=a,s}function Cl(e,t,n){const r=t;let a;if(r.mode?a=r.inCloudParams||{model:Yc}:a=t,!a.model)throw new x(T.NO_MODEL,"Must provide a model name. Example: getGenerativeModel({ model: 'my-model-name' })");const i=e.chromeAdapterFactory?.(r.mode,typeof window>"u"?void 0:window,r.onDeviceParams);return new Ll(e,a,n,i)}function Al(){re(new ee(Ge,el,"PUBLIC").setMultipleInstances(!0)),Z(Ir,yn),Z(Ir,yn,"esm2020")}Al();const Bl={apiKey:"AIzaSyCmAiYHJ77vZCNzP1juaeU4xQ_KV6kc5h4",authDomain:"watchlist-b2fd0.firebaseapp.com",projectId:"watchlist-b2fd0",storageBucket:"watchlist-b2fd0.firebasestorage.app",messagingSenderId:"917010956394",appId:"1:917010956394:web:6ed1aa6e057ceced48ca13",measurementId:"G-ZZFBMG2K1G"},qn=Qr(Bl);nc(qn);typeof window<"u"&&qc(qn,{provider:new Pn("6LdRTRQsAAAAAK07rxxw0rG2s7iBlrx_zLaLs4u5"),isTokenAutoRefreshEnabled:!0});const Rl=Sl(qn,{backend:new Dt}),qa=Cl(Rl,{model:"gemini-2.5-flash"}),$l="25e3d089cc8e37a56bf6a1984daf3c5c";async function Ml(){console.log("Performing a hard reset. Deleting all media data...");const{error:e}=await g.from("media").delete().neq("id",0);if(e){console.error("CRITICAL: Failed to delete data. Check your RLS policies.",e);return}console.log("All existing media has been deleted.");const t=await Ol();if(t.length){console.log(`Starting to seed ${t.length} items from watchednotes.json...`);for(const n of t){const r=await Dl(n.title);if(r){const{error:a}=await g.from("media").insert({title:n.title,type:n.type,tmdb_id:r,source:"fetched"});a&&console.error(`Error inserting '${n.title}':`,a)}}console.log("Database hard reset and seeding complete.")}}async function Dl(e){const t=`https://api.themoviedb.org/3/search/multi?api_key=${$l}&query=${encodeURIComponent(e)}`;try{const r=await(await fetch(t)).json();if(r.results&&r.results.length>0){const a=r.results.find(i=>i.media_type==="movie"||i.media_type==="tv");if(a)return a.id}return console.warn(`TMDB ID not found for: ${e}`),null}catch(n){return console.error(`Error fetching TMDB ID for ${e}:`,n),null}}async function Ol(){try{const e=await fetch("/watchednotes.json");if(!e.ok)throw new Error("Failed to fetch watchednotes.json");return await e.json()}catch(e){return console.error("Error fetching local media data:",e),[]}}async function Nl(){const{data:e,error:t}=await g.from("flairs").select("*").order("name");return t?(console.error("Error fetching flairs:",t),[]):e}async function Pl(e){const{data:t,error:n}=await g.from("media_flairs").select(`
            flair_id,
            flairs (
                id,
                name,
                color,
                icon,
                description
            )
        `).eq("media_id",e);return n?(console.error("Error fetching media flairs:",n),[]):t.map(r=>r.flairs)}async function Fl(e){const{data:t,error:n}=await g.from("flairs").insert([e]).select().single();return n?(console.error("Error creating flair:",n),null):t}async function jl(e,t){const n=await Pl(e);if(n.length>=2)return{success:!1,message:"Max 2 flairs per media item."};if(n.find(a=>a.id===t))return{success:!1,message:"Flair already assigned."};const{error:r}=await g.from("media_flairs").insert([{media_id:e,flair_id:t}]);return r?(console.error("Error assigning flair:",r),{success:!1,message:"Failed to assign flair."}):{success:!0,message:"Flair assigned."}}async function Hl(e,t){const{error:n}=await g.from("media_flairs").delete().eq("media_id",e).eq("flair_id",t);return n?(console.error("Error removing flair:",n),!1):!0}function pe(e,t="text-xs px-2 py-0.5"){let n="";return e.icon&&(e.icon.startsWith("fa")?n=`<i class="${e.icon}"></i>`:n=`<span>${e.icon}</span>`),`
        <span class="inline-flex items-center gap-1 rounded-full font-semibold shadow-sm ${t} transform transition-transform hover:scale-105 cursor-default border border-white/20" 
              style="background-color: ${e.color}; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
            ${n}
            <span>${e.name}</span>
        </span>
    `}const ql="25e3d089cc8e37a56bf6a1984daf3c5c",Ul=[{name:"get_activity_log",description:"Fetches the most recent activity logs from the database to see what users have been doing (watching, rating, etc.).",parameters:{type:"object",properties:{limit:{type:"number",description:"The number of activity logs to fetch (default 10, max 50)."}}}},{name:"get_user_settings",description:"Fetches the current user settings, including themes, bios, avatars, and wallpapers.",parameters:{type:"object",properties:{}}},{name:"get_list_by_status",description:"Fetches a list of media items filtered by their status (watched, want_to_watch, currently_watching).",parameters:{type:"object",properties:{status:{type:"string",description:"The status to filter by: 'watched', 'want_to_watch', or 'currently_watching'.",enum:["watched","want_to_watch","currently_watching"]},limit:{type:"number",description:"The number of items to fetch (default 20)."}},required:["status"]}},{name:"search_tmdb",description:"Searches for movies or TV shows in the global TMDB database (online search). Use this when the user asks for something not in their watchlist.",parameters:{type:"object",properties:{query:{type:"string",description:"The movie or TV show title to search for."}},required:["query"]}},{name:"search_media",description:"Searches the LOCAL watchlist database for specific titles. Use this first to see if they already have it.",parameters:{type:"object",properties:{query:{type:"string",description:"The title to search for."}},required:["query"]}},{name:"get_media_flairs",description:"Fetches the flairs assigned to a specific media item.",parameters:{type:"object",properties:{media_id:{type:"number",description:"The ID of the media item in the database (not TMDB ID)."}},required:["media_id"]}},{name:"get_tv_progress",description:"Fetches the watching progress for a TV show (seasons/episodes).",parameters:{type:"object",properties:{tmdb_id:{type:"number",description:"The TMDB ID of the TV show."}},required:["tmdb_id"]}},{name:"add_to_watchlist",description:"Adds a movie or TV show to the user's watchlist (marks as 'Want to Watch').",parameters:{type:"object",properties:{tmdb_id:{type:"number",description:"The TMDB ID of the media."},type:{type:"string",description:"The type of media ('movie' or 'tv')."},title:{type:"string",description:"The title of the media."}},required:["tmdb_id","type","title"]}},{name:"rate_media",description:"Updates the rating for a media item for a specific user.",parameters:{type:"object",properties:{tmdb_id:{type:"number",description:"The TMDB ID of the media."},rating:{type:"number",description:"The rating value (1-10)."},user:{type:"string",description:"The user rating the item ('juainny' or 'erick')."}},required:["tmdb_id","rating","user"]}},{name:"update_media_notes",description:"Updates the notes for a media item for a specific user.",parameters:{type:"object",properties:{tmdb_id:{type:"number",description:"The TMDB ID of the media."},note:{type:"string",description:"The content of the note."},user:{type:"string",description:"The user adding the note ('juainny' or 'erick')."}},required:["tmdb_id","note","user"]}},{name:"get_media_notes",description:"Retrieves the notes and ratings for a specific media item by title.",parameters:{type:"object",properties:{title:{type:"string",description:"The title of the media to get notes for."}},required:["title"]}},{name:"get_watched_media",description:"Fetches all media items marked as 'watched' by a specific user. Supports filtering by media type and rating status.",parameters:{type:"object",properties:{user:{type:"string",description:"The user whose watchlist to fetch ('juainny' or 'erick')."},type:{type:"string",description:"Optional. Filter by media type: 'movie' or 'tv'."},unrated_only:{type:"boolean",description:"Optional. If true, only return items that the user hasn't rated yet."}},required:["user"]}},{name:"mark_watched",description:"Marks a media item as watched.",parameters:{type:"object",properties:{tmdb_id:{type:"number",description:"The TMDB ID of the media."}},required:["tmdb_id"]}},{name:"request_user_rating",description:"Ask the user to rate a movie or TV show. Use this when the user wants to rate something or you need their opinion. The UI will show a star rating input.",parameters:{type:"object",properties:{tmdb_id:{type:"integer",description:"The TMDB ID of the media to rate."}},required:["tmdb_id"]}},{name:"start_trivia",description:"Start a trivia game about a specific movie or TV show. The UI will show a trivia card with a question and options.",parameters:{type:"object",properties:{tmdb_id:{type:"integer",description:"The TMDB ID of the media to quiz on."}},required:["tmdb_id"]}},{name:"analyze_taste",description:"Analyze the user's recently watched/rated items and 'roast' or compliment their taste. Use this when the user asks to roast their taste or analyze their profile.",parameters:{type:"object",properties:{user_id:{type:"string",description:"The user ID to analyze (e.g., 'juainny' or 'erick')."}},required:["user_id"]}},{name:"recommend_by_vibe",description:"Find a movie from the user's *existing* watchlist (or new ones) that matches a specific mood/vibe. Use this when the user says 'I want to cry', 'I want adrenaline', etc.",parameters:{type:"object",properties:{vibe:{type:"string",description:"The mood or vibe to match (e.g., 'sad', 'exciting', 'cozy')."},genre:{type:"string",description:"Optional genre filter."}},required:["vibe"]}}],$r={async get_activity_log({limit:e=10}){const t=Math.min(Math.max(e,1),50),{data:n,error:r}=await g.from("activity_log").select(`
                *,
                media:media_id (title, name)
            `).order("created_at",{ascending:!1}).limit(t);return r?`Error fetching activity log: ${r.message}`:JSON.stringify(n)},async get_user_settings(){const{data:e,error:t}=await g.from("settings").select("*").single();return t?`Error fetching settings: ${t.message}`:JSON.stringify(e)},async get_list_by_status({status:e,limit:t=20}){const n=Math.min(Math.max(t,1),50);let r=g.from("media").select("title, type, release_year, tmdb_id");if(e==="watched")r=r.eq("watched",!0);else if(e==="want_to_watch")r=r.eq("want_to_watch",!0);else if(e==="currently_watching")r=r.eq("currently_watching",!0);else return"Invalid status. Please use 'watched', 'want_to_watch', or 'currently_watching'.";const{data:a,error:i}=await r.limit(n);return i?`Error fetching list: ${i.message}`:!a||a.length===0?`No items found in '${e}' list.`:JSON.stringify(a)},async search_tmdb({query:e}){try{const t=await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${ql}&query=${encodeURIComponent(e)}&include_adult=false`);if(!t.ok)return"Error searching TMDB.";const r=(await t.json()).results.slice(0,5).map(a=>({title:a.title||a.name,type:a.media_type,year:a.release_date||a.first_air_date,overview:a.overview,tmdb_id:a.id}));return r.length===0?"No results found online.":JSON.stringify(r)}catch(t){return`Error connecting to TMDB: ${t.message}`}},async search_media({query:e}){const{data:t,error:n}=await g.from("media").select("*").ilike("title",`%${e}%`).limit(5);return n?`Error searching media: ${n.message}`:!t||t.length===0?"No media found matching that query.":JSON.stringify(t)},async get_media_flairs({media_id:e}){const{data:t,error:n}=await g.from("media_flairs").select(`
                *,
                flair:flair_id (label, icon, color)
            `).eq("media_id",e);return n?`Error fetching flairs: ${n.message}`:JSON.stringify(t)},async get_tv_progress({tmdb_id:e}){const{data:t,error:n}=await g.from("media").select("*").eq("tmdb_id",e).single();return n?`Error fetching TV progress: ${n.message}`:JSON.stringify({status:t.currently_watching?"Currently Watching":t.watched?"Watched":"Not Started",details:"Detailed episode progress tracking is not fully implemented in the database yet."})},async add_to_watchlist({tmdb_id:e,type:t,title:n}){const{data:r}=await g.from("media").select("id").eq("tmdb_id",e).single();if(r){const{error:a}=await g.from("media").update({want_to_watch:!0}).eq("id",r.id);return a?`Error updating watchlist: ${a.message}`:`Updated '${n}' to be in the watchlist.`}else{const{error:a}=await g.from("media").insert([{tmdb_id:e,type:t,title:n,want_to_watch:!0}]);return a?`Error adding to watchlist: ${a.message}`:`Added '${n}' to the watchlist.`}},async rate_media({tmdb_id:e,rating:t,user:n}){const r=n.toLowerCase()==="juainny"?"juainny_rating":"erick_rating",{data:a}=await g.from("media").select("id").eq("tmdb_id",e).single();if(!a)return"Media item not found in database. Please add it first.";const{error:i}=await g.from("media").update({[r]:t}).eq("id",a.id);return i?`Error rating media: ${i.message}`:`Rated '${e}' as ${t}/10 for ${n}.`},async analyze_taste({user_id:e}){const{data:t,error:n}=await g.from("activity_log").select("*, media(*)").eq("user_id",e.toLowerCase()).order("created_at",{ascending:!1}).limit(20);if(n)throw new Error(`Failed to fetch history: ${n.message}`);if(!t||t.length===0)return"No recent history found to analyze.";const r=t.map(a=>{const i=a.media?.title||a.media?.name||"Unknown Title",s=a.action_type,o=a.details?.rating?`rated ${a.details.rating} stars`:"";return`- ${s} "${i}" ${o}`}).join(`
`);return`Here is ${e}'s recent activity:
${r}

Please analyze this taste profile. Be sassy, funny, and slightly judgmental (a "roast"). Point out patterns (e.g., "too many rom-coms", "pretentious sci-fi").`},async get_watched_media({user:e,type:t,unrated_only:n}){const{data:r,error:a}=await g.from("media").select("*").eq("watched",!0);if(a)throw new Error(`Failed to fetch watched media: ${a.message}`);if(!r||r.length===0)return`${e} hasn't marked any items as watched yet.`;let i=r;if(t&&(i=i.filter(c=>c.type===t)),n){const c=e.toLowerCase()==="juainny"?"juainny_rating":"erick_rating";i=i.filter(d=>!d[c]||d[c]===0)}if(i.length===0)return"No items found matching your criteria.";const s=i.map(c=>{const d=c.title||c.name,m=c.release_year||"",f=c.type==="movie"?"ðŸŽ¬":"ðŸ“º",y=e.toLowerCase()==="juainny"?"juainny_rating":"erick_rating",h=c[y]?`â­ ${c[y]}/10`:"(unrated)";return`${f} ${d} ${m?`(${m})`:""} - ${h}`}).slice(0,50).join(`
`),o=i.length,l=Math.min(50,o);return`Here are ${e}'s watched items (showing ${l} of ${o}):

${s}${o>50?`

...and more. Let me know if you need a specific subset.`:""}`},async recommend_by_vibe({vibe:e,genre:t}){const{data:n,error:r}=await g.from("media").select("*");if(r)throw new Error(`Failed to fetch media: ${r.message}`);if(!n||n.length===0)return"No media found in database.";const o=n.filter(l=>!l.watched).sort(()=>.5-Math.random()).slice(0,30).map(l=>`- ${l.title||l.name} (Overview: ${l.overview?.substring(0,100)}...)`).join(`
`);return`The user wants a recommendation with this vibe: "${e}"${t?` and genre: ${t}`:""}.
        
Here is a sample of items from their watchlist they haven't watched yet:
${o}

Please pick the BEST match from this list. Explain why it fits the vibe perfectly. If none fit well, say so.`},async update_media_notes({tmdb_id:e,note:t,user:n}){const r=n.toLowerCase()==="juainny"?"juainny_notes":"erick_notes",{data:a}=await g.from("media").select("id").eq("tmdb_id",e).single();if(!a)return"Media item not found in database. Please add it first.";const{error:i}=await g.from("media").update({[r]:t}).eq("id",a.id);return i?`Error updating notes: ${i.message}`:`Updated notes for '${e}' for ${n}.`},async get_media_notes({title:e}){const{data:t,error:n}=await g.from("media").select("title, juainny_notes, erick_notes, juainny_rating, erick_rating").ilike("title",`%${e}%`).limit(1).single();return n?n.code==="PGRST116"?`No media found with title matching "${e}".`:`Error fetching notes: ${n.message}`:JSON.stringify({title:t.title,juainny:{notes:t.juainny_notes||"No notes yet",rating:t.juainny_rating||"Not rated"},erick:{notes:t.erick_notes||"No notes yet",rating:t.erick_rating||"Not rated"}})},async mark_watched({tmdb_id:e}){const{data:t}=await g.from("media").select("id, title").eq("tmdb_id",e).single();if(!t)return"Media item not found. Please add it first.";const{error:n}=await g.from("media").update({watched:!0,want_to_watch:!1,currently_watching:!1}).eq("id",t.id);return n?`Error marking media as watched: ${n.message}`:`Marked '${t.title}' as watched.`}};async function Mr(e,t,n){const r={title:e.title||e.name,type:e.type,year:e.release_year,rating:e.content_rating,runtime:e.runtime,overview:e.overview,genres:e.genres},a=`Summarize opinions on this ${r.type||"media"}:

**Title:** ${r.title}
**Type:** ${r.type||"Unknown"}
${r.year?`**Year:** ${r.year}`:""}
${r.overview?`**Overview:** ${r.overview.substring(0,200)}...`:""}

**Juainny:** ${t.user1||"Not rated"}/10 - ${n.user1||"No notes"}
**Erick:** ${t.user2||"Not rated"}/10 - ${n.user2||"No notes"}

Rules:
- Use **markdown** (bold, italic, lists)
- Max 60 words
- Highlight agreement/disagreement
- No greetings
- Be accurate about the media type`;try{return(await(await qa.generateContent(a)).response).text()}catch(i){return console.error("Error generating summary:",i),"Unable to generate summary at this time."}}function Ot(e,t=null){const n=new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),r={total:e.length,watched:e.filter(l=>l.watched).length,want_to_watch:e.filter(l=>l.want_to_watch).length,currently_watching:e.filter(l=>l.currently_watching).length,favorited:e.filter(l=>l.favorited_by?.length>0).length},a=e.map(l=>({t:l.title||l.name,w:l.watched?1:0,cw:l.currently_watching?1:0})),i=t?`
**Current User:** You are chatting with ${t.charAt(0).toUpperCase()+t.slice(1)}. When they say "my notes" or "my rating", they mean ${t}'s notes/rating. Personalize your responses accordingly.`:"",s=`Today: ${n}

You are Mr. W, an AI assistant for Juainny and Erick's watchlist app.${i}

**Database Context:**
Stats: ${JSON.stringify(r)}
Titles (Sample): ${JSON.stringify(a.slice(0,50))}... (Use search_media tool for more)

**Important:**
- You have access to tools to query the database and perform actions.
- **ALWAYS** use the \`search_media\` tool if the user asks about a specific movie/show to see if it's ALREADY in the database.
- **ALWAYS** use the \`search_tmdb\` tool if the user asks about a movie/show that is NOT in the database (online search).
- **ALWAYS** use \`get_list_by_status\` if the user asks "what am I watching?" or "what do I want to watch?".
- **ALWAYS** use \`get_activity_log\` if the user asks about recent activity.
- **ALWAYS** use \`get_user_settings\` if the user asks about themes, bios, or avatars.
- **ALWAYS** use \`get_media_flairs\` if the user asks about flairs for a specific item.
- **ALWAYS** use \`get_tv_progress\` if the user asks about episode/season progress.
- **ALWAYS** use \`get_media_notes\` when asked about notes or ratings for a specific title.
- Use \`add_to_watchlist\`, \`rate_media\`, \`update_media_notes\`, or \`mark_watched\` when explicitly asked to perform these actions.
- **IMPORTANT:** If asked to update notes, ALWAYS confirm the content with the user before saving.
- Maintain conversation context across messages.
- Ratings are out of 10.
- Use **markdown** formatting.
- Be conversational and helpful.`;return qa.startChat({history:[{role:"user",parts:[{text:s}]},{role:"model",parts:[{text:"Hello! I'm Mr. W. I can help you manage your watchlist, check your activity, and more. How can I help you today?"}]}],generationConfig:{maxOutputTokens:1e3,temperature:.7},tools:[{functionDeclarations:Ul}]})}async function Ua(e,t){try{let n=await e.sendMessage(t),r=await n.response,a=r.text(),i=r.functionCalls();for(;i&&i.length>0;){const o=[];for(const l of i){const c=l.name,d=l.args;if($r[c])try{const m=await $r[c](d);o.push({functionResponse:{name:c,response:{name:c,content:m}}})}catch(m){console.error(`Error executing tool ${c}:`,m),o.push({functionResponse:{name:c,response:{name:c,content:`Error executing tool: ${m.message}`}}})}else console.error(`Tool ${c} not found.`),o.push({functionResponse:{name:c,response:{name:c,content:`Error: Tool ${c} not found.`}}})}n=await e.sendMessage(o),r=await n.response,a=r.text(),i=r.functionCalls()}if(!a||a.trim().length===0)return r.promptFeedback?.blockReason?{route:"ERROR",text:`Response blocked: ${r.promptFeedback.blockReason}`}:{route:"ERROR",text:"Received empty response. Please try again."};let s="CHAT";return/database|watchlist|stats|titles/i.test(a)?s="DATABASE":/search|web|google|found|according to/i.test(a)&&(s="WEB"),{route:s,text:a}}catch(n){return console.error("Chat error details:",n),{route:"ERROR",text:`Error: ${n.message||"Unknown error occurred"}. Try refreshing the page.`}}}const rn=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEEAD","#D4A5A5","#9B59B6","#3498DB","#E67E22","#2ECC71"];class Wl{constructor(t,n){this.allMedia=t||[],this.filteredItems=[],this.openModalCallback=n,this.canvas=document.getElementById("wheel-canvas"),this.ctx=this.canvas?this.canvas.getContext("2d"):null,this.isSpinning=!1,this.currentAngle=0,this.spinVelocity=0,this.spinFriction=.985,this.segments=[],this.modal=document.getElementById("wheel-modal"),this.spinBtn=document.getElementById("wheel-spin-btn"),this.closeBtn=document.getElementById("close-wheel-modal-btn"),this.shuffleBtn=document.getElementById("wheel-shuffle-btn"),this.itemCountLabel=document.getElementById("wheel-item-count"),this.filterMovie=document.getElementById("wheel-filter-movie"),this.filterTV=document.getElementById("wheel-filter-tv"),this.filterRuntime=document.getElementById("wheel-filter-runtime"),this.filterRuntimeValue=document.getElementById("wheel-runtime-value"),this.ratingFiltersContainer=document.getElementById("wheel-rating-filters"),this.sourceSelect=document.getElementById("wheel-source-select"),this.resultOverlay=document.getElementById("wheel-result-overlay"),this.winnerCard=document.getElementById("wheel-winner-card"),this.winnerImage=document.getElementById("wheel-winner-image"),this.winnerTitle=document.getElementById("wheel-winner-title"),this.openWinnerBtn=document.getElementById("wheel-open-winner-btn"),this.removeWinnerBtn=document.getElementById("wheel-remove-winner-btn"),this.closeResultBtn=document.getElementById("wheel-close-result-btn"),this.currentWinner=null,this.removedIds=new Set,this.init()}init(){this.canvas&&(window.addEventListener("resize",()=>this.resizeCanvas()),this.spinBtn.addEventListener("click",()=>this.spin()),this.closeBtn.addEventListener("click",()=>this.close()),this.shuffleBtn.addEventListener("click",()=>this.shuffle()),this.filterMovie.addEventListener("change",()=>this.applyFilters()),this.filterTV.addEventListener("change",()=>this.applyFilters()),this.filterRuntime.addEventListener("input",t=>{const n=t.target.value;this.filterRuntimeValue.textContent=n>=240?"All":`< ${n}m`,this.applyFilters()}),this.sourceSelect.addEventListener("change",()=>{this.updateSourceIndicator(),this.applyFilters()}),this.closeResultBtn.addEventListener("click",()=>this.hideResult()),this.openWinnerBtn.addEventListener("click",()=>{this.currentWinner&&(this.openModalCallback(this.currentWinner.tmdb_id,this.currentWinner.type||this.currentWinner.media_type),this.close())}),this.removeWinnerBtn.addEventListener("click",()=>{this.removeWinner(),this.hideResult()}),this.winnerCard&&this.winnerCard.addEventListener("click",()=>{this.currentWinner&&(this.openModalCallback(this.currentWinner.tmdb_id,this.currentWinner.type||this.currentWinner.media_type),this.close())}),this.populateRatingFilters(),this.updateSourceIndicator(),this.applyFilters())}updateMedia(t){this.allMedia=t,this.removedIds.clear(),this.populateRatingFilters(),this.applyFilters()}populateRatingFilters(){const t=new Set;this.allMedia.forEach(n=>{n.content_rating&&t.add(n.content_rating)}),this.ratingFiltersContainer.innerHTML="",Array.from(t).sort().forEach(n=>{if(!n)return;const r=document.createElement("label");r.className="cursor-pointer group",r.innerHTML=`
                <input type="checkbox" value="${n}" checked class="peer hidden wheel-rating-checkbox">
                <div class="h-8 rounded-lg bg-bg-tertiary border border-border-primary peer-checked:border-accent-primary peer-checked:bg-accent-primary/10 flex items-center justify-center transition-all">
                    <span class="text-xs font-medium text-text-secondary peer-checked:text-accent-primary group-hover:text-text-primary">${n}</span>
                </div>
            `,r.querySelector("input").addEventListener("change",()=>this.applyFilters()),this.ratingFiltersContainer.appendChild(r)})}applyFilters(){const t=this.filterMovie.checked,n=this.filterTV.checked,r=parseInt(this.filterRuntime.value),a=this.sourceSelect.value,i=Array.from(this.ratingFiltersContainer.querySelectorAll("input:checked")).map(s=>s.value);this.filteredItems=this.allMedia.filter(s=>{if(this.removedIds.has(s.tmdb_id))return!1;const o=s.type==="movie"||s.media_type==="movie",l=s.type==="tv"||s.media_type==="tv"||s.type==="series";if(o&&!t||l&&!n||s.content_rating&&!i.includes(s.content_rating))return!1;if(r<240){const c=s.runtime||(s.episode_run_time?s.episode_run_time[0]:0);if(!c||c>r)return!1}return!(a==="want-to-watch"&&!s.want_to_watch||a==="currently-watching"&&!s.currently_watching)}),this.itemCountLabel.textContent=`${this.filteredItems.length} items`,this.drawWheel()}updateSourceIndicator(){const t=document.getElementById("source-indicator");if(!t)return;const n=this.sourceSelect.value;n==="all"?t.style.transform="translateX(0)":n==="want-to-watch"?t.style.transform="translateX(100%)":n==="currently-watching"&&(t.style.transform="translateX(200%)")}resizeCanvas(){const t=this.canvas.parentElement,n=t.clientWidth,r=t.clientHeight;n>0&&r>0&&(this.canvas.width=n,this.canvas.height=r,this.drawWheel())}drawWheel(){if(!this.ctx)return;const{width:t,height:n}=this.canvas,r=t/2,a=n/2,i=Math.min(t,n)/2-10;if(i<=0||!isFinite(i))return;this.ctx.clearRect(0,0,t,n);const s=this.filteredItems.length;if(s===0){this.ctx.fillStyle="#ccc",this.ctx.beginPath(),this.ctx.arc(r,a,i,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#666",this.ctx.font="20px Inter",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("No items found",r,a);return}const o=Math.PI*2/s;this.ctx.save(),this.ctx.translate(r,a),this.ctx.rotate(this.currentAngle);for(let l=0;l<s;l++){const c=this.filteredItems[l],d=l*o,m=(l+1)*o;this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.arc(0,0,i,d,m),this.ctx.fillStyle=rn[l%rn.length],this.ctx.fill(),this.ctx.stroke(),this.ctx.save(),this.ctx.rotate(d+o/2),this.ctx.textAlign="right",this.ctx.fillStyle="#fff",this.ctx.font=s>50?"10px Inter":"14px Inter",this.ctx.shadowColor="rgba(0,0,0,0.5)",this.ctx.shadowBlur=4;let f=c.title||c.name;f.length>20&&(f=f.substring(0,18)+"..."),this.ctx.fillText(f,i-20,5),this.ctx.restore()}this.ctx.restore()}spin(){this.isSpinning||this.filteredItems.length===0||(this.isSpinning=!0,this.spinVelocity=Math.random()*.3+.4,this.spinBtn.disabled=!0,this.spinBtn.classList.add("opacity-50","cursor-not-allowed"),this.animate())}animate(){this.isSpinning&&(this.currentAngle+=this.spinVelocity,this.spinVelocity*=this.spinFriction,this.spinVelocity<.001?(this.isSpinning=!1,this.spinVelocity=0,this.spinBtn.disabled=!1,this.spinBtn.classList.remove("opacity-50","cursor-not-allowed"),this.determineWinner()):(this.drawWheel(),requestAnimationFrame(()=>this.animate())))}determineWinner(){const t=this.filteredItems.length,n=Math.PI*2/t;let r=this.currentAngle%(Math.PI*2);const a=(Math.PI*2-r%(Math.PI*2))%(Math.PI*2),i=Math.floor(a/n);this.currentWinner=this.filteredItems[i];const s=(i+.5)*n;this.currentAngle=-s,this.drawWheel(),this.showResult(this.currentWinner)}showResult(t){window.confetti&&window.confetti({particleCount:150,spread:70,origin:{y:.6},colors:rn}),this.winnerTitle.textContent=t.title||t.name;const n=t.poster_path;n?(this.winnerImage.crossOrigin="anonymous",this.winnerImage.src=n.startsWith("http")?n:`https://image.tmdb.org/t/p/w500${n}`):this.winnerImage.src="https://placehold.co/300x450?text=No+Image",this.resultOverlay.classList.remove("hidden"),setTimeout(()=>{this.resultOverlay.classList.remove("opacity-0")},10)}hideResult(){this.resultOverlay.classList.add("opacity-0"),setTimeout(()=>{this.resultOverlay.classList.add("hidden")},300)}removeWinner(){this.currentWinner&&(this.filteredItems=this.filteredItems.filter(t=>t.tmdb_id!==this.currentWinner.tmdb_id),this.removedIds||(this.removedIds=new Set),this.removedIds.add(this.currentWinner.tmdb_id),this.applyFilters())}shuffle(){for(let t=this.filteredItems.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[this.filteredItems[t],this.filteredItems[n]]=[this.filteredItems[n],this.filteredItems[t]]}this.drawWheel()}open(){this.modal.classList.remove("hidden"),this.modal.classList.add("flex"),setTimeout(()=>{this.resizeCanvas(),this.applyFilters()},10)}close(){this.modal.classList.add("hidden"),this.modal.classList.remove("flex")}}function Vl(e,t){return new Wl(e,t)}const ae="25e3d089cc8e37a56bf6a1984daf3c5c";async function zl(e){let n=[],r=0,a=0;for(let i=0;i<e.length;i+=10){const o=e.slice(i,i+10).map(async c=>{if(!c.tmdb_id||!c.type)return c;const f=`https://api.themoviedb.org/3/${c.type==="movie"?"movie":"tv"}/${c.tmdb_id}?api_key=${ae}&append_to_response=release_dates,content_ratings,external_ids`;try{const y=await fetch(f);if(!y.ok)return console.error(`Error fetching TMDB data for ${c.title} (ID: ${c.tmdb_id}): ${y.status}`),a++,c;const h=await y.json(),E=h.title||h.name,u={};c.poster_path!==h.poster_path&&(u.poster_path=h.poster_path),c.title!==E&&(u.title=E);const p=h.release_date||h.first_air_date||"",_=p?parseInt(p.split("-")[0]):null;_&&(!c.release_year||c.release_year!==_)&&(u.release_year=_);let I=h.runtime||(h.episode_run_time&&h.episode_run_time.length>0?h.episode_run_time[0]:0);const B=c.type==="tv"||c.type==="series";B&&!I&&(h.last_episode_to_air&&h.last_episode_to_air.runtime?I=h.last_episode_to_air.runtime:h.next_episode_to_air&&h.next_episode_to_air.runtime&&(I=h.next_episode_to_air.runtime)),I&&(c.runtime===0||!c.runtime||c.runtime!==I)&&(u.runtime=I);let v="N/A";if(c.type==="movie"&&h.release_dates){const S=h.release_dates.results.find($=>$.iso_3166_1==="US");if(S){const $=S.release_dates.find(ie=>ie.certification!=="");$&&(v=$.certification)}}else if(B&&h.content_ratings&&h.content_ratings.results){const S=h.content_ratings.results.find($=>$.iso_3166_1==="US");S?v=S.rating:h.content_ratings.results.length>0&&(v=h.content_ratings.results[0].rating)}v!=="N/A"&&(!c.content_rating||c.content_rating==="N/A"||c.content_rating!==v)&&(u.content_rating=v);const L=h.external_ids?.imdb_id;if(L&&(!c.imdb_id||c.imdb_id!==L)&&(u.imdb_id=L),Object.keys(u).length>0){const{error:S}=await g.from("media").update(u).eq("id",c.id);return S?(console.error(`Error updating Supabase for ${c.title}:`,S),a++,c):(r++,{...c,...u})}return c}catch(y){return console.error(`Error during TMDB sync for ${c.title}:`,y),a++,c}}),l=await Promise.all(o);n=n.concat(l)}return n}let A=[],Qe=[],K=[],oe="all",bn="grid",Lt="default",xe=[],D=new Map,vn=!1;async function Gl(e){if(!e||e.trim()==="")return[];const t=`https://api.themoviedb.org/3/search/multi?api_key=${ae}&query=${encodeURIComponent(e)}`;try{let a=(await(await fetch(t)).json()).results.filter(s=>s.media_type==="movie"||s.media_type==="tv");const{data:i}=await g.from("settings").select("hide_search_results_without_images").single();return i?.hide_search_results_without_images&&(a=a.filter(s=>s.poster_path)),i?.hide_search_results_without_images&&(a=a.filter(s=>s.poster_path)),a}catch(n){return console.error("Error searching TMDB:",n),[]}}function V(){const e=document.getElementById("movie-grid"),t=document.getElementById("movie-list");if(oe==="all"?K=Qe:K=Qe.filter(n=>{const r=n.type||n.media_type;return oe==="movie"?r==="movie":oe==="tv"?r==="tv"||r==="series":oe==="watched"?n.watched===!0:oe==="rejected"?n.rejected===!0:!1}),sd(),bn==="grid"){if(e.innerHTML="",t.innerHTML="",e.style.display="grid",t.style.display="none",K.length===0){e.innerHTML='<p class="text-text-muted col-span-full text-center">No results found.</p>';return}for(const n of K){const r=n.poster_path?`https://image.tmdb.org/t/p/w500${n.poster_path}`:"https://placehold.co/500x750?text=No+Image",a=n.title||n.name,i=n.type||n.media_type,s=n.tmdb_id||n.id;Kl(e,a,i,s,r,n.watched,vn)}}else{if(e.innerHTML="",t.innerHTML="",e.style.display="none",t.style.display="block",K.length===0){t.innerHTML='<p class="text-text-muted text-center">No results found.</p>';return}const n=document.createElement("div");n.className="bg-bg-secondary p-4 md:p-6 rounded-lg shadow-lg",K.forEach(r=>{const a=r.title||r.name,i=r.type||r.media_type,s=r.tmdb_id||r.id,o=document.createElement("div");o.className="flex items-center py-1",o.innerHTML=`
                <span class="text-text-muted mr-2">-</span>
                <a href="#" class="text-text-primary hover:text-accent-primary underline transition-colors" data-tmdb-id="${s}" data-type="${i}">${a}</a>
            `,o.querySelector("a").addEventListener("click",l=>{l.preventDefault(),Re(s,i)}),n.appendChild(o)}),t.appendChild(n)}}function Kl(e,t,n,r,a,i,s=!1){const o=document.createElement("div");o.className="movie-card relative rounded-lg shadow-lg overflow-hidden cursor-pointer group",i&&o.classList.add("watched"),o.dataset.tmdbId=r,o.dataset.type=n;const l=A.find(c=>c.tmdb_id==r)?.favorited_by||[];if(l.length>1?o.classList.add("super-favorite-glow"):l.length>0&&o.classList.add("favorite-glow"),o.innerHTML=`
        <img src="${a}" alt="${t}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" crossorigin="anonymous">
        
        <!-- Reactions Overlay -->
        <div class="absolute top-2 left-2 flex flex-col gap-1 z-10">
            ${A.find(c=>c.tmdb_id==r)?.juainny_reaction?`
                <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Juainny" data-reaction="${A.find(c=>c.tmdb_id==r).juainny_reaction}">
                    <img src="moods/${A.find(c=>c.tmdb_id==r).juainny_reaction}" class="w-full h-full object-contain drop-shadow-md">
                    <div class="absolute -bottom-1 -right-1 w-4 h-4">
                        ${z("juainny","w-full h-full")}
                    </div>
                </div>
            `:""}
            ${A.find(c=>c.tmdb_id==r)?.erick_reaction?`
                <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Erick" data-reaction="${A.find(c=>c.tmdb_id==r).erick_reaction}">
                    <img src="moods/${A.find(c=>c.tmdb_id==r).erick_reaction}" class="w-full h-full object-contain drop-shadow-md">
                    <div class="absolute -bottom-1 -right-1 w-4 h-4">
                        ${z("erick","w-full h-full")}
                    </div>
                </div>
            `:""}
        </div>

        <div class="absolute bottom-2 left-2 flex flex-col gap-1 z-10 items-start pointer-events-none">
            <!-- Flairs Container -->
             ${(D.get(A.find(c=>c.tmdb_id==r)?.id)||[]).map(c=>pe(c,"text-[10px] px-1.5 py-0.5 shadow-md")).join("")}
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4">
            <!-- Title removed as per user request -->
        </div>
        ${s?`
        <button class="bookmark-icon absolute bottom-2 right-2 text-white text-2xl transition-all duration-200" style="transform: scale(1);">
            <i class="fas fa-bookmark"></i>
        </button>
        `:""}
    `,o.querySelectorAll(".reaction-item").forEach(c=>{c.addEventListener("mouseenter",d=>{Pt(d.currentTarget)}),c.addEventListener("mouseleave",()=>{lt()}),c.addEventListener("click",d=>{Wn(d.currentTarget,d)})}),s){const c=o.querySelector(".bookmark-icon");c&&(A.find(m=>m.tmdb_id==r)?.want_to_watch&&(c.classList.add("text-yellow-400"),c.classList.remove("text-white")),c.addEventListener("click",async m=>{m.stopPropagation();const f=a.includes("image.tmdb.org")?a.replace("https://image.tmdb.org/t/p/w500",""):null,y=await We(r,n,t,f);if(!y)return;D.has(y.id)||D.set(y.id,[]);const h=!y.want_to_watch,E={want_to_watch:h};h&&(E.currently_watching=!1);const{error:u}=await g.from("media").update(E).eq("id",y.id);u?console.error("Error updating bookmark from grid:",u):(c.style.transform="scale(1.3)",setTimeout(()=>{c.style.transform="scale(1)"},200),h?(c.classList.remove("text-white"),c.classList.add("text-yellow-400")):(c.classList.remove("text-yellow-400"),c.classList.add("text-white")))}))}o.addEventListener("click",c=>{Re(r,n)}),e.appendChild(o)}async function Ze(){const{data:e,error:t}=await g.from("media").select("*").eq("currently_watching",!0);if(t)return console.error("Error fetching currently watching media:",t),[];if(!e||e.length===0)return[];const n=e.map(s=>s.id),{data:r,error:a}=await g.from("activity_log").select("media_id, created_at").in("media_id",n).order("created_at",{ascending:!1});if(a)return console.error("Error fetching activity logs for sorting:",a),e;const i={};return r.forEach(s=>{i[s.media_id]||(i[s.media_id]=new Date(s.created_at).getTime())}),e.sort((s,o)=>{const l=i[s.id]||0;return(i[o.id]||0)-l})}async function et(){const{data:e,error:t}=await g.from("media").select("*").eq("want_to_watch",!0).order("created_at",{ascending:!1});return t?(console.error("Error fetching want to watch media:",t),[]):e}function ne(e,t){const n=document.getElementById(e);if(!n)return;if(n.className="relative group/carousel w-full overflow-hidden",n.innerHTML="",t.length===0){n.innerHTML='<p class="text-text-muted text-center w-full">Nothing here yet!</p>';return}const r=document.createElement("div");r.className="flex gap-4 scroll-smooth pb-4 px-1 scrollbar-hide snap-x snap-mandatory",r.style.cssText="overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; max-width: 100%; width: 100%;";const a=document.createElement("style");a.textContent=`
        #${e} .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    `,n.appendChild(a);const i=document.createElement("div");i.className="absolute left-0 top-0 bottom-0 z-20 flex items-center px-2 opacity-0 group-hover/carousel:opacity-100 transition-opacity";const s=document.createElement("button");s.type="button",s.className="bg-accent-primary hover:bg-accent-secondary text-white p-2 rounded-full cursor-pointer transition-colors",s.innerHTML='<i class="fas fa-chevron-left"></i>',s.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation();const d=r.clientWidth*.8;r.scrollTo({left:r.scrollLeft-d,behavior:"smooth"})}),i.appendChild(s);const o=document.createElement("div");o.className="absolute right-0 top-0 bottom-0 z-20 flex items-center px-2 opacity-0 group-hover/carousel:opacity-100 transition-opacity";const l=document.createElement("button");l.type="button",l.className="bg-accent-primary hover:bg-accent-secondary text-white p-2 rounded-full cursor-pointer transition-colors",l.innerHTML='<i class="fas fa-chevron-right"></i>',l.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation();const d=r.clientWidth*.8;r.scrollTo({left:r.scrollLeft+d,behavior:"smooth"})}),o.appendChild(l),n.appendChild(i),n.appendChild(r),n.appendChild(o),t.forEach(c=>{const d=c.poster_path?`https://image.tmdb.org/t/p/w500${c.poster_path}`:"https://placehold.co/500x750?text=No+Image",m=c.title||c.name,f=c.type||c.media_type,y=c.tmdb_id||c.id,h=document.createElement("div");h.className="flex-shrink-0 w-32 sm:w-36 md:w-44 lg:w-48 movie-card relative rounded-lg shadow-lg overflow-hidden cursor-pointer group snap-start",h.style.cssText="flex-shrink: 0;",h.dataset.tmdbId=y,h.dataset.type=f;let E=c.favorited_by||[];if(typeof E=="string")try{E=JSON.parse(E)}catch{E=[]}const u=E.includes("user1"),p=E.includes("user2");u&&p?h.classList.add("rainbow-glow"):(u||p)&&h.classList.add("favorite-glow"),h.innerHTML=`
            <img src="${d}" alt="${m}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
            <!-- Removed gradient overlay as per request -->
            
            <!-- Reactions Overlay -->
            <div class="absolute top-2 left-2 flex flex-col gap-1 z-10">
                ${c.juainny_reaction?`
                    <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Juainny" data-reaction="${c.juainny_reaction}">
                        <img src="moods/${c.juainny_reaction}" class="w-full h-full object-contain drop-shadow-md">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4">
                            ${z("juainny","w-full h-full")}
                        </div>
                    </div>
                `:""}
                ${c.erick_reaction?`
                    <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Erick" data-reaction="${c.erick_reaction}">
                        <img src="moods/${c.erick_reaction}" class="w-full h-full object-contain drop-shadow-md">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4">
                            ${z("erick","w-full h-full")}
                        </div>
                    </div>
                `:""}
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-2">
                 <!-- Title removed -->
            </div>
            
            <div class="absolute bottom-2 left-2 flex flex-col gap-1 z-10 items-start pointer-events-none">
                <!-- Flairs Container -->
                 ${(D.get(c.id)||[]).map(_=>pe(_,"text-[10px] px-1.5 py-0.5 shadow-md")).join("")}
            </div>
        `,h.querySelectorAll(".reaction-item").forEach(_=>{_.addEventListener("mouseenter",I=>{Pt(I.currentTarget)}),_.addEventListener("mouseleave",()=>{lt()}),_.addEventListener("click",I=>{Wn(I.currentTarget,I)})}),h.addEventListener("click",()=>Re(y,f)),r.appendChild(h)})}let w=null;async function Re(e,t){const n=document.getElementById("movie-modal");if(n)try{let r;document.body.style.overflow="hidden";const a=document.querySelector("footer");a&&a.classList.add("hidden");const i=document.getElementById("juainny-profile-link"),s=document.getElementById("erick-profile-link");i&&(i.onclick=()=>window.location.href="/profile?user=juainny"),s&&(s.onclick=()=>window.location.href="/profile?user=erick");const o=document.getElementById("tv-progress-section"),l=document.getElementById("tv-warning-section"),c=p=>p?p.watched||p.currently_watching||p.want_to_watch:!1,d=A.find(p=>p.tmdb_id==e),m=c(d);if(t==="tv"||t==="series"){if(o.classList.remove("hidden"),!l){const p=document.createElement("div");p.id="tv-warning-section",p.className="hidden text-center py-8 px-4 bg-yellow-500/10 rounded-lg border border-yellow-500/20 my-4",p.innerHTML=`
                <i class="fas fa-lock text-yellow-500 text-3xl mb-3"></i>
                <p class="text-text-primary font-semibold">Episode Guide Locked</p>
                <p class="text-text-muted text-sm mt-2">You can't see the episode carousel until you add this as "Watched", "Watching", or "Want to Watch".</p>
             `,o.parentNode.insertBefore(p,o.nextSibling)}if(m){o.classList.remove("hidden");const p=document.getElementById("tv-warning-section");p&&p.classList.add("hidden");const B=`https://api.themoviedb.org/3/${t==="movie"?"movie":"tv"}/${e}?api_key=${ae}&append_to_response=credits,images,videos,release_dates,external_ids`,L=await(await fetch(B)).json();await Va(e,L.seasons)}else{o.classList.add("hidden");const p=document.getElementById("tv-warning-section");p&&p.classList.remove("hidden")}}else{o.classList.add("hidden");const p=document.getElementById("tv-warning-section");p&&p.classList.add("hidden")}n.dataset.tmdbId=e;const f=A.find(p=>p.tmdb_id==e)||(w&&w.tmdb_id==e?w:null);if(f){document.getElementById("modal-overview").textContent=f.overview||"Loading...",document.getElementById("modal-title").textContent=f.title||f.name||"Loading...";const p=f.release_date||f.first_air_date||"";document.getElementById("modal-release-year").textContent=p.substring(0,4),n.classList.remove("hidden"),n.classList.remove("modal-hidden"),n.classList.add("flex")}const E=`https://api.themoviedb.org/3/${t==="movie"?"movie":"tv"}/${e}?api_key=${ae}&append_to_response=credits,images,videos,release_dates,external_ids,content_ratings`;let u;try{const p=await fetch(E);if(!p.ok)throw new Error("Failed to fetch modal data.");u=await p.json(),document.getElementById("modal-overview").textContent=u.overview;const _=document.getElementById("modal-title");_.innerHTML="";const I=u.images?.logos?.find(b=>b.iso_639_1==="en"&&!b.file_path.endsWith(".svg"))||u.images?.logos?.[0],B=u.title||u.name;if(I){const b=`https://image.tmdb.org/t/p/w500${I.file_path}`;_.innerHTML=`<img src="${b}" alt="${B} Logo" class="max-h-20 object-contain cursor-pointer" style="max-width: 14.4rem;">`;const C=_.querySelector("img");C&&C.addEventListener("dblclick",()=>{navigator.clipboard.writeText(B).then(()=>{bd()}).catch(k=>{console.error("Failed to copy text:",k)})})}else _.textContent=B;const v=u.release_date||u.first_air_date||"",L=f?.release_year||v.substring(0,4);document.getElementById("modal-release-year").textContent=L;let S=f?.runtime||u.runtime||(u.episode_run_time&&u.episode_run_time.length>0?u.episode_run_time[0]:0);t==="tv"&&!S&&(u.last_episode_to_air&&u.last_episode_to_air.runtime?S=u.last_episode_to_air.runtime:u.next_episode_to_air&&u.next_episode_to_air.runtime&&(S=u.next_episode_to_air.runtime)),document.getElementById("modal-runtime").textContent=Xl(S),Ql(S);let $=f?.content_rating||"N/A";if($==="N/A"){if(t==="movie"&&u.release_dates){const b=u.release_dates.results.find(C=>C.iso_3166_1==="US");if(b){const C=b.release_dates.find(k=>k.certification!=="");C&&($=C.certification)}}else if(t==="tv"&&u.content_ratings&&u.content_ratings.results){const b=u.content_ratings.results.find(C=>C.iso_3166_1==="US");b?$=b.rating:u.content_ratings.results.length>0&&($=u.content_ratings.results[0].rating)}}document.getElementById("modal-content-rating").textContent=$;const ie=document.getElementById("title-tooltip");if(ie){const b=f?.title||f?.name||u.title||u.name;ie.setAttribute("title",b)}const se=u.external_ids.imdb_id,Pe=u.vote_average?u.vote_average.toFixed(1):"N/A";document.getElementById("modal-score").textContent=Pe;const Fe=document.getElementById("modal-imdb-link");if(se?(Fe.href=`https://www.imdb.com/title/${se}`,Fe.style.display="flex"):Fe.style.display="none",m&&d&&d.id&&(d.watched||d.currently_watching)){const b={},C=document.getElementById("willow-summary-section"),k=document.getElementById("willow-summary-text"),P=document.getElementById("regenerate-summary-btn");C.classList.remove("hidden"),k.innerHTML='<i class="fas fa-spinner fa-spin"></i> Loading...';const M=d.juainny_rating&&d.juainny_rating>0||d.erick_rating&&d.erick_rating>0,j=d.juainny_notes?.replace(/<[^>]*>/g,"").trim()||"",G=d.erick_notes?.replace(/<[^>]*>/g,"").trim()||"",te=j.length>0||G.length>0;!M&&!te?k.innerHTML='<em class="text-text-muted">No ratings or notes yet. Willow will share thoughts once you add some!</em>':d.ai_summary?k.innerHTML=vt(d.ai_summary):(async()=>{k.innerHTML='<i class="fas fa-spinner fa-spin"></i> Willow is thinking...';const Ht=document.querySelector("#juainny-rating-container .stars")?.dataset.rating||d.juainny_rating,qt=document.getElementById("juainny-notes").innerText,Ut=document.querySelector("#erick-rating-container .stars")?.dataset.rating||d.erick_rating,Wt=document.getElementById("erick-notes").innerText,Vt={user1:Ht,user2:Ut},Ie={user1:qt,user2:Wt};try{const fe=await Mr(d,Vt,Ie);k.innerHTML=vt(fe);const{error:Xn}=await g.from("media").update({ai_summary:fe}).eq("tmdb_id",e);Xn?console.error("Failed to save summary:",Xn):d.ai_summary=fe}catch(fe){console.error("Summary generation error:",fe),k.innerHTML='<em class="text-red-400">Failed to generate summary</em>'}})(),P.style.display="flex",P.onclick=async()=>{k.innerHTML='<i class="fas fa-spinner fa-spin"></i> Willow is thinking...';const me=document.querySelector("#juainny-rating-container .stars")?.dataset.rating||d.juainny_rating,Ht=document.getElementById("juainny-notes").innerText,qt=document.querySelector("#erick-rating-container .stars")?.dataset.rating||d.erick_rating,Ut=document.getElementById("erick-notes").innerText,Wt={user1:me,user2:qt},Vt={user1:Ht,user2:Ut};try{const Ie=await Mr(d,Wt,Vt);k.innerHTML=vt(Ie);const{error:fe}=await g.from("media").update({ai_summary:Ie}).eq("tmdb_id",e);fe?console.error("Failed to save regenerated summary:",fe):d.ai_summary=Ie}catch(Ie){console.error("Summary regeneration error:",Ie),k.innerHTML='<em class="text-red-400">Failed to generate summary</em>'}}}else document.getElementById("willow-summary-section").classList.add("hidden");if(m&&d&&d.id){const b={};!d.release_year&&L&&(b.release_year=parseInt(L)),!d.runtime&&S&&(b.runtime=S),(!d.content_rating||d.content_rating==="N/A")&&$!=="N/A"&&(b.content_rating=$),!d.imdb_id&&se&&(b.imdb_id=se),Object.keys(b).length>0&&g.from("media").update(b).eq("tmdb_id",e).then(({error:C})=>{C&&console.error("Error auto-saving metadata:",C)})}const Ft=u.backdrop_path?`https://image.tmdb.org/t/p/w780${u.backdrop_path}`:"https://placehold.co/800x400?text=No+Image";document.getElementById("modal-backdrop-image").src=Ft;const{data:_e,error:jt}=await g.from("media").select("*").eq("tmdb_id",e).maybeSingle();jt&&jt.code!=="PGRST116"&&console.error("Error fetching media item for ratings:",jt),w=_e||{tmdb_id:e,type:t,title:u.title||u.name,poster_path:u.poster_path,favorited_by:[],watched:!1,juainny_rating:null,erick_rating:null,juainny_notes:null,erick_notes:null},await an("juainny-rating-container",w?.juainny_rating||0,_n),await an("erick-rating-container",w?.erick_rating||0,_n);const zn=(b,C)=>{const k=document.getElementById(C);if(k){const P=z(b,"w-10 h-10 mr-3"),M=document.createElement("div");M.innerHTML=P;const j=M.firstElementChild;j.id=C,k.replaceWith(j)}};zn("juainny","juainny-avatar"),zn("erick","erick-avatar"),En(w),Je(w);const Gn=(b,C)=>{const k=document.getElementById(C);if(!k)return;const P=k.previousElementSibling;P&&P.classList.contains("notes-toolbar")&&P.remove();const M=document.createElement("div");M.className="flex gap-2 mb-2 notes-toolbar",M.innerHTML=`
                <button type="button" data-format="bold" class="p-2 hover:bg-gray-700 rounded text-white" style="font-weight: bold;">B</button>
                <button type="button" data-format="italic" class="p-2 hover:bg-gray-700 rounded text-white" style="font-style: italic;">I</button>
                <button type="button" data-format="underline" class="p-2 hover:bg-gray-700 rounded text-white" style="text-decoration: underline;">U</button>
            `,k.parentNode.insertBefore(M,k),M.querySelectorAll("button").forEach(G=>{G.addEventListener("click",te=>{te.preventDefault();const me=G.dataset.format;me==="bold"&&document.execCommand("bold",!1,null),me==="italic"&&document.execCommand("italic",!1,null),me==="underline"&&document.execCommand("underline",!1,null),k.focus()})});const j=w?.[`${b}_notes`]||"";k.innerHTML=j};if(Gn("juainny","juainny-notes"),Gn("erick","erick-notes"),document.getElementById("notes-section").classList.remove("hidden"),_e&&u.backdrop_path&&_e.backdrop_path!==u.backdrop_path){const{error:b}=await g.from("media").update({backdrop_path:u.backdrop_path}).eq("tmdb_id",e);b&&console.error("Error updating backdrop path:",b)}Nt();const Kn=document.getElementById("add-mood-btn");Kn&&(Kn.onclick=b=>{b.preventDefault(),yd(e)});const Yn=document.getElementById("modal-flairs-container");if(Yn){const b=_e&&D.get(_e.id)||[];Yn.innerHTML=b.map(C=>pe(C,"text-xs px-2 py-1")).join("")}if(r=document.getElementById("manage-flairs-btn"),r){m?(r.classList.remove("hidden"),r.onclick=async C=>{C.preventDefault();const k=await We(e,t,u.title||u.name,u.poster_path);k&&Yl(k.id)}):r.classList.add("hidden");const b=document.getElementById("discuss-ai-btn");if(b)b.onclick=C=>{C.preventDefault(),Hr(w||{tmdb_id:e,title:u.title||u.name,poster_path:u.poster_path,release_date:u.release_date||u.first_air_date})};else{const C=document.querySelector(".modal-actions")||document.getElementById("willow-summary-section");if(C&&!document.getElementById("discuss-ai-btn-dynamic")){const k=document.createElement("button");k.id="discuss-ai-btn-dynamic",k.className="mt-3 w-full py-2 px-4 bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 border border-purple-500/30 rounded-lg transition flex items-center justify-center gap-2 text-sm font-medium",k.innerHTML='<i class="fas fa-comments"></i> Discuss with Mr. W',k.onclick=()=>Hr(w||{tmdb_id:e,title:u.title||u.name,poster_path:u.poster_path,release_date:u.release_date||u.first_air_date});const P=document.getElementById("regenerate-summary-btn");P&&P.parentNode?P.parentNode.insertBefore(k,P.nextSibling):C.appendChild(k)}}}const Ja="45991eb5-21e1-40ee-8bde-5beee11a7dff",Xa=(_e&&D.get(_e.id)||[]).some(b=>b.id===Ja||b.name==="MCU"),Ee=document.getElementById("marvel-marathon-display"),dt=document.getElementById("normal-modal-content"),ut=document.getElementById("mood-controls");if(Xa){if(Ee){Ee.classList.remove("hidden"),Ee.classList.add("flex");const b=document.getElementById("marvel-marathon-link");b&&(b.href=`https://mm.juainny.com/?tmdb_id=${e}`,b.textContent="Open in Marvel Marathon")}dt&&dt.classList.add("hidden"),ut&&ut.classList.add("hidden")}else Ee&&Ee.classList.add("hidden"),Ee&&Ee.classList.remove("flex"),dt&&dt.classList.remove("hidden"),ut&&ut.classList.remove("hidden");const mt=document.getElementById("share-modal-btn");if(mt){const b=mt.cloneNode(!0);mt.parentNode.replaceChild(b,mt),b.onclick=async C=>{C.preventDefault(),C.stopPropagation();const k=`${window.location.origin}/?tmdb_id=${e}`,P={title:`Check out ${u.title||u.name}`,text:`Check out ${u.title||u.name} on Watchlist!`,url:k};if(navigator.share&&/Mobi|Android/i.test(navigator.userAgent))try{await navigator.share(P)}catch(M){console.error("Error sharing:",M)}else try{await navigator.clipboard.writeText(k);const M=document.getElementById("tooltip");if(M){M.textContent="Link copied to clipboard!",M.style.display="block";const j=b.getBoundingClientRect();M.style.left=`${j.left-100}px`,M.style.top=`${j.bottom+10}px`,M.classList.remove("hidden"),setTimeout(()=>{M.classList.add("hidden")},2e3)}else alert("Link copied to clipboard!")}catch(M){console.error("Failed to copy:",M)}}}n.classList.remove("hidden"),n.classList.remove("modal-hidden"),n.classList.add("flex");const ft=document.getElementById("movie-modal-scrollable-content");if(ft&&r){const b=()=>{ft.scrollTop>20?(r.style.opacity="0",r.style.pointerEvents="none"):(r.style.opacity="1",r.style.pointerEvents="auto")};ft.removeEventListener("scroll",b),ft.addEventListener("scroll",b)}const Jn=document.getElementById("modal-stats-pill");if(Jn){let b=0,C=null;Jn.onclick=async()=>{if(b++,b===1)C=setTimeout(()=>{b=0},500);else if(b===3){clearTimeout(C),b=0;let k=u.runtime||(u.episode_run_time&&u.episode_run_time.length>0?u.episode_run_time[0]:0);t==="tv"&&!k&&(u.last_episode_to_air&&u.last_episode_to_air.runtime?k=u.last_episode_to_air.runtime:u.next_episode_to_air&&u.next_episode_to_air.runtime&&(k=u.next_episode_to_air.runtime));const P=u.release_date||u.first_air_date||"",M=P?parseInt(P.split("-")[0]):null;let j="N/A";if(t==="movie"&&u.release_dates){const G=u.release_dates.results.find(te=>te.iso_3166_1==="US");if(G){const te=G.release_dates.find(me=>me.certification!=="");te&&(j=te.certification)}}else if(t==="tv"&&u.content_ratings&&u.content_ratings.results){const G=u.content_ratings.results.find(te=>te.iso_3166_1==="US");G?j=G.rating:u.content_ratings.results.length>0&&(j=u.content_ratings.results[0].rating)}if(confirm(`Update database with:
Year: ${M}
Runtime: ${k}m
Rating: ${j}`)){const{error:G}=await g.from("media").update({release_year:M,runtime:k,content_rating:j}).eq("tmdb_id",e);G?(alert("Failed to update stats."),console.error(G)):alert("Updated database with runtime, year date, and rating.")}}}}}catch(p){console.error("Error opening movie modal:",p)}}finally{}}async function Yl(e){const t=document.getElementById("flair-modal"),n=document.getElementById("close-flair-modal-btn"),r=document.getElementById("current-flairs-list"),a=document.getElementById("available-flairs-list"),i=document.getElementById("toggle-create-flair-btn"),s=document.getElementById("create-flair-form"),o=document.getElementById("save-new-flair-btn");if(!t)return;s.classList.add("hidden");const l=document.getElementById("delete-flair-btn"),c=document.getElementById("cancel-edit-flair-btn"),d=document.getElementById("flair-form-title"),m=document.getElementById("edit-flair-id"),f=document.getElementById("new-flair-name"),y=document.getElementById("new-flair-color"),h=document.getElementById("new-flair-icon"),E=()=>{s.classList.add("hidden"),m.value="",f.value="",y.value="#ef4444",h.value="",d.textContent="NEW FLAIR",o.textContent="Create Flair",l.classList.add("hidden"),c.classList.add("hidden")},u=()=>{r.innerHTML="";const p=D.get(e)||[];p.forEach(_=>{const I=document.createElement("div");I.className="relative group cursor-pointer",I.innerHTML=pe(_,"text-sm px-3 py-1");const B=document.createElement("div");B.className="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs",B.innerHTML='<i class="fas fa-times"></i>',B.onclick=async v=>{v.stopPropagation(),await Hl(e,_.id);const L=D.get(e).filter($=>$.id!==_.id);D.set(e,L),u(),V();const S=document.getElementById("modal-flairs-container");S&&(S.innerHTML=L.map($=>pe($,"text-xs px-2 py-1")).join(""))},I.appendChild(B),r.appendChild(I)}),a.innerHTML="",xe.forEach(_=>{if(p.find(L=>L.id===_.id))return;const I=document.createElement("div");I.className="flex items-center gap-2 group";const B=document.createElement("div");B.className="cursor-pointer hover:opacity-80",B.innerHTML=pe(_,"text-sm px-3 py-1"),B.onclick=async()=>{if(p.length>=2){alert("Max 2 flairs per item!");return}const L=await jl(e,_.id);if(L.success){D.has(e)||D.set(e,[]),D.get(e).push(_),u(),V();const S=document.getElementById("modal-flairs-container");if(S){const $=D.get(e);S.innerHTML=$.map(ie=>pe(ie,"text-xs px-2 py-1")).join("")}}else alert(L.message)};const v=document.createElement("button");v.className="text-xs text-text-muted hover:text-accent-primary opacity-0 group-hover:opacity-100 transition-opacity",v.innerHTML='<i class="fas fa-pencil-alt"></i>',v.onclick=L=>{L.stopPropagation(),m.value=_.id,f.value=_.name,y.value=_.color,h.value=_.icon||"",d.textContent="EDIT FLAIR",o.textContent="Update Flair",l.classList.remove("hidden"),c.classList.remove("hidden"),s.classList.remove("hidden")},I.appendChild(B),I.appendChild(v),a.appendChild(I)})};u(),n.onclick=()=>{t.classList.add("hidden"),t.classList.add("modal-hidden"),E()},t.onclick=p=>{p.target===t&&(t.classList.add("hidden"),t.classList.add("modal-hidden"),E())},i.onclick=()=>{!s.classList.contains("hidden")&&!m.value?s.classList.add("hidden"):(E(),s.classList.remove("hidden"))},c.onclick=()=>{E()},l.onclick=async()=>{const p=m.value;if(p&&confirm("Are you sure you want to delete this flair? This will remove it from all media items."))if(await deleteFlair(p)){xe=xe.filter(I=>I.id!==p);for(let[I,B]of D)D.set(I,B.filter(v=>v.id!==p));E(),u(),V()}else alert("Failed to delete flair.")},o.onclick=async()=>{const p=f.value.trim(),_=y.value,I=h.value.trim(),B=m.value;if(!p){alert("Name is required");return}if(B){const v=await updateFlair(B,{name:p,color:_,icon:I});if(v){const L=xe.findIndex(se=>se.id===B);L!==-1&&(xe[L]=v);for(let[se,Pe]of D){const Fe=Pe.findIndex(Ft=>Ft.id===B);Fe!==-1&&(Pe[Fe]=v)}E(),u(),V();const[S,$]=await Promise.all([Ze(),et()]);ne("currently-watching-carousel",S),ne("want-to-watch-carousel",$);const ie=document.getElementById("modal-flairs-container");if(ie){const se=D.get(e)||[];ie.innerHTML=se.map(Pe=>pe(Pe,"text-xs px-2 py-1")).join("")}}else alert("Failed to update flair.")}else{const v=await Fl({name:p,color:_,icon:I});v?(xe.push(v),E(),u()):alert("Failed to create flair.")}},t.classList.remove("hidden"),t.classList.remove("modal-hidden"),t.classList.add("flex")}function Jl(){const e=document.getElementById("close-modal-btn"),t=document.getElementById("movie-modal"),n=()=>{t.classList.add("hidden"),t.classList.add("modal-hidden"),t.classList.remove("flex"),document.body.style.overflow="";const r=document.querySelector("footer");r&&r.classList.remove("hidden");const a=document.getElementById("iron-man-walker");a&&(a.classList.remove("walk"),a.classList.add("hidden"))};e&&(e.onclick=n),t&&(t.onclick=r=>{r.target===t&&n()})}function Xl(e){if(!e||e===0)return"N/A";const t=Math.floor(e/60),n=e%60;let r="";return t>0&&(r+=`${t}h `),n>0&&(r+=`${n}m`),r.trim()}function Ql(e){const t=document.getElementById("start-time-hour"),n=document.getElementById("start-time-minute"),r=document.getElementById("end-time"),a=document.getElementById("end-time-calculator");if(!e||e===0){a.classList.add("hidden");return}a.classList.remove("hidden");let i=new Date,s=i.getHours(),o=i.getMinutes();const l=()=>{const c=new Date;c.setHours(s,o,0,0),c.setMinutes(c.getMinutes()+e);const d=c.getHours().toString().padStart(2,"0"),m=c.getMinutes().toString().padStart(2,"0");r.textContent=`${d}:${m}`,t.textContent=s.toString().padStart(2,"0"),n.textContent=o.toString().padStart(2,"0")};t.onclick=()=>{s=(s+1)%24,l()},n.onclick=()=>{o=(o+1)%60,l()},l()}let F=[],Ke=[],H=1,ye=!1,Wa=null,ce=null;async function Va(e,t){const n=document.getElementById("tv-progress-container");n.innerHTML='<div class="text-center">Loading progress...</div>',Ke=t.filter(r=>r.season_number>0&&r.episode_count>0),Wa=e;try{const{data:r,error:a}=await g.from("media").select("id").eq("tmdb_id",e).single();if(a)try{const o=await fetch(`https://api.themoviedb.org/3/tv/${e}?api_key=${ae}&append_to_response=content_ratings`);if(!o.ok)throw new Error("Failed to fetch TV details from TMDB");const l=await o.json(),c=l.first_air_date?parseInt(l.first_air_date.split("-")[0]):null;let d="N/A";if(l.content_ratings&&l.content_ratings.results){const y=l.content_ratings.results.find(h=>h.iso_3166_1==="US");y?d=y.rating:l.content_ratings.results.length>0&&(d=l.content_ratings.results[0].rating)}const{data:m,error:f}=await g.from("media").insert({tmdb_id:e,type:"series",title:l.name,poster_path:l.poster_path,backdrop_path:l.backdrop_path,release_year:c,source:"fetched",runtime:l.episode_run_time?.[0]||0,content_rating:d}).select("id").single();if(f)throw f;ce=m.id}catch(o){console.error("Plan 2 Failed:",o),n.innerHTML=`
                    <div class="text-center py-8 px-4">
                        <i class="fas fa-exclamation-circle text-danger text-3xl mb-3"></i>
                        <p class="text-text-muted">Failed to sync TV show data.</p>
                        <p class="text-text-muted text-sm mt-2">Please try adding it to your watchlist manually first.</p>
                    </div>
                `;return}else ce=r.id;const[i,s]=await Promise.all([g.from("episode_progress").select("*").eq("media_id",ce).eq("viewer","user1"),g.from("episode_progress").select("*").eq("media_id",ce).eq("viewer","user2")]);if(i.error)throw i.error;if(s.error)throw s.error;if(F=[...i.data||[],...s.data||[]],n.innerHTML=`
            <div class="flex justify-between items-center sticky top-0 z-40 bg-bg-tertiary/95 backdrop-blur-md py-3 px-4 border-b border-white/5 mb-4 rounded-t-lg">
                <div class="relative group">
                    <select id="season-select" class="appearance-none bg-black/20 hover:bg-black/40 text-text-primary py-2 pl-4 pr-10 rounded-full font-semibold focus:outline-none focus:ring-2 focus:ring-accent-primary cursor-pointer transition-all border border-white/10">
                        ${Ke.map(o=>`<option value="${o.season_number}">Season ${o.season_number}</option>`).join("")}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-text-muted group-hover:text-text-primary transition-colors">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                     <button id="mark-season-watched-btn" class="text-xs py-2 px-4 rounded-full bg-accent-secondary/20 text-accent-secondary hover:bg-accent-secondary hover:text-white border border-accent-secondary/50 transition font-semibold flex items-center gap-2">
                        <i class="fas fa-check"></i> Season Watched
                    </button>
                    <button id="edit-episodes-btn" class="text-text-muted hover:text-text-primary transition p-2 rounded-full hover:bg-white/10" title="Edit Watched Status">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
            </div>

            <div id="episodes-carousel-wrapper" class="relative pb-4" style="overflow: hidden;">
                <!-- Episodes carousel will be loaded here -->
                <div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-accent-primary mx-auto"></div></div>
            </div>
        `,document.getElementById("season-select").addEventListener("change",o=>{H=parseInt(o.target.value),St(H)}),document.getElementById("mark-season-watched-btn").addEventListener("click",()=>Zl()),document.getElementById("edit-episodes-btn").addEventListener("click",td),Ke.length>0){let o=Ke[0].season_number;const{data:l}=await g.from("activity_log").select("details").eq("media_id",ce).eq("action_type","watched_episode").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(l&&l.details&&l.details.season){const d=l.details.season;Ke.some(m=>m.season_number===d)&&(o=d)}H=o;const c=document.getElementById("season-select");c&&(c.value=H),await St(H)}else n.innerHTML='<div class="text-center">No seasons found.</div>'}catch(r){console.error("Error rendering TV progress:",r),n.innerHTML='<div class="text-center text-danger">Failed to load progress.</div>'}}async function St(e){const t=document.getElementById("episodes-carousel-wrapper");if(t){t.innerHTML='<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-accent-primary mx-auto"></div></div>';try{const n=await fetch(`https://api.themoviedb.org/3/tv/${Wa}/season/${e}?api_key=${ae}`);if(!n.ok)throw new Error("Failed to fetch season details");const r=await n.json();if(!r||!r.episodes){t.innerHTML='<div class="text-center">No episodes found.</div>';return}t.innerHTML=`
            <div class="episodes-carousel-container relative px-2 sm:px-12" style="position: relative;">
                <button class="episodes-nav-btn episodes-nav-left absolute left-0 sm:left-2 top-1/2 -translate-y-1/2 z-10 bg-black/70 hover:bg-black/90 text-white p-2 sm:p-3 rounded-full transition-all shadow-lg hidden sm:block" style="position: absolute;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="episodes-carousel" class="flex overflow-x-auto gap-3 sm:gap-4 pb-4 px-1 sm:px-2 scroll-smooth snap-x snap-mandatory" style="touch-action: pan-x; overscroll-behavior-x: contain; overscroll-behavior-y: none;">
                    <!-- Episodes will be inserted here -->
                </div>
                <button class="episodes-nav-btn episodes-nav-right absolute right-0 sm:right-2 top-1/2 -translate-y-1/2 z-10 bg-black/70 hover:bg-black/90 text-white p-2 sm:p-3 rounded-full transition-all shadow-lg hidden sm:block" style="position: absolute;">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;const a=document.getElementById("episodes-carousel");a.addEventListener("wheel",o=>{if(Math.abs(o.deltaY)>Math.abs(o.deltaX)){const c=o.deltaY;a.scrollLeft+=c,o.preventDefault(),o.stopPropagation()}else o.stopPropagation()},{passive:!1}),r.episodes.forEach(o=>{const l=F.some(h=>h.season_number===e&&h.episode_number===o.episode_number&&h.viewer==="user1"&&h.watched),c=F.some(h=>h.season_number===e&&h.episode_number===o.episode_number&&h.viewer==="user2"&&h.watched),d=l&&c,m=o.still_path?`https://image.tmdb.org/t/p/w500${o.still_path}`:"https://placehold.co/500x281?text=No+Image",f=document.createElement("div");f.className=`episode-card flex-shrink-0 w-[calc(100vw-4rem)] sm:w-72 md:w-80 relative rounded-lg overflow-hidden shadow-md bg-bg-primary cursor-pointer snap-start ${d&&ye?"shake":""}`,f.style.maxWidth="400px",f.dataset.episodeNumber=o.episode_number,f.dataset.seasonNumber=e,f.innerHTML=`
                <div class="relative aspect-video">
                    <img src="${m}" alt="${o.name}" class="w-full h-full object-cover transition-opacity duration-300 ${d?"opacity-50":"opacity-100"}">
                    <div class="absolute top-0 left-0 bg-black/80 text-white text-xs font-bold px-2 py-1 rounded-br-lg z-20">
                        E${o.episode_number}
                    </div>
                    ${d?`
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                            <i class="fas fa-check text-success text-4xl drop-shadow-lg"></i>
                        </div>
                    `:""}
                    <button class="unwatch-btn absolute top-2 right-2 bg-danger text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-700 transition z-30 ${d&&ye?"":"hidden"}">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <div class="p-3">
                    <h4 class="font-semibold text-sm truncate" title="${o.name}">${o.name}</h4>
                    <p class="text-xs text-text-muted line-clamp-2 mt-1">${o.overview||"No description available."}</p>
                </div>
            `,f.addEventListener("click",h=>{h.target.closest(".unwatch-btn")||ye||d||Dr(e,o.episode_number,!0)}),f.querySelector(".unwatch-btn").addEventListener("click",h=>{h.stopPropagation(),Dr(e,o.episode_number,!1)}),a.appendChild(f)});const i=t.querySelector(".episodes-nav-left"),s=t.querySelector(".episodes-nav-right");i.addEventListener("click",()=>{a.scrollBy({left:-a.clientWidth,behavior:"smooth"})}),s.addEventListener("click",()=>{a.scrollBy({left:a.clientWidth,behavior:"smooth"})}),za(r.episodes.length)}catch(n){console.error("Error rendering season episodes:",n),t.innerHTML='<div class="text-center text-danger">Failed to load episodes.</div>'}}}async function Dr(e,t,n){["user1","user2"].forEach(i=>{const s=F.findIndex(o=>o.season_number===e&&o.episode_number===t&&o.viewer===i);s>=0?F[s].watched=n:F.push({media_id:ce,season_number:e,episode_number:t,watched:n,viewer:i})}),nd(e,t,n),za(document.querySelectorAll(".episode-card").length);const r=["user1","user2"].map(i=>({media_id:ce,viewer:i,season_number:e,episode_number:t,watched:n})),{error:a}=await g.from("episode_progress").upsert(r,{onConflict:"media_id,viewer,season_number,episode_number"});a?(console.error("Error updating episode progress:",a),St(H)):n&&await Q("watched_episode","both",w,{season:e,episode:t})}async function Zl(){const e=document.querySelectorAll(".episode-card");if(e.length===0)return;const n=!Array.from(e).every(i=>{const s=parseInt(i.dataset.episodeNumber),o=F.some(c=>c.season_number===H&&c.episode_number===s&&c.viewer==="user1"&&c.watched),l=F.some(c=>c.season_number===H&&c.episode_number===s&&c.viewer==="user2"&&c.watched);return o&&l}),r=[];e.forEach(i=>{const s=parseInt(i.dataset.episodeNumber);["user1","user2"].forEach(o=>{const l=F.findIndex(c=>c.season_number===H&&c.episode_number===s&&c.viewer===o);l>=0?F[l].watched=n:F.push({media_id:ce,season_number:H,episode_number:s,watched:n,viewer:o}),r.push({media_id:ce,viewer:o,season_number:H,episode_number:s,watched:n})})}),St(H);const{error:a}=await g.from("episode_progress").upsert(r,{onConflict:"media_id,viewer,season_number,episode_number"});a&&console.error("Error updating season progress:",a)}async function ed(e){try{const{data:t,error:n}=await g.from("media").select("id").eq("tmdb_id",e).single();if(n)throw console.error("Error fetching media for markAllEpisodesWatched:",n),new Error("Could not find media in database");const r=t.id,a=await fetch(`https://api.themoviedb.org/3/tv/${e}?api_key=${ae}`);if(!a.ok)throw new Error("Failed to fetch TV series details");const i=await a.json(),s=[];for(const o of i.seasons)if(o.season_number>0&&o.episode_count>0){const l=await fetch(`https://api.themoviedb.org/3/tv/${e}/season/${o.season_number}?api_key=${ae}`);if(!l.ok)throw new Error(`Failed to fetch season ${o.season_number} details`);(await l.json()).episodes.forEach(d=>{["user1","user2"].forEach(m=>{s.push({media_id:r,viewer:m,season_number:o.season_number,episode_number:d.episode_number,watched:!0})})})}if(s.length>0){const{error:o}=await g.from("episode_progress").upsert(s,{onConflict:"media_id,viewer,season_number,episode_number"});o?console.error("Error marking all episodes watched:",o):await Va(e,i.seasons)}}catch(t){console.error("Error in markAllEpisodesWatched:",t)}}function td(){ye=!ye;const e=document.getElementById("edit-episodes-btn");ye?e.classList.add("text-accent-primary","animate-pulse"):e.classList.remove("text-accent-primary","animate-pulse"),document.querySelectorAll(".episode-card").forEach(n=>{const r=parseInt(n.dataset.episodeNumber),a=parseInt(n.dataset.seasonNumber),i=F.some(c=>c.season_number===a&&c.episode_number===r&&c.viewer==="user1"&&c.watched),s=F.some(c=>c.season_number===a&&c.episode_number===r&&c.viewer==="user2"&&c.watched),o=i&&s,l=n.querySelector(".unwatch-btn");o&&ye?(n.classList.add("shake"),l.classList.remove("hidden")):(n.classList.remove("shake"),l.classList.add("hidden"))})}function nd(e,t,n){const r=document.querySelector(`.episode-card[data-season-number="${e}"][data-episode-number="${t}"]`);if(!r)return;const a=r.querySelector("img"),i=r.querySelector(".fa-check")?.parentElement,s=r.querySelector(".unwatch-btn");if(n){if(a.classList.remove("opacity-100"),a.classList.add("opacity-50"),!i){const o=document.createElement("div");o.className="absolute inset-0 flex items-center justify-center pointer-events-none",o.innerHTML='<i class="fas fa-check text-success text-4xl drop-shadow-lg"></i>',r.querySelector(".aspect-video").appendChild(o)}ye&&(r.classList.add("shake"),s.classList.remove("hidden"))}else a.classList.remove("opacity-50"),a.classList.add("opacity-100"),i&&i.remove(),r.classList.remove("shake"),s.classList.add("hidden")}function za(e){const t=document.getElementById("mark-season-watched-btn");if(!t)return;[...new Set(F.filter(a=>a.season_number===H&&a.watched).map(a=>a.episode_number))].filter(a=>{const i=F.some(o=>o.season_number===H&&o.episode_number===a&&o.viewer==="user1"&&o.watched),s=F.some(o=>o.season_number===H&&o.episode_number===a&&o.viewer==="user2"&&o.watched);return i&&s}).length===e&&e>0?(t.textContent="Season Watched",t.classList.remove("bg-accent-secondary"),t.classList.add("bg-success")):(t.textContent="Mark Season Watched",t.classList.remove("bg-success"),t.classList.add("bg-accent-secondary","text-white"),t.classList.remove("text-accent-secondary"))}function Ga(e,t){let n;return function(...r){const a=this;clearTimeout(n),n=setTimeout(()=>e.apply(a,r),t)}}const _n=Ga(rd,500);async function rd(){const t=document.getElementById("movie-modal").dataset.tmdbId;if(!t){console.error("saveRatingsAndNotes: tmdbId not found on modal");return}const n=document.querySelector("#juainny-rating-container .rating-input-hidden").value,r=document.querySelector("#erick-rating-container .rating-input-hidden").value,a={juainny_rating:parseFloat(n)||null,juainny_notes:document.getElementById("juainny-notes").innerHTML||null,erick_rating:parseFloat(r)||null,erick_notes:document.getElementById("erick-notes").innerHTML||null};if(!t){console.error("saveRatingsAndNotes: tmdbId is missing!");return}const{data:i,error:s}=await g.from("media").select("tmdb_id").eq("tmdb_id",t).single();if(s&&s.code!=="PGRST116"){console.error("Error checking for existing media:",s);return}let o;if(i)o=await g.from("media").update(a).eq("tmdb_id",t).select().single();else return;const{data:l,error:c}=o;c?console.error("Error saving ratings and notes:",c):(w&&(a.juainny_rating!==w.juainny_rating&&a.juainny_rating!==null&&await Q("rate","juainny",l,{rating:a.juainny_rating}),a.juainny_notes!==w.juainny_notes&&a.juainny_notes!==""&&await Q("note_added","juainny",l),a.erick_rating!==w.erick_rating&&a.erick_rating!==null&&await Q("rate","erick",l,{rating:a.erick_rating}),a.erick_notes!==w.erick_notes&&a.erick_notes!==""&&await Q("note_added","erick",l)),w=l)}function ad(){["juainny-notes","erick-notes"].forEach(t=>{const n=document.getElementById(t);n&&n.addEventListener("input",_n)})}function id(){const e=document.getElementById("wheel-picker-btn");e&&e.addEventListener("click",()=>{Vl(A,Re).open()})}function sd(){switch(Lt){case"popularity":K.sort((n,r)=>r.popularity-n.popularity);break;case"alphabetical":K.sort((n,r)=>(n.title||n.name).localeCompare(r.title||r.name));break;case"release_date":K.sort((n,r)=>{const a=new Date(n.release_date||n.first_air_date);return new Date(r.release_date||r.first_air_date)-a});break;case"length":K.sort((n,r)=>(r.runtime||r.episode_run_time?.[0]||0)-(n.runtime||n.episode_run_time?.[0]||0));break;case"default":default:const e=K.filter(n=>n.source==="fetched").sort((n,r)=>n.id-r.id);K=[...K.filter(n=>n.source!=="fetched").sort((n,r)=>{const a=new Date(n.release_date||n.first_air_date);return new Date(r.release_date||r.first_air_date)-a}),...e];break}}function od(){document.getElementById("sort-select").addEventListener("change",t=>{Lt=t.target.value,V()})}function cd(){const e=document.getElementById("filter-controls");e.addEventListener("click",t=>{if(t.target.matches(".filter-btn")){const n=t.target.dataset.filter;if(n===oe)return;oe=n,e.querySelectorAll(".filter-btn").forEach(r=>{r.classList.remove("btn-active")}),t.target.classList.add("btn-active"),V()}})}function En(e){const t=document.querySelector(".movie-modal-content"),n=document.querySelector(`.movie-card[data-tmdb-id="${e.tmdb_id}"]`),r=e.favorited_by||[],a=r.includes("user1"),i=r.includes("user2");[t,n].forEach(s=>{s&&(s.classList.remove("favorite-glow","rainbow-glow"),a&&i?s.classList.add("rainbow-glow"):(a||i)&&s.classList.add("favorite-glow"))})}async function Q(e,t,n,r={}){try{if(!n||!n.id){console.warn("Cannot log activity: Missing media ID");return}const{error:a}=await g.from("activity_log").insert({media_id:n.id,tmdb_id:n.tmdb_id,action_type:e,user_id:t,details:r});a&&console.error("Error logging activity:",a)}catch(a){console.error("Unexpected error logging activity:",a)}}function ld(){const e=document.getElementById("favorite-btn"),t=document.getElementById("user-selection-menu");e.addEventListener("click",()=>{t.classList.toggle("hidden")}),t.addEventListener("click",async n=>{if(n.target.matches("button")){const r=n.target.id.replace("-btn",""),a=w.tmdb_id,i=w.type||w.media_type,s=w.title||w.name,o=w.poster_path,l=await We(a,i,s,o);if(!l){console.error("Failed to ensure media item exists"),t.classList.add("hidden");return}if(r==="remove-all"){const{error:c}=await g.from("media").update({favorited_by:[]}).eq("tmdb_id",a);c?console.error("Error removing all favorites:",c):(w.favorited_by=[],En(w))}else{const c=r,d=c==="user1"?"juainny":"erick",{data:m,error:f}=await g.from("media").select("id, tmdb_id, title, poster_path, favorited_by").contains("favorited_by",[c]);if(f){console.error("Error checking favorite count:",f),t.classList.add("hidden");return}if(m&&m.length>=3&&!m.some(p=>p.tmdb_id===a)){const p=await dd(m);if(!p){t.classList.add("hidden");return}const _=m.find(I=>I.tmdb_id===p);if(_){const I=(_.favorited_by||[]).filter(v=>v!==c);await g.from("media").update({favorited_by:I}).eq("tmdb_id",p);const B=A.findIndex(v=>v.tmdb_id==p);B>-1&&(A[B].favorited_by=I)}}let y=l.favorited_by||[];if(typeof y=="string")try{y=JSON.parse(y)}catch{y=[]}y.includes(c)?y=y.filter(u=>u!==c):y.push(c);const{data:h,error:E}=await g.from("media").update({favorited_by:y}).eq("tmdb_id",a).select().single();if(E)console.error("Error updating favorites:",E);else{w=h,En(w);const u=A.findIndex(p=>p.tmdb_id===a);u>-1&&(A[u]=h),y.includes(c)&&await Q("favorite",d,h)}}V(),t.classList.add("hidden")}})}async function dd(e,t){return new Promise(n=>{const r=document.getElementById("favorite-removal-modal"),a=document.getElementById("favorite-removal-list"),i=document.getElementById("cancel-favorite-removal-btn");a.innerHTML="",e.forEach(o=>{const l=document.createElement("div");l.className="flex items-center gap-3 p-3 rounded-lg border border-border-primary hover:bg-bg-tertiary cursor-pointer transition";const c=o.poster_path?`https://image.tmdb.org/t/p/w92${o.poster_path}`:"https://placehold.co/92x138?text=No+Image";l.innerHTML=`
                <img src="${c}" class="w-12 h-18 object-cover rounded" alt="${o.title}">
                <span class="flex-grow text-text-primary font-semibold">${o.title}</span>
                <button class="remove-favorite-btn text-danger hover:text-red-400 px-3 py-1 border border-danger rounded transition" data-tmdb-id="${o.tmdb_id}">
                    <i class="fas fa-times"></i> Remove
                </button>
            `,l.querySelector(".remove-favorite-btn").addEventListener("click",()=>{r.classList.add("hidden"),r.classList.remove("flex"),n(o.tmdb_id)}),a.appendChild(l)});const s=()=>{r.classList.add("hidden"),r.classList.remove("flex"),n(null)};i.removeEventListener("click",s),i.addEventListener("click",s),r.classList.remove("hidden"),r.classList.add("flex")})}function Je(e){const t=document.getElementById("toggle-watched-btn"),n=document.getElementById("currently-watching-btn"),r=document.getElementById("remove-currently-watching-btn"),a=document.getElementById("bookmark-btn");n.classList.add("hidden"),r.classList.add("hidden"),t.classList.remove("hidden"),e.watched?(t.textContent="Mark as Unwatched",t.classList.replace("bg-success","bg-gray-600")):e.currently_watching?(t.textContent="Mark as Watched",t.classList.replace("bg-gray-600","bg-success"),r.classList.remove("hidden")):(t.textContent="Mark as Watched",t.classList.replace("bg-gray-600","bg-success"),n.classList.remove("hidden")),e.want_to_watch?a.classList.add("text-accent-primary"):a.classList.remove("text-accent-primary")}async function We(e,t,n,r=null){let a=t;a==="tv"&&(a="series");let{data:i,error:s}=await g.from("media").select("*").eq("tmdb_id",e).single();if(s&&s.code!=="PGRST116")return console.error("Error checking for media item:",s),null;if(i){if(r&&!i.poster_path){const{data:c,error:d}=await g.from("media").update({poster_path:r}).eq("tmdb_id",e).select().single();return d?(console.error("Error updating poster path:",d),i):c}return i}const{data:o,error:l}=await g.from("media").insert({tmdb_id:e,type:a,title:n,poster_path:r,source:"added"}).select().single();return l?(console.error("Error creating new media item:",l),null):o}function ud(){const e=document.getElementById("toggle-watched-btn"),t=document.getElementById("toggle-rejected-btn"),n=document.getElementById("currently-watching-btn"),r=document.getElementById("remove-currently-watching-btn"),a=document.getElementById("bookmark-btn"),i=async s=>{const{tmdb_id:o,type:l,title:c,poster_path:d}=w;if(!await We(o,l,c,d))return;if((l==="tv"||l==="series")&&!w.watched&&!s){const u=await vd("Mark Series Watched?","How would you like to mark this series?");if(u==="cancel")return;u==="all-episodes"&&await ed(o)}const f=s?!1:!w.watched;let y={watched:f};s&&(y.currently_watching=!1,y.source=null),f&&(y.currently_watching=!1,y.want_to_watch=!1);const{data:h,error:E}=await g.from("media").update(y).eq("tmdb_id",o).select().single();if(E)console.error("Error updating watched status:",E);else{w=h,Je(w);const u=A.findIndex(p=>p.tmdb_id===o);u>-1?A[u]=h:A.push(h),f&&!s&&await Q("watched","both",h),V()}};r.addEventListener("click",async()=>{const{tmdb_id:s}=w,{data:o,error:l}=await g.from("media").update({currently_watching:!1}).eq("tmdb_id",s).select().single();l?console.error("Error removing from currently watching:",l):(w=o,Je(w))}),n.addEventListener("click",async()=>{const{tmdb_id:s,type:o,title:l,poster_path:c}=w;if(!await We(s,o,l,c))return;const m={currently_watching:!0,want_to_watch:!1,watched:!1},{data:f,error:y}=await g.from("media").update(m).eq("tmdb_id",s).select().single();y?console.error("Error setting currently watching:",y):(w=f,Je(w),await Q("currently_watching","both",f))}),a.addEventListener("click",async()=>{const{tmdb_id:s,type:o,title:l,poster_path:c}=w;if(!await We(s,o,l,c))return;const m=!w.want_to_watch;let f={want_to_watch:m};m&&(f.currently_watching=!1);const{data:y,error:h}=await g.from("media").update(f).eq("tmdb_id",s).select().single();h?console.error("Error updating bookmark:",h):(w=y,Je(w),m&&await Q("want_to_watch","both",y))}),e.addEventListener("click",()=>i(!1)),t.addEventListener("click",()=>i(!0))}function md(){const e=document.getElementById("view-controls");e.addEventListener("click",t=>{const n=t.target.closest(".view-btn");if(n){const r=n.dataset.view;if(r===bn)return;bn=r,e.querySelectorAll(".view-btn").forEach(a=>{a.classList.remove("btn-active")}),n.classList.add("btn-active"),V()}})}async function fd(){try{xe=await Nl();const{data:e,error:t}=await g.from("media_flairs").select("media_id, flairs(*)");!t&&e&&e.forEach(v=>{D.has(v.media_id)||D.set(v.media_id,[]),D.get(v.media_id).push(v.flairs)});const n=await Ze();ne("currently-watching-carousel",n);const r=await et();ne("want-to-watch-carousel",r),g.channel("media-carousels").on("postgres_changes",{event:"*",schema:"public",table:"media"},async v=>{const[L,S]=await Promise.all([Ze(),et()]);ne("currently-watching-carousel",L),ne("want-to-watch-carousel",S)}).subscribe(),g.channel("media").on("postgres_changes",{event:"*",schema:"public",table:"media"},async v=>{const[L,S]=await Promise.all([Ze(),et()]);ne("currently-watching-carousel",L),ne("want-to-watch-carousel",S)}).subscribe();const a=new URLSearchParams(window.location.search);a.get("hardrefresh")==="true"&&(await Ml(),window.history.replaceState({},document.title,window.location.pathname));const s=document.getElementById("loading-spinner");s&&(s.style.display="flex");const{data:o,error:l}=await g.from("media").select("*");if(l){console.error("Error fetching all media:",l);return}A=await zl(o),Qe=A.filter(v=>v.watched),V(),s&&(s.style.display="none"),kd();const c=a.get("tmdb_id");if(c){const v=A.find(S=>S.tmdb_id==c);if(v)Re(v.tmdb_id,v.type||v.media_type);else try{(await fetch(`https://api.themoviedb.org/3/movie/${c}?api_key=${ae}`)).ok?Re(c,"movie"):(await fetch(`https://api.themoviedb.org/3/tv/${c}?api_key=${ae}`)).ok&&Re(c,"tv")}catch(S){console.error("Error finding shared item type:",S)}const L=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.replaceState({path:L},"",L)}const d=document.getElementById("search-bar");d.setAttribute("autocomplete","off"),d.setAttribute("data-lpignore","true"),d.setAttribute("data-form-type","other"),d.setAttribute("spellcheck","false");const m=document.getElementById("sort-select"),f=document.getElementById("home-btn"),y=document.getElementById("logo-container"),h=document.getElementById("currently-watching-section"),E=document.getElementById("want-to-watch-section"),u=()=>{d.value="",Qe=A,oe="watched",m.value="default",Lt="default",m.disabled=!1,f.classList.add("hidden"),h.classList.remove("hidden"),E.classList.remove("hidden"),vn=!1;const v=document.getElementById("watched-items-header");v&&v.classList.remove("hidden"),V(),In()},_=Ga(async v=>{try{const L=v.target.value.trim();if(L==="")u();else{f.classList.remove("hidden"),h.classList.add("hidden"),E.classList.add("hidden"),vn=!0;const S=document.getElementById("watched-items-header");S&&S.classList.add("hidden"),Qe=await Gl(L),Lt="popularity",oe="all",m.disabled=!0,V()}}catch(L){console.error("Error in search handler:",L)}},300);d.addEventListener("input",_),f.addEventListener("click",u),y.addEventListener("click",u),Jl(),ad(),cd(),id(),md(),ld(),ud(),od(),ii(),await st(),hd(),pd(),In();const I=document.getElementById("notification-btn");I&&I.addEventListener("click",()=>{alert("Notifications Coming Soon!")});const B=document.getElementById("avatar-toggle");B&&B.addEventListener("change",v=>{document.body.classList.toggle("show-avatars",v.target.checked)}),qe(),document.addEventListener("click",v=>{const L=document.getElementById("reaction-tooltip");L&&!L.classList.contains("hidden")&&(v.target.closest(".reaction-item")||lt())})}catch(e){console.error("Error during app initialization:",e)}}function hd(){const e=document.getElementById("user-menu-btn"),t=document.getElementById("user-menu");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("hidden")})}function pd(){const e={"currently-watching":document.getElementById("edit-currently-watching-btn"),"want-to-watch":document.getElementById("edit-want-to-watch-btn")},t={"currently-watching":document.getElementById("currently-watching-carousel"),"want-to-watch":document.getElementById("want-to-watch-carousel")};let n={"currently-watching":!1,"want-to-watch":!1};const r=a=>{n[a]=!n[a];const i=t[a],s=e[a];n[a]?(s.classList.add("text-accent-primary"),i.querySelectorAll(".movie-card").forEach(o=>{o.classList.add("shake");const l=document.createElement("button");l.className="absolute inset-0 bg-black bg-opacity-50 text-white flex items-center justify-center text-4xl",l.innerHTML='<i class="fas fa-times"></i>',l.onclick=async()=>{const c=o.dataset.tmdbId,d=a==="currently-watching"?{currently_watching:!1}:{want_to_watch:!1},{error:m}=await g.from("media").update(d).eq("tmdb_id",c);m?console.error(`Error removing from ${a}:`,m):o.remove()},o.appendChild(l)})):(s.classList.remove("text-accent-primary"),i.querySelectorAll(".movie-card").forEach(o=>{o.classList.remove("shake"),o.querySelector("button")?.remove()}))};e["currently-watching"].addEventListener("click",()=>r("currently-watching")),e["want-to-watch"].addEventListener("click",()=>r("want-to-watch"))}document.addEventListener("DOMContentLoaded",fd);const gd=["24klabubu.png","afraid.png","amazed.png","angry.png","bored.png","celebratory.png","crazy.png","crying.png","disgusted.png","happy.png","melted.png","neutral.png","not-a-fan.png","sad.png","satisfied.png","sexy.png","surprised.png","thinking.png","tea.png","lol.png"],Ka={"tea.png":"Das Tea","lol.png":"Laughter","24klabubu.png":"24k Labubu","not-a-fan.png":"Not A Fan"};function yd(e){const t=document.getElementById("mood-modal-container");if(!t){console.error("mood-modal-container not found!");return}t.style.cssText=`
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
    `,Se=null,He=null,t.innerHTML=`
        <div class="mood-modal" style="background-color: #1a1a1a; color: white; border-radius: 1rem; width: 95%; max-width: 40rem; max-height: 80vh; overflow-y: auto; position: relative; border: 1px solid #404040; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <button id="close-mood-modal-btn" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.1); border-radius: 50%; padding: 0.5rem; cursor: pointer; color: white;">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div style="padding: 1.5rem;">
                <h2 class="text-2xl font-bold mb-6 text-center">How did this movie make you react?</h2>
                
                <div class="flex justify-center mb-8 gap-4">
                    <button class="user-select-btn" data-user="juainny">
                        <div class="user-avatar-preview user1-avatar-preview">J</div>
                        <span class="font-semibold">Juainny</span>
                    </button>
                    <button class="user-select-btn" data-user="erick">
                        <div class="user-avatar-preview user2-avatar-preview">E</div>
                        <span class="font-semibold">Erick</span>
                    </button>
                </div>

                <div id="mood-grid-container" class="mood-grid grayscale transition-all duration-300" style="opacity: 0.5; pointer-events: none;">
                    ${gd.map(a=>{const i=Ka[a]||a.replace(".png","").replace(/-/g," ").replace(/_/g," ");return`
                        <div class="mood-option" data-mood="${a}" role="button" aria-label="${i}">
                            <img src="moods/${a}" alt="${i}">
                            <span class="mood-label">${i}</span>
                        </div>
                    `}).join("")}
                </div>

                <div class="mt-8 text-center">
                    <button id="mood-done-btn" class="bg-accent-primary hover:bg-accent-secondary text-text-on-accent font-bold py-2 px-8 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Done</button>
                </div>
            </div>
        </div >
        `,document.getElementById("close-mood-modal-btn").addEventListener("click",closeReactionSelector),t.addEventListener("click",a=>{a.target===t&&closeReactionSelector()});const n=t.querySelectorAll(".user-select-btn");n.forEach(a=>{a.addEventListener("click",()=>{n.forEach(s=>s.classList.remove("selected")),a.classList.add("selected"),Se=a.dataset.user;const i=document.getElementById("mood-grid-container");i.classList.remove("grayscale"),i.style.opacity="1",i.style.pointerEvents="auto",Or()})});const r=t.querySelectorAll(".mood-option");r.forEach(a=>{a.addEventListener("click",()=>{Se&&(r.forEach(i=>i.classList.remove("selected")),a.classList.add("selected"),He=a.dataset.mood,Or())})}),document.getElementById("mood-done-btn").addEventListener("click",()=>{Se&&He&&(wd(e,Se,He),closeReactionSelector())})}let Se=null,He=null;function Or(){const e=document.getElementById("mood-done-btn");Se&&He?e.disabled=!1:e.disabled=!0}window.closeReactionSelector=function(){const e=document.getElementById("mood-modal-container");e&&(e.innerHTML="",e.style.cssText=""),Se=null,He=null};async function wd(e,t,n){const r={};if((t==="user1"||t==="juainny")&&(r.juainny_reaction=n),(t==="user2"||t==="erick")&&(r.erick_reaction=n),w&&w.tmdb_id==e)w.title||w.name,w.poster_path,w.type||w.title;else{const o=A.find(l=>l.tmdb_id==e);o&&(o.title||o.name,o.poster_path,o.type)}w&&w.tmdb_id==e&&(t==="user1"&&(w.juainny_reaction=n),t==="user2"&&(w.erick_reaction=n),Nt());const a=A.findIndex(o=>o.tmdb_id==e);if(a>-1){A[a]={...A[a],...r},V();const o=await Ze();ne("currently-watching-carousel",o);const l=await et();ne("want-to-watch-carousel",l)}const{data:i,error:s}=await g.from("media").update(r).eq("tmdb_id",e).select().single();s?(console.error("Error saving reaction:",s),alert("Failed to save reaction. Please try again.")):i&&n&&await Q("reaction",t==="user1"||t==="juainny"?"juainny":"erick",i,{reaction:n})}function Nt(){const e=document.getElementById("modal-mood-display"),t=document.getElementById("remove-mood-btn");if(!e)return;e.innerHTML="";let n=!1;w?.juainny_reaction&&(n=!0,e.innerHTML+=`
        <div class="relative group" title="Juainny's Reaction">
            <img src="moods/${w.juainny_reaction}" class="w-10 h-10 object-contain drop-shadow-md">
                <div class="absolute -bottom-1 -right-1 w-4 h-4">
                    ${z("juainny","w-full h-full")}
                </div>
            </div>
    `),w?.erick_reaction&&(n=!0,e.innerHTML+=`
        <div class="relative group" title="Erick's Reaction">
            <img src="moods/${w.erick_reaction}" class="w-10 h-10 object-contain drop-shadow-md">
                <div class="absolute -bottom-1 -right-1 w-4 h-4">
                    ${z("erick","w-full h-full")}
                </div>
            </div>
    `),n?(t.classList.remove("hidden"),t.onclick=async()=>{if(confirm("Remove all reactions for this item?")){const r={juainny_reaction:null,erick_reaction:null};w.juainny_reaction=null,w.erick_reaction=null,Nt(),await g.from("media").update(r).eq("tmdb_id",w.tmdb_id),V()}}):t.classList.add("hidden")}function In(){document.querySelectorAll(".movie-card").forEach(e=>{const t=e.dataset.tmdbId,n=A.find(r=>r.tmdb_id==t);if(n){const r=e.querySelector(".absolute.top-2.left-2");if(r){let a="";n.juainny_reaction&&(a+=`
                        <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Juainny" data-reaction="${n.juainny_reaction}">
                            <img src="moods/${n.juainny_reaction}" class="w-full h-full object-contain drop-shadow-md">
                            <div class="absolute -bottom-1 -right-1 w-4 h-4">
                                ${z("juainny","w-full h-full")}
                            </div>
                        </div>
                    `),n.erick_reaction&&(a+=`
                        <div class="relative w-8 h-8 group/reaction cursor-pointer reaction-item" data-user="Erick" data-reaction="${n.erick_reaction}">
                            <img src="moods/${n.erick_reaction}" class="w-full h-full object-contain drop-shadow-md">
                            <div class="absolute -bottom-1 -right-1 w-4 h-4">
                                ${z("erick","w-full h-full")}
                            </div>
                        </div>
                    `),r.innerHTML=a,r.querySelectorAll(".reaction-item").forEach(i=>{i.addEventListener("mouseenter",s=>{Pt(s.currentTarget)}),i.addEventListener("mouseleave",()=>{lt()}),i.addEventListener("click",s=>{Wn(s.currentTarget,s)})})}}}),w&&Nt()}let Un=null;function Pt(e){const t=document.getElementById("reaction-tooltip"),n=document.getElementById("tooltip-avatar"),r=document.getElementById("tooltip-text");if(!t||!n||!r)return;const a=e.dataset.user,i=e.dataset.reaction;let s=Ka[i];s||(s=i.replace(".png","").replace(/_/g," ").replace(/-/g," ").split(" ").map(d=>d.charAt(0).toUpperCase()+d.slice(1)).join(" ")),n.innerHTML=z(a.toLowerCase(),"w-6 h-6"),r.textContent=`${a} reacted with ${s}`;const o=e.getBoundingClientRect(),l=window.pageYOffset||document.documentElement.scrollTop,c=window.pageXOffset||document.documentElement.scrollLeft;t.style.position="absolute",t.style.left=`${o.left+c+o.width/2}px`,t.style.top=`${o.bottom+l+8}px`,t.style.transform="translateX(-50%)",t.classList.remove("hidden"),Un=e}function lt(){const e=document.getElementById("reaction-tooltip");e&&(e.classList.add("hidden"),Un=null)}function Wn(e,t){t.stopPropagation(),Un===e?lt():Pt(e)}function bd(){let e=document.getElementById("copied-popup");e||(e=document.createElement("div"),e.id="copied-popup",e.className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[9999] pointer-events-none",e.innerHTML=`
            <div class="bg-black/90 backdrop-blur-md text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-2 border border-white/20">
                <i class="fas fa-check-circle text-green-400"></i>
                <span class="text-lg font-semibold">Copied!</span>
            </div>
        `,document.body.appendChild(e)),e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0.8)",e.classList.remove("hidden"),requestAnimationFrame(()=>{e.style.transition="opacity 0.2s ease-out, transform 0.2s ease-out",e.style.opacity="1",e.style.transform="translate(-50%, -50%) scale(1)"}),setTimeout(()=>{e.style.transition="opacity 0.3s ease-in, transform 0.3s ease-in",e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0.8)",setTimeout(()=>{e.classList.add("hidden")},300)},1500)}function vd(e,t){return new Promise(n=>{const r=document.getElementById("confirmation-modal"),a=document.getElementById("confirmation-title"),i=document.getElementById("confirmation-message"),s=document.getElementById("confirm-series-only-btn"),o=document.getElementById("confirm-all-episodes-btn"),l=document.getElementById("cancel-confirmation-btn");a.textContent=e,i.textContent=t,o&&o.classList.remove("hidden"),r.classList.remove("hidden"),r.classList.add("flex");const c=()=>{r.classList.add("hidden"),r.classList.remove("flex"),s.onclick=null,o&&(o.onclick=null),l.onclick=null};s.onclick=()=>{c(),n("series-only")},o&&(o.onclick=()=>{c(),n("all-episodes")}),l.onclick=()=>{c(),n("cancel")}})}const Nr=document.getElementById("willow-fab"),bt=document.getElementById("willow-chat-modal"),Ye=document.getElementById("willow-chat-container"),Pr=document.getElementById("willow-chat-form"),X=document.getElementById("willow-chat-input"),Ve=document.getElementById("willow-chat-messages"),Ct=document.getElementById("willow-user-selection"),Fr=document.getElementById("select-juainny-btn"),jr=document.getElementById("select-erick-btn");let $e=null,le=null;Fr&&Fr.addEventListener("click",()=>{Vn("juainny")});jr&&jr.addEventListener("click",()=>{Vn("erick")});function Vn(e){le=e,Ct&&Ct.classList.add("hidden"),$e=Ot(A,e),X&&(X.disabled=!1,X.focus())}window.toggleWillowChat=function(){bt.classList.contains("hidden")?(bt.classList.remove("hidden"),setTimeout(()=>{Ye.style.opacity="1",Ye.style.transform="scale(1)"},10),le?setTimeout(()=>X.focus(),350):(Ct&&Ct.classList.remove("hidden"),X&&(X.disabled=!0))):(Ye.style.opacity="0",Ye.style.transform="scale(0.95)",setTimeout(()=>{bt.classList.add("hidden"),Ye.style.transform="scale(0.95)"},300))};async function Hr(e){const t=document.getElementById("movie-modal");t&&(t.classList.add("hidden"),t.classList.remove("flex"),document.body.style.overflow=""),bt.classList.contains("hidden")&&window.toggleWillowChat(),$e||(le?$e=Ot(A,le):Vn("juainny")),tt("","user",null,{type:"MEDIA_CONTEXT",media:e});const n=`The user wants to discuss the movie/show "${e.title||e.name}" (TMDB ID: ${e.tmdb_id}). Start the conversation by asking what they thought about it. Be brief and engaging.`,r=Ya();try{const a=await Ua($e,n);kn(r),tt(a.text,"ai",a.route,a.action)}catch(a){console.error("Error starting discussion:",a),kn(r),tt("I'm having trouble connecting right now, but I'd love to hear your thoughts!","ai")}}Nr&&Nr.addEventListener("click",window.toggleWillowChat);Pr&&Pr.addEventListener("submit",async e=>{e.preventDefault();const t=X.value.trim();if(!t)return;tt(t,"user"),X.value="",X.disabled=!0;const n=Ya();$e||($e=Ot(A,le));const r=await Ua($e,t);kn(n),tt(r.text,"ai",r.route,r.action),X.disabled=!1,X.focus()});function vt(e){return e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,'<ul class="list-disc pl-4 space-y-1">$1</ul>').replace(/\n/g,"<br>")}function tt(e,t,n=null,r=null){const a=document.createElement("div");a.className=`flex items-start gap-2 ${t==="user"?"flex-row-reverse":""}`;const i=t==="ai"?'<div class="w-10 h-10 flex-shrink-0 flex items-center justify-center overflow-hidden"><img src="/willow-logo.png" class="w-full h-full object-contain"></div>':"",s=t==="ai"?"bg-bg-tertiary text-text-primary rounded-tl-none":"bg-teal-600 text-white rounded-tr-none",o=t==="ai"?vt(e):e,l={DATABASE:'<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-900/50 text-blue-300 border border-blue-500/30 mb-2">ðŸ—„ï¸ Database</span>',WEB:'<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-900/50 text-green-300 border border-green-500/30 mb-2">ðŸŒ Web Search</span>',KNOWLEDGE:'<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-900/50 text-purple-300 border border-purple-500/30 mb-2">ðŸ’¡ Knowledge</span>',CHAT:'<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-700/50 text-gray-300 border border-gray-500/30 mb-2">ðŸ’¬ Chat</span>',ERROR:'<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-900/50 text-red-300 border border-red-500/30 mb-2">âš ï¸ Error</span>'},c=n&&l[n]?l[n]:"";if(a.innerHTML=`
        ${i}
        <div class="${s} p-3 rounded-2xl text-sm shadow-sm max-w-[85%] markdown-content">
            ${c}
            ${o}
        </div>
    `,r&&r.type==="REQUEST_RATING"){const d=document.createElement("div"),m=`chat-rating-${r.tmdbId}-${Date.now()}`;d.id=m,d.className="mt-3 p-3 bg-black/20 rounded-lg border border-white/10",a.querySelector(".markdown-content").appendChild(d),setTimeout(()=>{an(m,0,async()=>{const f=d.querySelector(".stars");if(f){const y=f.dataset.rating;await _d(r.tmdbId,y);const h=document.createElement("div");h.className="text-xs text-green-400 mt-1",h.innerHTML='<i class="fas fa-check"></i> Saved',d.appendChild(h)}})},50)}if(r&&r.type==="MEDIA_CONTEXT"){const d=r.media,m=d.poster_path?d.poster_path.startsWith("http")?d.poster_path:`https://image.tmdb.org/t/p/w92${d.poster_path}`:"https://placehold.co/92x138?text=No+Image",f=(d.release_date||d.first_air_date||"").split("-")[0];a.innerHTML=`
            <div class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 flex gap-3 items-center mb-4">
                <img src="${m}" class="w-12 h-18 object-cover rounded shadow-sm" crossorigin="anonymous">
                <div class="flex-grow min-w-0">
                    <div class="text-xs text-text-muted uppercase tracking-wider mb-0.5">Let's talk about</div>
                    <h4 class="font-bold text-text-primary truncate">${d.title||d.name}</h4>
                    <div class="text-xs text-text-muted">${f}</div>
                </div>
                <button class="text-xs bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-full transition whitespace-nowrap" onclick="openMovieModal(${d.tmdb_id}, '${d.type||"movie"}')">
                    View Details
                </button>
            </div>
        `,a.className="w-full max-w-md mx-auto my-2"}if(r&&r.type==="TRIVIA_GAME"){const d=`trivia-${r.tmdbId}-${Date.now()}`,m=document.createElement("div");m.id=d,m.className="w-full max-w-md mx-auto my-2 bg-bg-secondary border border-purple-500/30 rounded-lg p-4 shadow-lg",m.innerHTML=`
            <div class="text-center">
                <div class="text-purple-400 font-bold mb-2"><i class="fas fa-gamepad"></i> Trivia Challenge</div>
                <div class="animate-pulse text-sm text-text-muted">Generating question...</div>
            </div>
        `,a.appendChild(m),Ed(r.tmdbId,d)}return Ve.appendChild(a),Ve.scrollTop=Ve.scrollHeight,a.id="msg-"+Date.now()}async function _d(e,t){if(!le)return;const n={};le==="juainny"&&(n.juainny_rating=parseFloat(t)),le==="erick"&&(n.erick_rating=parseFloat(t));const{data:r,error:a}=await g.from("media").update(n).eq("tmdb_id",e).select().single();if(a)console.error("Error saving chat rating:",a);else{await Q("rate",le,r,{rating:parseFloat(t)});const i=A.findIndex(s=>s.tmdb_id==e);i>-1&&(A[i]=r),w&&w.tmdb_id==e&&(w=r)}}async function Ed(e,t){const n=`Generate a trivia question for the movie/show with TMDB ID ${e}. 
    Return ONLY a JSON object with this format:
    {
        "question": "The question text",
        "options": ["Option A", "Option B", "Option C", "Option D"],
        "correctIndex": 0,
        "explanation": "Why it is correct"
    }`;try{const s=(await(await Ot(A).sendMessage(n)).response.text()).match(/\{[\s\S]*\}/);if(s){const o=JSON.parse(s[0]);Id(t,o)}else throw new Error("No JSON found")}catch(r){console.error("Trivia generation failed",r);const a=document.getElementById(t);a&&(a.innerHTML='<div class="text-red-400 text-sm">Failed to load trivia. Try again!</div>')}}function Id(e,t){const n=document.getElementById(e);n&&(n.innerHTML=`
        <div class="text-center mb-3">
            <div class="text-purple-400 font-bold"><i class="fas fa-question-circle"></i> Trivia Time</div>
        </div>
        <div class="text-text-primary font-medium mb-4 text-lg">${t.question}</div>
        <div class="grid grid-cols-1 gap-2">
            ${t.options.map((r,a)=>`
                <button class="trivia-option w-full text-left p-3 rounded bg-white/5 hover:bg-white/10 border border-white/10 transition text-sm" onclick="handleTriviaAnswer(this, ${a}, ${t.correctIndex}, '${t.explanation.replace(/'/g,"\\'")}')">
                    ${r}
                </button>
            `).join("")}
        </div>
        <div class="trivia-feedback mt-3 text-sm hidden"></div>
    `)}window.handleTriviaAnswer=(e,t,n,r)=>{const a=e.closest(".grid").parentNode,i=a.querySelector(".trivia-feedback"),s=a.querySelectorAll(".trivia-option");s.forEach(o=>o.disabled=!0),t===n?(e.classList.add("bg-green-500/20","border-green-500","text-green-300"),i.innerHTML=`<div class="text-green-400 font-bold"><i class="fas fa-check"></i> Correct!</div><div class="text-text-muted mt-1">${r}</div>`):(e.classList.add("bg-red-500/20","border-red-500","text-red-300"),s[n].classList.add("bg-green-500/20","border-green-500","text-green-300"),i.innerHTML=`<div class="text-red-400 font-bold"><i class="fas fa-times"></i> Wrong!</div><div class="text-text-muted mt-1">${r}</div>`),i.classList.remove("hidden")};function Ya(){const e=document.createElement("div");return e.id="typing-"+Date.now(),e.className="flex items-start gap-2",e.innerHTML=`
        <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center overflow-hidden"><img src="/willow-logo.png" class="w-full h-full object-contain"></div>
        <div class="bg-bg-tertiary p-3 rounded-2xl rounded-tl-none text-text-primary text-sm shadow-sm">
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    `,Ve.appendChild(e),Ve.scrollTop=Ve.scrollHeight,e.id}function kn(e){const t=document.getElementById(e);t&&t.remove()}function kd(){if(localStorage.getItem("welcome_modal_seen"))return;const t=document.getElementById("welcome-modal"),n=document.getElementById("close-welcome-btn"),r=document.getElementById("dismiss-welcome-btn"),a=document.getElementById("welcome-signature-avatar");if(!t)return;t.classList.remove("hidden"),t.classList.add("flex"),a&&(a.innerHTML=z("juainny","w-full h-full"));const i=()=>{t.classList.add("hidden"),t.classList.remove("flex"),localStorage.setItem("welcome_modal_seen","true")};n&&n.addEventListener("click",i),r&&r.addEventListener("click",i),t.addEventListener("click",s=>{s.target===t&&i()})}const Td=Object.freeze(Object.defineProperty({__proto__:null,refreshAllReactionAvatars:In},Symbol.toStringTag,{value:"Module"}));
